<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>SpringCloud | 李阳的秘密小屋</title><meta name="keywords" content="javaweb"><meta name="author" content="李阳"><meta name="copyright" content="李阳"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="SpringCloud"><meta name="application-name" content="SpringCloud"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud"><meta property="og:url" content="https://blog.baskly.fun/posts/42622/index.html"><meta property="og:site_name" content="李阳的秘密小屋"><meta property="og:description" content="SpringCloud"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=320ac6a6-3bf5-9cc8-180a-c9c4b73ea680"><meta property="article:author" content="李阳"><meta property="article:tag" content="bask,李阳"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=320ac6a6-3bf5-9cc8-180a-c9c4b73ea680"><meta name="description" content="SpringCloud"><link rel="shortcut icon" href="/img/flow-32x32.ico"><link rel="canonical" href="https://blog.baskly.fun/posts/42622/"><link rel="preconnect" href="//cdn.cbd.int"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"><link rel="mask-icon" href="/img/siteicon/yang180.png" color="#5bbad5"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/yang180.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/yang180.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/yang32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/yang16.png"><link rel="bookmark" href="/img/siteicon/yang180.png"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:void 0,peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"Liyang",mode:"local",switchBtn:!1,btnLink:"https://afdian.net/item/886a79d4db6711eda42a52540025c377",randomNum:3,basicWordCount:1e3,key:"xxxx",Referer:"https://xx.xx/"},diytitle:{enable:!0,leaveTitle:"不要走",backTitle:"不要离开我     -"},LA51:void 0,greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 要睡觉喽",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.baskly.fun",commentBarrageConfig:void 0,music_page_default:"nav_music",root:"/",preloader:{source:3},friends_vue_info:void 0,navMusic:!0,mainTone:{mode:"both",api:null,cover_change:!0},authorStatus:{skills:["东隅已逝 桑榆非晚","集中精神 攻克难关"]},algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!0,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!1,limitCount:50,languages:{author:"作者: 李阳",link:"链接: ",source:"来源: 李阳的秘密小屋",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:void 0,autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"李阳的秘密小屋",title:"SpringCloud",postAI:"",pageFillDescription:"一、前置课程, 1、MybatisPlus, 1.1 项目启动, 1.2 常用注解, 1.3 常见配置, 1.4 核心功能, 模糊查询, 条件更新, 条件更新, 自定义SQL, Service接口–IService, 1.5 Restful风格接口, 1.6 逻辑删除, 1.7 枚举处理器, 1.8 JSON类型处理器, 1.9 分页插件, 通用分页查询案例, 将分页条件封装在工具类中, 2.Docker, 1. 安装问题, 2. 解决Docker镜像问题, 2. 安装MySQL, 3. Docker常见命令, 4. 数据卷, 4.1 什么是数据卷, 4.2 数据卷的命令, 4.3 创建Nginx 数据卷, 4.4 MySQL 容器的数据挂载, 5. 自定义镜像, 6. 网络, 7.使用Docker打包项目（tlias为例）, 7.1后端打包, 具体步骤, 7.2. 前端项目部署, 8. DockerCompose, 二、微服务01, 1. 导入后端项目, 解决时区不同步问题, 2. 单体架构与微服务, 3. 微服务拆分原则, 4. 远程调用（RPC）, 4.1 RestTemplate, 4.2 注册中心, 4.3 Nacos注册中心, 4.4 OpenFeign, 4.5 连接池, 4.6 最佳实践, 4.6 日志输出, 定义日志级别, 三、 微服务02, 1. 网关路由, 1.1 网关快速入门, 1.2 路由属性, 路由断言, 路由过滤器, 2. 网关登录, 2.1 网关过滤器, 2.2 自定义过滤器, 2.3 实现登录校验, 2.4 网关传递用户, 保存用户到请求头, 拦截器获取用户, 配置拦截器, 添加扫描, 结果, 1.3.5 OpenFeign传递用户, 3. 配置管理, 3.1 配置共享, 3.1.1 添加共享配置, 3.2 拉取nacos, 3.3 配置热更新, 3.4 动态路由, 四、 微服务03, 4.1 雪崩问题, 4.2 微服务保护, 4.2.1 服务保护方案, 4.2.2 请求限流, 4.2.3 线程隔离, 4.2.4 服务熔断, 4.3 Sentinel, 4.3.1 Sentinel安装, Window安装, Docker运行, 4.3.2 Fallback, 4.4 分布式事务, 4.4.1 Seata, 4.4.2 Seata配置, 4.4.3 微服务集成Seata, 导入依赖, 配置nacos, 改造配置, 4.4.4 XA模式（面试题）, 回滚日志, 4.4.5 AT模式, 五、MQ基础, 5.1 异步调用, 5.2 技术选型, 5.3 RabbitMQ, 5.3.1 安装, 5.3.2 Spring AMQP, 5.3.2.1 WorkQueues模型, 5.3.2.2 交换机, 5.3.2.3 Fanout 交换机, 5.3.2.4 Direct 交换机, 5.3.2.5 Topic交换机, 5.3.2.6 声明队列和交换机, 5.3.2.7 消息转换器, 5.3.2.8 订单业务, 六、 MQ高级, 1.发送者的可靠性, 1.1 发送者重连, 1.2 发送者确认, 开启生产者确认, ReturnCallback, ConfirmCallback, 2. MQ的可靠性, 2.1 数据持久化, 2.2 Lazy Queue, 控制台配置Lazy模式, 代码配置Lazy模式, 更新已有队列为Lazy模式, 3. 消费者可靠性, 3.1 消费者确认机制, 3.2 失败重试机制, 3.3 失败处理机制, 3.4 业务幂等性, 3.4.1 唯一消息id（白雪）, 3.4.2 业务判断, 3.5 兜底方案, 4. 延迟消息, 4.1 死信交换机（白雪）, 4.2 DelayExchage插件, 声明延迟交换机, 发送延迟消息, 5.超时取消订单, 七、Elasticsearch 01, 1.安装, 1.1 安装elasticsearch, 2. 倒排索引, 正向和倒排, 3. IK 分词器, 3.1 安装, 3.2 使用, 3.3 拓展词典, 4. 基本概览, 索引和映射, MySQL与elasticsearch, 5. 索引库的操作, 5.1 Mapping映射属性, 5.2 索引的CRUD, 创建索引库和映射, 查询, 修改索引库, 删除, 总结, 6. 文档操作, 新增, 查询, 删除, 修改, 局部修改, 7. 批处理, 8. JavaRestClient, 8.1 导入客户端, 8.1.1 编写简单测试类, 8.2 索引库操作, 8.3 文档操作, 新增, 查询, 删除, 更新, 批处理, 完整代码, 八. Elasticsearch 02, 8.1 DSL查询, 1. 入门, 2. 叶子查询, 2.1 全文检索查询, 2.2 精确查询, range范围查询, 3. 复合查询, 3.1 bool查询, 例如：, 4. 排序, 5. 分页, 深度分页, 6. 高亮显示, 8.2 RestClient 查询, 1. 查询所有, 2. 构建条件查询, 全文检索查询, 精确查询, 布尔查询, 3. 排序和分页, 4. 高亮显示, 8.3 数据聚合, 1. DSL聚合, Bucket聚合, 带条件的聚合, Metric聚合, 2. RestClient聚合, 九、面试部分跌跌撞撞终于来到这里我会记得这一天知不可乎骤得托遗响于悲风苏轼赤壁赋引用站外地址飞书详细文档黑马程序员引用站外地址黑马商城一前置课程项目启动导入起步依赖自义定继承提供的接口并且指定实体类泛型常用注解约定大于配置用来指定表名用来指定表中主键字段信息用来指定表中的普通字段信息使用注解的常见场景成员变量名与数据库字段名不一致成员变量名以开头且是布尔值成员变量名与数据库关键字冲突成员变量不是数据库字段常见配置别名扫描包文件地址默认值是否开启下划线和驼峰的映射是否开启二级缓存为雪花算法生成更新策略只更新非空字段核心功能模糊查询查询名字中带的等构建查询条件查询条件更新更新用户名为的的余额为元要更新的数据更新的条件执行更新条件更新更新为的用户余额扣自定义我们可以利用的来构建复杂的条件然后自己定义语句中剩下的部分基于构建条件在方法参数中用注解声明变量名称必须是自定义并且使用条件接口自定义去继承要指定实体泛型自定义去继承要指定泛型和实体泛型风格接口后端传给前端要定义前端传给后端定义这里有一个我之前没有注意的点要转为可以使用工具包进行拷贝原始实体目标实体逻辑删除枚举处理器在枚举类的值上添加注解配置全局枚举处理器类型处理器首先定义一个单独的实体然后将类的字段修改为类型并声明类型处理器在类上开启自动映射这里设置是因为对于这种类中再嵌套一个自定义类的是需要手动在中定义相关字段等或者像这样开启自动映射分页插件在未引入分页插件的情况下是不支持分页功能的和中的分页方法都无法正常起效所以我们必须配置分页插件新建初始化核心插件添加分页插件编写分页查询的测试分页查询的两个参数分别是页码每页大小总条数总页数数据也可以支持排序根据排序是降序分页参数排序参数通过来指定通用分页查询案例定义一个统一的分页查询条件的实体包含分页排序参数过滤条件分页查询实体页码页码排序字段是否升序然后让我们需要分页的实体去继承分页实体根据子类自身的字段值和从父类继承的字段值来生成当两个子类对象比较时只有子类对象的本身的字段值和继承父类的字段值都相同方法的返回值是用于自动生成和方法并且在比较时调用父类的和方法用户查询条件实体用户名关键字用户状态正常冻结余额最小值余额最大值新建统一返回结果集分页结果总条数总页数集合分页查询代码示例构建条件分页条件排序条件默认按照更新时间排序查询数据非空校验无数据返回空结果有数据转换封装返回将分页条件封装在工具类中页码页码排序字段是否升序分页条件排序条件先看前端有没有传排序字段再看有没有手动指定排序字段返回空分页结果的分页结果目标类型原始类型的分页对象将分页结果转为分页结果的分页结果目标类型的字节码目标类型原始类型的分页对象非空校验无数据返回空结果数据转换封装返回将分页结果转为分页结果允许用户自定义到的转换方式的分页结果到的转换函数目标类型原始类型的分页对象非空校验无数据返回空结果数据转换封装返回业务层代码可简化为构建条件查询封装返回拷贝属性到用户名脱敏安装问题解决配置网络时显示被已拔出问题在电脑服务中开启和即可解决镜像问题操她奶奶的你妹的傻鸟用老师安装的方式一直不成功最终在评论区找到答案无法安装建议直接这条命令一次性全安装完毕安装常见命令命令说明文档地址查看本地镜像删除本地镜像创建并运行容器不能重复创建停止指定容器启动指定容器重新启动容器删除指定容器查看容器查看容器运行日志进入容器保存镜像到本地压缩文件加载本地压缩文件到镜像查看容器详细信息如何把镜像交给运维人员使用形成本地压缩包运维人员再使用将本地这个压缩包进行解压将镜像推送到镜像仓库运维人员再从镜像仓库进行拉取数据卷容器是隔离环境容器内程序的文件配置运行时产生的容器都在容器内部我们要读写容器内的文件非常不方便大家思考几个问题如果要升级版本需要销毁旧容器那么数据岂不是跟着被销毁了容器运行后如果我要修改其中的某些配置该怎么办我想要让代理我的静态资源怎么办因此容器提供程序的运行环境但是程序运行产生的数据程序运行依赖的配置都应该与容器解耦什么是数据卷数据卷是一个虚拟目录是容器内目录与宿主机目录之间映射的桥梁其实类似于双向绑定修改数据卷里面的内容实际的的内容也会修改以为例我们知道中有两个关键的目录放置一些静态资源放置配置文件如果我们要让代理我们的静态资源最好是放到目录如果我们要修改的配置最好是找到下的文件但遗憾的是容器运行的所有的文件都在容器内部所以我们必须利用数据卷将两个目录与宿主机目录关联方便我们操作如图在上图中我们创建了两个数据卷容器内部的目录和目录分别与两个数据卷关联而数据卷和分别指向了宿主机的目录和目录这样以来容器内的和目录就与宿主机的和目录关联起来我们称为挂载此时我们操作宿主机的就是在操作容器内的目录只要我们将静态资源放入宿主机对应目录就可以被代理了数据卷的命令命令说明文档地址创建数据卷查看所有数据卷删除指定数据卷查看某个数据卷的详情清除数据卷注意容器与数据卷的挂载要在创建容器时配置对于创建好的容器是不能设置数据卷的而且创建容器的过程中数据卷会自动创建如何挂载数据卷在创建容器时利用数据卷名容器内目录完成挂载容器创建时如果发现挂载的数据卷不存在时会自动创建创建数据卷哇神奇这是的默认存储位置所有命名卷都会存放在卷名下对应的宿主机目录是虚拟目录容器内的对应目录容器的数据挂载发现有默认的数据挂载但是默认匿名挂载名字复杂目录太深了下面给他修改到挂载到根目录注意文件必须要有创建数据库的命令不然无法创建成功数据库然后将文件放在文件夹里面运行即可自定义镜像镜像就是包含了应用程序程序运行的系统函数库运行配置等文件的文件包构建镜像的过程其实就是把上述文件打包的过程由于制作镜像的过程中需要逐层处理和打包比较复杂所以就提供了自动打包镜像的功能我们只需要将打包的过程每一层要做的事情用固定的语法写下来交给去执行即可而这种记录镜像结构的文件就称为指令说明示例指定基础镜像设置环境变量可在后面指令使用拷贝本地文件到镜像的指定目录执行的命令一般是安装过程的命令指定容器运行时监听的端口是给镜像使用者看的镜像中应用的启动命令容器运行时调用网络容器的网络其实是一个虚拟的其值并不固定与某一个容器绑定如果我们在开发时写死某个而在部署时很可能容器的会发生变化连接会失败所以我们必须借助于的网络功能来解决这个问题常见命令命令说明文档地址创建一个网络查看所有网络删除指定网络清除未使用的网络使指定容器连接加入某网络使指定容器连接离开某网络查看网络详细信息使用打包项目为例老东西终于把焚决交出来了后端打包准备容器并且创建数据库以及表结构上面在本地目录挂载时已经完成准备应用镜像部署容器运行测试修改项目的配置文件修改数据库服务地址及日志文件存放地址打包编写文件构建镜像部署容器具体步骤打开将中数据库连接部分改为中的在中的中的中点击等待成功然后我们的文件夹中会出现我们的包了包名字很长可以适当重命名新建使用作为基础镜像添加到镜像中设置环境变量配置阿里云你的你的统一编码创建应用目录复制应用文件到容器暴露端口运行命令在下新建文件夹里面上传进去我们的然后去构建镜像取名字为版本在当前文件夹里部署容器使用查看后端启动日志这样我们的项目就启动成功了使用发送请求也能正常输出结果前端项目部署创建一个新的容器将资料中提供的前端项目的静态资源部署到中在文件夹下创建一个新文件夹用于映射名字叫然后配置挂载然后访问未开启需要开启一下服务安装若未安装同步阿里云时间服务器北京时间解决因为时间和系统系统不符导致的时区不同步问题老东西把异火也交出来了通过一个单独的模板文件格式来定义一组相关联的应用容器帮助我们实现多个相互关联的容器的快速部署现在我们使用来重新构建项目准备资源服务端的包前端项目打包文件准备配置文件基于快速构建项目根据定义的路径在文件夹下新建空文件夹然后将以下文件存放在文件夹中其中和都是可选参数比较常见的有类型参数或指令说明指定文件的路径和名称指定名称就是当前文件中设置的多个的集合是逻辑概念创建并启动所有容器停止并移除所有容器网络列出所有启动的容器查看指定容器的日志停止容器启动容器重启容器查看运行的进程在指定的运行中容器中执行命令创建容器开始停止容器心心念念的终于结束了二微服务导入后端项目导入后端项目启动项目时报了错误看弹幕说时因为版本与高版本冲突导致的反射问题配置即可解决解决时区不同步问题年月日星期一年月日星期一时分秒秒一月月月月月月月月月月年月日星期二单体架构与微服务单体架构将业务的所有功能集中在一个项目中开发打成一个包部署优点架构简单部署成本低缺点团队协作成本高系统发布效率低系统可用性差微服务架构是服务化思想指导下的一套最佳实践架构方案服务化就是把单体架构中的功能模块拆分为多个独立项目微服务拆分原则什么时候需要拆分微服务如果是创业型公司最好先用单体架构快速迭代开发验证市场运作模型快速试错当业务跑通以后随着业务规模扩大人员规模增加再考虑拆分微服务如果是大型企业有充足的资源可以在项目开始之初就搭建微服务架构如何拆分首先要做到高内聚低耦合从拆分方式来说有横向拆分和纵向拆分两种纵向就是按照业务功能模块横向则是拆分通用性业务提高复用性服务拆分之后不可避免的会出现跨微服务的业务此时微服务之间就需要进行远程调用微服务之间的远程调用被称为即远程过程调用的实现方式有很多比如基于协议基于协议我们使用的是方式这种方式不关心服务提供者的具体技术实现只要对外暴露接口即可更符合微服务的需要远程调用在拆分的时候我们发现一个问题就是购物车业务中需要查询商品信息但商品信息查询的逻辑全部迁移到了服务导致我们无法查询最终结果就是查询到的购物车数据不完整因此要想解决这个问题我们就必须改造其中的代码把原本本地方法调用改造成跨微服务的远程调用即因此现在查询购物车列表的流程变成了这样那么问题来了我们该如何跨服务调用准确的说如何在中获取服务中的提供的商品数据呢答案是肯定的我们前端向服务端查询数据其实就是从浏览器远程查询服务端数据比如我们刚才通过测试商品查询接口就是向这个接口发起的请求而这种查询就是通过请求的方式来完成的不仅仅可以实现远程查询还可以实现新增删除等各种远程请求那么我们该如何用代码发送的请求呢发送请求可以使用提供的使用的基本步骤如下注册到容器调用的发送请求常见方法有发送请求并返回指定类型对象发送请求并返回指定类型对象发送请求发送请求发送任意类型请求返回感觉这种如果有大量用户同时请求不会变的很卡吗构造器注入构造器注入推荐我们使用构造器注入而不是使用因此我们可以在类上添加注解使用注入类注册中心在微服务远程调用的过程中包括两个角色服务提供者提供接口供其它微服务访问比如服务消费者调用其它微服务提供的接口比如服务者可以是消费者消费者也可以是服务者在大型微服务项目中服务提供者的数量会非常多为了管理这些服务就引入了注册中心的概念注册中心服务提供者服务消费者三者间关系如下流程如下服务启动时就会注册自己的服务信息服务名端口到注册中心调用者可以从注册中心订阅想要的服务获取服务对应的实例列表个服务可能多实例部署调用者自己对实例列表负载均衡挑选一个实例调用者向该实例发起远程调用当服务提供者的实例宕机或者启动新实例时调用者如何得知呢服务提供者会定期向注册中心发送请求报告自己的健康状态心跳请求当注册中心长时间收不到提供者的心跳时会认为该实例宕机将其从服务的实例列表中剔除注册中心一旦认为某个实例宕机并将其剔除实例列表那么其他服务的调用者就无法再调用这个实例当服务有新实例启动时会发送注册服务请求其信息会被记录在注册中心的服务实例列表当注册中心服务列表变更时会主动通知微服务更新本地服务列表注册中心访问路径哇神奇将来可以根据服务名称去注册中心中去拉取实例列表会使用负载均衡自动获取一个实例我们在中引入了负载均衡的依赖了然后定义请求路径为连接池连接池指的是一组预先创建的连接这些连接可以被重复使用而不是每次请求都创建一个新的连接在中不同的客户端实现对连接池的支持有所不同这是的默认客户端实现不支持连接池每次请求都会创建一个新的连接请求完成后连接会被关闭这种方式在高并发场景下性能较差这是一个功能强大的客户端库支持连接池通过配置连接池可以复用连接提高性能这是另一个流行的客户端库也支持连接池的连接池实现高效且易于配置适合在高并发场景下使用对请求做了优雅的伪装不过其底层发起请求依赖于其它的框架这些框架可以自己选择包括以下三种默认实现不支持连接池支持连接池支持连接池具体源码可以参考类中的成员变量因此我们通常会使用带有连接池的客户端来代替默认的比如我们使用在的中引入依赖的依赖在的配置文件中开启的连接池功能开启功能最佳实践方案抽取更加简单工程结构也比较清晰但缺点是整个项目耦合度偏高方案抽取相对麻烦工程结构相对更复杂但服务之间耦合度降低这个注解中包含了这个注解会扫描当前包中的文件而由于被抽离到模块包下两者包的位置不同所以扫描不到那么解决方法有扩大扫描包的范围那么在启动类上添加但此方法不推荐使用注解就包含了注解由第三方依赖提供的注解选项可以简化我们的操作不需要自己使用日志输出只会在所在包的日志级别为时才会输出日志而且其日志级别有级不记录任何日志信息这是默认值仅记录请求的方法以及响应状态码和执行时间在的基础上额外记录了请求和响应的头信息记录所有请求和响应的明细包括头信息请求体元数据默认的日志级别就是所以默认我们看不到请求日志一般也不开启的日志配置只有在需要调试的时候才开启日志因为日志输出的内容有很多输出时会影响性能定义日志级别在模块下新建一个配置类定义的日志级别接下来要让日志级别生效还需要配置这个类有两种方式局部生效在某个中配置只对当前生效全局生效在中配置针对所有生效三微服务由于每个微服务都有不同的地址或端口入口不同相信大家在与前端联调的时候发现了一些问题请求不同数据时要访问不同的入口需要维护多个入口地址麻烦前端无法调用无法实时更新服务列表单体架构时我们只需要完成一次用户登录身份校验就可以在所有业务中获取到用户信息而微服务拆分后每个微服务都独立部署这就存在一些问题每个微服务都需要编写登录校验用户信息获取的功能吗当微服务之间调用时该如何传递用户信息不要着急这些问题都可以在今天的学习中找到答案我们会通过网关技术解决上述问题今天的内容会分为章第一章网关路由解决前端请求入口的问题第二章网关鉴权解决统一登录校验和用户信息获取的问题第三章统一配置管理解决微服务的配置文件重复和配置热更新问题通过今天的学习你将掌握下列能力会利用微服务网关做请求路由会利用微服务网关做登录身份校验会利用实现统一配置管理会利用实现配置热更新网关路由网关就是网络的关口数据在网络间传输从一个网络传输到另一网络时就需要经过网关来做数据的路由和转发以及数据安全的校验更通俗的来讲网关就像是以前园区传达室的大爷外面的人要想进入园区必须经过大爷的认可如果你是不怀好意的人肯定被直接拦截外面的人要传话或送信要找大爷大爷帮你带给目标人现在微服务网关就起到同样的作用前端请求不能直接访问微服务而是要请求网关网关可以做安全控制也就是登录身份校验校验通过才放行通过认证后网关再根据请求判断应该访问哪个微服务将请求转发过去路由网关的基本构件它由一个一个目的地一个断言集合和一个过滤器集合定义如果断言为真则路由被匹配网关也相当于一个微服务其会注册到并拉取所有的服务信息所以要获取某个微服务对网关来说不是难事迷迷糊糊说这么多还是不知道网关是什么前端发送的请求先发给网关网关进行校验完毕之后使用负载均衡请求到具体的微服务中前端只要知道网关地址即可前端所有请求地址都为那么就会到达网关然后网关会根据前端的请求来去判断应该由哪个微服务来处理判断过程就是请求的路由然后网关就会帮你的请求转发到具体的微服务路由转发网关可以利用注册中心所有的微服务接口都存放在了注册中心拉取所有的服务中心网关来负责身份校验这样转发就不用在此校验了网关快速入门网关也相当于一个微服务其会注册到并拉取所有的服务信息所以要获取某个微服务对网关来说不是难事接下来在模块的目录新建一个文件内容如下路由规则自定义唯一路由的目标服务代表负载均衡会从注册中心拉取服务列表路由断言判断当前请求是否符合当前规则符合则路由到目标服务这里是以请求路径作为判断规则路由属性网关路由对应的类型是其中常见的属性有路由唯一标示路由目标地址路由断言判断请求是否符合当前路由路由过滤器对请求或响应做特殊处理路由断言名称说明示例是某个时间点后的请求是某个时间点之前的请求是某两个时间点之前的请求请求必须包含某些请求必须包含某些请求必须是访问某个域名请求方式必须是指定方式请求路径必须符合指定规则请求参数必须包含指定参数或者请求者的必须是指定范围权重处理路由过滤器名称说明示例给当前请求添加一个请求头移除请求中的一个请求头给响应结果中添加一个响应头从响应结果中移除有一个响应头请求路径重写去除请求路径中的段前缀则路径转发时只保留网关登录单体架构时我们只需要完成一次用户登录身份校验就可以在所有业务中获取到用户信息而微服务拆分后每个微服务都独立部署不再共享数据也就意味着每个微服务都需要做登录校验这显然不可取我们的登录是基于来实现的校验的算法复杂而且需要用到秘钥如果每个微服务都去做登录校验这就存在着两大问题每个微服务都需要知道的秘钥不安全每个微服务重复编写登录校验代码权限校验代码麻烦既然网关是所有微服务的入口一切请求都需要先经过网关我们完全可以把登录校验的工作放到网关去做这样之前说的问题就解决了只需要在网关和用户服务保存秘钥只需要在网关开发登录校验功能此时登录校验的流程如图不过这里存在几个问题网关路由是配置的请求转发是内部代码我们如何在转发之前做登录校验网关校验之后如何将用户信息传递给微服务微服务之间也会相互调用这种调用不经过网关又该如何传递用户信息网关过滤器登录校验必须在请求转发到微服务之前做否则就失去了意义而网关的请求转发是内部代码实现的要想在请求转发之前做登录校验就必须了解内部工作的基本原理网关内部是没有业务逻辑的他的任务是基于我们配的路由规则然后判断一下前端请求到底该由哪个微服务处理然后将请求转发到对应的微服务而进行路由判断的功能就是由一个叫的接口来处理的的默认实现是路由断言根据请求找到匹配的路由并存入上下文然后把请求交给处理默认实现是顾名思义是一个过滤器处理器它会加载网关中配置的多个过滤器放入集合并排序形成过滤器链然后依次执行这些过滤器而整个过滤链的最后要执行负责将请求转发到微服务当微服务返回结果后存入上下文接着依次传递给其他过滤器最终返回给用户过滤器内部可以包含两部分逻辑分别是和分别会在请求路由到微服务之前和之后执行当所有的逻辑都依次顺序执行通过后请求才会被路由到微服务否则会被拦截后续过滤器不再执行微服务返回结果后再倒序执行的逻辑如果我们能够定义一个过滤器在其中实现登录校验逻辑并且将过滤器执行顺序定义到之前这就符合我们的需求了可以将用户信息保存在请求头中然后传递给微服务然后微服务在从请求头中取出用户信息自定义过滤器网关过滤器链中的过滤器有两种路由过滤器作用范围比较灵活可以是任意指定的路由配置的过滤器有种默认不生效配置到哪一个路由下之后就对配置的路由生效配置到之后就会对所有路由生效这样就不必在所有的路由中配置类但是所属类别依旧是全局过滤器作用范围是所有路由不可配置实现登录校验获取判断是否不需要拦截无需拦截直接放行获取请求头中的校验并解析如果无效拦截如果有效传递用户信息放行对于虽然它是框架的一部分但它并不是由管理的是一个工具类用于匹配风格的路径模式它没有定义为的因此容器不知道如何自动注入它为什么需要手动创建实例工具类是一个工具类通常不需要管理其生命周期工具类是无状态的可以在任何地方实例化和使用非单例由于是无状态的它不需要作为单例管理每次使用时创建一个新的实例是安全的不会导致资源浪费或状态不一致的问题简单性手动创建实例非常简单只需要使用关键字即可这种方式代码清晰易于理解网关传递用户现在网关已经可以完成登录校验并获取登录用户身份信息但是当网关将请求转发到微服务时微服务又该如何获取用户身份呢由于网关发送请求到微服务依然采用的是请求因此我们可以将用户信息以请求头的方式传递到下游微服务然后微服务可以从请求头中获取登录用户信息考虑到微服务内部可能很多地方都需要用到登录用户信息因此我们可以利用的拦截器来实现登录用户信息获取并存入方便后续使用据图流程图如下因此接下来我们要做的事情有改造网关过滤器在获取用户信息后保存到请求头转发到下游微服务编写微服务拦截器拦截请求获取用户信息保存到后放行保存用户到请求头首先我们修改登录校验拦截器的处理逻辑保存用户信息到请求头中修改如果有效传递用户信息方法可以对下游请求做更改表示对请求做处理利用可以对请求中各种信息做修改放行拦截器先通过解析出再将其放入请求头后续的可以直接从请求头中获取无需再次解析提高效率拦截器获取用户需求由于每个微服务都可能有获取登录用户的需求因此我们直接在模块定义拦截器这样微服务只需要引入依赖即可生效无需重复编写获取请求头中的用户信息判断是否为空不为空保存到放行移除用户这里只是写了一个拦截器类但是并没有注册到拦截器里要想注册进去需要进行配置编写配置类将其进去当请求从驱动进入下游微服务时不会被直接传递而是自动被底层协议转换为标准的和通过线程池复用线程并且不是每次使用都会覆盖信息所以有必要在一次请求完成后清理信息拦截器生命周期等如有特殊情况处理如果请求在返回拦截请求不会执行但仍会触发行为配置拦截器拦截器需要配置进行配置才能生效通过将一个名为的拦截器添加到拦截器注册表中这样自定义的拦截器才会生效添加的原因因为中也引用了模块而我们知道使用的虽然也处理请求但是底层不是靠实现的而现在设计了只要引用这个包就会自动装配配置类然而底层没有自然无法自动装配配置类会报错所以我们需要设计成只有依赖了的微服务模块才自动装配而的核心类就是所以只有有这个类的微服务模块才会自动装配配置类是中的一个条件注解它用于在特定类存在于类路径上时才启用配置因此特定的类就是只要再中加入就会存在类是的核心组件之一通常用于处理请求如果存在说明当前项目中使用了会加载配置类除了外底层都是那要想不让网关得到这个配置那就要利用的特点去排除它都有一个的当我们配置了扫描时其他的微服务就会使用这个拦截器配置的内容但是网关也使用了这个配置类网关没有的内容因此会报错添加扫描不过需要注意的是这个配置类默认是不会生效的因为它所在的包是与其它微服务的扫描包不一致无法被扫描到因此无法生效基于的自动装配原理我们要将其添加到目录下的文件中依赖虽然被引入但默认扫描启动类所在的包及其子包这里没在对应的扫描范围内所有没有注册可以添加包范围在对应模块通过文件将对应配置类的全限定名写进去利用自动配置原理其他微服务引入对应模块依赖在启动后会进行注册同样也还可以用导入对应的组件或配置类可以基于的自动装配机制自动发现并装配配置类简单来说就是所有微服务都无法扫描到这个拦截器我们可以给每一个微服务的启动类加上指定扫描这个拦截器但是微服务数量庞大显然不是个好办法利用的自动装配原理就简单的多结果这样我们请求单个购物车就查询不到用户信息了传递用户请求从网关到交易时会被拦截将存入当这个请求执行完之后会清除故当交易发请求到商品时是没有的前端发起的请求都会经过网关再到微服务由于我们之前编写的过滤器和拦截器功能微服务可以轻松获取登录用户信息但有些业务是比较复杂的请求到达微服务后还需要调用其它多个微服务比如下单业务流程如下下单的过程中需要调用商品服务扣减库存调用购物车服务清理用户购物车而清理购物车时必须知道当前登录的用户身份但是订单服务调用购物车时并没有传递用户信息购物车服务无法知道当前用户是谁由于微服务获取用户信息是通过拦截器在请求头中读取因此要想实现微服务之间的用户信息传递就必须在微服务发起调用时把用户信息存入请求头仅限单线程内用于存储线程级别的上下文如用户身份事务其生命周期与线程绑定无法跨进程或跨服务传递微服务间通信本质是跨进程的分布式调用服务可能部署在不同物理节点无法穿透网络边界无法在服务的线程中直接访问服务的线程数据服务调用即跨进程的服务调用而只仅限于当前服务内部的范围所以无法使用但网关那里刚开始不是已经通过过滤器进行了存入请求头中吗为什么后续微服务调用服务时需要再次将存入请求头才能传递用户信息呢那是因为协议无状态每个请求默认不携带上一个请求的上下文直接理解成每次发送的都是一个新的请求所以需要我们自己给该请求做标识最后记住拦截器组合是实现微服务间身份透传的标准模式拦截器是属于微服务的过滤器是属于网关的拦截器从请求头获取并保存在中过滤器解析并保存在请求头中微服务之间调用是基于来实现的并不是我们自己发送的请求我们如何才能让每一个由发起的请求自动携带登录用户信息呢这里要借助中提供的一个拦截器接口不放在中因为不是所有模块都需要例如网关微服务就不需要其实就是拦截下来的转发请求然后再请求头中添加上字段后放行将用户信息添加请求头微服务调用微服务的请求是从网关传过来的所以这时请求头中是有用户信息的只需要从请求头中获取到用户信息添加到请求头中即可如何请求再次传递给下一个微服务这样就将用户信息传递给了其他微服务了配置管理到目前为止我们已经解决了微服务相关的几个问题微服务远程调用微服务注册发现微服务请求路由负载均衡微服务登录用户信息传递不过现在依然还有几个问题需要解决网关路由在配置文件中写死了如果变更必须重启微服务某些业务配置在配置文件中写死了每次修改都要重启服务每个微服务都有很多重复的配置维护成本高这些问题都可以通过统一的配置管理器服务解决而不仅仅具备注册中心功能也具备配置管理的功能微服务共享的配置可以统一交给保存和管理在控制台修改配置后会将配置变更推送给相关的微服务并且无需重启即可生效实现配置热更新网关的路由同样是配置因此同样可以基于这个功能实现动态路由功能无需重启网关即可修改路由配置配置共享我们可以把微服务共享的配置抽取到中统一管理这样就不需要每个微服务都重复配置了分为两步在中添加共享配置微服务拉取配置添加共享配置以为例我们看看有哪些配置是重复的可以抽取的首先是相关配置然后是日志配置然后是以及的配置我们在控制台分别添加这些配置首先是相关配置在配置管理配置列表中点击新建一个配置在弹出的表单中填写信息其中详细的配置如下注意这里的的相关参数并没有写死例如数据库通过配置了默认值为同时允许通过来覆盖默认值数据库端口通过配置了默认值为同时允许通过来覆盖默认值数据库可以通过来设定无默认值然后是统一的日志配置命名为配置内容如下然后是统一的配置命名为配置内容如下黑马商城接口文档黑马商城接口文档虎哥注意这里的相关配置我们没有写死例如接口文档标题我们用了来代替将来可以有用户手动指定联系人邮箱我们用了默认值是同时允许用户利用来覆盖拉取接下来我们要在微服务拉取共享配置将拉取到的共享配置与本地的配置合并完成项目上下文的初始化不过需要注意的是读取配置是上下文初始化时处理的发生在项目的引导阶段然后才会初始化上下文去读取也就是说引导阶段文件尚未读取根本不知道地址该如何去加载中的配置文件呢在初始化上下文的时候会先读取一个名为或者的文件如果我们将地址配置到中那么在项目引导阶段就可以读取中的配置了因此微服务整合配置管理的步骤如下引入依赖在模块引入依赖配置管理读取文件新建在中的目录新建一个文件内容如下服务名称地址文件后缀名共享配置共享配置共享日志配置共享日志配置修改由于一些配置挪到了因此需要修改为开启连接池支持购物车服务接口文档重启服务发现所有配置都生效了配置热更新有很多的业务相关参数将来可能会根据实际情况临时调整例如购物车业务购物车数量有一个上限默认是对应代码如下现在这里购物车是写死的固定值我们应该将其配置在配置文件中方便后期修改但现在的问题是即便写在配置文件中修改了配置还是需要重新打包重启服务才能生效能不能不用重启直接生效呢这就要用到的配置热更新能力了分为两步在中添加配置在微服务读取配置文件名称由三部分组成服务名我们是购物车服务所以是就是中的可以省略则所有共享该配置后缀名例如这里我们直接使用这个名称则不管是还是环境都可以共享该配置配置内容如下购物车商品数量上限接着我们在微服务中读取配置实现配置热更新在中新建一个属性读取类代码如下接着在业务中使用该属性加载类测试向购物车中添加多个商品我们在控制台将购物车上限配置为无需重启再次测试购物车功能加入成功无需重启服务配置热更新就生效了动态路由网关的路由配置全部是在项目启动时由在项目启动的时候加载并且一经加载就会缓存到内存中的路由表内一个不会改变也不会监听路由变更所以我们无法利用上节课学习的配置热更新来实现路由更新因此我们必须监听的配置变更然后手动把最新的路由更新到路由表中这里有两个难点如何监听配置变更如何把路由信息更新到路由表四微服务在微服务远程调用的过程中还存在几个问题需要解决首先是业务健壮性问题例如在之前的查询购物车列表业务中购物车服务需要查询最新的商品信息与购物车数据做对比提醒用户大家设想一下如果商品服务查询时发生故障查询购物车列表在调用商品服务时是不是也会异常从而导致购物车查询失败但从业务角度来说为了提升用户体验即便是商品查询失败购物车列表也应该正确展示出来哪怕是不包含最新的商品信息还有级联失败问题还是查询购物车的业务假如商品服务业务并发较高占用过多连接可能会导致商品服务的所有接口响应时间增加延迟变高甚至是长时间阻塞直至查询失败此时查询购物车业务需要查询并等待商品查询结果从而导致查询购物车列表业务的响应时间也变长甚至也阻塞直至无法访问而此时如果查询购物车的请求较多可能导致购物车服务的连接占用较多所有接口的响应时间都会增加整个服务性能很差甚至不可用依次类推整个微服务群中与购物车服务商品服务等有调用关系的服务可能都会出现问题最终导致整个集群不可用这就是级联失败问题或者叫雪崩问题级联失败是指一个系统中的局部故障引发连锁反应导致其他部分相继失效最终造成更大范围甚至整个系统崩溃的现象还有跨服务的事务问题比如昨天讲到过的下单业务下单的过程中需要调用多个微服务商品服务扣减库存订单服务保存订单购物车服务清理购物车这些业务全部都是数据库的写操作我们必须确保所有操作的同时成功或失败但是这些操作在不同微服务也就是不同的这样的情况如何确保事务特性呢雪崩问题雪崩问题产生的原因微服务相互调用服务提供者出现故障或阻塞服务调用者没有做好异常处理导致自身故障调用链中的所有服务级联失败导致整个集群故障如何避免雪崩尽量避免服务出现故障或阻塞保证代码的健壮性保证网络畅通能应对较高的并发请求服务调用者做好远程调用异常的后备方案避免故障扩散微服务保护服务保护方案微服务保护的方案有很多比如请求限流线程隔离服务熔断这些方案或多或少都会导致服务的体验上略有下降比如请求限流降低了并发上限线程隔离降低了可用资源数量服务熔断降低了服务的完整度部分服务变的不可用或弱可用因此这些方案都属于服务降级的方案但通过这些方案服务的健壮性得到了提升请求限流服务故障最重要原因就是并发太高解决了这个问题就能避免大部分故障当然接口的并发不是一直很高而是突发的因此请求限流就是限制或控制接口访问的并发流量避免服务因流量激增而出现故障请求限流往往会有一个限流器数量高低起伏的并发请求曲线经过限流器就变的非常平稳这就像是水电站的大坝起到蓄水的作用可以通过开关控制水流出的大小让下游水流始终维持在一个平稳的量线程隔离当一个业务接口响应时间长而且并发高时就可能耗尽服务器的线程资源导致服务内的其它接口受到影响所以我们必须把这种影响降低或者缩减影响的范围线程隔离正是解决这个问题的好办法线程隔离的思想来自轮船的舱壁模式轮船的船舱会被隔板分割为个相互隔离的密闭舱假如轮船触礁进水只有损坏的部分密闭舱会进水而其他舱由于相互隔离并不会进水这样就把进水控制在部分船体避免了整个船舱进水而沉没为了避免某个接口故障或压力过大导致整个服务不可用我们可以限定每个接口可以使用的资源范围也就是将其隔离起来如图所示我们给查询购物车业务限定可用线程数量上限为这样即便查询购物车的请求因为查询商品服务而出现故障也不会导致服务器的线程资源被耗尽不会影响到其它接口服务熔断线程隔离虽然避免了雪崩问题但故障服务商品服务依然会拖慢购物车服务服务调用方的接口响应速度而且商品查询的故障依然会导致查询购物车功能出现故障购物车业务也变的不可用了所以我们要做两件事情编写服务降级逻辑就是服务调用失败后的处理逻辑根据业务场景可以抛出异常也可以返回友好提示或默认数据异常统计和熔断统计服务提供方的异常比例当比例过高表明该接口会影响到其它服务应该拒绝调用该接口而是直接走降级逻辑这里服务提供方就是商品服务异常比例过高意思就是说如果过往记录中发现调用商品服务有次失败而熔断决策这里是当失败率超过阈值如购物车服务调用方的熔断器会拒绝后续请求不再真正调用商品服务避免资源浪费直接走降级逻辑返回缓存数据默认值或友好提示熔断恢复经过一段时间如秒熔断器尝试放行一个请求探测商品服务是否恢复若成功则逐步关闭熔断引用站外地址包下载微服务保护的技术有很多但在目前国内使用较多的还是所以接下来我们学习的使用是阿里巴巴开源的一款服务保护框架目前已经加入中的使用可以分为两个部分核心库包不依赖任何框架库能够运行于及以上的版本的运行时环境同时对等框架也有较好的支持在项目中引入依赖即可实现服务限流隔离熔断等功能控制台主要负责管理推送规则监控管理机器信息等安装安装下载包运行访问页面就可以看到的控制台了需要输入账号和密码默认都是登录后即可看到控制台默认会监控服务本身运行然后运行触发限流或熔断后的请求不一定要直接报错也可以返回一些默认数据或者友好提示用户体验会更好给编写失败后的降级逻辑有两种方式方式一无法对远程调用的异常做处理方式二可以对远程调用的异常做处理我们一般选择这种方式分布式事务首先我们看看项目中的下单业务整体流程由于订单购物车商品分别在三个不同的微服务而每个微服务都有自己独立的数据库因此下单过程中就会跨多个数据库完成业务而每个微服务都会执行自己的本地事务交易服务下单事务购物车服务清理购物车事务库存服务扣减库存事务整个业务中各个本地事务是有关联的因此每个微服务的本地事务也可以称为分支事务多个有关联的分支事务一起就组成了全局事务我们必须保证整个全局事务同时成功或失败我们知道每一个分支事务就是传统的单体事务都可以满足特性但全局事务跨越多个服务多个数据库是否还能满足呢我们来做一个测试先进入购物车页面目前有个购物车然结算下单进入订单结算页面然后将购物车中某个商品的库存修改为然后提交订单最终因库存不足导致下单失败然后我们去查看购物车列表发现购物车数据依然被清空了并未回滚事务并未遵循的原则归其原因就是参与事务的多个子业务在不同的微服务跨越了不同的数据库虽然每个单独的业务都能在本地遵循但是它们互相之间没有感知不知道有人失败了无法保证最终结果的统一也就无法遵循的事务特性了这就是分布式事务问题出现以下情况之一就可能产生分布式事务问题业务跨多个服务实现业务跨多个数据源实现接下来这一章我们就一起来研究下如何解决分布式事务问题解决分布式事务的方案有很多但实现起来都比较复杂因此我们一般会使用开源的框架来解决分布式事务问题在众多的开源分布式事务框架中功能最完善使用最多的就是阿里巴巴在年开源的了引用站外地址官方文档其实分布式事务产生的一个重要原因就是参与事务的多个分支事务互相无感知不知道彼此的执行状态因此解决分布式事务的思想非常简单就是找一个统一的事务协调者与多个分支事务通信检测每个分支事务的执行状态保证全局事务下的每一个分支事务同时成功或失败即可大多数的分布式事务框架都是基于这个理论来实现的也不例外在的事务管理中有三个重要的角色事务协调者维护全局和分支事务的状态协调全局事务提交或回滚事务管理器定义全局事务的范围开始全局事务提交或回滚全局事务资源管理器管理分支事务与交谈以注册分支事务和报告分支事务的状态并驱动分支事务提交或回滚的工作架构如图所示其中和可以理解为的客户端部分引入到参与事务的微服务依赖中即可将来和就会协助微服务实现本地分支事务与之间交互实现事务的提交或回滚而服务则是事务协调中心是一个独立的微服务需要单独部署三者关系的小例子可以把处理分布式事务的过程类比成组织一次多人协作的搬家任务用生活化场景理解三个角色事务管理器搬家发起人作用决定要不要开始全局事务搬家这件事以及最后成功了提交结果搬完失败了回滚不搬或恢复原样举例你想组织一次搬家先拍板周末要把家里东西搬到新房定义全局事务范围然后通知大家开始干活开启全局事务要是中途发现新房没收拾好你说不搬了东西放回原处回滚全局事务要是一切顺利你确认搬完啦任务结束提交全局事务事务协调者搬家总指挥作用盯着所有分支事务打包搬运拆装家具等环节的状态协调大家一起成功或一起失败举例你请了个指挥他负责盯着打包队有没有把东西包好分支事务状态搬运车有没有把东西运到分支事务状态拆装队有没有把家具装好分支事务状态要是打包队说包一半发现东西太多搞不定指挥就通知所有人别搬了各自恢复原样要是所有人都反馈搞定指挥就告诉大家可以收尾任务完成资源管理器具体干活的小组作用管理自己负责的分支事务比如打包组管打包搬运组管运输随时给汇报进度和状态举例打包组负责把家里东西分类打包打包完了跟指挥说我们包好啦要是打包到一半发现东西坏了也跟指挥说这里搞不定需要回退搬运组负责把打包好的东西运到新房路上车坏了分支事务失败就跟指挥汇报运不了得终止要是顺利运到就说送达成功拆装组负责在新房把家具装好装完汇报装好了装到一半发现零件少了汇报装不了得回退总结流程你发起搬家全局事务指挥协调打包搬运拆装分支事务每个小组干活并汇报状态指挥根据所有人状态决定让大家一起成功搬完或一起回滚不搬恢复你最终确认结果配置这样就使用成功部署了微服务集成导入依赖为了方便各个微服务集成我们需要把配置共享到因此模块不仅仅要引入依赖还要引入依赖统一配置管理读取文件配置首先在上添加一个共享的配置命名为内容如下服务注册中心的配置微服务根据这些信息去注册中心获取服务地址注册中心类型地址默认为空分组默认是服务名称事务组名称事务组与集群的映射关系改造配置内容如下服务名称地址文件后缀名共享配置共享配置共享日志配置共享日志配置共享配置模式面试题规范是组织定义的分布式事务处理标准规范描述了全局的与局部的之间的接口几乎所有主流的关系型数据库都对规范提供了支持的模式如下一阶段的工作注册分支事务到执行分支业务但是不提交报告执行状态到二阶段的工作检测各分支事务执行状态如果成功失败通知提交回滚事务接收指令提交回滚事务具体流程当方法执行时全局事务向注册一个全局事务执行内部业务逻辑调用每一个分支会拦截对的操作会向注册分支事务然后再放行去执行业务的执行完毕后不可以提交当所有方法执行完毕会向发送全局事务结束的信息会检查注册分支的事务状态如果发现都成功了就向所有分支发送提交回滚的指令这些事务才能提交事务释放锁反之下达回滚的命令优缺点模式的优点是什么事务的强一致性满足原则常用数据库都支持实现简单并且没有代码侵入模式的缺点是什么因为一阶段需要锁定数据库资源等待二阶段结束才释放性能较差依赖关系型数据库实现事务回滚日志模式模式同样是分阶段提交的事务模型不过缺弥补了模型中资源锁定周期过长的缺陷阶段一的工作注册分支事务记录数据快照执行业务并提交报告事务状态阶段二提交时的工作删除即可阶段二回滚时的工作根据恢复数据到更新前具体流程全局事务方法开启时会向注册一个全局事务调用所有的分支在操作之前会被拦截会向注册分支事务微服务的执行具体的语句并且立刻提交事务在执行之前先去生成一个修改数据库之前的数据保存一个快照保存在数据表中当执行完毕后回向报告事务状态会向报告事务的状态会检测事务状态都成功会删除快照失败则回滚从数据库中恢复快照那么万一有其他线程这时候修改了数据怎么办呢引用站外地址全局锁防止脏读简述模式与模式最大的区别是什么模式一阶段不提交事务锁定资源模式一阶段直接提交不锁定资源模式依赖数据库机制实现回滚模式利用数据快照实现数据回滚模式强一致模式最终一致快照数据的版本检查在回滚时会检查快照数据的版本是否与当前数据一致如果发现数据已经被其他事务修改会抛出异常阻止回滚操作这种机制可以避免数据被错误覆盖但会导致事务回滚失败需要额外的处理逻辑补偿机制如果回滚失败会尝试通过补偿机制如补偿来恢复数据补偿是根据业务逻辑预先定义的用于在回滚失败时尽可能恢复数据的一致性五基础面试考点来了嘿嘿异步调用异步调用方式其实就是基于消息通知的方式一般包含三个角色消息发送者投递消息的人就是原来的调用方消息管理暂存转发消息你可以把它理解成微信服务器消息接收者接收和处理消息的人就是原来的服务提供方在异步调用中发送者不再直接同步调用接收者的业务接口而是发送一条消息投递给消息然后接收者根据自己的需求从消息那里订阅消息每当发送方发送消息后接受者都能获取消息并处理这样发送消息的人和接收消息的人就完全解耦了还是以余额支付业务为例除了扣减余额更新支付流水单状态以外其它调用逻辑全部取消而是改为发送一条消息到而相关的微服务都可以订阅消息通知一旦消息到达则会分发给每一个订阅了的微服务处理各自的业务假如产品经理提出了新的需求比如要在支付成功后更新用户积分支付代码完全不用变更而仅仅是让积分服务也订阅消息即可不管后期增加了多少消息订阅者作为支付服务来讲执行问扣减余额更新支付流水状态后发送消息即可业务耗时仅仅是这三部分业务耗时仅仅大大提高了业务性能另外不管是交易服务通知服务还是积分服务他们的业务与支付关联度低现在采用了异步调用解除了耦合他们即便执行过程中出现了故障也不会影响到支付服务交易服务通知服务积分服务收到的消息后如果业务代码没有执行成功还会再给服务发消息直到成功执行为止为了使用实现分布式事务不能将发送消息的代码加入到事务中比如像不支持回滚操作的此时可以配合分布式事务中的事务钩子定义一个发送消息的方法每当事务成功的时候就可以发送消息综上异步调用的优势包括耦合度更低性能更好业务拓展性强故障隔离避免级联失败缓存消息流量削峰填谷当然异步通信也并非完美无缺它存在下列缺点完全依赖于的可靠性安全性和性能架构复杂后期维护和调试麻烦技术选型消息目前常见的实现方案就是消息队列简称为目比较常见的实现几种常见的对比公司社区阿里开发语言协议支持自定义协议自定义协议可用性高一般高高单机吞吐量一般差高非常高消息延迟微秒级毫秒级毫秒级毫秒以内消息可靠性高一般高一般追求可用性追求可靠性追求吞吐能力追求消息低延迟据统计目前国内消息队列使用最多的还是再加上其各方面都比较均衡稳定性也好因此我们选择来学习安装然后访问即可看到管理控制台首次访问需要登录默认的用户名和密码在配置文件中已经指定了对应的架构其中包含几个概念生产者也就是发送消息的一方消费者也就是消费消息的一方队列存储消息生产者投递的消息会暂存在消息队列中等待消费者处理交换机负责消息路由生产者发送的消息由交换机决定投递到哪个队列区分计网中的交换机的交换机是用于消息传递的而计网的交换机是用于数据包传输的虚拟主机起到数据隔离的作用每个虚拟主机相互独立有各自的每个虚拟主机相当于一个数据库彼此之间互不影响将来我们开发业务功能的时候肯定不会在控制台收发消息而是应该基于编程的方式由于采用了协议因此它具备跨语言的特性任何语言只要遵循协议收发消息都可以与交互并且官方也提供了各种不同语言的客户端但是官方提供的客户端编码相对复杂一般生产环境下我们更多会结合来使用而的官方刚好基于提供了这样一套消息收发的模板工具并且还基于对其实现了自动装配使用起来非常方便提供了三个功能自动声明队列交换机及其绑定关系设置队列基于注解的监听器模式异步接收消息设置消费端封装了工具用于发送消息设置生产端模型任务模型简单来说就是让多个消费者绑定到一个队列共同消费队列中的消息当消息处理比较耗时的时候可能生产消息的速度会远远大于消息的消费速度长此以往消息就会堆积越来越多无法及时处理此时就可以使用模型多个消费者共同处理消息处理消息处理的速度就能大大提高了交换机可以看到在订阅模型中多了一个角色而且过程略有变化生产者不再发送消息到队列中而是发给交换机交换机一方面接收生产者发送的消息另一方面知道如何处理消息例如递交给某个特别队列递交给所有队列或是将消息丢弃到底如何操作取决于的类型消息队列也与以前一样接收消息缓存消息不过队列一定要与交换机绑定消费者与以前一样订阅队列没有变化交换机只负责转发消息不具备存储消息的能力因此如果没有任何队列与绑定或者没有符合路由规则的队列那么消息会丢失引入的目的是为了在中一个消息能够分发给多个中被不同的消费者服务多次消费比如你一个订单信息需要加积分加经验这下可以分为两个来执行交换机的类型有四种广播将消息交给所有绑定到交换机的队列我们最早在控制台使用的正是交换机订阅基于路由发送给订阅了消息的队列通配符订阅与类似只不过可以使用通配符头匹配基于的消息头匹配用的较少交换机会将接收到的消息路由到每一个跟其绑定的所以也叫广播模式交换机会将接收到的消息根据规则路由到指定的因此称为定向路由每一个都与设置一个发布者发送消息时指定消息的将消息路由到与消息一致的队列描述下交换机与交换机的差异交换机将消息路由给每一个与之绑定的队列交换机根据判断路由给哪个队列如果多个队列具有相同的则与功能类似交换机也是基于做消息路由但是通常是多个单词的组合并且以分割与指定时可以使用通配符代指个或多个单词代指一个单词声明队列和交换机在之前我们都是基于控制台来创建队列交换机但是在实际开发时队列和交换机是程序员定义的将来项目上线又要交给运维去创建那么程序员就需要把程序中运行的所有队列和交换机都写下来交给运维在这个过程中是很容易出现错误的因此推荐的做法是由程序启动时检查队列和交换机是否存在如果不存在自动创建如果交换机或队列不存在会自动创建它们如果交换机不存在会根据注解中的配置如名称和类型自动创建交换机如果队列不存在会根据注解中的配置如名称自动创建队列如果绑定关系不存在会根据注解中的配置如路由键自动建立绑定关系如果交换机或队列已经存在不会更改已存在的交换机或队列如果交换机或队列已经存在并且它们的配置如名称类型等与注解中的配置一致不会对它们进行任何更改如果交换机或队列的配置与注解中的配置不一致例如交换机类型不同或队列的持久性设置不同会抛出错误导致声明失败消费者接收到的消息消费者接收到的消息再试试模式消费者接收到的消息消费者接收到的消息消息转换器当使用发送消息时传输内容通常是对象但消息队列只能处理字节数据因此需要先将对象序列化为字节发送接收时再反序列化为对象默认使用的是的序列化机制但这种方式格式不友好体积大不安全实际开发中通常会配置转换器使消息更轻量可读且更安全导入依赖然后添加一个定义消息转换器配置自动创建消息用于识别不同消息也可以在业务中基于判断是否是重复消息订单业务案例需求改造余额支付功能将支付成功后基于的交易服务的更新订单状态接口的同步调用改为基于的异步通知说明目前没有通知服务和积分服务因此我们只关注交易服务步骤如下定义类型交换机命名为定义消息队列命名为将与绑定为支付成功时不再调用交易服务更新订单状态的接口而是发送一条消息到发送消息的为消息内容是订单交易服务监听队列接收到消息后更新订单状态为已支付不管是生产者还是消费者都需要配置的基本信息分为两步添加依赖消息发送配置地址你的虚拟机端口虚拟主机用户名密码接收消息在服务中定义一个消息监听类其代码如下发送消息修改服务下的类中的方法查询支付单判断状态订单不是未支付状态异常交易已支付或关闭尝试扣减余额修改支付单状态交易已支付或关闭修改订单状态支付成功的消息发送失败支付单交易单六高级发送者的可靠性发送者重连首先第一种情况就是生产者发送消息时出现了网络故障导致与的连接中断为了解决这个问题提供的消息发送时的重试机制即当与连接超时后多次重试修改模块的文件添加下面的内容设置的连接超时时间开启超时重试机制失败后的初始等待时间失败后下次的等待时长倍数下次等待时长最大重试次数当网络不稳定的时候利用重试机制可以有效提高消息发送的成功率不过提供的重试机制是阻塞式的重试也就是说多次重试等待的过程中当前线程是被阻塞的会影响业务性能如果对于业务性能有要求建议禁用重试机制如果一定要使用请合理配置等待时长和重试次数当然也可以考虑使用异步线程来执行发送消息的代码发送者确认提供了和两种确认机制开启确机制认后当发送者发送消息给后会返回确认结果给发送者返同的结里有以下几种情况一般情况下只要生产者与之间的网路连接顺畅基本不会出现发送消息丢失的情况因此大多数情况下我们无需考虑这种问题不过在少数情况下也会出现消息发送到之后丢失的现象比如内部处理消息的进程发生了异常生产者发送消息到达后未找到生产者发送消息到达的后未找到合适的因此无法路由针对上述情况提供了生产者消息确认机制包括和两种在开启确认机制的情况下当生产者发送消息给后会根据消息处理的情况返回不同的回执具体如图所示总结如下当消息投递到但是路由失败时通过返回异常信息同时返回的确认信息代表投递成功临时消息投递到了并且入队成功返回告知投递成功持久消息投递到了并且入队完成持久化返回告知投递成功其它情况都会返回告知投递失败其中和属于机制是投递成功是投递失败而则属于机制默认两种机制都是关闭状态需要通过配置文件来开启和机制是可以同时开启的机制确认消息是否从路由到机制确认消息是否到达若同时开启路由失败队列不存在或者交换机配置错误时机制返回异常信息以及消息机制则返回不是两个机制不会互相影响和都是由机制返回的路由失败交换机到队列才触发机制返回异常信息消息投递发送者到交换机成功机制返回投递失败返回机制用于向生产者确认消息是否成功送达队列当生产者向发送消息时会返回一个唯一的交付标签生产者可以通过这个标签来查询消息的投递状态机制用于处理无法路由的消息当生产者向发送一条消息时如果消息无法被正确路由例如由于队列不存在或交换机配置错误会将该消息返回给生产者并附带一个错误信息开启生产者确认在模块的中添加配置开启机制并设置类型开启机制这里有三种模式可选关闭机制同步阻塞等待的回执异步回调返回回执一般我们推荐使用回调机制每个只能配置一个因此我们可以在配置类中统一设置我们在模块定义一个配置类的作用当消息发送到交换机时如果交换机无法将消息路由到任何队列例如路由键不匹配或队列不存在会返回一个消息就是用来处理这种场景的配置类中设置了一个消息返回的回调处理机制当发送的消息因为某些原因未能成功投递到目标队列时如交换机路由键不匹配等会触发回调并通过日志记录详细的错误信息这样你可以通过日志详细了解失败的原因便于排查问题内容如下它主要用于类在被创建并完成属性注入后执行一些初始化操作带有注解的方法会被自动调用触发由于每个消息发送时的处理逻辑不一定相同因此需要在每次发消息时定义具体来说是在调用中的方法时多传递一个参数这里的中包含两个核心的东西消息的唯一标示对不同的消息的回执以此做判断避免混淆回执结果的对象为什么只用写一次配置而需要每次都写因为消息需要被确认并且是每条消息都需要被确认我们新建一个测试向系统自带的交换机发送消息并且添加创建给添加发生异常时的处理逻辑基本不会触发接收到回执的处理逻辑参数中的就是回执内容类型代表回执代表回执发送消息成功收到类型返回时的异常描述发送消息失败收到发送消息可以看到由于传递的是错误的路由失败后触发了同时也收到了当我们修改为正确的以后就不会触发了只收到而如果连交换机都是错误的则只会收到开启生产者确认比较消耗性能一般不建议开启而且大家思考一下触发确认的几种情况路由失败一般是因为错误导致往往是编程导致交换机名称错误同样是编程错误导致内部故障这种需要处理但概率往往较低因此只有对消息可靠性要求非常高的业务才需要开启而且仅仅需要开启处理就可以了的可靠性在默认情况下会将接收到的信息保存在内存中以降低消息收发的延迟这样会导致两个问题一旦宕机内存中的消息会丢失内存空间有限当消费者故障或处理过慢时会导致消息积压引发阻塞在内存满的情况下会持久化一部分到磁盘然而这个过程较为耗时这个过程中的消息发过来则就相当于丢失了这个过程是阻塞式的就不能处理消息了每一次把消息从内存写出到磁盘做的过程中处于阻塞状态消息处理会直接降为这就是基于内存带来的影响所以需要将消息设置为持久化的如何保证消息的可靠性首先通过配置可以让交换机队列以及发送的消息都持久化这样队列中的消息会持久化到磁盘重启消息依然存在在版本引入了并且在版本后会称为队列的默认模式会将所有消息都持久化开启持久化和生产者确认时只有在消息持久化完成后才会给生产者返回回执数据持久化为了提升性能默认情况下的数据都是在内存存储的临时数据重启后就会消失为了保证数据的可靠性必须配置数据持久化包括交换机持久化队列持久化消息持久化说明在开启持久化机制以后如果同时还开启了生产者确认那么会在消息持久化以后才发送回执进一步确保消息的可靠性不过出于性能考虑为了减少次数发送到的消息并不是逐条持久化到数据库的而是每隔一段时间批量持久化一般间隔在毫秒左右这就会导致有一定的延迟因此建议生产者确认全部采用异步方式在默认情况下会将接收到的信息保存在内存中以降低消息收发的延迟但在某些特殊情况下这会导致消息积压比如消费者宕机或出现网络故障消息发送量激增超过了消费者处理速度消费者处理业务发生阻塞一旦出现消息堆积问题的内存占用就会越来越高直到触发内存预警上限此时会将内存消息刷到磁盘上这个行为成为会耗费一段时间并且会阻塞队列进程因此在这个过程中不会再处理新的消息生产者的所有请求都会被阻塞为了解决这个问题从的版本开始就增加了的模式也就是惰性队列惰性队列的特征如下接收到消息后直接存入磁盘而非内存消费者要消费消息时才会从磁盘中读取并加载到内存也就是懒加载支持数百万条的消息存储而在版本之后已经成为所有队列的默认格式因此官方推荐升级为版本或者所有队列都设置为模式之前的消息持久化以后是内存里写一份的同时内存里满了会直接删除不会再像之前一样阻塞了队列进行消息写入磁盘磁盘里也写一份这样接受处理消息的速度就下降了如果消费者处理消息的速度很快时那么就不会逐条那种去从磁盘里加载消息到内存而是直接提前缓存一批消息到内存最多条普通的持久化发一条写一条写的日志文件而不是消息体本身消息体本身只有当内存中存的消满了之后才会写入磁盘的使用惰性队列的性能更好的原因是接收到消息直接存入磁盘避免了非持久化的情况下内存满时需要向磁盘中此时不能接收消息同时对磁盘的进行了优化使其效率更高控制台配置模式在添加队列的时候添加参数即可设置队列为模式代码配置模式在利用声明队列的时候添加参数也可设置队列为模式开启模式这里是通过的函数配置模式底层源码如下当然我们也可以基于注解来声明队列并设置为模式接收到的消息更新已有队列为模式对于已经存在的队列也可以配置为模式但是要通过设置实现可以基于命令行设置命令解读的命令行工具添加一个策略策略名称可以自定义用正则表达式匹配队列的名字设置队列模式为模式策略的作用对象是所有的队列当然也可以在控制台配置进入在控制台的页面点击即可添加配置在中消息的持久性是由消息本身和队列的持久性决定的如果消息没有被标记为持久化那么即使队列本身是持久化的在服务器重启后这些消息也会丢失这里的关键点在于队列的持久性持久化队列意味着队列的元数据例如队列的名称绑定关系等会被存储到磁盘中在服务器重启时可以恢复队列的结构但是队列本身的持久性并不自动意味着队列中的消息会被持久化消息的持久性如果消息在发送时没有设置为持久化即没有将设置为即持久化则这些消息只会保存在内存中当服务器重启时这些未持久化的消息会丢失尽管队列本身可能被恢复是一种优化机制它使得消息以最少的内存使用保存在磁盘上即使是普通非持久化消息也可以保存在磁盘上避免过多占用内存它并不改变消息持久性的属性也就是说即使队列是类型的如果消息没有被标记为持久化消息仍然会在服务器重启时丢失总结队列持久化保存队列结构消息持久化确保消息在重启后不丢失优化内存使用减少对的依赖但消息如果未持久化仍会丢失所以即使是如果消息没有被标记为持久化那么这些消息在服务器重启后仍然会丢失如何保证消息可靠性首先通过配置可以让交换机队列以及发送的消息都持久化这样队列中的消息会持久化到磁盘重启消息依然存在在版本引入了并且在版本后会称为队列的默认模式会将所有消息都持久化开启持久化和生产者确认时只有在消息持久化完成后才会给生产者返回回执消费者可靠性当向消费者投递消息以后需要知道消费者的处理状态如何因为消息投递给消费者并不代表就一定被正确消费了可能出现的故障有很多比如消息投递的过程中出现了网络故障消费者接收到消息后突然宕机消费者接收到消息后因处理不当导致异常一旦发生上述情况消息也会丢失因此必须知道消费者的处理状态一旦消息处理失败才能重新投递消息但问题来了如何得知消费者的处理状态呢消费者确认机制消费者确认机制是为了确认消费者是否成功处理消息当消费者处理消息结束后应该向发送一个回执告知自己消息处理状态成功处理消息从队列中删除该消息消息处理失败需要再次投递消息消息处理失败并拒绝该消息从队列中删除该消息一般方式用的较少除非是消息格式有问题那就是开发问题了因此大多数情况下我们需要将消息处理的代码通过机制捕获消息处理成功时返回处理失败时返回由于消息回执的处理代码比较统一因此帮我们实现了消息确认并允许我们通过配置文件设置处理方式有三种模式不处理即消息投递给消费者后立刻消息会立刻从删除非常不安全不建议使用手动模式需要自己在业务代码中调用发送或存在业务入侵但更灵活自动模式利用对我们的消息处理逻辑做了环绕增强当业务正常执行时则自动返回当业务出现异常时根据异常判断返回不同结果如果是业务异常会自动返回如果是消息处理或校验异常自动返回由于消息回执的处理代码比较统一因此帮我们实现了消息确认并允许我们通过配置文件设置处理方式有三种模式不处理即消息投递给消费者后立刻消息会立刻从删除非常不安全不建议使用手动模式需要自己在业务代码中调用发送或存在业务入侵但更灵活自动模式利用对我们的消息处理逻辑做了环绕增强当业务正常执行时则自动返回当业务出现异常时根据异常判断返回不同结果如果是业务异常会自动返回如果是消息处理或校验异常自动返回返回的常见异常有通过下面的配置可以修改的处理方式不做处理修改服务的类中的方法模拟一个消息处理的异常消费者接收到消息故意的消息处理完成测试可以发现当消息处理发生异常时消息依然被删除了我们再次把确认机制修改为自动失败重试机制当消费者出现异常后消息会不断重入队到队列再重新发送给消费者如果消费者再次执行依然出错消息会再次到队列再次投递直到消息处理成功为止极端情况就是消费者一直无法执行成功那么消息就会无限循环导致的消息处理飙升带来不必要的压力又提供了消费者失败重试机制在消费者出现异常时利用本地重试而不是无限制的到队列修改服务的文件添加内容开启消费者失败重试初识的失败等待时长为秒失败的等待时长倍数下次等待时长最大重试次数无状态有状态如果业务中包含事务这里改为重启服务重复之前的测试可以发现消费者在失败后消息没有重新回到无限重新投递而是在本地重试了次本地重试次以后抛出了异常查看控制台发现消息被删除了说明最后返回的是结论开启本地重试时消息处理过程中抛出异常不会到队列而是在消费者本地重试重试达到最大次数后会返回消息会被丢弃失败处理机制在之前的测试中本地测试达到最大重试次数后消息会被丢弃这在某些对于消息可靠性要求较高的业务场景下显然不太合适了开启之后都失败后的默认实现使得消息不从而被丢弃因此允许我们自定义重试次数耗尽后的消息处理策略这个策略是由接口来定义的它有个不同实现重试耗尽后直接丢弃消息默认就是这种方式重试耗尽后返回消息重新入队重试耗尽后将失败消息投递到指定的交换机比较优雅的一种处理方案是失败后将消息投递到一个指定的专门存放异常消息的队列后续由人工集中处理在服务中定义处理失败消息的交换机和队列定义一个关联队列和交换机完整代码如下业务幂等性何为幂等性消息被重复消费如果消费者和之间的网络连接断开消费者的未能成功发送到那么等到连接好了之后又会重新发送消息此时消息重复被消费如果这个消息是用于扣减库存的那么就会出现问题幂等是一个数学概念用函数表达式来描述是这样的例如求绝对值函数在程序开发中则是指同一个业务执行一次或多次对业务状态的影响是一致的例如根据删除数据查询数据新增数据但数据的更新往往不是幂等的如果重复执行可能造成不一样的后果比如取消订单恢复库存的业务如果多次恢复就会出现库存重复增加的情况退款业务重复退款对商家而言会有经济损失所以我们要尽可能避免业务被重复执行然而在实际业务场景中由于意外经常会出现业务被重复执行的情况例如页面卡顿时频繁刷新导致表单重复提交服务间调用的重试消息的重复投递我们在用户支付成功后会发送消息到交易服务修改订单状态为已支付就可能出现消息重复投递的情况如果消费者不做判断很有可能导致消息被消费多次出现业务故障举例假如用户刚刚支付完成并且投递消息到交易服务交易服务更改订单为已支付状态由于某种原因例如网络故障导致生产者没有得到确认隔了一段时间后重新投递给交易服务但是在新投递的消息被消费之前用户选择了退款将订单状态改为了已退款状态退款完成后新投递的消息才被消费那么订单状态会被再次改为已支付业务异常因此我们必须想办法保证消息处理的幂等性这里给出两种方案唯一消息业务状态判断唯一消息白雪这个思路非常简单每一条消息都生成一个唯一的与消息一起投递给消费者消费者接收到消息后处理自己的业务业务处理成功后将消息保存到数据库如果下次又收到相同消息去数据库查询判断是否存在存在则为重复消息放弃处理我们该如何给消息添加唯一呢其实很简单的自带了的功能我们只要开启这个功能即可以的消息转换器为例定义消息转换器配置自动创建消息用于识别不同消息也可以在业务中基于判断是否是重复消息业务判断业务判断就是基于业务本身的逻辑或状态来判断是否是重复的请求或消息不同的业务场景判断的思路也不一样例如我们当前案例中处理消息的业务逻辑是把订单状态从未支付修改为已支付因此我们就可以在执行业务时判断订单状态是否是未支付如果不是则证明订单已经被处理过无需重复处理相比较而言消息的方案需要改造原有的数据库所以我更推荐使用业务判断的方案以支付修改订单的业务为例我们需要修改中的方法查询订单判断订单状态订单不存在或者订单状态不是放弃处理尝试更新订单上述代码逻辑上符合了幂等判断的需求但是由于判断和更新是两步动作因此在极小概率下可能存在线程安全问题我们可以合并上述操作为这样注意看上述代码等同于这样的语句我们在条件中除了判断以外还加上了必须为的条件如果条件不符说明订单已支付则匹配不到数据根本不会执行如何保证支付服务与交易服务订单状态的一致性首先支付服务会正在用户支付成功以后利用消息通知交易服务完成订单状态同步其次为了保证消息的可靠性我们采用了生产者确认机制消费者确认消费者失败重试等策略确保消息投递和处理的可靠性同时也开启了的持久化避免因服务宕机导致消息丢失最后我们还在交易服务更新订单状态时做了业务幂等判断避免因消息重复消费导致订单状态异常兜底方案虽然我们利用各种机制尽可能增加了消息的可靠性但也不好说能保证消息的可靠万一真的通知失败该怎么办呢有没有其它兜底方案能够确保订单的支付状态一致呢其实思想很简单既然通知不一定发送到交易服务那么交易服务就必须自己主动去查询支付状态这样即便支付服务的通知失败我们依然能通过主动查询来保证订单状态的一致流程如下图中黄色线圈起来的部分就是通知失败后的兜底处理方案由交易服务自己主动去查询支付状态不过需要注意的是交易服务并不知道用户会在什么时候支付如果查询的时机不正确比如查询的时候用户正在支付中可能查询到的支付状态也不正确那么问题来了我们到底该在什么时间主动查询支付状态呢这个时间是无法确定的因此通常我们采取的措施就是利用定时任务定期查询例如每隔秒就查询一次并判断支付状态如果发现订单已经支付则立刻更新订单状态为已支付即可定时任务大家之前学习过具体的实现这里就不再赘述了至此消息可靠性的问题已经解决了综上支付服务与交易服务之间的订单状态一致性是如何保证的首先支付服务会正在用户支付成功以后利用消息通知交易服务完成订单状态同步其次为了保证消息的可靠性我们采用了生产者确认机制消费者确认消费者失败重试等策略确保消息投递的可靠性最后我们还在交易服务设置了定时任务定期查询订单支付状态这样即便通知失败还可以利用定时任务作为兜底方案确保订单支付状态的最终一致性延迟消息延迟消息发送者发送消息时指定一个时间消费者不会立刻收到消息而是在指定时间之后才收到消息在电商的支付业务中对于一些库存有限的商品为了更好的用户体验通常都会在用户下单时立刻扣减商品库存例如电影院购票高铁购票下单后就会锁定座位资源其他人无法重复购买但是这样就存在一个问题假如用户下单后一直不付款就会一直占有库存资源导致其他客户无法正常交易最终导致商户利益受损因此电商中通常的做法就是对于超过一定时间未支付的订单应该立刻取消订单并释放占用的库存例如订单支付超时时间为分钟则我们应该在用户下单后的第分钟检查订单支付状态如果发现未支付应该立刻取消订单释放库存但问题来了如何才能准确的实现在下单后第分钟去检查支付状态呢像这种在一段时间以后才执行的任务我们称之为延迟任务而要实现延迟任务最简单的方案就是利用的延迟消息了在中实现延迟消息也有两种方案死信交换机存活时间延迟消息插件这一章我们就一起研究下这两种方案的实现方式以及优缺点死信交换机白雪当一个队列中的消息满足下列情况之一时就会成为死信消费者使用或声明消费失败并且消息的参数设置为消息是一个过期消息达到了队列或消息本身设置的过期时间超时无人消费要投递的队列消息堆积满了最早的消息可能成为死信如果一个队列中的消息已经成为死信并且这个队列通过属性指定了一个交换机那么队列中的死信就会投递到这个交换机中而这个交换机就称为死信交换机而此时加入有队列与死信交换机绑定则最终死信就会被投递到这个队列中死信交换机有什么作用呢收集那些因处理失败而被拒绝的消息收集那些因队列满了而被拒绝的消息收集因有效期到期的消息前面两种作用场景可以看做是把死信交换机当做一种消息处理的最终兜底方案与消费者重试时讲的作用类似而最后一种场景大家设想一下这样的场景如图有一组绑定的交换机和队列但是没有消费者监听而是设定了死信交换机而队列则与死信交换机绑定是假如我们现在发送一条消息到为并设置消息的有效期为毫秒注意尽管这里的不需要但是当消息变为死信并投递到死信交换机时会沿用之前的这样才能正确路由消息消息肯定会被投递到之后由于没有消费者因此消息无人消费秒之后消息的有效期到期成为死信死信被再次投递到死信交换机并沿用之前的也就是由于与绑定的是因此最终消息被成功路由到如果此时有消费者与绑定也就能成功消费消息了但此时已经是秒钟以后了也就是说发送了一条消息但最终在秒后才收到消息我们成功实现了延迟消息这里的必须一致死信在转移到死信队列时他的也会保存下来但是如果配置了这个参数的话就会被替换为配置的这个值另外死信在转移到死信队列的过程中是没有经过消息发送者确认的所以并不能保证消息的安全性的消息过期是基于追溯方式来实现的也就是说当一个消息的到期以后不一定会被移除或投递到死信交换机而是在消息恰好处于队首时才会被处理当队列中消息堆积很多的时候过期消息可能不会被按时处理因此你设置的时间不一定准确插件基于死信队列虽然可以实现延迟消息但是太麻烦了因此社区提供了一个延迟消息插件来实现相同的效果因为我们是基于安装所以需要先查看的插件目录对应的数据卷结果如下插件目录被挂载到了这个目录我们上传插件到该目录下接下来执行命令安装插件运行结果如下声明延迟交换机基于注解方式接收到的延迟消息基于的方式指定交换机类型和名称设置的属性为持久化发送延迟消息发送消息时必须通过属性设定延迟时间创建消息发送消息利用消息后置处理器添加消息头添加延迟消息属性延迟消息插件内部会维护一个本地数据库表同时使用功能实现计时如果消息的延迟时间设置较长可能会导致堆积的延迟消息非常多会带来较大的开销同时延迟消息的时间会存在误差因此不建议设置延迟时间过长的延迟消息超时取消订单接下来我们就在交易服务中利用延迟消息实现订单超时取消功能其大概思路如下假如订单超时支付时间为分钟理论上说我们应该在下单时发送一条延迟消息延迟时间为分钟这样就可以在接收到消息时检验订单支付状态关闭未支付订单七是由公司开发的一套搜索引擎技术它是技术栈中的一部分完整的技术栈包括用于数据存储计算和搜索用于数据收集用于数据可视化整套技术栈被称为经常用来做日志收集系统监控和状态分析等等整套技术栈的核心就是用来存储搜索计算的因此我们接下来学习的核心也是我们要安装的内容包含部分存储搜索和运算图形化展示首先不用多说是提供核心的数据存储搜索分析功能的然后是对外提供的是风格的任何操作都可以通过发送请求来完成不过请求的方式路径还有请求参数的格式都有严格的规范这些规范我们肯定记不住因此我们要借助于这个服务是公司提供的用于操作的可视化控制台它的功能非常强大包括对数据的搜索展示对数据的统计聚合并形成图形化报表图形对的集群状态监控它还提供了一个开发控制台在其中对的的接口提供了语法提示安装安装通过下面的命令即可安装单机版本的注意这里我们采用的是的版本由于以上版本的变化很大在企业中应用并不广泛企业中应用较多的还是以下的版本安装完成后访问端口即可看到响应的服务的基本信息通过下面的命令即可部署倒排索引倒排索引中有两个非常重要的概念文档用来搜索的数据其中的每一条数据就是一个文档例如一个网页一个商品信息词条对文档数据或用户搜索数据利用某种算法分词得到的具备含义的词语就是词条例如我是中国人就可以分为我是中国人中国国人这样的几个词条创建倒排索引是对正向索引的一种特殊处理和应用流程如下将每一个文档的数据利用分词算法根据语义拆分得到一个个词条创建表每行数据包括词条词条所在文档位置等信息因为词条唯一性可以给词条创建正向索引流程描述用户输入条件华为手机进行搜索对用户输入条件分词得到词条华为手机拿着词条在倒排索引中查找由于词条有索引查询效率很高即可得到包含词条的文档拿着文档到正向索引中查找具体文档即可由于也有索引查询效率也很高虽然要先查询倒排索引再查询正向索引但是无论是词条还是文档都建立了索引查询速度非常快无需全表扫描正向和倒排以索引的使用来理解正向索引走的是全表扫描速度很慢而倒排根据词条找文档可以走索引再根据文档找文档也是索引因此效率很高那么为什么一个叫做正向索引一个叫做倒排索引呢正向索引是最传统的根据索引的方式但根据词条查询时必须先逐条获取每个文档然后判断文档中是否包含所需要的词条是根据文档找词条的过程而倒排索引则相反是先找到用户要搜索的词条根据词条得到保护词条的文档的然后根据获取文档是根据词条找文档的过程是不是恰好反过来了那么两者方式的优缺点是什么呢正向索引优点可以给多个字段创建索引根据索引字段搜索排序速度非常快缺点根据非索引字段或者索引字段中的部分词条查找时只能全表扫描倒排索引优点根据词条搜索模糊搜索时速度非常快缺点只能给词条创建索引而不是字段无法根据字段做排序什么是正向索引基于文档创建索引根据查询快但是查询词条时必须先找到文档而后判断是否包含词条什么是倒排索引对文档内容分词对词条创建索引并记录词条所在文档的查询时先根据词条查询到文档而后根据文档查询文档分词器安装最后重启容器使用分词器包含两种模式智能语义切分最细粒度切分我们在的上来测试分词器首先测试官方提供的标准分词器黑马程序员学习太棒了结果如下黑马程序员学习太棒了可以看到标准分词器智能字词条无法正确对中文做分词我们再测试分词器黑马程序员学习太棒了执行结果如下黑马程序员学习太棒了拓展词典在目录下的文件下即可添加新词基本概览是面向文档存储的可以是数据库中的一条商品数据一个订单信息文档数据会被序列化为格式后存储在中因此原本数据库中的一行数据就是中的一个文档而数据库中每行数据都包含很多列这些列就转换为文档中的字段索引和映射随着业务发展需要在中存储的文档也会越来越多比如有商品的文档用户的文档订单文档等等所有文档都散乱存放显然非常混乱也不方便管理因此我们要将类型相同的文档集中在一起管理称为索引例如商品索引小米手机华为手机三星手机用户索引张三李四麻子订单索引所有用户文档就可以组织在一起称为用户的索引所有商品的文档可以组织在一起称为商品的索引所有订单的文档可以组织在一起称为订单的索引因此我们可以把索引当做是数据库中的表数据库的表会有约束信息用来定义表的结构字段的名称类型等信息因此索引库中就有映射是索引中文档的字段约束信息类似表的结构约束索引和的表的概念类似映射索引中文档的字段约束信息类似表的结构约束与我们统一的把与的概念做一下对比说明索引就是文档的集合类似数据库的表文档就是一条条的数据类似数据库中的行文档都是格式字段就是文档中的字段类似数据库中的列映射是索引中文档的约束例如字段类型约束类似数据库的表结构是提供的风格的请求语句用来操作实现那是不是说我们学习了就不再需要了呢并不是如此两者各自有自己的擅长之处擅长事务类型操作可以确保数据的安全和一致性擅长海量数据的搜索分析计算因此在企业中往往是两者结合使用对安全性要求较高的写操作使用实现对查询性能要求较高的搜索需求使用实现两者再基于某种方式实现数据的同步保证一致性索引库的操作就类似数据库表映射就类似表的结构我们要向中存储数据必须先创建和是的字段结构建索引规则分词逻辑存储行为的声明就类似于你在中写这种语句映射属性是对索引库中文档的约束常见的属性包括字段数据类型常见的简单类型有字符串可分词的文本精确值例如品牌国家地址数值布尔日期对象是否创建索引默认为使用哪种分词器该字段的子字段例如下面的文档黑马程序员讲师云赵对应的每个字段映射索引的由于采用的是风格的因此其请求方式和路径相对都比较规范而且请求参数也都采用风格我们直接基于的来编写请求做测试由于有语法提示会非常方便创建索引库和映射基本语法请求方式请求路径索引库名可以自定义请求参数映射格式索引库名称字段名字段名字段名子字段略示例查询基本语法请求方式请求路径索引库名请求参数无格式索引库名示例修改索引库倒排索引结构虽然不复杂但是一旦数据结构改变比如改变了分词器就需要重新创建倒排索引这简直是灾难因此索引库一旦创建无法修改虽然无法修改中已有的字段但是却允许添加新的字段到中因为不会对倒排索引产生影响因此修改索引库能做的就是向索引库中添加新字段或者更新索引库的基础属性新字段会创建自己的倒排索引与现有索引并行存在不会干扰已索引的数据语法说明索引库名新字段名示例删除语法请求方式请求路径索引库名请求参数无格式索引库名示例总结索引库操作有哪些创建索引库索引库名查询索引库索引库名删除索引库索引库名修改索引库添加字段索引库名可以看到对索引库的操作基本遵循的的风格因此接口非常统一方便记忆文档操作有了索引库接下来就可以向索引库中添加数据了中的数据其实就是风格的文档操作文档自然包括增删改查等几种常见操作我们分别来学习新增新增文档就会按照索引库中的映射来创建倒排索引但是创建倒排索引的过程对我们是不可见的语法理解为数据库的主键索引库名文档字段值字段值字段子属性值子属性值示例黑马程序员讲师云赵查询根据风格新增是查询应该是不过查询一般都需要条件这里我们把文档带上语法索引库名称示例删除删除使用请求同样需要根据进行删除语法索引库名值示例修改全量修改是覆盖原来的文档其本质是两步操作根据指定的删除文档新增一个相同的文档注意如果根据删除时不存在第二步的新增也会执行也就从修改变成了新增操作了语法索引库名文档字段值字段值略示例黑马程序员高级讲师云赵由于为的文档已经被删除所以第一次执行时得到的反馈是所以如果执行第次时得到的反馈则是局部修改局部修改是只修改指定匹配的文档中的部分字段语法索引库名文档字段名新的值示例批处理批处理采用请求基本语法如下其中代表新增操作指定索引库名指定要操作的文档则是要新增的文档内容代表删除操作指定索引库名指定要操作的文档代表更新操作指定索引库名指定要操作的文档要更新的文档字段示例批量新增黑马程序员讲师五王黑马程序员前端讲师三张批量删除导入客户端在提供的中与一切交互都封装在一个名为的类中必须先完成这个对象的初始化建立与的连接分为三步在模块中引入的依赖因为默认的版本是所以我们需要覆盖默认的版本初始化初始化的代码如下编写简单测试类李阳测试初始化客户端销毁客户端索引库操作李阳测试创建对象准备请求参数发送请求创建对象发送请求创建对象发送请求初始化客户端销毁客户端文档操作新增从中新增数据到李阳文档测试准备文档数据根据查询商品信息将商品信息转换为文档数据准备准备请求参数发送请求初始化客户端销毁客户端有是想要对象注解通常用于集成测试中它会启动整个容器以便可以注入管理的如果不是测试类使用启动应用在模块的包中定义一个新的新增结果查询准备发送请求处理响应结果结果删除准备发送请求更新更新准备准备请求参数发送请求批处理批处理与前面讲的文档的步骤基本一致创建但这次用的是准备请求参数发送请求这次要用到方法本身其实并没有请求参数其本质就是将多个普通的请求组合在一起发送例如批量新增文档就是给每个文档创建一个请求然后封装到中一起发出批量删除就是创建个请求然后封装到一起发出因此中提供了方法用以添加其它的请求可以看到能添加的请求有也就是新增也就是修改也就是删除因此中添加了多个就是批量新增功能了示例创建准备请求参数发送请求完整代码批处理准备文档数据查询到一页数据准备准备请求参数发送请求翻页八的查询可以分为两大类叶子查询一般是在特定的字段里查询特定值属于简单查询很少单独使用复合查询以逻辑方式组合多个叶子查询或者更改叶子查询的行为方式查询入门我们依然在的中学习查询的语法首先来看查询的语法结构索引库名查询类型查询条件说明索引库名其中的是固定路径不能修改例如我们以最简单的无条件查询为例无条件查询的类型是因此其查询语句如下由于无条件所以条件位置不写即可叶子查询叶子查询可分为全文检索查询利用分词器对用户输入搜索条件先分词得到词条然后再利用倒排索引搜索词条例如精确查询不对用户输入搜索条件分词根据字段内容精确值匹配但只能查找数值日期类型的字段例如地理坐标查询用于搜索地理位置搜索方式很多例如按矩形搜索按点和半径搜索略全文检索查询索引库名字段名搜索条件与类似的还有区别在于可以同时对多个字段搜索而且多个字段都要满足语法示例索引库名搜索条件字段字段参与查询字段越多查询性能就越差可以使用将多个字段拷贝到一个字段中相关度评分是基于算法来计算的这是一种改进的算法精确查询精确查询英文是顾名思义词条级别的查询也就是说不会对用户输入的搜索条件再分词而是作为一个词条与搜索的字段内容精确值匹配因此推荐查找数值日期类型的字段例如城市地名人名等等作为一个整体才有含义的字段以查询为例其语法如下索引库名字段名搜索条件因为这里的是类型的会被分词如果直接匹配就匹配不上了所以加了范围查询是范围查询对于范围筛选的关键字有大于等于大于小于等于小于根据查询具体的和的区别是什么根据一个字段查询根据多个字段查询参与查询字段越多查询性能越差精确查询常见的有哪些查询根据词条精确匹配一般搜索类型数值类型布尔类型日期类型字段查询根据数值范围查询可以是数值日期的范围复合查询复合查询大致可以分为两类第一类基于逻辑运算组合叶子查询实现组合条件例如第二类基于某种算法修改查询时的文档相关性算分从而改变文档排名例如查询查询即布尔查询就是利用逻辑运算来组合一个或多个查询子句的组合查询支持的逻辑运算有必须匹配每个子查询类似与选择性匹配子查询类似或必须不匹配不参与算分类似非必须匹配不参与算分查询的语法如下手机小米出于性能考虑与搜索关键字无关的查询尽量采用或逻辑运算避免参与相关性算分例如查询智能手机品牌华为智能手机华为排序默认是根据相关度算分来排序但是也支持自定义方式对搜索结果排序不过分词字段无法排序能参与排序字段类型有类型数值类型地理坐标类型日期类型等语法说明排序字段排序方式和示例分页默认情况下只返回的数据而如果要查询更多数据就需要修改分页参数了中通过修改参数来控制要返回的分页结果从第几个文档开始总共查询几个文档类似于中的语法如下分页开始的位置默认为每页文档数量默认例如手机深度分页的数据一般会采用分片存储也就是把一个索引中的数据分成份存储到不同节点上这种存储方式比较有利于数据扩展但给分页带来了一些麻烦的索引由多个不可变的分段组成每个分段独立存储数据文档按写入顺序存储在分段内类似数组结构通过内部文档的可直接计算偏移量实现快速随机访问就会自动创建就是手动创建前面我们通过的客户端是后者的方式但是简单分页查询的问题在于排序并不一定总是按文档顺序排序而是常常会按某些关键字进行排序例如下方但下方并未说明实际有条件但没有条件时算分均为此时按文档升序排列题外话如果只有和不显式指定排序条件时默认会将搜索结果按算分降序排列但同时没有条件时那么默认就是所有算分都是此时退化为按升序默认排序所以会导致排序后文档分散从而无法依靠顺序如同数组一般随机访问而是如同链表一般顺序访问而分页条件越大查询内容也就越多查询内容当然存在内存中是一个项目例如找出前个数据放在内存里最后遍历到第的数据数据过多就会导致这里深度分页解决的就是分页数据量过于庞大的问题页码针对深度分页提供了两种解决方案分页时需要排序原理是从上一次的排序值开始查询下一页数据官方推荐使用的方式原理将排序后的文档形成快照保存下来基于快照做分页官方已经不推荐使用假设你在看一本书你已经翻到某一页例如第页然后你想继续看第页就像是给你上一页的最后一行文字让你知道接下来你应该从哪里开始读而不是从头开始翻书就像那样跳过很多页高亮显示事实上已经提供了给搜索关键字加标签的语法无需我们自己编码基本语法如下索引库名搜索字段搜索关键字高亮字段名称高亮的前置标签高亮的后置标签注意搜索必须有查询条件而且是全文检索类型的查询条件例如参与高亮的字段必须是类型的字段默认情况下参与高亮的字段要与搜索字段一致除非添加示例脱脂牛奶查询文档的查询依然使用昨天学习的对象查询的基本步骤如下创建对象这次是搜索所以是准备请求参数也就是查询对应的参数发起请求解析响应响应结果相对复杂需要逐层解析查询所有查询所有创建对象配置对象发送请求解析响应结果获取总条数总条数获取总记录数初始化客户端销毁客户端构建条件查询全文检索查询精确查询布尔查询示例搜索关键字脱脂牛奶品牌德亚价格低于创建对象配置对象脱脂牛奶德亚发送请求解析响应结果获取总条数总条数获取总记录数初始化客户端销毁客户端排序和分页示例分页模拟前端传入的参数创建对象配置对象设置分页设置排序发送请求解析响应结果获取总条数总条数获取总记录数高亮显示高亮创建对象配置对象脱脂牛奶设置高亮发送请求解析响应结果获取总条数总条数获取总记录数获取高亮结果根据高亮字段名获取高亮结果获取高亮结果覆盖非高亮数据聚合聚合可以让我们极其方便的实现对数据的统计分析运算例如什么品牌的手机最受欢迎这些手机的平均价格最高价格最低价格这些手机每月的销售情况如何实现这些统计功能的比数据库的要方便的多而且查询速度非常快可以实现近实时搜索效果聚合常见的有三类桶聚合用来对文档做分组按照文档字段值分组例如按照品牌值分组按照国家分组按照日期阶梯分组例如一周为一组或者一月为一组度量聚合用以计算一些值比如最大值最小值平均值等求平均值求最大值求最小值同时求等管道聚合其它聚合的结果为基础做进一步运算注意参加聚合的字段必须是日期数值布尔类型下面俩小人怎么盯着劳资看聚合例如我们要统计所有商品中共有哪些商品分类其实就是以分类字段对数据分组值一样的放在同一组属于聚合中的聚合基本语法如下设置为结果中不包含文档只包含聚合结果定义聚合给聚合起名字聚合的类型按照品牌值聚合所以选择参与聚合的字段希望获取的聚合结果数量聚合聚合带条件的聚合带条件的聚合手机聚合上节课我们统计了价格高于的手机品牌形成了一个个桶现在我们需要对桶内的商品做运算获取每个品牌价格的最小值最大值平均值这就要用到聚合了例如聚合就可以同时获取等结果聚合手机聚合创建对象配置对象分页设置聚合函数发送请求解析响应结果遍历获取桶品牌数量九面试部分详情参照站内另外一篇文章面试模块",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-08-04 10:43:02",postMainColor:""}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise(((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach((e=>{c.setAttribute(e,t[e])})),document.head.appendChild(c)})),e.getCSS=(e,t=!1)=>new Promise(((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)})),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/npm/js-heo@1.0.11/poem/poem.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/npm/js-heo@1.0.11/mainColor/heoMainColor.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/essay-style.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/todolist.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.1/static/custom-me.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/imgloaded.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/twikoo.min.css"><script async defer src="https://umami.baskly.fun/script.js" data-website-id="83445f1f-eab2-4423-b52a-d98fcec8638f"></script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg"><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",(()=>{preloader.endLoading()})),setTimeout((function(){preloader.endLoading()}),1e4),document.addEventListener("pjax:send",(()=>{preloader.initLoading()})),document.addEventListener("pjax:complete",(()=>{preloader.endLoading()}))</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">李阳的秘密小屋</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i> <span>隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongji1"></use></svg> <span>统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=12781955100&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>耳机分你一半</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zuji"></use></svg> <span>脚步</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-taiyang"></use></svg> <span>小太阳</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-a-xiaoyangyang_huaban1"></use></svg> <span>了解我</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i> <span>搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/408/" style="font-size:1.05rem">408<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:1.05rem">C语言<sup>1</sup></a><a href="/tags/java/" style="font-size:1.05rem">java<sup>1</sup></a><a href="/tags/javaweb/" style="font-size:1.05rem">javaweb<sup>8</sup></a><a href="/tags/%E5%8A%9B%E6%89%A3%E5%88%B7%E9%A2%98/" style="font-size:1.05rem">力扣刷题<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:1.05rem">操作系统<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size:1.05rem">数据结构<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" style="font-size:1.05rem">计算机组成原理<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:1.05rem">计算机网络<sup>2</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size:1.05rem">软件工程<sup>1</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"><i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/" itemprop="url">java</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/javaweb/" tabindex="-1" itemprop="url"><span><i class="anzhiyufont anzhiyu-icon-hashtag"></i> javaweb</span></a></span></div></div><h1 class="post-title" itemprop="name headline">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-07-13T00:34:21.000Z" title="发表于 2025-07-13 08:34:21">2025-07-13</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-08-04T02:43:02.432Z" title="更新于 2025-08-04 10:43:02">2025-08-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">48.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>184分钟</span></span><span class="post-meta-separator"></span><span data-flag-title="SpringCloud"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"></span><span class="post-meta-position" title="作者IP属地为武汉"><i class="anzhiyufont anzhiyu-icon-location-dot"></i> 武汉</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/42622/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=320ac6a6-3bf5-9cc8-180a-c9c4b73ea680"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.baskly.fun/posts/42622/"><header><a class="post-meta-categories" href="/categories/java/" itemprop="url">java</a><a href="/tags/javaweb/" tabindex="-1" itemprop="url">javaweb</a><h1 id="CrawlerTitle" itemprop="name headline">SpringCloud</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">李阳</span><time itemprop="dateCreated datePublished" datetime="2025-07-13T00:34:21.000Z" title="发表于 2025-07-13 08:34:21">2025-07-13</time><time itemprop="dateCreated datePublished" datetime="2025-08-04T02:43:02.432Z" title="更新于 2025-08-04 10:43:02">2025-08-04</time></header><blockquote><p>跌跌撞撞终于来到这里，我会记得这一天。</p><p>知不可乎骤得，托遗响于悲风。 <em>—— 苏轼《赤壁赋》</em></p></blockquote><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://b11et3un53m.feishu.cn/wiki/PsyawI04ei2FQykqfcPcmd7Dnsc"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left" style="background-image:url(https://bu.dusays.com/2025/07/29/68888113f2ea7.png)"><i class="anzhiyufont anzhiyu-icon-link" style="display:none"></i></div><div class="tag-link-right"><div class="tag-link-title">飞书详细文档</div><div class="tag-link-sitename">黑马程序员</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://github.com/lyay23/hmall-SpringCloud"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left" style="background-image:url(https://bu.dusays.com/2025/07/29/6888ac51b0913.png)"><i class="anzhiyufont anzhiyu-icon-link" style="display:none"></i></div><div class="tag-link-right"><div class="tag-link-title">hmall黑马商城</div><div class="tag-link-sitename">GitHub</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><h1 id="一前置课程">一、前置课程</h1><h2 id="1mybatisplus">1、MybatisPlus</h2><h3 id="11-项目启动">1.1 项目启动</h3><ol type="1"><li><p>导入起步依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&lt;!―-MybatisPlus--&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">grouprd</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&lt;/ dependency&gt;</span><br></pre></td></tr></table></figure></li><li><p>自义定<code>Mapper</code>继承<code>MyBatisPlus</code>提供的<code>BaseMapper</code>接口,并且指定实体类泛型</p><p>eg:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="12-常用注解">1.2 常用注解</h3><p>约定大于配置</p><ul><li><code>@TableName</code>:用来指定表名</li><li><code>@Table</code>: 用来指定表中主键字段信息</li><li><code>@TableField</code>:用来指定表中的普通字段信息</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/687309fd4d023.png" alt="image-20250713092057985"></p><p>使用<code>@TableField</code>注解的常见场景</p><ul><li>成员变量名与数据库字段名不一致</li><li>成员变量名以is开头且是布尔值</li><li>成员变量名与数据库关键字冲突</li><li>成员变量不是数据库字段</li></ul><h3 id="13-常见配置">1.3 常见配置</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">   <span class="attr">type-aliases-package:</span> <span class="string">com.itheima.mp.domain.po</span> <span class="comment">#别名扫描包</span></span><br><span class="line">   <span class="attr">mapper-locations:</span> <span class="string">&quot;classpath* : /mapper/**/*,xml&quot;</span> <span class="comment"># Mapper.xml文件地址，默认值</span></span><br><span class="line">   <span class="attr">configuration:</span></span><br><span class="line">     <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span> <span class="comment">#是否开启下划线和驼峰的映射</span></span><br><span class="line">     <span class="attr">cache-enabled:</span> <span class="literal">false</span> <span class="comment">#是否开启二级缓存</span></span><br><span class="line">   <span class="attr">global-config:</span></span><br><span class="line">     <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">assign_id</span> <span class="comment"># id为雪花算法生成</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span> <span class="comment">#更新策略:只更新非空字段</span></span><br></pre></td></tr></table></figure><h3 id="14-核心功能">1.4 核心功能</h3><h4 id="模糊查询">模糊查询</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//查询名字中带o,balance&gt;1000的id，user等</span></span><br><span class="line">/ /<span class="number">1.</span>构建查询条件</span><br><span class="line">Querywrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">Querywrapper</span>&lt;User&gt;()</span><br><span class="line">                   .select( <span class="string">&quot;id&quot;</span>，<span class="string">&quot;username&quot;</span>，<span class="string">&quot;info&quot;</span>,<span class="string">&quot;balance&quot;</span>)</span><br><span class="line">                   .like(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;o&quot;</span>)</span><br><span class="line">                   .ge( <span class="string">&quot;balance&quot;</span>,<span class="number">1000</span>) ;</span><br><span class="line"><span class="comment">// 2.查询</span></span><br><span class="line">userMapper.selectList(wrapper) ;</span><br></pre></td></tr></table></figure><h4 id="条件更新">条件更新</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新用户名为jack的的余额为2000元</span></span><br><span class="line"><span class="comment">// 1.要更新的数据</span></span><br><span class="line"><span class="type">user</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">user.setBalance (<span class="number">2000</span>);</span><br><span class="line"><span class="comment">// 2.更新的条件</span></span><br><span class="line">Querywrapperuser&gt; wrapper = <span class="keyword">new</span> <span class="title class_">Querywrapper</span>&lt;User&gt;()</span><br><span class="line">    .eq( column: <span class="string">&quot;username&quot;</span>，val: <span class="string">&quot;jack&quot;</span>);</span><br><span class="line"><span class="comment">//3.执行更新</span></span><br><span class="line">userMapper.update(user,wrapper);</span><br></pre></td></tr></table></figure><h4 id="条件更新-1">条件更新</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新id为1，2，4的用户余额扣100</span></span><br><span class="line">List&lt;Long&gt; ids = List.of(<span class="number">1L</span>，<span class="number">2L</span>，<span class="number">4L</span>);</span><br><span class="line">updatewrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">Updatewrapper</span>&lt;User&gt; ()</span><br><span class="line">    .setsql( <span class="string">&quot;balance = balance - 200&quot;</span>)</span><br><span class="line">    .in( column: <span class="string">&quot;id, ids);</span></span><br><span class="line"><span class="string">userMapper.update( null, wrapper) ;</span></span><br></pre></td></tr></table></figure><h4 id="自定义sql">自定义SQL</h4><p>我们可以利用MyBatisPlus的Wrapper来构建复杂的Where条件，然后自己定义SQL语句中剩下的部分。</p><ol type="1"><li>基于Wrapper构建where条件</li><li>在mapper方法参数中用Param注解声明wrapper变量名称，必须是ew</li><li>自定义SQL，并且使用wrapper条件</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68731e6092394.png" alt="image-20250713104756971"></p><h4 id="service接口iservice">Service接口–IService</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/687321021b3e5.png" alt="image-20250713105909031"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/687322560f0d9.png" alt="image-20250713110450874"></p><p>自定义Service去继承Iservice（要指定实体泛型），自定义ServiceImpl去继承ServiceImpl（要指定Mapper泛型和实体泛型）</p><p>eg：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserserice</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServigeImpl</span>&lt;UserMapper，User&gt; <span class="keyword">implements</span> <span class="title class_">TUserService</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="15-restful风格接口">1.5 Restful风格接口</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68733109e18c1.png" alt="image-20250713120734859"></p><p>后端传给前端要定义VO，前端传给后端定义DTO</p><p>这里有一个我之前没有注意的点，po要转为vo，可以使用<code>hutool</code>工具包进行拷贝</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BeanUtil.copyproperties(原始实体，目标实体)</span><br></pre></td></tr></table></figure><h3 id="16-逻辑删除">1.6 逻辑删除</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734a0b9ec3e.png" alt="image-20250713135411266"></p><h3 id="17-枚举处理器">1.7 枚举处理器</h3><ol type="1"><li>在枚举类的值上添加<code>@EnumValue</code>注解</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734c7b05f15.png" alt="image-20250713140439923"></p><ol start="2" type="1"><li><p>配置全局枚举处理器</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="18-json类型处理器">1.8 JSON类型处理器</h3><ol type="1"><li>首先定义一个单独的JSON实体</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734ef1d9262.png" alt="image-20250713141511161"></p><ol start="2" type="1"><li>然后将User类的info字段修改为UserInfo类型，并声明类型处理器：</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734ee32877a.png" alt="image-20250713141456253"></p><ol start="3" type="1"><li>在类上开启自动映射（这里设置autoResultMap = true是因为MyBatis-Plus对于这种类中再嵌套一个自定义类的，是需要手动在.xml中定义相关字段等，或者像这样开启自动映射）</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734f1e6a5ac.png" alt="image-20250713141555704"></p><h3 id="19-分页插件">1.9 分页插件</h3><p>在未引入分页插件的情况下，<code>MybatisPlus</code>是不支持分页功能的，<code>IService</code>和<code>BaseMapper</code>中的分页方法都无法正常起效。 所以，我们必须配置分页插件。</p><p>新建<code>MybatisConfig.java</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化核心插件</span></span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="comment">// 添加分页插件</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写分页查询的测试</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPageQuery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.分页查询，new Page()的两个参数分别是：页码、每页大小</span></span><br><span class="line">    Page&lt;User&gt; p = userService.page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">2</span>, <span class="number">2</span>));</span><br><span class="line">    <span class="comment">// 2.总条数</span></span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + p.getTotal());</span><br><span class="line">    <span class="comment">// 3.总页数</span></span><br><span class="line">    System.out.println(<span class="string">&quot;pages = &quot;</span> + p.getPages());</span><br><span class="line">    <span class="comment">// 4.数据</span></span><br><span class="line">    List&lt;User&gt; records = p.getRecords();</span><br><span class="line">    records.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以支持排序(根据balance排序，false是降序)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1</span>, pageSize = <span class="number">5</span>;</span><br><span class="line"><span class="comment">// 分页参数</span></span><br><span class="line">Page&lt;User&gt; page = Page.of(pageNo, pageSize);</span><br><span class="line"><span class="comment">// 排序参数, 通过OrderItem来指定</span></span><br><span class="line">page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;balance&quot;</span>, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">userService.page(page);</span><br></pre></td></tr></table></figure><h4 id="通用分页查询案例">通用分页查询案例</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68735433538aa.png" alt="image-20250713143735745"></p><ol type="1"><li><p>定义一个统一的分页查询条件的实体，包含分页、排序参数、过滤条件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页查询实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageSize;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;排序字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sortBy;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否升序&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isAsc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后让我们需要分页的实体去继承分页实体</p><p><code>callSuper = true</code>根据子类自身的字段值和从父类继承的字段值 来生成hashcode，当两个子类对象比较时，只有子类对象的本身的字段值和继承父类的字段值都相同，equals方法的返回值是true</p><p><code>@EqualsAndHashCode</code> 用于自动生成 equals() 和 hashCode() 方法，并且在比较时，调用父类（super）的 equals() 和 hashCode() 方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;用户查询条件实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserQuery</span> <span class="keyword">extends</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名关键字&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户状态：1-正常，2-冻结&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最小值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer minBalance;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最大值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer maxBalance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>新建统一返回结果集</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页结果&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总条数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总页数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pages;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;集合&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>分页查询代码示例</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageDTO&lt;UserVO&gt; <span class="title function_">queryUsersPage</span><span class="params">(PageQuery query)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建条件</span></span><br><span class="line">    <span class="comment">// 1.1.分页条件</span></span><br><span class="line">    Page&lt;User&gt; page = Page.of(query.getPageNo(), query.getPageSize());</span><br><span class="line">    <span class="comment">// 1.2.排序条件</span></span><br><span class="line">    <span class="keyword">if</span> (query.getSortBy() != <span class="literal">null</span>) &#123;</span><br><span class="line">        page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(query.getSortBy(), query.getIsAsc()));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 默认按照更新时间排序</span></span><br><span class="line">        page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;update_time&quot;</span>, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.查询</span></span><br><span class="line">    page(page);</span><br><span class="line">    <span class="comment">// 3.数据非空校验</span></span><br><span class="line">    List&lt;User&gt; records = page.getRecords();</span><br><span class="line">    <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 无数据，返回空结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(page.getTotal(), page.getPages(), Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.有数据，转换</span></span><br><span class="line">    List&lt;UserVO&gt; list = BeanUtil.copyToList(records, UserVO.class);</span><br><span class="line">    <span class="comment">// 5.封装返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;UserVO&gt;(page.getTotal(), page.getPages(), list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="将分页条件封装在工具类中">将分页条件封装在工具类中</h4><p><code>PageQuery</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageNo=<span class="number">1</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageSize=<span class="number">10</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;排序字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sortBy;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否升序&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isAsc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt;  Page&lt;T&gt; <span class="title function_">toMpPage</span><span class="params">(OrderItem ... orders)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.分页条件</span></span><br><span class="line">        Page&lt;T&gt; p = Page.of(pageNo, pageSize);</span><br><span class="line">        <span class="comment">// 2.排序条件</span></span><br><span class="line">        <span class="comment">// 2.1.先看前端有没有传排序字段</span></span><br><span class="line">        <span class="keyword">if</span> (sortBy != <span class="literal">null</span>) &#123;</span><br><span class="line">            p.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(sortBy, isAsc));</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.2.再看有没有手动指定排序字段</span></span><br><span class="line">        <span class="keyword">if</span>(orders != <span class="literal">null</span>)&#123;</span><br><span class="line">            p.addOrder(orders);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPage</span><span class="params">(String defaultSortBy, <span class="type">boolean</span> isAsc)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.toMpPage(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(defaultSortBy, isAsc));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPageDefaultSortByCreateTimeDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toMpPage(<span class="string">&quot;create_time&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPageDefaultSortByUpdateTimeDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toMpPage(<span class="string">&quot;update_time&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PageDTO</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.mp.domain.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="keyword">private</span> Long pages;</span><br><span class="line">    <span class="keyword">private</span> List&lt;V&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回空分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlus的分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; 目标VO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; 原始PO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VO的分页对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">empty</span><span class="params">(Page&lt;P&gt; p)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将MybatisPlus分页结果转为 VO分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlus的分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voClass 目标VO类型的字节码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; 目标VO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; 原始PO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VO的分页对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">of</span><span class="params">(Page&lt;P&gt; p, Class&lt;V&gt; voClass)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.非空校验</span></span><br><span class="line">        List&lt;P&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 无数据，返回空结果</span></span><br><span class="line">            <span class="keyword">return</span> empty(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.数据转换</span></span><br><span class="line">        List&lt;V&gt; vos = BeanUtil.copyToList(records, voClass);</span><br><span class="line">        <span class="comment">// 3.封装返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), vos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将MybatisPlus分页结果转为 VO分页结果，允许用户自定义PO到VO的转换方式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlus的分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> convertor PO到VO的转换函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; 目标VO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; 原始PO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VO的分页对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">of</span><span class="params">(Page&lt;P&gt; p, Function&lt;P, V&gt; convertor)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.非空校验</span></span><br><span class="line">        List&lt;P&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 无数据，返回空结果</span></span><br><span class="line">            <span class="keyword">return</span> empty(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.数据转换</span></span><br><span class="line">        List&lt;V&gt; vos = records.stream().map(convertor).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 3.封装返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), vos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>业务层代码可简化为</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageDTO&lt;UserVO&gt; <span class="title function_">queryUserByPage</span><span class="params">(PageQuery query)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建条件</span></span><br><span class="line">    Page&lt;User&gt; page = query.toMpPageDefaultSortByCreateTimeDesc();</span><br><span class="line">    <span class="comment">// 2.查询</span></span><br><span class="line">    page(page);</span><br><span class="line">    <span class="comment">// 3.封装返回</span></span><br><span class="line">    <span class="keyword">return</span> PageDTO.of(page, user -&gt; &#123;</span><br><span class="line">        <span class="comment">// 拷贝属性到VO</span></span><br><span class="line">        <span class="type">UserVO</span> <span class="variable">vo</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserVO.class);</span><br><span class="line">        <span class="comment">// 用户名脱敏</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> vo.getUsername();</span><br><span class="line">        vo.setUsername(username.substring(<span class="number">0</span>, username.length() - <span class="number">2</span>) + <span class="string">&quot;**&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2docker">2.Docker</h2><h3 id="1-安装问题">1. 安装问题</h3><h4 id="1-解决配置网络时es33显示被已拔出问题">1. 解决配置网络时es33显示被已拔出问题</h4><p>在电脑服务中开启VMware DHCP Service”和“VMware NAT Service”。即可</p><h4 id="2-解决docker镜像问题">2. 解决Docker镜像问题</h4><p>操她奶奶的，你妹的傻鸟Docker，用老师安装的方式一直不成功，最终在评论区找到答案</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">无法安装docker 建议直接：bash &lt;(curl -sSL https:<span class="comment">//linuxmirrors.cn/docker.sh)  这条命令，一次性全安装完毕</span></span><br></pre></td></tr></table></figure><h3 id="2-安装mysql">2. 安装MySQL</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> mysql \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line">  <span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line">  <span class="literal">-e</span> MYSQL_ROOT_PASSWORD=abc123 \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;  <span class="string">&quot;registry-mirrors&quot;</span>: [   </span><br><span class="line">        <span class="string">&quot;https://docker-0.unsee.tech&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;https://docker-cf.registry.cyou&quot;</span>,   </span><br><span class="line">        <span class="string">&quot;https://docker.1panel.live&quot;</span>  </span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="3-docker常见命令">3. Docker常见命令</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68743df04bd52.png" alt="img"></p><table><thead><tr><th style="text-align:center">命令</th><th style="text-align:center">说明</th><th style="text-align:center">文档地址</th></tr></thead><tbody><tr><td style="text-align:center">docker images</td><td style="text-align:center">查看本地镜像</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/images/">docker images</a></td></tr><tr><td style="text-align:center">docker rmi</td><td style="text-align:center">删除本地镜像</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a></td></tr><tr><td style="text-align:center">docker run</td><td style="text-align:center">创建并运行容器（不能重复创建）</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></td></tr><tr><td style="text-align:center">docker stop</td><td style="text-align:center">停止指定容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></td></tr><tr><td style="text-align:center">docker start</td><td style="text-align:center">启动指定容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/start/">docker start</a></td></tr><tr><td style="text-align:center">docker restart</td><td style="text-align:center">重新启动容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/restart/">docker restart</a></td></tr><tr><td style="text-align:center">docker rm</td><td style="text-align:center">删除指定容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rm/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker ps</td><td style="text-align:center">查看容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/ps/">docker ps</a></td></tr><tr><td style="text-align:center">docker logs</td><td style="text-align:center">查看容器运行日志</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/logs/">docker logs</a></td></tr><tr><td style="text-align:center">docker exec</td><td style="text-align:center">进入容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a></td></tr><tr><td style="text-align:center">docker save</td><td style="text-align:center">保存镜像到本地压缩文件</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/save/">docker save</a></td></tr><tr><td style="text-align:center">docker load</td><td style="text-align:center">加载本地压缩文件到镜像</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/load/">docker load</a></td></tr><tr><td style="text-align:center">docker inspect</td><td style="text-align:center">查看容器详细信息</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/inspect/">docker inspect</a></td></tr></tbody></table><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68743f28292ae.png" alt="image-20250714072007387"></p><p>如何把镜像交给运维人员：1.使用docker save形成本地压缩包，运维人员再使用docker load将本地这个压缩包进行解压；2.将镜像推送到镜像仓库，运维人员再从镜像仓库进行拉取</p><h3 id="4-数据卷">4. 数据卷</h3><p>容器是隔离环境，容器内程序的文件、配置、运行时产生的容器都在容器内部，我们要读写容器内的文件非常不方便。大家思考几个问题：</p><ul><li>如果要升级MySQL版本，需要销毁旧容器，那么数据岂不是跟着被销毁了？</li><li>MySQL、Nginx容器运行后，如果我要修改其中的某些配置该怎么办？</li><li>我想要让Nginx代理我的静态资源怎么办？</li></ul><p>因此，容器提供程序的运行环境，但是<strong>程序运行产生的数据、程序运行依赖的配置都应该与容器解耦</strong>。</p><h4 id="41-什么是数据卷">4.1 什么是数据卷</h4><p><strong>数据卷（volume）<strong>是一个虚拟目录，是</strong>容器内目录</strong>与<strong>宿主机目录</strong>之间映射的桥梁。（ps：其实类似于双向绑定，修改数据卷里面的nginx内容，实际的nginx的内容也会修改）</p><p>以Nginx为例，我们知道Nginx中有两个关键的目录：</p><ul><li><code>html</code>：放置一些静态资源</li><li><code>conf</code>：放置配置文件</li></ul><p>如果我们要让Nginx代理我们的静态资源，最好是放到<code>html</code>目录；如果我们要修改Nginx的配置，最好是找到<code>conf</code>下的<code>nginx.conf</code>文件。</p><p>但遗憾的是，容器运行的Nginx所有的文件都在容器内部。所以我们必须利用数据卷将两个目录与宿主机目录关联，方便我们操作。如图：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/687441cd20ef8.png" alt="image-20250714073124180"></p><p>在上图中：</p><ul><li>我们创建了两个数据卷：<code>conf</code>、<code>html</code></li><li>Nginx容器内部的<code>conf</code>目录和<code>html</code>目录分别与两个数据卷关联。</li><li>而数据卷conf和html分别指向了宿主机的<code>/var/lib/docker/volumes/conf/_data</code>目录和<code>/var/lib/docker/volumes/html/_data</code>目录</li></ul><p>这样以来，容器内的<code>conf</code>和<code>html</code>目录就 与宿主机的<code>conf</code>和<code>html</code>目录关联起来，我们称为<strong>挂载</strong>。此时，我们操作宿主机的<code>/var/lib/docker/volumes/html/_data</code>就是在操作容器内的<code>/usr/share/nginx/html/_data</code>目录。只要我们将静态资源放入宿主机对应目录，就可以被Nginx代理了。</p><h4 id="42-数据卷的命令">4.2 数据卷的命令</h4><table><thead><tr><th style="text-align:center"><strong>命令</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>文档地址</strong></th></tr></thead><tbody><tr><td style="text-align:center">docker volume create</td><td style="text-align:center">创建数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_create/">docker volume create</a></td></tr><tr><td style="text-align:center">docker volume ls</td><td style="text-align:center">查看所有数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_ls/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker volume rm</td><td style="text-align:center">删除指定数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker volume inspect</td><td style="text-align:center">查看某个数据卷的详情</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_inspect/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker volume prune</td><td style="text-align:center">清除数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docker volume prune</a></td></tr></tbody></table><p>注意：容器与数据卷的挂载要在创建容器时配置，对于创建好的容器，是不能设置数据卷的。而且<strong>创建容器的过程中，数据卷会自动创建</strong>。</p><p>如何挂载数据卷？</p><ul><li>在创建容器时，利用-v数据卷名:容器内目录完成挂载</li><li>容器创建时，如果发现挂载的数据卷不存在时，会自动创建</li></ul><h4 id="43-创建nginx-数据卷">4.3 创建Nginx 数据卷</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68744990bc1b6.png" alt="image-20250714080431521"> 哇神奇</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker rm -f nginx</span></span><br><span class="line">nginx</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker run -d --name nginx -p 80:80 -v html:/usr/share/nginx/html nginx</span></span><br><span class="line">d7d95a4dd8cb76b5a4baeb1a17ab2f5acbfdfe34844da319d3c7e30bfa1be047</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                   CREATED             STATUS             PORTS                                                  NAMES</span><br><span class="line">d7d95a4dd8cb   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">8</span> seconds ago       Up <span class="number">7</span> seconds       <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp, :::<span class="number">80</span>-&gt;<span class="number">80</span>/tcp                      nginx</span><br><span class="line"><span class="number">5</span>bb7b84c208d   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   About an hour ago   Up About an hour   <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">3306</span>-&gt;<span class="number">3306</span>/tcp, :::<span class="number">3306</span>-&gt;<span class="number">3306</span>/tcp, <span class="number">33060</span>/tcp   mysql</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     f029801a77bbe84d7ee550a9cce21abf4644a56906111cc68be691efd9495a9e</span><br><span class="line">local     html</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker volume inspect html</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2025-07-13T22:12:13+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: <span class="type">null</span>,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/html/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: <span class="type">null</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cd /var/lib/docker/volumes/html/_data</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">_data</span>]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是 Docker 的默认存储位置，所有命名卷都会存放在 <code>/var/lib/docker/volumes/&lt;卷名&gt;/_data</code> 下</p><p>volume对应的宿主机目录，html是虚拟目录 ，<code>/usr/share/nginx/html</code> 容器内的对应目录</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68746bec07642.png" alt="image-20250714103106907"></p><h4 id="44-mysql-容器的数据挂载">4.4 MySQL 容器的数据挂载</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker inspect mysql</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;e4c3c8923f08031b15e4590cbc0a10209867ac4793a46ac409e4ae3d6923cea9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-07-13T18:25:21.488931875Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;docker-entrypoint.sh&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;mysqld&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;running&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Running&quot;</span>: <span class="type">true</span>,</span><br><span class="line">            <span class="string">&quot;Paused&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Restarting&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;OOMKilled&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Dead&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Pid&quot;</span>: <span class="number">52260</span>,</span><br><span class="line">            <span class="string">&quot;ExitCode&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2025-07-13T18:25:21.819305537Z&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line"> </span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;c5ab9bdf061d55de6fc1d602ff8e644d915611171539536ea48f1ba0b5092d5e&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/c5ab9bdf061d55de6fc1d602ff8e644d915611171539536ea48f1ba0b5092d5e/_data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RW&quot;</span>: <span class="type">true</span>,</span><br><span class="line">                <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;e4c3c8923f08&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;3306/tcp&quot;</span>: &#123;&#125;,</span><br><span class="line">                <span class="string">&quot;33060/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;TZ=Asia/Shanghai&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_ROOT_PASSWORD=abc123&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;GOSU_VERSION=1.17&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_MAJOR=innovation&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_VERSION=9.3.0-1.el9&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_SHELL_VERSION=9.3.0-1.el9&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;mysqld&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;/var/lib/mysql&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;docker-entrypoint.sh&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: <span class="type">null</span>,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;NetworkSettings&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Bridge&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxID&quot;</span>: <span class="string">&quot;bbc2939d84f12f3ba3b2063229491abfaf2b0ee8a52b7b3d605792017b49f3a5&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxKey&quot;</span>: <span class="string">&quot;/var/run/docker/netns/bbc2939d84f1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Ports&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;3306/tcp&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;3306&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;::&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;3306&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;33060/tcp&quot;</span>: <span class="type">null</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;HairpinMode&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6PrefixLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: <span class="type">null</span>,</span><br><span class="line">            <span class="string">&quot;SecondaryIPv6Addresses&quot;</span>: <span class="type">null</span>,</span><br><span class="line">            <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;67d5ed6abb8444918c766a0e9be1ba00a6ed7d9f32d55155e1b7924466ee1a0d&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IPPrefixLen&quot;</span>: <span class="number">16</span>,</span><br><span class="line">            <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Networks&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;bridge&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;IPAMConfig&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;Links&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;Aliases&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;2bcb6623ac17cfcba762bc1efedf14674fe023680a15b89e4f5f687f76ad2d90&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;67d5ed6abb8444918c766a0e9be1ba00a6ed7d9f32d55155e1b7924466ee1a0d&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPPrefixLen&quot;</span>: <span class="number">16</span>,</span><br><span class="line">                    <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&quot;DriverOpts&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;DNSNames&quot;</span>: <span class="type">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>发现有默认的数据挂载，但是默认匿名挂载名字复杂目录太深了，下面给他修改到挂载到根目录</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> mysql \</span><br><span class="line"><span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line"><span class="literal">-e</span> Tz=Asia/Shanghai \</span><br><span class="line"><span class="literal">-e</span> MYSQL_ROOT_PASSWORD=abc123 \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/<span class="keyword">data</span>:/var/lib/mysql \</span><br><span class="line"><span class="literal">-v</span> /root/mysq1/conf:/etc/mysq1/conf.d \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/init:/docker<span class="literal">-entrypoint-initdb</span>.d \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><p>注意：SQL文件必须要有创建数据库的命令，不然无法创建成功数据库</p><p>然后将SQL文件放在init文件夹里面</p><p>运行</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> mysql \</span><br><span class="line"><span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line"><span class="literal">-e</span> Tz=Asia/Shanghai \</span><br><span class="line"><span class="literal">-e</span> MYSQL_ROOT_PASSWORD=abc123 \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/<span class="keyword">data</span>:/var/lib/mysql \</span><br><span class="line"><span class="literal">-v</span> /root/mysq1/conf:/etc/mysq1/conf.d \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/init:/docker<span class="literal">-entrypoint-initdb</span>.d \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><p>即可</p><h3 id="5-自定义镜像">5. 自定义镜像</h3><p>镜像就是包含了应用程序、程序运行的系统函数库、运行配置等文件的文件包。构建镜像的过程其实就是把上述文件打包的过程。</p><p>由于制作镜像的过程中，需要逐层处理和打包，比较复杂，所以Docker就提供了自动打包镜像的功能。我们只需要将打包的过程，每一层要做的事情用固定的语法写下来，交给Docker去执行即可。而这种记录镜像结构的文件就称为<strong>Dockerfile</strong></p><table><thead><tr><th style="text-align:center"><strong>指令</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>示例</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>FROM</strong></td><td style="text-align:center">指定基础镜像</td><td style="text-align:center"><code>FROM centos:6</code></td></tr><tr><td style="text-align:center"><strong>ENV</strong></td><td style="text-align:center">设置环境变量，可在后面指令使用</td><td style="text-align:center"><code>ENV key value</code></td></tr><tr><td style="text-align:center"><strong>COPY</strong></td><td style="text-align:center">拷贝本地文件到镜像的指定目录</td><td style="text-align:center"><code>COPY ./xx.jar /tmp/app.jar</code></td></tr><tr><td style="text-align:center"><strong>RUN</strong></td><td style="text-align:center">执行Linux的shell命令，一般是安装过程的命令</td><td style="text-align:center"><code>RUN yum install gcc</code></td></tr><tr><td style="text-align:center"><strong>EXPOSE</strong></td><td style="text-align:center">指定容器运行时监听的端口，是给镜像使用者看的</td><td style="text-align:center"><code>EXPOSE 8080</code></td></tr><tr><td style="text-align:center"><strong>ENTRYPOINT</strong></td><td style="text-align:center">镜像中应用的启动命令，容器运行时调用</td><td style="text-align:center"><code>ENTRYPOINT java -jar xx.jar</code></td></tr></tbody></table><h3 id="6-网络">6. 网络</h3><p>容器的网络IP其实是一个虚拟的IP，其值并不固定与某一个容器绑定，如果我们在开发时写死某个IP，而在部署时很可能MySQL容器的IP会发生变化，连接会失败。</p><p>所以，我们必须借助于docker的网络功能来解决这个问题 常见命令</p><table><thead><tr><th style="text-align:center"><strong>命令</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>文档地址</strong></th></tr></thead><tbody><tr><td style="text-align:center">docker network create</td><td style="text-align:center">创建一个网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_create/">docker network create</a></td></tr><tr><td style="text-align:center">docker network ls</td><td style="text-align:center">查看所有网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_ls/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network rm</td><td style="text-align:center">删除指定网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_rm/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network prune</td><td style="text-align:center">清除未使用的网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_prune/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network connect</td><td style="text-align:center">使指定容器连接加入某网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_connect/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network disconnect</td><td style="text-align:center">使指定容器连接离开某网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_disconnect/">docker network disconnect</a></td></tr><tr><td style="text-align:center">docker network inspect</td><td style="text-align:center">查看网络详细信息</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_inspect/">docker network inspect</a></td></tr></tbody></table><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">mysql</span>]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">f1a34d4477b4   baskly    bridge    local</span><br><span class="line"><span class="number">2</span>bcb6623ac17   bridge    bridge    local</span><br><span class="line">e693457ba93b   host      host      local</span><br><span class="line"><span class="number">028</span>d2b795efa   none      null      local</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">mysql</span>]<span class="comment"># docker network connect baskly mysql</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">mysql</span>]<span class="comment"># docker inspect mysql</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="7使用docker打包项目tlias为例">7.使用Docker打包项目（tlias为例）</h3><blockquote><p>老东西 终于把焚决交出来了</p></blockquote><h4 id="71后端打包">7.1后端打包</h4><ol type="1"><li><p>准备MySQL容器，并且创建tlias数据库以及表结构（上面在本地目录挂载MySQL时已经2完成）</p></li><li><p>准备Java应用（tlias）镜像，部署Docker容器，运行测试</p><ul><li><p>修改tlias项目的配置文件，修改数据库服务地址及logback日志文件存放地址，打jar包。</p></li><li><p>编写Dockerfile文件。</p></li><li><p>构建Docker镜像。</p></li><li><p>部署Docker容器。</p></li></ul></li></ol><h5 id="具体步骤">具体步骤</h5><ol type="1"><li><p>打开idea将yml中数据库连接部分改为Docker中的MySQL</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">   <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">   <span class="attr">url:</span> <span class="string">jdbc:mysql://mysql:3306/tlias?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line">   <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">password:</span> <span class="string">abc123</span></span><br></pre></td></tr></table></figure></li><li><p>在idea中的Maven中的Lifecycle中点击<code>package</code>,等待build成功。然后我们的target文件夹中会出现我们的Jar包了。jar包名字很长可以适当重命名</p></li><li><p>新建Dockerfile</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 CentOS 7 作为基础镜像</span></span><br><span class="line">FROM centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 JDK 到镜像中</span></span><br><span class="line"><span class="built_in">COPY</span> jdk21.tar.gz /usr/local/</span><br><span class="line">RUN tar <span class="literal">-xzf</span> /usr/local/jdk21.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr/local/jdk21.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">ENV JAVA_HOME=/usr/local/jdk<span class="literal">-21</span>.<span class="number">0.1</span></span><br><span class="line">ENV PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置阿里云OSS</span></span><br><span class="line">ENV OSS_ACCESS_KEY_ID=[你的]</span><br><span class="line">ENV OSS_ACCESS_KEY_SECRET=[你的]</span><br><span class="line"><span class="comment">#统一编码</span></span><br><span class="line">ENV LANG=en_US.UTF<span class="literal">-8</span></span><br><span class="line">ENV LANGUAGE=en_US:en</span><br><span class="line">ENV LC_ALL=en_US.UTF<span class="literal">-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用目录</span></span><br><span class="line">RUN mkdir <span class="literal">-p</span> /tlias</span><br><span class="line">WORKDIR /tlias</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用 JAR 文件到容器</span></span><br><span class="line"><span class="built_in">COPY</span>  tlias.jar  tlias.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/tlias/tlias.jar&quot;</span>]</span><br></pre></td></tr></table></figure></li><li><p>在<code>/usr/local/</code>下新建<code>tlias-docker-app</code>文件夹，里面上传进去我们的<code>tlias.jar</code>,<code>Dockerfile</code>,<code>jdk21</code></p></li><li><p>然后去构建Docker镜像</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker build -t tlias:1.0 .</span></span><br><span class="line">[+] Building <span class="number">266.8</span>s (<span class="number">11</span>/<span class="number">11</span>) FINISHED                             docker:default</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load build definition from Dockerfile                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">818</span>B                                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load metadata <span class="keyword">for</span> docker.io/library/centos:<span class="number">7</span>              <span class="number">146.9</span>s</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load .dockerignore                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                            <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">1</span>/<span class="number">6</span>] FROM docker.io/library/centos:<span class="number">7</span>@sha256:be65f488b7764ad3638f23  <span class="number">111.2</span>s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/centos:<span class="number">7</span>@sha256:be65f488b7764ad3638f236b  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:eeb6ee3f44bd0b5103bb561b4c16bcb82328cfe5809 <span class="number">2.75</span>kB / <span class="number">2.75</span>kB  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:<span class="number">2</span>d473b07cdd5f0912cd6f1a703352c82b512407 <span class="number">76.10</span>MB / <span class="number">76.10</span>MB  <span class="number">103.9</span>s</span><br><span class="line"> =&gt; =&gt; sha256:be65f488b7764ad3638f236b7b515b3678369a5124c <span class="number">1.20</span>kB / <span class="number">1.20</span>kB  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:dead07b4d8ed7e29e98de0f4504d87e8880d4347859d839 <span class="number">529</span>B / <span class="number">529</span>B  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; extracting sha256:<span class="number">2</span>d473b07cdd5f0912cd6f1a703352c82b512407db6b05b43  <span class="number">7.1</span>s</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load build context                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">173</span>B                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">2</span>/<span class="number">6</span>] <span class="built_in">COPY</span> jdk21.tar.gz /usr/local/                                    <span class="number">2.0</span>s</span><br><span class="line"> =&gt; [<span class="number">3</span>/<span class="number">6</span>] RUN tar <span class="literal">-xzf</span> /usr/local/jdk21.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr  <span class="number">5.4</span>s</span><br><span class="line"> =&gt; [<span class="number">4</span>/<span class="number">6</span>] RUN mkdir <span class="literal">-p</span> /tlias                                              <span class="number">0.4</span>s</span><br><span class="line"> =&gt; [<span class="number">5</span>/<span class="number">6</span>] WORKDIR /tlias                                                   <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">6</span>/<span class="number">6</span>] <span class="built_in">COPY</span>  tlias.jar  tlias.jar                                       <span class="number">0.1</span>s</span><br><span class="line"> =&gt; exporting to image                                                     <span class="number">0.7</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                    <span class="number">0.6</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:<span class="number">8</span>b8dd47f37a8752599c8d24b4b01dcce96ccb2469d4f4  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/tlias:<span class="number">1.0</span>                               <span class="number">0.0</span>s</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">tlias        <span class="number">1.0</span>       <span class="number">8</span>b8dd47f37a8   About a minute ago   <span class="number">783</span>MB</span><br><span class="line">redis        latest    f2cd22713a18   <span class="number">7</span> days ago           <span class="number">128</span>MB</span><br><span class="line">nginx        latest    <span class="number">9592</span>f5595f2b   <span class="number">2</span> weeks ago          <span class="number">192</span>MB</span><br><span class="line">mysql        latest    <span class="number">4</span>c2531d6bf10   <span class="number">2</span> months ago         <span class="number">859</span>MB</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>取名字为tlias，版本1.0，在当前文件夹里</p></li><li><p>部署docker容器</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker run -d --name tlias-server -p 8080:8080 --network baskly tlias:1.0</span></span><br><span class="line">ffc30c9fde8cf187b0c035e1fd27b12417ebcf988af34b3779c2cf50040f7a4d</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                   CREATED          STATUS          PORTS   NAMES</span><br><span class="line">ffc30c9fde8c   tlias:<span class="number">1.0</span>   <span class="string">&quot;java -jar /tlias/tl…&quot;</span>   <span class="number">18</span> seconds ago   Up <span class="number">17</span> seconds   <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp, :::<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp   tlias<span class="literal">-server</span></span><br></pre></td></tr></table></figure></li><li><p>使用<code>docker logs -f tlias-service</code> 查看后端启动日志</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[root<span class="meta">@localhost</span> tlias-docker-app]# docker logs -f tlias-server</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | &#x27;</span>_ | <span class="string">&#x27;_| | &#x27;</span>_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">&#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> :: Spring Boot ::                (v3.4.4)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2025-07-13T21:02:32.843Z  INFO 1 --- [tlias-web-managemen] [           main] c.itheima.TliasWebManagemenApplication   : Starting TliasWebManagemenApplication v0.0.1-SNAPSHOT using Java 21.0.1 with PID 1 (/tlias/tlias.jar started by root in /tlias)</span></span><br><span class="line"><span class="string">2025-07-13T21:02:32.849Z  INFO 1 --- [tlias-web-managemen] [           main] c.itheima.TliasWebManagemenApplication   : No active profile set, falling back to 1 default profile: &quot;default&quot;</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.395Z  INFO 1 --- [tlias-web-managemen] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port 8080 (http)</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.427Z  INFO 1 --- [tlias-web-managemen] [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.428Z  INFO 1 --- [tlias-web-managemen] [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.39]</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.493Z  INFO 1 --- [tlias-web-managemen] [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.495Z  INFO 1 --- [tlias-web-managemen] [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 2524 ms</span></span><br><span class="line"><span class="string">Logging initialized using &#x27;</span><span class="keyword">class</span> <span class="title class_">org</span>.apache.ibatis.logging.stdout.StdOutImpl<span class="string">&#x27; adapter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">,------.                           ,--.  ,--.         ,--.</span></span><br><span class="line"><span class="string">|  .--. &#x27;</span>  ,--,--.  ,---.   ,---.  |  <span class="string">&#x27;--&#x27;</span>  |  ,---.  |  |  ,---.   ,---.  ,--.--.</span><br><span class="line">|  <span class="string">&#x27;--&#x27;</span> | <span class="string">&#x27; ,-.  | | .-. | | .-. : |  .--.  | | .-. : |  | | .-. | | .-. : |  .--&#x27;</span></span><br><span class="line">|  | --<span class="string">&#x27;  \ &#x27;</span>-<span class="string">&#x27;  | &#x27;</span> <span class="string">&#x27;-&#x27;</span> <span class="string">&#x27; \   --. |  |  |  | \   --. |  | | &#x27;</span>-<span class="string">&#x27; &#x27;</span> \   --. |  |</span><br><span class="line">`--<span class="string">&#x27;       `--`--&#x27;</span> .`-  /   `----<span class="string">&#x27; `--&#x27;</span>  `--<span class="string">&#x27;  `----&#x27;</span> `--<span class="string">&#x27; |  |-&#x27;</span>   `----<span class="string">&#x27; `--&#x27;</span></span><br><span class="line">                   `---<span class="string">&#x27;                                   `--&#x27;</span>                        is intercepting.</span><br><span class="line"></span><br><span class="line"><span class="number">2025</span>-<span class="number">07</span>-13T21:<span class="number">02</span>:<span class="number">37.</span>128Z  INFO <span class="number">1</span> --- [tlias-web-managemen] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port <span class="number">8080</span> (http) with context path <span class="string">&#x27;/&#x27;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">07</span>-13T21:<span class="number">02</span>:<span class="number">37.</span>149Z  INFO <span class="number">1</span> --- [tlias-web-managemen] [           main] c.itheima.TliasWebManagemenApplication   : Started TliasWebManagemenApplication in <span class="number">5.209</span> seconds (process running <span class="keyword">for</span> <span class="number">5.838</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>这样我们的项目就启动成功了使用ApiFox发送请求也能正常输出结果 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874a49234ca3.png" alt="image-20250714143249324"></p></li></ol><h4 id="72-前端项目部署">7.2. 前端项目部署</h4><p>创建一个新的nginx容器，将资料中提供的前端项目的静态资源部署到nginx中。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874a598518f0.png" alt="image-20250714143712192"></p><ol type="1"><li><p>在root文件夹下创建一个新文件夹用于映射Nginx，名字叫<code>tlias-nginx</code>。</p></li><li><p>然后配置挂载</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"> <span class="literal">--name</span> nginx<span class="literal">-tlias</span> \</span><br><span class="line"> <span class="literal">-v</span> /root/tlias<span class="literal">-nginx</span>/html:/usr/share/nginx/html \</span><br><span class="line"> <span class="literal">-v</span> /root/tlias<span class="literal">-nginx</span>/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line"> <span class="literal">--network</span> baskly \</span><br><span class="line"> <span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> \</span><br><span class="line">nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure></li><li><p>然后访问（未开启需要开启一下服务）</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装ntpdate（若未安装）</span></span><br><span class="line">sudo yum install <span class="literal">-y</span> ntpdate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步阿里云时间服务器（北京时间）</span></span><br><span class="line">sudo ntpdate ntp.aliyun.com</span><br></pre></td></tr></table></figure><p>解决因为Linux时间和系统系统不符导致的时区不同步问题</p></li></ol><h3 id="8-dockercompose">8. DockerCompose</h3><blockquote><p>老东西 把异火也交出来了</p></blockquote><p>Docker Compose通过一个单独的docker-compose.yml模板文件（YANL 格式）来定义一组相关联的应用容器，帮助我们实现多个相互关联的Docker容器的快速部署。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874b22bd22c4.png" alt="image-20250714153048956"></p><p>现在我们使用DockerCompose来重新构建项目</p><ul><li>准备资源（tlias.sql，服务端的jdk17、jar包、Dockerfile，前端项目打包文件、nginx.conf)</li><li>准备docker-compose.yml配置文件</li><li>基于DockerCompose快速构建项目</li></ul><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">abc123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/init:/docker-entrypoint-initdb.d&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">  <span class="attr">tlias:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">tlias-server</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-tlias</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/conf/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">tlias-net:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">itheima</span></span><br></pre></td></tr></table></figure><p>根据compose定义的路径在文件夹下新建空文件夹，然后将以下文件存放在文件夹中</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874bc04e9c7b.png" alt="image-20250714161252989"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker compose [<span class="type">OPTIONS</span>] [<span class="type">COMMAND</span>]</span><br></pre></td></tr></table></figure><p>其中，OPTIONS和COMMAND都是可选参数，比较常见的有：</p><table><thead><tr><th><strong>类型</strong></th><th><strong>参数或指令</strong></th><th style="text-align:center"><strong>说明</strong></th></tr></thead><tbody><tr><td>Options</td><td>-f</td><td style="text-align:center">指定compose文件的路径和名称</td></tr><tr><td></td><td>-p</td><td style="text-align:center">指定project名称。project就是当前compose文件中设置的多个service的集合，是逻辑概念</td></tr><tr><td>Commands</td><td>up</td><td style="text-align:center">创建并启动所有service容器</td></tr><tr><td></td><td>down</td><td style="text-align:center">停止并移除所有容器、网络</td></tr><tr><td></td><td>ps</td><td style="text-align:center">列出所有启动的容器</td></tr><tr><td></td><td>logs</td><td style="text-align:center">查看指定容器的日志</td></tr><tr><td></td><td>stop</td><td style="text-align:center">停止容器</td></tr><tr><td></td><td>start</td><td style="text-align:center">启动容器</td></tr><tr><td></td><td>restart</td><td style="text-align:center">重启容器</td></tr><tr><td></td><td>top</td><td style="text-align:center">查看运行的进程</td></tr><tr><td></td><td>exec</td><td style="text-align:center">在指定的运行中容器中执行命令</td></tr></tbody></table><ol type="1"><li><p>创建容器</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment"># docker compose up -d</span></span><br><span class="line">[+] Running <span class="number">11</span>/<span class="number">11</span></span><br><span class="line"> ✔ mysql Pulled                                                           <span class="number">94.0</span>s</span><br><span class="line">   ✔ <span class="number">90</span>dac1e734aa Already exists                                           <span class="number">0.0</span>s</span><br><span class="line">   ✔ bf40b60a847d Pull complete                                           <span class="number">32.0</span>s</span><br><span class="line">   ✔ <span class="number">9</span>d9cb66e1171 Pull complete                                           <span class="number">32.1</span>s</span><br><span class="line">   ✔ <span class="number">31</span>b29e08d2d1 Pull complete                                           <span class="number">32.8</span>s</span><br><span class="line">   ✔ <span class="number">1</span>f5a1dfb5b55 Pull complete                                           <span class="number">32.8</span>s</span><br><span class="line">   ✔ <span class="number">7</span>becd864c61c Pull complete                                           <span class="number">32.8</span>s</span><br><span class="line">   ✔ <span class="number">00</span>a0a1479659 Pull complete                                           <span class="number">35.0</span>s</span><br><span class="line">   ✔ cff841917be4 Pull complete                                           <span class="number">35.0</span>s</span><br><span class="line">   ✔ <span class="number">8</span>e98c1c43da6 Pull complete                                           <span class="number">76.4</span>s</span><br><span class="line">   ✔ <span class="number">61</span>ba5ff08093 Pull complete                                           <span class="number">76.4</span>s</span><br><span class="line">[+] Building <span class="number">38.5</span>s (<span class="number">11</span>/<span class="number">11</span>) FINISHED                              docker:default</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load build definition from Dockerfile                 <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">818</span>B                                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load metadata <span class="keyword">for</span> docker.io/library/centos:<span class="number">7</span>         <span class="number">36.3</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load .dockerignore                                    <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                            <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="number">1</span>/<span class="number">6</span>] FROM docker.io/library/centos:<span class="number">7</span>@sha256:be65f488b7764ad363  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load build context                                    <span class="number">2.1</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">232.73</span>MB                                      <span class="number">2.1</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">2</span>/<span class="number">6</span>] <span class="built_in">COPY</span> jdk21.tar.gz /usr/local/                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">3</span>/<span class="number">6</span>] RUN tar <span class="literal">-xzf</span> /usr/local/jdk21.tar.gz <span class="literal">-C</span> /usr/local  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">4</span>/<span class="number">6</span>] RUN mkdir <span class="literal">-p</span> /tlias                                 <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">5</span>/<span class="number">6</span>] WORKDIR /tlias                                      <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">6</span>/<span class="number">6</span>] <span class="built_in">COPY</span>  tlias.jar  tlias.jar                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span>] exporting to image                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                    <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:e2a98bd74211094262b8ba068f777e782edeba8b11cdf  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/app<span class="literal">-tlias</span>                               <span class="number">0.0</span>s</span><br><span class="line">[+] Running <span class="number">4</span>/<span class="number">4</span></span><br><span class="line"> ✔ Network itheima         Created                                         <span class="number">0.1</span>s</span><br><span class="line"> ✔ Container mysql         Started                                         <span class="number">1.2</span>s</span><br><span class="line"> ✔ Container tlias<span class="literal">-server</span>  Started                                         <span class="number">1.2</span>s</span><br><span class="line"> ✔ Container nginx<span class="literal">-tlias</span>   Started   </span><br></pre></td></tr></table></figure></li><li><p>开始停止容器</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment"># docker compose stop</span></span><br><span class="line">[+] Stopping <span class="number">3</span>/<span class="number">3</span></span><br><span class="line"> ✔ Container nginx<span class="literal">-tlias</span>   Stopped                                         <span class="number">0.2</span>s</span><br><span class="line"> ✔ Container tlias<span class="literal">-server</span>  Stopped                                         <span class="number">0.2</span>s</span><br><span class="line"> ✔ Container mysql         Stopped                                         <span class="number">2.9</span>s</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment"># docker compose start</span></span><br><span class="line">[+] Running <span class="number">3</span>/<span class="number">3</span></span><br><span class="line"> ✔ Container mysql         Started                                         <span class="number">0.3</span>s</span><br><span class="line"> ✔ Container tlias<span class="literal">-server</span>  Started                                         <span class="number">0.3</span>s</span><br><span class="line"> ✔ Container nginx<span class="literal">-tlias</span>   Started                                         <span class="number">0.4</span>s</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>🥲心心念念的Docker终于结束了</p></li></ol><h1 id="二微服务01">二、微服务01</h1><h3 id="1-导入后端项目">1. 导入后端项目</h3><p>导入后端项目启动项目时报了错误</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.reflect.InaccessibleObjectException</span><br></pre></td></tr></table></figure><p>看弹幕说时因为MyBatisPlus版本与Java高版本冲突导致的反射问题</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874f9c876c67.png" alt="image-20250714203620847"></p><p>配置vm</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="literal">--add-opens</span> java.base/java.lang.invoke=ALL<span class="literal">-UNNAMED</span></span><br></pre></td></tr></table></figure><p>即可解决</p><h4 id="解决时区不同步问题">解决时区不同步问题</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/68759b7de967c.png" alt="image-20250715080613698"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># date</span></span><br><span class="line"><span class="number">2025</span>年 <span class="number">07</span>月 <span class="number">14</span>日 星期一 <span class="number">21</span>:<span class="number">22</span>:<span class="number">05</span> CST</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># hwclock</span></span><br><span class="line"><span class="number">2025</span>年<span class="number">07</span>月<span class="number">14</span>日 星期一 <span class="number">21</span>时<span class="number">22</span>分<span class="number">51</span>秒  <span class="literal">-0</span>.<span class="number">695010</span> 秒</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># systemctl status ntpd</span></span><br><span class="line">● ntpd.service - Network Time Service</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 一 <span class="number">2025</span><span class="literal">-07-14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> CST; <span class="number">10</span><span class="built_in">h</span> ago</span><br><span class="line">  <span class="keyword">Process</span>: <span class="number">43362</span> ExecStart=/usr/sbin/ntpd <span class="literal">-u</span> ntp:ntp <span class="variable">$OPTIONS</span> (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"> Main PID: <span class="number">43363</span> (ntpd)</span><br><span class="line">    Tasks: <span class="number">1</span></span><br><span class="line">   Memory: <span class="number">624.0</span>K</span><br><span class="line">   CGroup: /system.slice/ntpd.service</span><br><span class="line">           └─<span class="number">43363</span> /usr/sbin/ntpd <span class="literal">-u</span> ntp:ntp <span class="literal">-g</span></span><br><span class="line"></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: Listen normally on <span class="number">9</span> ens33 fe80::<span class="number">8396</span>:<span class="number">4</span>bf:<span class="number">9262</span>:f21 UDP <span class="number">123</span></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: Listen normally on <span class="number">10</span> veth1ba4f03 fe80::<span class="number">3</span>cd2:e1ff:fe8b:fa0a UDP <span class="number">123</span></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: Listening on routing socket on fd <span class="comment">#27 for interface updates</span></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c016 <span class="number">06</span> restart</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c012 <span class="number">02</span> freq_set kernel <span class="number">0.000</span> PPM</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c011 <span class="number">01</span> freq_not_set</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost systemd[<span class="number">1</span>]: Started Network Time Service.</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">09</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c61c <span class="number">0</span>c clock_step +<span class="number">38329.171798</span> s</span><br><span class="line"><span class="number">7</span>月 <span class="number">15</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">58</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c614 <span class="number">04</span> freq_mode</span><br><span class="line"><span class="number">7</span>月 <span class="number">15</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">59</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c618 <span class="number">08</span> no_sys_peer</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># date</span></span><br><span class="line"><span class="number">2025</span>年 <span class="number">07</span>月 <span class="number">15</span>日 星期二 <span class="number">08</span>:<span class="number">02</span>:<span class="number">44</span> CST</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-单体架构与微服务">2. 单体架构与微服务</h3><p>单体架构:将业务的所有功能集中在一个项目中开发，打成一个包部署。</p><p>优点：架构简单，部署成本低</p><p>缺点：团队协作成本高，系统发布效率低，系统可用性差</p><p>微服务架构，是服务化思想指导下的一套最佳实践架构方案。服务化，就是把单体架构中的功能模块拆分为多个独立项目。</p><h3 id="3-微服务拆分原则">3. 微服务拆分原则</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/68759e54a2d78.png" alt="image-20250715081827665"></p><p>什么时候需要拆分微服务？</p><ul><li>如果是创业型公司，最好先用单体架构快速迭代开发，验证市场运作模型，快速试错。当业务跑通以后，随着业务规模扩大、人员规模增加，再考虑拆分微服务。</li><li>如果是大型企业，有充足的资源，可以在项目开始之初就搭建微服务架构</li></ul><p>如何拆分？</p><ul><li>首先要做到高内聚、低耦合</li><li>从拆分方式来说，有横向拆分和纵向拆分两种。纵向就是按照业务功能模块，横向则是拆分通用性业务，提高复用性</li></ul><p>服务拆分之后，不可避免的会出现跨微服务的业务，此时微服务之间就需要进行远程调用。微服务之间的远程调用被称为RPC，即远程过程调用。RPC的实现方式有很多，比如：</p><ul><li>基于Http协议</li><li>基于Dubbo协议</li></ul><p>我们使用的是Http方式，这种方式不关心服务提供者的具体技术实现，只要对外暴露Http接口即可，更符合微服务的需要。</p><h3 id="4-远程调用rpc">4. 远程调用（RPC）</h3><p>在拆分的时候，我们发现一个问题：就是购物车业务中需要查询商品信息，但商品信息查询的逻辑全部迁移到了<code>item-service</code>服务，导致我们无法查询。</p><p>最终结果就是查询到的购物车数据不完整，因此要想解决这个问题，我们就必须改造其中的代码，把原本本地方法调用，改造成跨微服务的远程调用（RPC，即<strong>R</strong>emote <strong>P</strong>roduce <strong>C</strong>all）。</p><p>因此，现在查询购物车列表的流程变成了这样：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/6875bf1040313.png" alt="image-20250715103806173"></p><p>那么问题来了：我们该如何跨服务调用，准确的说，如何在<code>cart-service</code>中获取<code>item-service</code>服务中的提供的商品数据呢？</p><p>答案是肯定的，我们前端向服务端查询数据，其实就是从浏览器远程查询服务端数据。比如我们刚才通过Swagger测试商品查询接口，就是向<code>http://localhost:8081/items</code>这个接口发起的请求：</p><p>而这种查询就是通过http请求的方式来完成的，不仅仅可以实现远程查询，还可以实现新增、删除等各种远程请求。 那么：我们该如何用Java代码发送Http的请求呢？</p><h4 id="41-resttemplate">4.1 RestTemplate</h4><p>Java发送http请求可以使用Spring提供的RestTemplate，使用的基本步骤如下：</p><ul><li>注册RestTemplate到Spring容器</li><li>调用RestTemplate的API发送请求，常见方法有：<ul><li>getForObject：发送Get请求并返回指定类型对象</li><li>PostForObject：发送Post请求并返回指定类型对象</li><li>put：发送PUT请求</li><li>delete：发送Delete请求</li><li>exchange：发送任意类型请求，返回ResponseEntity</li></ul></li></ul><p>感觉这种如果有大量用户同时请求不会变的很卡吗？？？？？？</p><div class="note blue anzhiyufont anzhiyu-icon-bullhorn modern"><p>构造器注入</p></div><details class="folding-tag" green><summary>构造器注入</summary><div class="content"><p>Spring推荐我们使用Lombok构造器注入而不是使用<code>@Autowired</code></p><p>因此我们可以在类上添加<code>@RequiredArgsConstructor</code>注解，使用<code>final</code>注入类</p><p>eg：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/6875c44601fb1.png" alt="image-20250715110020446"></p></div></details><h4 id="42-注册中心">4.2 注册中心</h4><p>在微服务远程调用的过程中，包括两个角色：</p><ul><li>服务提供者：提供接口供其它微服务访问，比如<code>item-service</code></li><li>服务消费者：调用其它微服务提供的接口，比如<code>cart-service</code></li><li>服务者可以是消费者，消费者也可以是服务者</li></ul><p>在大型微服务项目中，服务提供者的数量会非常多，为了管理这些服务就引入了<strong>注册中心</strong>的概念。注册中心、服务提供者、服务消费者三者间关系如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/687642f91dee1.png" alt="image-20250715200054715"></p><p>流程如下：</p><ul><li>服务启动时就会注册自己的服务信息（服务名、IP、端口）到注册中心</li><li>调用者可以从注册中心订阅想要的服务，获取服务对应的实例列表（1个服务可能多实例部署）</li><li>调用者自己对实例列表负载均衡，挑选一个实例</li><li>调用者向该实例发起远程调用</li></ul><p>当服务提供者的实例宕机或者启动新实例时，调用者如何得知呢？</p><ul><li>服务提供者会定期向注册中心发送请求，报告自己的健康状态（心跳请求）</li><li>当注册中心长时间收不到提供者的心跳时，会认为该实例宕机，将其从服务的实例列表中剔除</li><li>注册中心一旦认为某个实例宕机并将其剔除实例列表，那么其他服务的调用者就无法再调用这个实例。</li><li>当服务有新实例启动时，会发送注册服务请求，其信息会被记录在注册中心的服务实例列表</li><li>当注册中心服务列表变更时，会主动通知微服务，更新本地服务列表</li></ul><h4 id="43-nacos注册中心">4.3 Nacos注册中心</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> nacos \</span><br><span class="line"><span class="literal">--env-file</span> ./nacos/custom.env \</span><br><span class="line"><span class="literal">-p</span> <span class="number">8848</span>:<span class="number">8848</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">9848</span>:<span class="number">9848</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">9849</span>:<span class="number">9849</span> \</span><br><span class="line"><span class="literal">--restart</span>=always \</span><br><span class="line"><span class="literal">--network</span> hm<span class="literal">-net</span> \</span><br><span class="line">nacos/nacos<span class="literal">-server</span>:v2.<span class="number">1.0</span><span class="literal">-slim</span></span><br></pre></td></tr></table></figure><p>访问路径</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8848</span>/nacos</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/68764c4d39516.png" alt="image-20250715204042672"></p><h4 id="44-openfeign">4.4 OpenFeign</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/687759c72d8e2.png" alt="image-20250716155017015"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/68775a37c9c09.png" alt="image-20250716155218953"></p><p>哇神奇</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/68775f9635517.png" alt="image-20250716161513007"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/687765ea25acb.png" alt="image-20250716164213666"></p><ol type="1"><li>将来Feign可以根据服务名称去注册中心中去拉取实例列表</li><li>Feign会使用负载均衡自动获取一个实例（我们在pom中引入了负载均衡的依赖了）</li><li>然后定义GET请求，路径为<code>/items</code>,</li></ol><h4 id="45-连接池">4.5 连接池</h4><p>连接池指的是一组预先创建的 HTTP 连接，这些连接可以被重复使用，而不是每次请求都创建一个新的连接。</p><p>在 Feign 中，不同的 HTTP 客户端实现对连接池的支持有所不同：</p><p><code>HttpURLConnection</code>：</p><p>这是 Java 的默认 HTTP 客户端实现，不支持连接池。每次请求都会创建一个新的连接，请求完成后连接会被关闭。这种方式在高并发场景下性能较差。</p><p><code>Apache HttpClient</code>：</p><p>这是一个功能强大的 HTTP 客户端库，支持连接池。通过配置连接池，可以复用连接，提高性能。</p><p><code>OKHttp</code>：</p><p>这是另一个流行的 HTTP 客户端库，也支持连接池。OKHttp 的连接池实现高效且易于配置，适合在高并发场景下使用。</p><p>OpenFeign对Http请求做了优雅的伪装，不过其底层发起http请求，依赖于其它的框架。这些框架可以自己选择，包括以下三种:</p><ul><li>HttpURLConnection:默认实现，不支持连接池</li><li>Apache Httpclient:支持连接池</li><li>OKHttp:支持连接池</li></ul><p>具体源码可以参考FeignBlockingLoadBalancerClient类中的delegate成员变量。</p><p>因此我们通常会使用带有连接池的客户端来代替默认的HttpURLConnection。比如，我们使用OK Http</p><p>在<code>cart-service</code>的<code>pom.xml</code>中引入依赖：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!--OK http 的依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;feign-okhttp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>在<code>cart-service</code>的<code>application.yml</code>配置文件中开启Feign的连接池功能：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">feign:</span><br><span class="line">  okhttp:</span><br><span class="line">    enabled: <span class="literal">true</span> # 开启OKHttp功能</span><br></pre></td></tr></table></figure><h4 id="46-最佳实践">4.6 最佳实践</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/19/687b4ef5b6320.png" alt="image-20250719155315118"></p><p>方案1抽取更加简单，工程结构也比较清晰，但缺点是整个项目耦合度偏高。</p><p>方案2抽取相对麻烦，工程结构相对更复杂，但服务之间耦合度降低。</p><p>@SpringBootApplication这个注解中包含了@ComponentScan, 这个注解会扫描当前包(com.hmall.cart)中的文件, 而ItemClient由于被抽离到hm-api模块包下(com.hmall.api), 两者包的位置不同, 所以springboot扫描不到. 那么解决方法有: 1. 扩大扫描包的范围, 那么在启动类上添加“@ComponentScan({“com.hmall.cart”,“com.hmall.api”})“, 但此方法不推荐. 2. 使用”@import“注解, “@EnableFeignClients“就包含了@import注解, 由第三方依赖提供的 @EnableXxxxx注解, basePackages选项可以简化我们的操作, 不需要自己使用@Import.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/19/687b550a170a4.png" alt="image-20250719161917933"></p><h4 id="46-日志输出">4.6 日志输出</h4><p>OpenFeign只会在FeignClient所在包的日志级别为<strong>DEBUG</strong>时，才会输出日志。而且其日志级别有4级：</p><ul><li><strong>NONE</strong>：不记录任何日志信息，这是默认值。</li><li><strong>BASIC</strong>：仅记录请求的方法，URL以及响应状态码和执行时间</li><li><strong>HEADERS</strong>：在BASIC的基础上，额外记录了请求和响应的头信息</li><li><strong>FULL</strong>：记录所有请求和响应的明细，包括头信息、请求体、元数据。</li></ul><p>Feign默认的日志级别就是NONE，所以默认我们看不到请求日志。一般也不开启feign的日志配置，只有在需要调试feign的时候才开启日志，因为日志输出的内容有很多，输出时会影响性能。</p><h5 id="定义日志级别">定义日志级别</h5><p>在hm-api模块下新建一个配置类，定义Feign的日志级别：</p><p>接下来，要让日志级别生效，还需要配置这个类。有两种方式：</p><ul><li><strong>局部</strong>生效：在某个<code>FeignClient</code>中配置，只对当前<code>FeignClient</code>生效</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;, configuration = DefaultFeignConfig.class)</span></span><br></pre></td></tr></table></figure><ul><li><strong>全局</strong>生效：在<code>@EnableFeignClients</code>中配置，针对所有<code>FeignClient</code>生效。</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = DefaultFeignConfig.class)</span></span><br></pre></td></tr></table></figure><h1 id="三-微服务02">三、 微服务02</h1><p>由于每个微服务都有不同的地址或端口，入口不同，相信大家在与前端联调的时候发现了一些问题：</p><ul><li>请求不同数据时要访问不同的入口，需要维护多个入口地址，麻烦</li><li>前端无法调用nacos，无法实时更新服务列表</li></ul><p>单体架构时我们只需要完成一次用户登录、身份校验，就可以在所有业务中获取到用户信息。而微服务拆分后，每个微服务都独立部署，这就存在一些问题：</p><ul><li>每个微服务都需要编写登录校验、用户信息获取的功能吗？</li><li>当微服务之间调用时，该如何传递用户信息？</li></ul><p>不要着急，这些问题都可以在今天的学习中找到答案，我们会通过<strong>网关</strong>技术解决上述问题。今天的内容会分为3章：</p><ul><li>第一章：网关路由，解决前端请求入口的问题。</li><li>第二章：网关鉴权，解决统一登录校验和用户信息获取的问题。</li><li>第三章：统一配置管理，解决微服务的配置文件重复和配置热更新问题。</li></ul><p>通过今天的学习你将掌握下列能力：</p><ul><li>会利用微服务网关做请求路由</li><li>会利用微服务网关做登录身份校验</li><li>会利用Nacos实现统一配置管理</li><li>会利用Nacos实现配置热更新</li></ul><h2 id="1-网关路由">1. 网关路由</h2><p>网关就是<strong>网</strong>络的<strong>关</strong>口。数据在网络间传输，从一个网络传输到另一网络时就需要经过网关来做数据的<strong>路由和转发以及数据安全的校验</strong>。</p><p>更通俗的来讲，网关就像是以前园区传达室的大爷。</p><ul><li>外面的人要想进入园区，必须经过大爷的认可，如果你是不怀好意的人，肯定被直接拦截。</li><li>外面的人要传话或送信，要找大爷。大爷帮你带给目标人。</li></ul><p>现在，微服务网关就起到同样的作用。前端请求不能直接访问微服务，而是要请求网关：</p><ul><li>网关可以做安全控制，也就是登录身份校验，校验通过才放行</li><li>通过认证后，网关再根据请求判断应该访问哪个微服务，将请求转发过去</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/20/687c38bd937a6.png" alt="image-20250720083051495"></p><p><code>Route</code>（路由）: 网关的基本构件。它由一个ID、一个目的地URI、一个断言（Predicate）集合和一个过滤器（Filter）集合定义。如果断言为真，则路由被匹配。</p><p>网关也相当于一个微服务，其会注册到nacos，并拉取所有的服务信息，所以要获取某个微服务对网关来说不是难事</p><p>迷迷糊糊说这么多还是不知道网关是什么🥲🥲</p><ol type="1"><li>前端发送的请求先发给网关，网关进行校验完毕之后使用负载均衡请求到具体的微服务中</li><li>前端只要知道网关地址即可（8080），前端所有请求地址都为8080那么就会到达网关，然后网关会根据前端的请求来去判断应该由哪个微服务来处理（判断过程就是请求的路由 ），然后网关就会帮你的请求转发到具体的微服务（路由转发）</li><li>网关可以利用注册中心（所有的微服务接口都存放在了注册中心），拉取所有的服务中心</li><li>网关来负责身份校验，这样转发就不用在此校验了</li></ol><h3 id="11-网关快速入门">1.1 网关快速入门</h3><p>网关也相当于一个微服务，其会注册到nacos，并拉取所有的服务信息，所以要获取某个微服务对网关来说不是难事。</p><p>接下来，在<code>hm-gateway</code>模块的<code>resources</code>目录新建一个<code>application.yaml</code>文件，内容如下：</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span> <span class="comment"># 路由规则id，自定义，唯一</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span> <span class="comment"># 路由的目标服务，lb代表负载均衡，会从注册中心拉取服务列表</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，判断当前请求是否符合当前规则，符合则路由到目标服务</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span> <span class="comment"># 这里是以请求路径作为判断规则</span></span><br></pre></td></tr></table></figure><h3 id="12-路由属性">1.2 路由属性</h3><p>网关路由对应的Java类型是RouteDefinition，其中常见的属性有</p><ul><li>id:路由唯一标示</li><li>uri:路由目标地址</li><li>predicates:路由断言，判断请求是否符合当前路由。</li><li>filters:路由过滤器，对请求或响应做特殊处理。</li></ul><h4 id="路由断言">路由断言</h4><table><thead><tr><th style="text-align:center"><strong>名称</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>示例</strong></th></tr></thead><tbody><tr><td style="text-align:center">After</td><td style="text-align:center">是某个时间点后的请求</td><td style="text-align:center">- After=2037-01-20T17:42:47.789-07:00[America/Denver]</td></tr><tr><td style="text-align:center">Before</td><td style="text-align:center">是某个时间点之前的请求</td><td style="text-align:center">- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td></tr><tr><td style="text-align:center">Between</td><td style="text-align:center">是某两个时间点之前的请求</td><td style="text-align:center">- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</td></tr><tr><td style="text-align:center">Cookie</td><td style="text-align:center">请求必须包含某些cookie</td><td style="text-align:center">- Cookie=chocolate, ch.p</td></tr><tr><td style="text-align:center">Header</td><td style="text-align:center">请求必须包含某些header</td><td style="text-align:center">- Header=X-Request-Id, \d+</td></tr><tr><td style="text-align:center">Host</td><td style="text-align:center">请求必须是访问某个host（域名）</td><td style="text-align:center">- Host=.somehost.org,.anotherhost.org</td></tr><tr><td style="text-align:center">Method</td><td style="text-align:center">请求方式必须是指定方式</td><td style="text-align:center">- Method=GET,POST</td></tr><tr><td style="text-align:center">Path</td><td style="text-align:center">请求路径必须符合指定规则</td><td style="text-align:center">- Path=/red/{segment},/blue/**</td></tr><tr><td style="text-align:center">Query</td><td style="text-align:center">请求参数必须包含指定参数</td><td style="text-align:center">- Query=name, Jack或者- Query=name</td></tr><tr><td style="text-align:center">RemoteAddr</td><td style="text-align:center">请求者的ip必须是指定范围</td><td style="text-align:center">- RemoteAddr=192.168.1.1/24</td></tr><tr><td style="text-align:center">weight</td><td style="text-align:center">权重处理</td><td style="text-align:center"></td></tr></tbody></table><h4 id="路由过滤器">路由过滤器</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">说明</th><th style="text-align:center">示例</th></tr></thead><tbody><tr><td style="text-align:center">AddRequestHeader</td><td style="text-align:center">给当前请求添加一个请求头</td><td style="text-align:center">AddrequestHeader=headerName, headerValue</td></tr><tr><td style="text-align:center">RemoveRequestHeader</td><td style="text-align:center">移除请求中的一个请求头</td><td style="text-align:center">RemoveRequestHeader=headerName</td></tr><tr><td style="text-align:center">AddResponseHeader</td><td style="text-align:center">给响应结果中添加一个响应头</td><td style="text-align:center">AddResponseHeader=headerName , headerValue</td></tr><tr><td style="text-align:center">RemoveResponseHeader</td><td style="text-align:center">从响应结果中移除有一个响应头</td><td style="text-align:center">RemoveResponseHeader=headerName</td></tr><tr><td style="text-align:center">RewritePath</td><td style="text-align:center">请求路径重写</td><td style="text-align:center">RewritePath=/red/ ? ( ?&lt;segment&gt;.*)，/$\l{segment]</td></tr><tr><td style="text-align:center">StripPrefix</td><td style="text-align:center">去除请求路径中的N段前缀</td><td style="text-align:center">StripPrefix=1，则路径/a/b转发时只保留/b</td></tr></tbody></table><h2 id="2-网关登录">2. 网关登录</h2><p>单体架构时我们只需要完成一次用户登录、身份校验，就可以在所有业务中获取到用户信息。而微服务拆分后，每个微服务都独立部署，不再共享数据。也就意味着每个微服务都需要做登录校验，这显然不可取。</p><p>我们的登录是基于JWT来实现的，校验JWT的算法复杂，而且需要用到秘钥。如果每个微服务都去做登录校验，这就存在着两大问题：</p><ul><li>每个微服务都需要知道JWT的秘钥，不安全</li><li>每个微服务重复编写登录校验代码、权限校验代码，麻烦</li></ul><p>既然网关是所有微服务的入口，一切请求都需要先经过网关。我们完全可以把登录校验的工作放到网关去做，这样之前说的问题就解决了：</p><ul><li>只需要在网关和用户服务保存秘钥</li><li>只需要在网关开发登录校验功能</li></ul><p>此时，登录校验的流程如图：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/20/687c55b28e6dd.png" alt="image-20250720103424790"></p><p>不过，这里存在几个问题：</p><ul><li>网关路由是配置的，请求转发是Gateway内部代码，我们如何在转发之前做登录校验？</li><li>网关校验JWT之后，如何将用户信息传递给微服务？</li><li>微服务之间也会相互调用，这种调用不经过网关，又该如何传递用户信息？</li></ul><h3 id="21-网关过滤器">2.1 网关过滤器</h3><p>登录校验必须在请求转发到微服务之前做，否则就失去了意义。而网关的请求转发是<code>Gateway</code>内部代码实现的，要想在请求转发之前做登录校验，就必须了解<code>Gateway</code>内部工作的基本原理。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/20/687c576d672c9.png" alt="image-20250720104147586"></p><ol type="1"><li>网关内部是没有业务逻辑的，他的任务是基于我们配的路由规则然后判断一下前端请求，到底该由哪个微服务处理，然后将请求转发到对应的微服务</li><li>而进行路由判断的功能就是由一个叫<code>handlerMapping</code>的接口来处理的<code>HandlerMapping</code>的默认实现是 <code>RoutePredicateHandlerMapping</code>(路由断言).<code>HandlerMapping</code>根据请求找到匹配的路由并存入上下文，然后把请求交给webHandler处理。</li><li><code>WebHandler</code>默认实现是<code>FilteringwebHandler</code> ,顾名思义是一个过滤器处理器。它会加载网关中配置的多个过滤器，放入集合并排序，形成过滤器链。然后依次执行这些过滤器。</li><li>而整个过滤链的最后要执行<code>NettyRoutingFilter</code>，负责将请求转发到微服务，当微服务返回结果后存入上下文</li><li>接着依次传递给其他过滤器，最终返回给用户</li><li>过滤器内部可以包含两部分逻辑，分别是pre和post，分别会在请求路由到微服务之前和之后执行。</li><li>当所有Filter的pre逻辑都依次顺序执行通过后，请求才会被路由到微服务，否则会被拦截，后续过滤器不再执行。微服务返回结果后，再倒序执行Filter的post逻辑</li><li>如果我们能够定义一个过滤器，在其中实现登录校验逻辑，并且将过滤器执行顺序定义到<code>NettyRoutingFilter</code>之前，这就符合我们的需求了！</li><li>可以将用户信息保存在请求头中，然后传递给微服务，然后微服务在从请求头中取出用户信息</li></ol><h3 id="22-自定义过滤器">2.2 自定义过滤器</h3><p>网关过滤器链中的过滤器有两种：</p><ul><li><strong><code>GatewayFilter</code></strong>：路由过滤器，作用范围比较灵活，可以是任意指定的路由<code>Route</code>. （配置的过滤器，有33种，默认不生效，配置到哪一个路由下之后就对配置的路由生效。配置到default-filter：之后就会对所有路由生效（这样就不必在所有的路由中配置类，但是所属类别依旧是GatewayFilter）。）</li><li><strong><code>GlobalFilter</code></strong>：全局过滤器，作用范围是所有路由，不可配置。</li></ul><h3 id="23-实现登录校验">2.3 实现登录校验</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(AuthProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTool jwtTool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthProperties authProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取Request</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// 2.判断是否不需要拦截</span></span><br><span class="line">        <span class="keyword">if</span>(isExclude(request.getPath().toString()))&#123;</span><br><span class="line">            <span class="comment">// 无需拦截，直接放行</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.获取请求头中的token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        List&lt;String&gt; headers = request.getHeaders().get(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!CollUtils.isEmpty(headers)) &#123;</span><br><span class="line">            token = headers.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.校验并解析token</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userId = jwtTool.parseToken(token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnauthorizedException e) &#123;</span><br><span class="line">            <span class="comment">// 如果无效，拦截</span></span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            response.setRawStatusCode(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 5.如果有效，传递用户信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;userId = &quot;</span> + userId);</span><br><span class="line">        <span class="comment">// 6.放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExclude</span><span class="params">(String antPath)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String pathPattern : authProperties.getExcludePaths()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(antPathMatcher.match(pathPattern, antPath))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>对于AntPathMatcher，虽然它是Spring框架的一部分，但它并不是由Spring管理的Bean。AntPathMatcher是一个工具类，用于匹配Ant风格的路径模式，它没有定义为Spring的Bean，因此Spring容器不知道如何自动注入它。</p><p>为什么需要手动创建AntPathMatcher实例？</p><p>工具类：AntPathMatcher是一个工具类，通常不需要Spring管理其生命周期。工具类是无状态的，可以在任何地方实例化和使用。</p><p>非单例：由于AntPathMatcher是无状态的，它不需要作为单例Bean管理。每次使用时创建一个新的实例是安全的，不会导致资源浪费或状态不一致的问题。</p><p>简单性：手动创建AntPathMatcher实例非常简单，只需要使用new关键字即可。这种方式代码清晰，易于理解</p></li></ul><h3 id="24-网关传递用户">2.4 网关传递用户</h3><p>现在，网关已经可以完成登录校验并获取登录用户身份信息。但是当网关将请求转发到微服务时，微服务又该如何获取用户身份呢？</p><p>由于网关发送请求到微服务依然采用的是<code>Http</code>请求，因此我们可以将用户信息以请求头的方式传递到下游微服务。然后微服务可以从请求头中获取登录用户信息。考虑到微服务内部可能很多地方都需要用到登录用户信息，因此我们可以利用SpringMVC的拦截器来实现登录用户信息获取，并存入ThreadLocal，方便后续使用。</p><p>据图流程图如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/21/687e269e78f41.png" alt="image-20250721193804387"></p><p>因此，接下来我们要做的事情有：</p><ul><li>改造网关过滤器，在获取用户信息后保存到请求头，转发到下游微服务</li><li>编写微服务拦截器，拦截请求获取用户信息，保存到<code>ThreadLocal</code>后放行</li></ul><h4 id="保存用户到请求头">保存用户到请求头</h4><p>首先，我们修改登录校验拦截器的处理逻辑，保存用户信息到请求头中：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/22/687f7b34da201.png" alt="image-20250722195113363"></p><p>修改<code>AuthGlobalFilter</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 5.如果有效，传递用户信息</span></span><br><span class="line">        <span class="comment">// mutate()方法可以对下游请求做更改，.request表示对请求做处理，利用builder可以对请求中各种信息做修改</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> userId.toString();</span><br><span class="line">        <span class="type">ServerWebExchange</span> <span class="variable">swe</span> <span class="operator">=</span> exchange.mutate()</span><br><span class="line">                .request(builder -&gt; builder.header(<span class="string">&quot;user-Info&quot;</span>, userInfo))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// 6.放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(swe);</span><br></pre></td></tr></table></figure><ul><li>拦截器先通过 Token 解析出<code>userId</code>，再将其放入请求头；</li><li>后续的 Controller 可以直接从请求头<code>user-Info</code>中获取<code>userId</code>，无需再次解析 Token，提高效率。</li></ul><h4 id="拦截器获取用户">拦截器获取用户</h4><p>需求:由于每个微服务都可能有获取登录用户的需求，因此我们直接在hm-common模块定义拦截器，这样微服务只需要引入依赖即可生效，无需重复编写。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.common.interceptors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.hmall.common.utils.UserContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.获取请求头中的用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;user-info&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.判断是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(userInfo)) &#123;</span><br><span class="line">            <span class="comment">// 不为空，保存到ThreadLocal</span></span><br><span class="line">            UserContext.setUser(Long.valueOf(userInfo));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 移除用户</span></span><br><span class="line">        UserContext.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里只是写了一个拦截器类，但是并没有注册到<code>springmvc</code>拦截器里。要想注册进去需要进行配置：编写<code>config</code>配置类<code>WebMvcConfigurer</code> ，将其add进去</p><p>当请求从 Spring Cloud Gateway（WebFlux、Netty驱动）进入下游 Spring MVC 微服务时，exchange 不会被直接传递，而是 自动被底层 HTTP 协议转换为标准的 HttpServletRequest 和 HttpServletResponse。</p><p>spring-web通过线程池复用线程，并且不是每次使用user-service都会覆盖user信息，所以有必要在一次请求完成后清理user信息</p><p>拦截器生命周期：</p><p>preHandle() → 2. Controller &amp; Service等 → 3. postHandle()（如有） → 4. afterCompletion()</p><p>特殊情况处理如果请求在 preHandle 返回 false（拦截请求）：不会执行 Controller，但 仍会触发 afterCompletion（Spring 5.3+ 行为）。</p><h4 id="配置拦截器">配置拦截器</h4><p>springMVC拦截器需要配置@configuration，进行配置才能生效</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">UserInfoInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>通过 registry.addInterceptor(new UserInfoInterceptor()) 将一个名为 UserInfoInterceptor 的拦截器添加到拦截器注册表中。这样自定义的拦截器才会生效</li><li>添加@ConditionalOnClass(DispatcherServlet.class)的原因：因为hm-gateway中也引用了common模块，而我们知道gateway使用的openfeign虽然也处理http请求，但是底层不是靠SpringMvc实现的，而现在设计了只要引用common这个包就会自动装配MvcConfig配置类，然而hm-gateway底层没有springmvc自然无法自动装配MvcConfig配置类，会报错。所以我们需要设计成只有依赖了SpringMvc的微服务模块才自动装配，而SpringMvc的核心类就是DispatcherServlet.class，所以只有有DispatcherServlet.class这个类的微服务模块才会自动装配MvcConfig配置类</li><li>@ConditionalOnClass 是 Spring Boot 中的一个条件注解，它用于在特定类存在于类路径上时才启用配置。因此特定的类就是DispatcherServlet.class只要再pom.xml中加入spring-boot-starter-web就会存在DispatcherServlet类</li><li>DispatcherServlet.class 是 Spring MVC 的核心组件之一，通常用于处理 HTTP 请求。如果存在 DispatcherServlet，说明当前项目中使用了 Spring MVC，Spring 会加载 MvcConfig 配置类</li><li>除了hm-gateway外底层都是springMVC，那要想不让网关得到这个WebMvcconfigurer配置，那就要；利用SpringMVC的特点去排除它，SprngMVC都有一个DispatcherServlet的api。</li><li>当我们配置了扫描时，其他的微服务就会使用这个拦截器配置的内容，但是网关也使用了这个配置类，网关没有MVC的内容因此会报错。</li></ul><h4 id="添加扫描">添加扫描</h4><p><code>spring.factories</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  com.hmall.common.config.MyBatisConfig,\</span><br><span class="line">  com.hmall.common.config.MvcConfig,\</span><br><span class="line">  com.hmall.common.config.JsonConfig</span><br></pre></td></tr></table></figure><ul><li>不过，需要注意的是，这个配置类默认是不会生效的，因为它所在的包是<code>com.hmall.common.config</code>，与其它微服务的扫描包不一致，无法被扫描到，因此无法生效。基于SpringBoot的自动装配原理，我们要将其添加到<code>resources</code>目录下的<code>META-INF/spring.factories</code>文件中：</li><li>依赖虽然被引入，但@ComponentScan默认扫描启动类所在的包及其子包，这里没在对应的扫描范围内所有没有注册。可以@ComponentScan添加包范围；在对应模块通过spring.factories文件将对应配置类的全限定名写进去，利用Springboot自动配置原理，其他微服务引入对应模块依赖，在启动后会进行Bean注册；同样也还可以用@Import导入对应的Bean组件或配置类</li><li>spring.factories可以基于springboot的自动装配机制自动发现并装配配置类。简单来说，就是所有微服务都无法扫描到这个拦截器，我们可以给每一个微服务的启动类Application加上compinentscan指定扫描这个拦截器，但是，微服务数量庞大，显然不是个好办法，利用SpringBoot的自动装配原理就简单的多</li></ul><h4 id="结果">结果</h4><p>这样我们请求单个购物车就查询不到用户信息了</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/24/6881fa6ec44c8.png" alt="image-20250724171835215"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">: ==&gt;  Preparing: SELECT id,user_id,item_id,num,name,spec,price,image,create_time,update_time FROM cart <span class="title function_">WHERE</span> <span class="params">(user_id = ?)</span></span><br><span class="line"><span class="number">17</span>:<span class="number">15</span>:<span class="number">27</span>:<span class="number">140</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">6</span>] c.h.cart.mapper.CartMapper.selectList    : ==&gt; Parameters: <span class="number">2</span>(Long)</span><br><span class="line"><span class="number">17</span>:<span class="number">15</span>:<span class="number">27</span>:<span class="number">148</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">6</span>] c.h.cart.mapper.CartMapper.selectList    : &lt;==      Total: <span class="number">1</span></span><br><span class="line"><span class="number">17</span>:<span class="number">16</span>:<span class="number">27</span>:<span class="number">290</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">7</span>] c.h.cart.mapper.CartMapper.selectList    : ==&gt;  Preparing: SELECT id,user_id,item_id,num,name,spec,price,image,create_time,update_time FROM cart <span class="title function_">WHERE</span> <span class="params">(user_id = ?)</span></span><br><span class="line"><span class="number">17</span>:<span class="number">16</span>:<span class="number">27</span>:<span class="number">293</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">7</span>] c.h.cart.mapper.CartMapper.selectList    : ==&gt; Parameters: <span class="literal">null</span></span><br><span class="line"><span class="number">17</span>:<span class="number">16</span>:<span class="number">27</span>:<span class="number">298</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">7</span>] c.h.cart.mapper.CartMapper.selectList    : &lt;==      Total: <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="135-openfeign传递用户">1.3.5 OpenFeign传递用户</h3><blockquote><p>请求从网关到交易时会被mvc拦截，将userinfo存入threadlocal，当这个请求执行完之后，afterCompletion会清除threadlocal，故当交易发请求到商品时是没有ui的</p></blockquote><p>前端发起的请求都会经过网关再到微服务，由于我们之前编写的过滤器和拦截器功能，微服务可以轻松获取登录用户信息。</p><p>但有些业务是比较复杂的，请求到达微服务后还需要调用其它多个微服务。比如下单业务，流程如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/24/68820370c5d70.png" alt="image-20250724175700620"></p><p>下单的过程中，需要调用商品服务扣减库存，调用购物车服务清理用户购物车。而清理购物车时必须知道当前登录的用户身份。但是，<strong>订单服务调用购物车时并没有传递用户信息</strong>，购物车服务无法知道当前用户是谁！</p><p>由于微服务获取用户信息是通过拦截器在请求头中读取，因此要想实现微服务之间的用户信息传递，就<strong>必须在微服务发起调用时把用户信息存入请求头</strong>。</p><ul><li><p>ThreadLocal：仅限单JVM线程内，用于存储线程级别的上下文（如用户身份、事务ID）。其生命周期与线程绑定，无法跨进程或跨服务传递。</p><p>微服务间通信：本质是跨进程的分布式调用，服务可能部署在不同物理节点。ThreadLocal无法穿透网络边界，无法在服务A的线程中直接访问服务B的线程数据。</p></li><li><p>服务调用，即跨进程的服务调用，而ThreadLocal只仅限于当前服务内部的范围，所以无法使用，但网关那里刚开始不是已经通过过滤器进行了userInfo存入请求头中吗？为什么后续微服务a调用服务b时，需要再次将userInfo存入请求头才能传递用户信息呢？那是因为——&gt;HTTP协议无状态：每个请求默认不携带上一个请求的上下文（直接理解成，每次发送的都是一个新的http请求，所以需要我们自己给该请求做标识）。 最后记住：拦截器+Feign组合：是实现微服务间身份透传的标准模式。</p></li><li><p>拦截器是属于微服务的，过滤器是属于网关的；拦截器从请求头获取userId，并保存在context中，过滤器解析jwt并保存在请求头中；</p></li></ul><p>微服务之间调用是基于OpenFeign来实现的，并不是我们自己发送的请求。我们如何才能让每一个由OpenFeign发起的请求自动携带登录用户信息呢？</p><p>这里要借助Feign中提供的一个拦截器接口：<code>feign.RequestInterceptor</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/6882cd197e1e5.png" alt="image-20250725081720605"></p><p>不放在common中，因为不是所有模块都需要，例如网关微服务就不需要FeignClient 其实就是拦截下来OpenFeign的转发请求，然后再请求头中添加上user-info字段后放行。</p><p><code>DefaultFeignConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultFeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将用户信息添加请求头</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">userInfoRequestInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 微服务调用微服务的请求是从网关传过来的，</span></span><br><span class="line"><span class="comment">                 * 所以这时请求头中是有用户信息的，</span></span><br><span class="line"><span class="comment">                 * 只需要从请求头中获取到用户信息，添加到请求头中即可</span></span><br><span class="line"><span class="comment">                 * 如何请求再次传递给下一个微服务，这样就将用户信息传递给了其他微服务了</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserContext.getUser();</span><br><span class="line">                <span class="keyword">if</span> (userId != <span class="literal">null</span>)&#123;</span><br><span class="line">                    requestTemplate.header(<span class="string">&quot;user-info&quot;</span>, userId.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-配置管理">3. 配置管理</h2><p>到目前为止我们已经解决了微服务相关的几个问题：</p><ul><li>微服务远程调用</li><li>微服务注册、发现</li><li>微服务请求路由、负载均衡</li><li>微服务登录用户信息传递</li></ul><p>不过，现在依然还有几个问题需要解决：</p><ul><li>网关路由在配置文件中写死了，如果变更必须重启微服务</li><li>某些业务配置在配置文件中写死了，每次修改都要重启服务</li><li>每个微服务都有很多重复的配置，维护成本高</li></ul><p>这些问题都可以通过统一的<strong>配置管理器服务</strong>解决。而Nacos不仅仅具备注册中心功能，也具备配置管理的功能：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/6882ef6723d77.png" alt="image-20250725104348028"></p><p>微服务共享的配置可以统一交给Nacos保存和管理，在Nacos控制台修改配置后，Nacos会将配置变更推送给相关的微服务，并且无需重启即可生效，实现配置热更新。</p><p>网关的路由同样是配置，因此同样可以基于这个功能实现动态路由功能，无需重启网关即可修改路由配置。</p><h3 id="31-配置共享">3.1 配置共享</h3><p>我们可以把微服务共享的配置抽取到Nacos中统一管理，这样就不需要每个微服务都重复配置了。分为两步：</p><ul><li>在Nacos中添加共享配置</li><li>微服务拉取配置</li></ul><h4 id="311-添加共享配置">3.1.1 添加共享配置</h4><p>以cart-service为例，我们看看有哪些配置是重复的，可以抽取的：</p><p>首先是jdbc相关配置：</p><p>然后是日志配置：</p><p>然后是swagger以及OpenFeign的配置：</p><p>我们在nacos控制台分别添加这些配置。</p><p>首先是jdbc相关配置，在<code>配置管理</code>-&gt;<code>配置列表</code>中点击<code>+</code>新建一个配置：</p><p>在弹出的表单中填写信息：</p><p>其中详细的配置如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;hm.db.host:192.168.150.101&#125;:$&#123;hm.db.port:3306&#125;/$&#123;hm.db.database&#125;?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;hm.db.un:root&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.db.pw:123&#125;</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure><p>注意这里的jdbc的相关参数并没有写死，例如：</p><ul><li><code>数据库ip</code>：通过<code>$&#123;hm.db.host:192.168.150.101&#125;</code>配置了默认值为<code>192.168.150.101</code>，同时允许通过<code>$&#123;hm.db.host&#125;</code>来覆盖默认值</li><li><code>数据库端口</code>：通过<code>$&#123;hm.db.port:3306&#125;</code>配置了默认值为<code>3306</code>，同时允许通过<code>$&#123;hm.db.port&#125;</code>来覆盖默认值</li><li><code>数据库database</code>：可以通过<code>$&#123;hm.db.database&#125;</code>来设定，无默认值</li></ul><p>然后是统一的日志配置，命名为<code>shared-log.``yaml</code>，配置内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.hmall:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss:SSS</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>然后是统一的swagger配置，命名为<code>shared-swagger.yaml</code>，配置内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">$&#123;hm.swagger.title:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">$&#123;hm.swagger.description:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">$&#123;hm.swagger.email:zhanghuyi@itcast.cn&#125;</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">$&#123;hm.swagger.concat:虎哥&#125;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">$&#123;hm.swagger.package&#125;</span></span><br></pre></td></tr></table></figure><p>注意，这里的swagger相关配置我们没有写死，例如：</p><ul><li><code>title</code>：接口文档标题，我们用了<code>$&#123;hm.swagger.title&#125;</code>来代替，将来可以有用户手动指定</li><li><code>email</code>：联系人邮箱，我们用了<code>$&#123;hm.swagger.email:``zhanghuyi@itcast.cn``&#125;</code>，默认值是<code>zhanghuyi@itcast.cn</code>，同时允许用户利用<code>$&#123;hm.swagger.email&#125;</code>来覆盖。</li></ul><h3 id="32-拉取nacos">3.2 拉取nacos</h3><p>接下来，我们要在微服务拉取共享配置。将拉取到的共享配置与本地的<code>application.yaml</code>配置合并，完成项目上下文的初始化。</p><p>不过，需要注意的是，读取Nacos配置是SpringCloud上下文（<code>ApplicationContext</code>）初始化时处理的，发生在项目的引导阶段。然后才会初始化SpringBoot上下文，去读取<code>application.yaml</code>。</p><p>也就是说引导阶段，<code>application.yaml</code>文件尚未读取，根本不知道nacos 地址，该如何去加载nacos中的配置文件呢？</p><p>SpringCloud在初始化上下文的时候会先读取一个名为<code>bootstrap.yaml</code>(或者<code>bootstrap.properties</code>)的文件，如果我们将nacos地址配置到<code>bootstrap.yaml</code>中，那么在项目引导阶段就可以读取nacos中的配置了。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/688336256383b.png" alt="image-20250725154538843"></p><p>因此，微服务整合Nacos配置管理的步骤如下：</p><p>1）引入依赖：</p><p>在cart-service模块引入依赖：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos配置管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--读取bootstrap文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）新建bootstrap.yaml</p><p>在cart-service中的resources目录新建一个bootstrap.yaml文件：</p><p>内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cart-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span> <span class="comment"># nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 文件后缀名</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="comment"># 共享配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-jdbc.yaml</span> <span class="comment"># 共享mybatis配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-log.yaml</span> <span class="comment"># 共享日志配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-swagger.yaml</span> <span class="comment"># 共享日志配置</span></span><br></pre></td></tr></table></figure><p>3）修改application.yaml</p><p>由于一些配置挪到了bootstrap.yaml，因此application.yaml需要修改为：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启OKHttp连接池支持</span></span><br><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">swagger:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">购物车服务接口文档</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">com.hmall.cart.controller</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">hm-cart</span></span><br></pre></td></tr></table></figure><p>重启服务，发现所有配置都生效了。</p><h3 id="33-配置热更新">3.3 配置热更新</h3><p>有很多的业务相关参数，将来可能会根据实际情况临时调整。例如购物车业务，购物车数量有一个上限，默认是10，对应代码如下：</p><p>现在这里购物车是写死的固定值，我们应该将其配置在配置文件中，方便后期修改。</p><p>但现在的问题是，即便写在配置文件中，修改了配置还是需要重新打包、重启服务才能生效。能不能不用重启，直接生效呢？</p><p>这就要用到Nacos的配置热更新能力了，分为两步：</p><ul><li>在Nacos中添加配置</li><li>在微服务读取配置</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/68837b6508f41.png" alt="image-20250725204101759"></p><p>文件名称由三部分组成：</p><ul><li><strong><code>服务名</code></strong>：我们是购物车服务，所以是<code>cart-service</code></li><li><strong><code>spring.active.profile</code></strong>：就是spring boot中的<code>spring.active.profile</code>，可以省略，则所有profile共享该配置</li><li><strong><code>后缀名</code></strong>：例如yaml</li></ul><p>这里我们直接使用<code>cart-service.yaml</code>这个名称，则不管是dev还是local环境都可以共享该配置。</p><p>配置内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">cart:</span></span><br><span class="line">    <span class="attr">maxAmount:</span> <span class="number">1</span> <span class="comment"># 购物车商品数量上限</span></span><br></pre></td></tr></table></figure><p>接着，我们在微服务中读取配置，实现配置热更新。</p><p>在<code>cart-service</code>中新建一个属性读取类：</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.cart.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;hm.cart&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer maxAmount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着，在业务中使用该属性加载类：</p><p>测试，向购物车中添加多个商品：</p><p>我们在nacos控制台，将购物车上限配置为5：</p><p>无需重启，再次测试购物车功能：</p><p>加入成功！</p><p>无需重启服务，配置热更新就生效了！</p><h3 id="34-动态路由">3.4 动态路由</h3><p>网关的路由配置全部是在项目启动时由<code>org.springframework.cloud.gateway.route.CompositeRouteDefinitionLocator</code>在项目启动的时候加载，并且一经加载就会缓存到内存中的路由表内（一个Map），不会改变。也不会监听路由变更，所以，我们无法利用上节课学习的配置热更新来实现路由更新。</p><p>因此，我们必须监听Nacos的配置变更，然后手动把最新的路由更新到路由表中。这里有两个难点：</p><ul><li>如何监听Nacos配置变更？</li><li>如何把路由信息更新到路由表？</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/26/6884b4335720b.png" alt="image-20250726185538185"></p><h1 id="四-微服务03">四、 微服务03</h1><p>在微服务远程调用的过程中，还存在几个问题需要解决。</p><p>首先是<strong>业务健壮性</strong>问题：</p><p>例如在之前的查询购物车列表业务中，购物车服务需要查询最新的商品信息，与购物车数据做对比，提醒用户。大家设想一下，如果商品服务查询时发生故障，查询购物车列表在调用商品服 务时，是不是也会异常？从而导致购物车查询失败。但从业务角度来说，为了提升用户体验，即便是商品查询失败，购物车列表也应该正确展示出来，哪怕是不包含最新的商品信息。</p><p>还有<strong>级联</strong>失败问题：</p><p>还是查询购物车的业务，假如商品服务业务并发较高，占用过多Tomcat连接。可能会导致商品服务的所有接口响应时间增加，延迟变高，甚至是长时间阻塞直至查询失败。</p><p>此时查询购物车业务需要查询并等待商品查询结果，从而导致查询购物车列表业务的响应时间也变长，甚至也阻塞直至无法访问。而此时如果查询购物车的请求较多，可能导致购物车服务的Tomcat连接占用较多，所有接口的响应时间都会增加，整个服务性能很差， 甚至不可用。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/68859664902a1.png" alt="image-20250727110050083"></p><p>依次类推，整个微服务群中与购物车服务、商品服务等有调用关系的服务可能都会出现问题，最终导致整个集群不可用。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885968bb4fe9.png" alt="image-20250727110130582"></p><p>这就是<strong>级联</strong>失败问题，或者叫<strong>雪崩</strong>问题。</p><p>级联失败（Cascading Failure）是指一个系统中的局部故障引发连锁反应，导致其他部分相继失效，最终造成更大范围甚至整个系统崩溃的现象。</p><p>还有跨服务的事务问题：</p><p>比如昨天讲到过的下单业务，下单的过程中需要调用多个微服务：</p><ul><li>商品服务：扣减库存</li><li>订单服务：保存订单</li><li>购物车服务：清理购物车</li></ul><p>这些业务全部都是数据库的写操作，我们必须确保所有操作的同时成功或失败。但是这些操作在不同微服务，也就是不同的Tomcat，这样的情况如何确保事务特性呢？</p><h2 id="41-雪崩问题">4.1 雪崩问题</h2><blockquote><p>雪崩问题产生的原因？</p></blockquote><ul><li>微服务相互调用，服务提供者出现故障或阻塞。</li><li>服务调用者没有做好异常处理，导致自身故障。</li><li>调用链中的所有服务级联失败，导致整个集群故障</li></ul><blockquote><p>如何避免雪崩</p></blockquote><ul><li><p>尽量避免服务出现故障或阻塞。</p><ul><li>保证代码的健壮性;</li><li>保证网络畅通;</li><li>能应对较高的并发请求;</li></ul></li><li><p>服务调用者做好远程调用异常的后备方案，避免故障扩散</p></li></ul><h2 id="42-微服务保护">4.2 微服务保护</h2><h3 id="421-服务保护方案">4.2.1 服务保护方案</h3><p>微服务保护的方案有很多，比如：</p><ul><li>请求限流</li><li>线程隔离</li><li>服务熔断</li></ul><p>这些方案或多或少都会导致服务的体验上略有下降，比如请求限流，降低了并发上限；线程隔离，降低了可用资源数量；服务熔断，降低了服务的完整度，部分服务变的不可用或弱可用。因此这些方案都属于服务<strong>降级</strong>的方案。但通过这些方案，服务的健壮性得到了提升，</p><h3 id="422-请求限流">4.2.2 请求限流</h3><p>服务故障最重要原因，就是并发太高！解决了这个问题，就能避免大部分故障。当然，接口的并发不是一直很高，而是突发的。因此请求限流，就是<strong>限制或控制</strong>接口访问的并发流量，避免服务因流量激增而出现故障。</p><p>请求限流往往会有一个限流器，数量高低起伏的并发请求曲线，经过限流器就变的非常平稳。这就像是水电站的大坝，起到蓄水的作用，可以通过开关控制水流出的大小，让下游水流始终维持在一个平稳的量。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885aa8b68650.png" alt="image-20250727122650049"></p><h3 id="423-线程隔离">4.2.3 线程隔离</h3><p>当一个业务接口响应时间长，而且并发高时，就可能耗尽服务器的线程资源，导致服务内的其它接口受到影响。所以我们必须把这种影响降低，或者缩减影响的范围。线程隔离正是解决这个问题的好办法。</p><p>线程隔离的思想来自轮船的舱壁模式：</p><p>轮船的船舱会被隔板分割为N个相互隔离的密闭舱，假如轮船触礁进水，只有损坏的部分密闭舱会进水，而其他舱由于相互隔离，并不会进水。这样就把进水控制在部分船体，避免了整个船舱进水而沉没。</p><p>为了避免某个接口故障或压力过大导致整个服务不可用，我们可以限定每个接口可以使用的资源范围，也就是将其“隔离”起来。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885aac45ccdb.png" alt="image-20250727122747279"></p><p>如图所示，我们给查询购物车业务限定可用线程数量上限为20，这样即便查询购物车的请求因为查询商品服务而出现故障，也不会导致服务器的线程资源被耗尽，不会影响到其它接口。</p><h3 id="424-服务熔断">4.2.4 服务熔断</h3><p>线程隔离虽然避免了雪崩问题，但故障服务（商品服务）依然会拖慢购物车服务（服务调用方）的接口响应速度。而且商品查询的故障依然会导致查询购物车功能出现故障，购物车业务也变的不可用了。</p><p>所以，我们要做两件事情：</p><ul><li><strong>编写服务降级逻辑</strong>：就是服务调用失败后的处理逻辑，根据业务场景，可以抛出异常，也可以返回友好提示或默认数据。</li><li><strong>异常统计和熔断</strong>：统计服务提供方的异常比例，当比例过高表明该接口会影响到其它服务，应该拒绝调用该接口，而是直接走降级逻辑。</li></ul><p>这里服务提供方就是商品服务，异常比例过高意思就是说如果过往记录中发现调用10商品服务，有6次失败（60%），而熔断决策这里是当失败率超过阈值（如50%），购物车服务（调用方）的熔断器会：</p><ul><li>拒绝后续请求：不再真正调用商品服务，避免资源浪费。</li><li>直接走降级逻辑：返回缓存数据、默认值或友好提示。</li></ul><p>熔断恢复：</p><p>经过一段时间（如5秒），熔断器尝试放行一个请求探测商品服务是否恢复。若成功，则逐步关闭熔断。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885ab3154574.png" alt="image-20250727122936308"></p><h2 id="43-sentinel">4.3 Sentinel</h2><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://github.com/alibaba/Sentinel/releases"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left"><i class="anzhiyufont anzhiyu-icon-link"></i></div><div class="tag-link-right"><div class="tag-link-title">Sentinel</div><div class="tag-link-sitename">jar包下载</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><p>微服务保护的技术有很多，但在目前国内使用较多的还是Sentinel，所以接下来我们学习Sentinel的使用。</p><p>Sentinel是阿里巴巴开源的一款服务保护框架，目前已经加入SpringCloudAlibaba中。</p><p>Sentinel 的使用可以分为两个部分:</p><ul><li><strong>核心库</strong>（Jar包）：不依赖任何框架/库，能够运行于 Java 8 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。在项目中引入依赖即可实现服务限流、隔离、熔断等功能。</li><li><strong>控制台</strong>（Dashboard）：Dashboard 主要负责管理推送规则、监控、管理机器信息等。</li></ul><h3 id="431-sentinel安装">4.3.1 Sentinel安装</h3><h4 id="window安装">Window安装</h4><p>下载jar包，cmd运行：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -Dserver.port=8090 -Dcsp.sentinel.dashboard.server=localhost:8090 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar</span><br></pre></td></tr></table></figure><p>访问<a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8090</a>页面，就可以看到sentinel的控制台了</p><p>需要输入账号和密码，默认都是：sentinel</p><p>登录后，即可看到控制台，默认会监控sentinel-dashboard服务本身</p><h4 id="docker运行">Docker运行</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> sentinel <span class="literal">-p</span> <span class="number">8090</span>:<span class="number">8858</span> <span class="literal">--network</span> hm<span class="literal">-net</span> bladex/sentinel<span class="literal">-dashboard</span>:<span class="number">1.8</span>.<span class="number">7</span></span><br></pre></td></tr></table></figure><p>然后运行http://192.168.163.129:8090</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885bdfbd1cb5.png" alt="image-20250727134943797"></p><h3 id="432-fallback">4.3.2 Fallback</h3><p>触发限流或熔断后的请求不一定要直接报错，也可以返回一些默认数据或者友好提示，用户体验会更好。</p><p>给FeignClient编写失败后的降级逻辑有两种方式：</p><ul><li>方式一：FallbackClass，无法对远程调用的异常做处理</li><li>方式二：FallbackFactory，可以对远程调用的异常做处理，我们一般选择这种方式。</li></ul><h2 id="44-分布式事务">4.4 分布式事务</h2><p>首先我们看看项目中的下单业务整体流程：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885e1586ebce.png" alt="image-20250727162035686"></p><p>由于订单、购物车、商品分别在三个不同的微服务，而每个微服务都有自己独立的数据库，因此下单过程中就会跨多个数据库完成业务。而每个微服务都会执行自己的本地事务：</p><ul><li>交易服务：下单事务</li><li>购物车服务：清理购物车事务</li><li>库存服务：扣减库存事务</li></ul><p>整个业务中，各个本地事务是有关联的。因此每个微服务的本地事务，也可以称为<strong>分支事务</strong>。多个有关联的分支事务一起就组成了<strong>全局事务</strong>。我们必须保证整个全局事务同时成功或失败。</p><p>我们知道每一个分支事务就是传统的<strong>单体事务</strong>，都可以满足ACID特性，但全局事务跨越多个服务、多个数据库，是否还能满足呢？</p><p>我们来做一个测试，先进入购物车页面：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885e17732490.png" alt="image-20250727162106559"></p><p>目前有4个购物车，然结算下单，进入订单结算页面：</p><p>然后将购物车中某个商品的库存修改为<code>0</code>：</p><p>然后，提交订单，最终因库存不足导致下单失败：</p><p>然后我们去查看购物车列表，发现购物车数据依然被清空了，并未回滚：</p><p>事务并未遵循ACID的原则，归其原因就是参与事务的多个子业务在不同的微服务，跨越了不同的数据库。虽然每个单独的业务都能在本地遵循ACID，但是它们互相之间没有感知，不知道有人失败了，无法保证最终结果的统一，也就无法遵循ACID的事务特性了。</p><p>这就是分布式事务问题，出现以下情况之一就可能产生分布式事务问题：</p><ul><li>业务跨多个服务实现</li><li>业务跨多个数据源实现</li></ul><p>接下来这一章我们就一起来研究下如何解决分布式事务问题。</p><h3 id="441-seata">4.4.1 Seata</h3><p>解决分布式事务的方案有很多，但实现起来都比较复杂，因此我们一般会使用开源的框架来解决分布式事务问题。在众多的开源分布式事务框架中，功能最完善、使用最多的就是阿里巴巴在2019年开源的Seata了。</p><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://seata.apache.org/zh-cn/docs/overview/what-is-seata"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left"><i class="anzhiyufont anzhiyu-icon-link"></i></div><div class="tag-link-right"><div class="tag-link-title">Seata</div><div class="tag-link-sitename">官方文档</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><p>其实分布式事务产生的一个重要原因，就是参与事务的多个分支事务互相无感知，不知道彼此的执行状态。因此解决分布式事务的思想非常简单：</p><p>就是找一个统一的<strong>事务协调者</strong>，与多个分支事务通信，检测每个分支事务的执行状态，保证全局事务下的每一个分支事务同时成功或失败即可。大多数的分布式事务框架都是基于这个理论来实现的。</p><p>Seata也不例外，在Seata的事务管理中有三个重要的角色：</p><ul><li><strong>TC</strong> <strong>(Transaction Coordinator</strong>) - **事务协调者：**维护全局和分支事务的状态，协调全局事务提交或回滚。</li><li><strong>TM (Transaction Manager) -</strong> **事务管理器：**定义全局事务的范围、开始全局事务、提交或回滚全局事务。</li><li><strong>RM (Resource Manager) -</strong> **资源管理器：**管理分支事务，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li></ul><p>Seata的工作架构如图所示：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885e4942f0e7.png" alt="image-20250727163426944"></p><p>其中，<strong>TM</strong>和<strong>RM</strong>可以理解为Seata的客户端部分，引入到参与事务的微服务依赖中即可。将来<strong>TM</strong>和<strong>RM</strong>就会协助微服务，实现本地分支事务与<strong>TC</strong>之间交互，实现事务的提交或回滚。</p><p>而<strong>TC</strong>服务则是事务协调中心，是一个独立的微服务，需要单独部署。</p><details class="folding-tag" green><summary>三者关系的小例子</summary><div class="content"><p>可以把 Seata 处理分布式事务的过程，类比成组织一次多人协作的搬家任务，用生活化场景理解三个角色：</p><ol type="1"><li>TM（事务管理器）：搬家发起人</li></ol><ul><li><strong>作用</strong>：决定要不要开始 “全局事务（搬家这件事）”，以及最后成功了提交结果（搬完）、失败了回滚（不搬或恢复原样）。</li><li><strong>举例</strong>：你（TM）想组织一次搬家，先拍板 “周末要把家里东西搬到新房”（定义全局事务范围），然后通知大家开始干活（开启全局事务）。要是中途发现新房没收拾好，你说 “不搬了，东西放回原处”（回滚全局事务）；要是一切顺利，你确认 “搬完啦，任务结束”（提交全局事务）。</li></ul><ol start="2" type="1"><li>TC（事务协调者）：搬家总指挥</li></ol><ul><li><strong>作用</strong>：盯着所有 “分支事务（打包、搬运、拆装家具等环节）” 的状态，协调大家一起成功或一起失败。</li><li><strong>举例</strong>：你请了个指挥（TC），他负责盯着：打包队有没有把东西包好（分支事务状态）、搬运车有没有把东西运到（分支事务状态）、拆装队有没有把家具装好（分支事务状态）…… 要是打包队说 “包一半发现东西太多，搞不定”，指挥（TC）就通知所有人 “别搬了，各自恢复原样”；要是所有人都反馈 “搞定”，指挥（TC）就告诉大家 “可以收尾，任务完成”。</li></ul><ol start="3" type="1"><li>RM（资源管理器）：具体干活的小组</li></ol><ul><li><strong>作用</strong>：管理自己负责的 “分支事务（比如打包组管打包、搬运组管运输）”，随时给 TC 汇报进度和状态。</li><li><strong>举例</strong>：<ul><li>打包组（RM1）：负责把家里东西分类打包，打包完了跟指挥（TC）说 “我们包好啦”；要是打包到一半发现东西坏了，也跟指挥（TC）说 “这里搞不定，需要回退”。</li><li>搬运组（RM2）：负责把打包好的东西运到新房，路上车坏了（分支事务失败），就跟指挥（TC）汇报 “运不了，得终止”；要是顺利运到，就说 “送达成功”。</li><li>拆装组（RM3）：负责在新房把家具装好，装完汇报 “装好了”；装到一半发现零件少了，汇报 “装不了，得回退”。</li></ul></li></ul><p><strong>总结流程</strong>： 你（TM）发起搬家（全局事务）→ 指挥（TC）协调打包、搬运、拆装（分支事务）→ 每个小组（RM）干活并汇报状态 → 指挥（TC）根据所有人状态，决定让大家一起成功（搬完）或一起回滚（不搬 / 恢复）→ 你（TM）最终确认结果。</p></div></details><h3 id="442-seata配置">4.4.2 Seata配置</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">--name</span> seata \</span><br><span class="line"><span class="literal">-p</span> <span class="number">8099</span>:<span class="number">8099</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">7099</span>:<span class="number">7099</span> \</span><br><span class="line"><span class="literal">-e</span> SEATA_IP=<span class="number">192.168</span>.<span class="number">163.129</span> \</span><br><span class="line"><span class="literal">-v</span> ./seata:/seata<span class="literal">-server</span>/resources \</span><br><span class="line"><span class="literal">--privileged</span>=true \</span><br><span class="line"><span class="literal">--network</span> hm<span class="literal">-net</span> \</span><br><span class="line"><span class="literal">-d</span> \</span><br><span class="line">seataio/seata<span class="literal">-server</span>:<span class="number">1.5</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure><p>这样就使用Docker成功部署了</p><h3 id="443-微服务集成seata">4.4.3 微服务集成Seata</h3><h4 id="导入依赖">导入依赖</h4><p>为了方便各个微服务集成seata，我们需要把seata配置共享到nacos，因此<code>trade-service</code>模块不仅仅要引入seata依赖，还要引入nacos依赖:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--统一配置管理--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--读取bootstrap文件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="配置nacos">配置nacos</h4><p>首先在nacos上添加一个共享的seata配置，命名为<code>shared-seata.yaml</code>：</p><p>内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">registry:</span> <span class="comment"># TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span> <span class="comment"># 注册中心类型 nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span> <span class="comment"># nacos地址</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span> <span class="comment"># namespace，默认为空</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment"># 分组，默认是DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span> <span class="comment"># seata服务名称</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">hmall</span> <span class="comment"># 事务组名称</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span> <span class="comment"># 事务组与tc集群的映射关系</span></span><br><span class="line">      <span class="attr">hmall:</span> <span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885fec9f2b39.png" alt="image-20250727182613408"></p><h4 id="改造配置">改造配置</h4><p><code>bootstrap.yaml</code>：</p><p>内容如下:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">trade-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span> <span class="comment"># nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 文件后缀名</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="comment"># 共享配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-jdbc.yaml</span> <span class="comment"># 共享mybatis配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-log.yaml</span> <span class="comment"># 共享日志配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-swagger.yaml</span> <span class="comment"># 共享日志配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-seata.yaml</span> <span class="comment"># 共享seata配置</span></span><br></pre></td></tr></table></figure><h3 id="444-xa模式面试题">4.4.4 XA模式（面试题）</h3><p>XA规范是X/Open组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准，XA规范描述了全局的TM与局部的RM之间的接口，几乎所有主流的关系型数据库都对XA规范提供了支持。Seata的XA模式如下:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/68860a70183b9.png" alt="image-20250727191557888"></p><p>一阶段的工作</p><ul><li>RM注册分支事务到TC</li><li>RM执行分支业务SQL但是不提交</li><li>RM报告执行状态到TC</li></ul><p>二阶段的工作</p><ul><li>TC检测各分支事务执行状态（如果成功/失败，通知RM提交/回滚事务）</li><li>RM接收TC指令，提交/回滚事务</li></ul><blockquote><p>具体流程</p></blockquote><ul><li>当方法执行时，全局事务（TM）向TC注册一个全局事务</li><li>TM执行内部业务逻辑，调用每一个分支</li><li>RM会拦截对SQL的操作,RM会向TC注册分支事务</li><li>然后再放行去执行业务的SQL（SQL执行完毕后不可以<strong>提交</strong>）</li><li>当所有方法执行完毕TM会向TC发送全局事务结束的信息</li><li>TC会检查注册分支的事务状态 ，如果发现都成功了就向所有分支发送提交/回滚的指令</li><li>这些事务才能提交事务释放锁（反之下达回滚的命令）</li></ul><blockquote><p>优缺点</p></blockquote><p>XA模式的优点是什么?</p><ul><li>·事务的强一致性，满足ACID原则。</li><li>·常用数据库都支持，实现简单，并且没有代码侵入</li></ul><p>XA模式的缺点是什么?</p><ul><li>·因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差</li><li>·依赖关系型数据库实现事务</li></ul><h4 id="回滚日志">回滚日志</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">28.936</span>  INFO <span class="literal">---</span> [<span class="type">rverHandlerThread_1_4_500</span>] i.s.s.coordinator.DefaultCoordinator     : <span class="keyword">Begin</span> new global transaction applicationId: trade<span class="literal">-serviceup</span>: hmall, transactionName: createOrder(com.hmall.trade.domain.dto.OrderFormDTO),timeout:<span class="number">60000</span>,xid:<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203713</span></span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.113</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.139</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203715</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.286</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.290</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203717</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.345</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.350</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203719</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.464</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.468</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203721</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.548</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-cart</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.554</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203723</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-cart</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.597</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203713</span>,extraData=null1,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.734</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_10_500</span>] io.seata.server.coordinator.DefaultCore  : Committing global transaction is successfully done, xid =<span class="number">45712777161203713</span>.</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.234</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : timeout=<span class="number">60000</span>,transactionName=createOrder(com.hmall.tradeTO),clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.239</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_11_500</span>] i.s.s.coordinator.DefaultCoordinator     : <span class="keyword">Begin</span> new global transaction applicationId: trade<span class="literal">-serviceup</span>: hmall, transactionName: createOrder(com.hmall.trade.domain.dto.OrderFormDTO),timeout:<span class="number">60000</span>,xid:<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203822</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.270</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.288</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203824</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.317</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.322</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203826</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.339</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.342</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203828</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.369</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.372</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203830</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.435</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">4571277716120361203830</span>,resourceId=null,status=PhaseOne_Failed,applicationData=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.485</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Report branch status successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:, branchId = <span class="number">45712777161203830</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.612</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203822</span>,extraData=null1,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.664</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback branch transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span> branchId = <span class="number">45712777161203828</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.679</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback branch transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span> branchId = <span class="number">45712777161203826</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.692</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback branch transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span> branchId = <span class="number">45712777161203824</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.694</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback global transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span>.</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">39.827</span>  INFO <span class="literal">---</span> [      <span class="type">RetryCommitting_1_1</span>] io.seata.server.coordinator.DefaultCore  : Committing global transaction is successfully done, xid =<span class="number">45712777161203713</span>.</span><br><span class="line"><span class="number">01</span>:<span class="number">22</span>:<span class="number">16.808</span>  INFO <span class="literal">---</span> [     <span class="type">RetryRollbacking_1_1</span>] io.seata.server.coordinator.DefaultCore  : Rollback global transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span>.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="445-at模式">4.4.5 AT模式</h3><p><code>AT</code>模式同样是分阶段提交的事务模型，不过缺弥补了<code>XA</code>模型中资源锁定周期过长的缺陷</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/6886d4f275380.png" alt="image-20250728093957746"></p><p>阶段一<code>RM</code>的工作：</p><ul><li>注册分支事务</li><li>记录undo-log（数据快照）</li><li>执行业务sql并提交</li><li>报告事务状态</li></ul><p>阶段二提交时<code>RM</code>的工作：</p><ul><li>删除undo-log即可</li></ul><p>阶段二回滚时<code>RM</code>的工作：</p><ul><li>根据undo-log恢复数据到更新前</li></ul><blockquote><p>具体流程</p></blockquote><ol type="1"><li>全局事务方法开启时TM会向TC注册一个全局事务</li><li>TM调用所有的分支</li><li>，在操作SQL之前会被RM拦截，RM会向TC注册分支事务</li><li>微服务的item执行具体的SQL语句并且<strong>立刻提交事务</strong></li><li>item在执行SQL之前先去生成一个修改数据库之前的数据保存一个快照， 保存在数据表<code>undo-log</code>中</li><li>当执行完毕后回向TC报告事务状态</li><li>TM会向TC报告事务的状态</li><li>TC会检测事务状态，都成功会删除log快照，失败则回滚从数据库中恢复快照</li></ol><p>那么万一有其他线程这时候修改了数据怎么办呢？？？</p><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://www.cnblogs.com/hongdada/p/16796704.html"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left"><i class="anzhiyufont anzhiyu-icon-link"></i></div><div class="tag-link-right"><div class="tag-link-title">Seata全局锁</div><div class="tag-link-sitename">防止脏读</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><p>简述<code>AT</code>模式与<code>XA</code>模式最大的区别是什么？</p><ul><li><code>XA</code>模式一阶段不提交事务，锁定资源；<code>AT</code>模式一阶段直接提交，不锁定资源。</li><li><code>XA</code>模式依赖数据库机制实现回滚；<code>AT</code>模式利用数据快照实现数据回滚。</li><li><code>XA</code>模式强一致；<code>AT</code>模式最终一致</li></ul><p>快照数据的版本检查</p><p>Seata在回滚时会检查快照数据的版本是否与当前数据一致。如果发现数据已经被其他事务修改，Seata会抛出异常，阻止回滚操作。这种机制可以避免数据被错误覆盖，但会导致事务回滚失败，需要额外的处理逻辑。补偿机制：如果回滚失败，Seata会尝试通过补偿机制（如补偿SQL）来恢复数据。补偿SQL是根据业务逻辑预先定义的，用于在回滚失败时尽可能恢复数据的一致性。</p><h1 id="五mq基础">五、MQ基础</h1><blockquote><p>面试考点来了嘿嘿</p></blockquote><h2 id="51-异步调用">5.1 异步调用</h2><p>异步调用方式其实就是基于消息通知的方式，一般包含三个角色：</p><ul><li>消息发送者：投递消息的人，就是原来的调用方</li><li>消息Broker：管理、暂存、转发消息，你可以把它理解成微信服务器</li><li>消息接收者：接收和处理消息的人，就是原来的服务提供方</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68870ee59ec7e.png" alt="image-20250728134714684"></p><p>在异步调用中，发送者不再直接同步调用接收者的业务接口，而是发送一条消息投递给消息Broker。然后接收者根据自己的需求从消息Broker那里订阅消息。每当发送方发送消息后，接受者都能获取消息并处理。</p><p>这样，发送消息的人和接收消息的人就完全解耦了。</p><p>还是以余额支付业务为例：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68870f2ea38f5.png" alt="image-20250728134824173"></p><p>除了扣减余额、更新支付流水单状态以外，其它调用逻辑全部取消。而是改为发送一条消息到Broker。而相关的微服务都可以订阅消息通知，一旦消息到达Broker，则会分发给每一个订阅了的微服务，处理各自的业务。</p><p>假如产品经理提出了新的需求，比如要在支付成功后更新用户积分。支付代码完全不用变更，而仅仅是让积分服务也订阅消息即可：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68870f493649c.png" alt="image-20250728134850118"></p><p>不管后期增加了多少消息订阅者，作为支付服务来讲，执行问扣减余额、更新支付流水状态后，发送消息即可。业务耗时仅仅是这三部分业务耗时，仅仅100ms，大大提高了业务性能。</p><p>另外，不管是交易服务、通知服务，还是积分服务，他们的业务与支付关联度低。现在采用了异步调用，解除了耦合，他们即便执行过程中出现了故障，也不会影响到支付服务。</p><ul><li>交易服务、通知服务、积分服务收到Broker的消息后，如果业务代码没有执行成功broker还会再给服务发消息直到成功执行为止。</li><li>为了使用mq实现分布式事务，不能将mq发送消息的代码加入到事务中，比如像rabbitmq不支持rollback回滚操作的。此时可以配合分布式事务seata中的事务钩子，定义一个发送消息的方法，每当事务成功的时候，就可以发送消息。</li></ul><p>综上，异步调用的优势包括：</p><ul><li>耦合度更低</li><li>性能更好</li><li>业务拓展性强</li><li>故障隔离，避免级联失败</li><li>缓存消息，流量削峰填谷</li></ul><p>当然，异步通信也并非完美无缺，它存在下列缺点：</p><ul><li>完全依赖于Broker的可靠性、安全性和性能</li><li>架构复杂，后期维护和调试麻烦</li></ul><h2 id="52-技术选型">5.2 技术选型</h2><p>消息Broker，目前常见的实现方案就是消息队列（MessageQueue），简称为MQ.</p><p>目比较常见的MQ实现：</p><ul><li>ActiveMQ</li><li>RabbitMQ</li><li>RocketMQ</li><li>Kafka</li></ul><p>几种常见MQ的对比</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">RabbitMQ</th><th style="text-align:center">ActiveMQ</th><th style="text-align:center">RocketMQ</th><th style="text-align:center">Kafka</th></tr></thead><tbody><tr><td style="text-align:center">公司/社区</td><td style="text-align:center">Rabbit</td><td style="text-align:center">Apache</td><td style="text-align:center">阿里</td><td style="text-align:center">Apache</td></tr><tr><td style="text-align:center">开发语言</td><td style="text-align:center">Erlang</td><td style="text-align:center">Java</td><td style="text-align:center">Java</td><td style="text-align:center">Scala&amp;Java</td></tr><tr><td style="text-align:center">协议支持</td><td style="text-align:center">AMQP，XMPP，SMTP，STOMP</td><td style="text-align:center">OpenWire,STOMP，REST,XMPP,AMQP</td><td style="text-align:center">自定义协议</td><td style="text-align:center">自定义协议</td></tr><tr><td style="text-align:center">可用性</td><td style="text-align:center">高</td><td style="text-align:center">一般</td><td style="text-align:center">高</td><td style="text-align:center">高</td></tr><tr><td style="text-align:center">单机吞吐量</td><td style="text-align:center">一般</td><td style="text-align:center">差</td><td style="text-align:center">高</td><td style="text-align:center">非常高</td></tr><tr><td style="text-align:center">消息延迟</td><td style="text-align:center">微秒级</td><td style="text-align:center">毫秒级</td><td style="text-align:center">毫秒级</td><td style="text-align:center">毫秒以内</td></tr><tr><td style="text-align:center">消息可靠性</td><td style="text-align:center">高</td><td style="text-align:center">一般</td><td style="text-align:center">高</td><td style="text-align:center">一般</td></tr></tbody></table><p>追求可用性：Kafka、 RocketMQ 、RabbitMQ</p><p>追求可靠性：RabbitMQ、RocketMQ</p><p>追求吞吐能力：RocketMQ、Kafka</p><p>追求消息低延迟：RabbitMQ、Kafka</p><p>据统计，目前国内消息队列使用最多的还是RabbitMQ，再加上其各方面都比较均衡，稳定性也好，因此我们选择RabbitMQ来学习。</p><h2 id="53-rabbitmq">5.3 RabbitMQ</h2><h3 id="531-安装">5.3.1 安装</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run \</span><br><span class="line"> <span class="literal">-e</span> RABBITMQ_DEFAULT_USER=itheima \</span><br><span class="line"> <span class="literal">-e</span> RABBITMQ_DEFAULT_PASS=<span class="number">123321</span> \</span><br><span class="line"> <span class="literal">-v</span> mq<span class="literal">-plugins</span>:/plugins \</span><br><span class="line"> <span class="literal">--name</span> mq \</span><br><span class="line"> <span class="literal">--hostname</span> mq \</span><br><span class="line"> <span class="literal">-p</span> <span class="number">15672</span>:<span class="number">15672</span> \</span><br><span class="line"> <span class="literal">-p</span> <span class="number">5672</span>:<span class="number">5672</span> \</span><br><span class="line"> <span class="literal">--network</span> hm<span class="literal">-net</span>\</span><br><span class="line"> <span class="literal">-d</span> \</span><br><span class="line"> rabbitmq:<span class="number">3.8</span><span class="literal">-management</span></span><br></pre></td></tr></table></figure><p>然后访问http://192.168.150.101:15672即可看到管理控制台。首次访问需要登录，默认的用户名和密码在配置文件中已经指定了。</p><p>RabbitMQ对应的架构：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/688725203b22d.png" alt="image-20250728152206702"></p><p>其中包含几个概念：</p><ul><li><strong><code>publisher</code></strong>：生产者，也就是发送消息的一方</li><li><strong><code>consumer</code></strong>：消费者，也就是消费消息的一方</li><li><strong><code>queue</code></strong>：队列，存储消息。生产者投递的消息会暂存在消息队列中，等待消费者处理</li><li><strong><code>exchange</code></strong>：交换机，负责消息路由。生产者发送的消息由交换机决定投递到哪个队列。（区分计网中的交换机：RabbitMQ的交换机是用于消息传递的，而计网的交换机是用于数据包传输的。）</li><li><strong><code>virtual host</code></strong>：虚拟主机，起到数据隔离的作用。每个虚拟主机相互独立，有各自的exchange、queue（每个虚拟主机相当于一个数据库，彼此之间互不影响）</li></ul><h3 id="532-spring-amqp">5.3.2 Spring AMQP</h3><p>将来我们开发业务功能的时候，肯定不会在控制台收发消息，而是应该基于编程的方式。由于<code>RabbitMQ</code>采用了AMQP协议，因此它具备跨语言的特性。任何语言只要遵循AMQP协议收发消息，都可以与<code>RabbitMQ</code>交互。并且<code>RabbitMQ</code>官方也提供了各种不同语言的客户端。</p><p>但是，RabbitMQ官方提供的Java客户端编码相对复杂，一般生产环境下我们更多会结合Spring来使用。而Spring的官方刚好基于RabbitMQ提供了这样一套消息收发的模板工具：SpringAMQP。并且还基于SpringBoot对其实现了自动装配，使用起来非常方便。</p><p>SpringAMQP提供了三个功能：</p><ul><li>自动声明队列、交换机及其绑定关系(设置队列)</li><li>基于注解的监听器模式，异步接收消息(设置消费端)</li><li>封装了RabbitTemplate工具，用于发送消息(设置生产端)</li></ul><h4 id="5321-workqueues模型">5.3.2.1 WorkQueues模型</h4><p>Work queues，任务模型。简单来说就是<strong>让多个消费者</strong>绑定到一个队列，共同消费队列中的消息。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/6887393660eac.png" alt="image-20250728164739680"></p><p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。</p><p>此时就可以使用work 模型，<strong>多个消费者共同处理消息处理，消息处理的速度就能大大提高</strong>了。</p><h4 id="5322-交换机">5.3.2.2 交换机</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68873f1c747c5.png" alt="image-20250728171249867"></p><p>可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：</p><ul><li><strong>Publisher</strong>：生产者，不再发送消息到队列中，而是发给交换机</li><li><strong>Exchange</strong>：交换机，一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。</li><li><strong>Queue</strong>：消息队列也与以前一样，接收消息、缓存消息。不过队列一定要与交换机绑定。</li><li><strong>Consumer</strong>：消费者，与以前一样，订阅队列，没有变化</li></ul><p><strong>Exchange</strong>（交换机）只负责转发消息，不具备存储消息的能力，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！（引入Exchange的目的是为了在Rabbitmq中一个消息能够分发给多个queue中被不同的消费者服务多次消费，比如你一个订单信息需要加积分，加经验，这下可以分为两个queue来执行）</p><p>交换机的类型有四种：</p><ul><li><strong>Fanout</strong>：广播，将消息交给所有绑定到交换机的队列。我们最早在控制台使用的正是Fanout交换机</li><li><strong>Direct</strong>：订阅，基于RoutingKey（路由key）发送给订阅了消息的队列</li><li><strong>Topic</strong>：通配符订阅，与Direct类似，只不过RoutingKey可以使用通配符</li><li><strong>Headers</strong>：头匹配，基于MQ的消息头匹配，用的较少。</li></ul><h4 id="5323-fanout-交换机">5.3.2.3 Fanout 交换机</h4><p>Fanout Exchange 会将接收到的消息路由到每一个跟其绑定的queue，所以也叫广播模式</p><h4 id="5324-direct-交换机">5.3.2.4 Direct 交换机</h4><p>Direct Exchange 会将接收到的消息根据规则路由到指定的Queue，因此称为<strong>定向</strong>路由。</p><ul><li>每一个Queue都与Exchange设置一个BindingKey</li><li>发布者发送消息时，指定消息的RoutingKey</li><li>Exchange将消息路由到BindingKey与消息RoutingKey一致的队列</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68874f0032449.png" alt="image-20250728182043602"></p><p>描述下Direct交换机与Fanout交换机的差异？</p><ul><li>Fanout交换机将消息路由给每一个与之绑定的队列</li><li>Direct交换机根据RoutingKey判断路由给哪个队列</li><li>如果多个队列具有相同的RoutingKey，则与Fanout功能类似</li></ul><h4 id="5325-topic交换机">5.3.2.5 Topic交换机</h4><p>TopicExchange也是基于RoutingKey做消息路由，但是routingKey通常是多个单词的组合，并且以.分割。</p><p>Queue与Exchange指定BindingKey时可以使用通配符</p><ul><li>#：代指0个或多个单词</li><li>*： 代指一个单词</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/688751e789935.png" alt="image-20250728183310831"></p><h4 id="5326-声明队列和交换机">5.3.2.6 声明队列和交换机</h4><p>在之前我们都是基于RabbitMQ控制台来创建队列、交换机。但是在实际开发时，队列和交换机是程序员定义的，将来项目上线，又要交给运维去创建。那么程序员就需要把程序中运行的所有队列和交换机都写下来，交给运维。在这个过程中是很容易出现错误的。</p><p>因此推荐的做法是由程序启动时检查队列和交换机是否存在，如果不存在自动创建。</p><blockquote><p>如果交换机或队列不存在</p><p>Spring AMQP会自动创建它们：</p><p>如果交换机（Exchange）不存在，Spring AMQP会根据注解中的配置（如名称和类型）自动创建交换机。</p><p>如果队列（Queue）不存在，Spring AMQP会根据注解中的配置（如名称）自动创建队列。</p><p>如果绑定关系（Binding）不存在，Spring AMQP会根据注解中的配置（如路由键）自动建立绑定关系。</p><p>如果交换机或队列已经存在</p><p>不会更改已存在的交换机或队列：</p><p>如果交换机或队列已经存在，并且它们的配置（如名称、类型等）与注解中的配置一致，Spring AMQP不会对它们进行任何更改。</p><p>如果交换机或队列的配置与注解中的配置不一致（例如，交换机类型不同或队列的持久性设置不同），RabbitMQ会抛出错误，导致声明失败。</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到direct.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到direct.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再试试Topic模式：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;china.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到topic.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;#.news&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到topic.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5327-消息转换器">5.3.2.7 消息转换器</h4><p>当使用 Spring 发送消息时，传输内容通常是 Java 对象，但消息队列只能处理字节数据。因此，需要先将对象序列化为字节发送，接收时再反序列化为对象。Spring 默认使用的是 JDK 的序列化机制，但这种方式格式不友好、体积大、不安全。实际开发中，通常会配置 JSON 转换器，使消息更轻量、可读且更安全。</p><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后添加一个Bean</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jackson2JsonMessageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.配置自动创建消息id，用于识别不同消息，也可以在业务中基于ID判断是否是重复消息</span></span><br><span class="line">    jackson2JsonMessageConverter.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jackson2JsonMessageConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5328-订单业务">5.3.2.8 订单业务</h4><p>案例需求：改造余额支付功能，将支付成功后基于OpenFeign的交易服务的更新订单状态接口的同步调用，改为基于RabbitMQ的异步通知。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68885ef954ca9.png" alt="image-20250729134112561"></p><p>说明：目前没有通知服务和积分服务，因此我们只关注交易服务，步骤如下：</p><ul><li>定义<code>direct</code>类型交换机，命名为<code>pay.direct</code></li><li>定义消息队列，命名为<code>trade.pay.success.queue</code></li><li>将<code>trade.pay.success.queue</code>与<code>pay.direct</code>绑定，<code>BindingKey</code>为<code>pay.success</code></li><li>支付成功时不再调用交易服务更新订单状态的接口，而是发送一条消息到<code>pay.direct</code>，发送消息的<code>RoutingKey</code> 为<code>pay.success</code>，消息内容是订单id</li><li>交易服务监听<code>trade.pay.success.queue</code>队列，接收到消息后更新订单状态为已支付</li></ul><p>不管是生产者还是消费者，都需要配置MQ的基本信息。分为两步：</p><p>1）添加依赖：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--消息发送--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）配置MQ地址：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span> <span class="comment"># 你的虚拟机IP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure><p>4.1.接收消息</p><p>在trade-service服务中定义一个消息监听类：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68885f2ceb484.png" alt="image-20250729134204022"></p><p>其代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.trade.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.trade.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ExchangeTypes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayStatusListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = &quot;trade.pay.success.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = &quot;pay.topic&quot;),</span></span><br><span class="line"><span class="meta">            key = &quot;pay.success&quot;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenPaySuccess</span><span class="params">(Long orderId)</span>&#123;</span><br><span class="line">        orderService.markOrderPaySuccess(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.2.发送消息</p><p>修改<code>pay-service</code>服务下的<code>com.hmall.pay.``service``.impl.``PayOrderServiceImpl</code>类中的<code>tryPayOrderByBalance</code>方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPayOrderByBalance</span><span class="params">(PayOrderDTO payOrderDTO)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.查询支付单</span></span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">po</span> <span class="operator">=</span> getById(payOrderDTO.getId());</span><br><span class="line">    <span class="comment">// 2.判断状态</span></span><br><span class="line">    <span class="keyword">if</span>(!PayStatus.WAIT_BUYER_PAY.equalsValue(po.getStatus()))&#123;</span><br><span class="line">        <span class="comment">// 订单不是未支付，状态异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;交易已支付或关闭！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.尝试扣减余额</span></span><br><span class="line">    userClient.deductMoney(payOrderDTO.getPw(), po.getAmount());</span><br><span class="line">    <span class="comment">// 4.修改支付单状态</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> markPayOrderSuccess(payOrderDTO.getId(), LocalDateTime.now());</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;交易已支付或关闭！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.修改订单状态</span></span><br><span class="line">    <span class="comment">// tradeClient.markOrderPaySuccess(po.getBizOrderNo());</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;pay.direct&quot;</span>, <span class="string">&quot;pay.success&quot;</span>, po.getBizOrderNo());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;支付成功的消息发送失败，支付单id：&#123;&#125;， 交易单id：&#123;&#125;&quot;</span>, po.getId(), po.getBizOrderNo(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="六-mq高级">六、 MQ高级</h1><h2 id="1发送者的可靠性">1.发送者的可靠性</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/688865206c1ba.png" alt="image"></p><h3 id="11-发送者重连">1.1 发送者重连</h3><p>首先第一种情况，就是生产者发送消息时，出现了网络故障，导致与MQ的连接中断。</p><p>为了解决这个问题，SpringAMQP提供的消息发送时的重试机制。即：当<code>RabbitTemplate</code>与MQ连接超时后，多次重试。</p><p>修改<code>publisher</code>模块的<code>application.yaml</code>文件，添加下面的内容：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="string">1s</span> <span class="comment"># 设置MQ的连接超时时间</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启超时重试机制</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 失败后的初始等待时间</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br></pre></td></tr></table></figure><p>当网络不稳定的时候，利用重试机制可以有效提高消息发送的成功率。不过SpringAMQP提供的重试机制是阻塞式的重试，也就是说多次重试等待的过程中，当前线程是被阻塞的，会影响业务性能。</p><p>如果对于业务性能有要求，建议禁用重试机制。如果一定要使用，请合理配置等待时长和重试次数，当然也可以考虑使用异步线程来执行发送消息的代码。</p><h3 id="12-发送者确认">1.2 发送者确认</h3><p>SpringAMQP提供了Publisher Confirm和Publisher Return两种确认机制。开启确机制认后，当发送者发送消息给MQ后，MQ会返回确认结果给发送者。返同的结里有以下几种情况</p><p>一般情况下，只要生产者与MQ之间的网路连接顺畅，基本不会出现发送消息丢失的情况，因此大多数情况下我们无需考虑这种问题。</p><p>不过，在少数情况下，也会出现消息发送到MQ之后丢失的现象，比如：</p><ul><li>MQ内部处理消息的进程发生了异常</li><li>生产者发送消息到达MQ后未找到<code>Exchange</code></li><li>生产者发送消息到达MQ的<code>Exchange</code>后，未找到合适的<code>Queue</code>，因此无法路由</li></ul><p>针对上述情况，RabbitMQ提供了生产者消息确认机制，包括<code>Publisher Confirm</code>和<code>Publisher Return</code>两种。在开启确认机制的情况下，当生产者发送消息给MQ后，MQ会根据消息处理的情况返回不同的<strong>回执</strong>。</p><p>具体如图所示：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68886be28537d.png" alt="image-20250729143619347"></p><p>总结如下：</p><ul><li><p>当消息投递到MQ，但是路由失败时，通过<strong>Publisher Return</strong>返回异常信息，同时返回ack的确认信息，代表投递成功</p></li><li><p>临时消息投递到了MQ，并且入队成功，返回ACK，告知投递成功</p></li><li><p>持久消息投递到了MQ，并且入队完成持久化，返回ACK ，告知投递成功</p></li><li><p>其它情况都会返回NACK，告知投递失败</p></li><li><p>其中<code>ack</code>和<code>nack</code>属于<strong>Publisher Confirm</strong>机制，<code>ack</code>是投递成功；<code>nack</code>是投递失败。而<code>return</code>则属于<strong>Publisher Return</strong>机制。</p><p>默认两种机制都是关闭状态，需要通过配置文件来开启。</p></li><li><p>return和confirm机制是可以同时开启的。return机制：确认消息是否从 Exchange 路由到 Queue。confirm机制：确认消息是否到达 Exchange。若同时开启，路由失败(队列不存在或者交换机配置错误)时return机制返回异常信息以及消息，confirm机制则返回ack（不是nack）。两个机制不会互相影响。ack和nack都是由confirm机制返回的。</p></li><li><p>路由失败（交换机到队列），才触发ReturnCallback机制,返回异常信息；消息投递（发送者到交换机）成功，ConfirmCallback机制返回ack，投递失败返回nck</p></li><li><p>Publisher Confirm 机制用于向生产者确认消息是否成功送达队列。当生产者向 RabbitMQ 发送消息时，RabbitMQ 会返回一个唯一的交付标签（Delivery Tag），生产者可以通过这个标签来查询消息的投递状态。Publisher Return 机制用于处理无法路由的消息。当生产者向 RabbitMQ 发送一条消息时，如果消息无法被正确路由（例如由于队列不存在或交换机配置错误），RabbitMQ 会将该消息返回给生产者，并附带一个错误信息。</p></li></ul><h4 id="开启生产者确认">开启生产者确认</h4><p>在publisher模块的<code>application.yaml</code>中添加配置：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># 开启publisher confirm机制，并设置confirm类型</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 开启publisher return机制</span></span><br></pre></td></tr></table></figure><p>这里<code>publisher-confirm-type</code>有三种模式可选：</p><ul><li><code>none</code>：关闭confirm机制</li><li><code>simple</code>：同步阻塞等待MQ的回执</li><li><code>correlated</code>：MQ异步回调返回回执</li></ul><p>一般我们推荐使用<code>correlated</code>，回调机制。</p><h4 id="returncallback">ReturnCallback</h4><p>每个<code>RabbitTemplate</code>只能配置一个<code>ReturnCallback</code>，因此我们可以在配置类中统一设置。我们在publisher模块定义一个配置类：</p><p><code>ReturnCallback</code> 的作用：当消息发送到交换机时，如果交换机无法将消息路由到任何队列（例如，路由键不匹配或队列不存在），<code>RabbitMQ</code> 会返回一个 <code>Return</code> 消息。ReturnCallback 就是用来处理这种场景的。</p><p>配置类 <code>MqConfig</code> 中设置了一个消息返回的回调处理机制。当发送的消息因为某些原因未能成功投递到目标队列时（如交换机、路由键不匹配等），<code>rabbitTemplate</code> 会触发 <code>ReturnedMessage</code> 回调，并通过日志记录详细的错误信息。这样你可以通过日志详细了解失败的原因，便于排查问题。</p><p>内容如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="comment">// 它主要用于类, 在bean被创建并完成属性注入后，执行一些初始化操作(带有@PostConstruct注解的方法会被自动调用。)</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;触发return callback,&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());</span><br><span class="line">                log.debug(<span class="string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());</span><br><span class="line">                log.debug(<span class="string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());</span><br><span class="line">                log.debug(<span class="string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());</span><br><span class="line">                log.debug(<span class="string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="confirmcallback">ConfirmCallback</h4><p>由于每个消息发送时的处理逻辑不一定相同，因此ConfirmCallback需要在每次发消息时定义。具体来说，是在调用RabbitTemplate中的convertAndSend方法时，多传递一个参数：</p><p>这里的CorrelationData中包含两个核心的东西：</p><ul><li><code>id</code>：消息的唯一标示，MQ对不同的消息的回执以此做判断，避免混淆</li><li><code>SettableListenableFuture</code>：回执结果的Future对象</li></ul><p>为什么returnCallback只用写一次配置，而ConfirmCallback需要每次都写，因为消息需要被确认，并且是每条消息都需要被确认</p><p>我们新建一个测试，向系统自带的交换机发送消息，并且添加<code>ConfirmCallback</code>：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherConfirm</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建CorrelationData</span></span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">cd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>();</span><br><span class="line">    <span class="comment">// 2.给Future添加ConfirmCallback</span></span><br><span class="line">    cd.getFuture().addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;CorrelationData.Confirm&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.1.Future发生异常时的处理逻辑，基本不会触发</span></span><br><span class="line">            log.error(<span class="string">&quot;send message fail&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(CorrelationData.Confirm result)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.2.Future接收到回执的处理逻辑，参数中的result就是回执内容</span></span><br><span class="line">            <span class="keyword">if</span>(result.isAck())&#123; <span class="comment">// result.isAck()，boolean类型，true代表ack回执，false 代表 nack回执</span></span><br><span class="line">                log.debug(<span class="string">&quot;发送消息成功，收到 ack!&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123; <span class="comment">// result.getReason()，String类型，返回nack时的异常描述</span></span><br><span class="line">                log.error(<span class="string">&quot;发送消息失败，收到 nack, reason : &#123;&#125;&quot;</span>, result.getReason());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 3.发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;hmall.direct&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;hello&quot;</span>, cd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68887a6965355.png" alt="image-20250729153759012"></p><p>可以看到，由于传递的<code>RoutingKey</code>是错误的，路由失败后，触发了<code>return callback</code>，同时也收到了ack。</p><p>当我们修改为正确的<code>RoutingKey</code>以后，就不会触发<code>return callback</code>了，只收到ack。</p><p>而如果连交换机都是错误的，则只会收到nack。</p><div class="note warning simple"><p>开启生产者确认比较消耗MQ性能，一般不建议开启。而且大家思考一下触发确认的几种情况：</p><ul><li>路由失败：一般是因为RoutingKey错误导致，往往是编程导致</li><li>交换机名称错误：同样是编程错误导致</li><li>MQ内部故障：这种需要处理，但概率往往较低。因此只有对消息可靠性要求非常高的业务才需要开启，而且仅仅需要开启ConfirmCallback处理nack就可以了。</li></ul></div><h2 id="2-mq的可靠性">2. MQ的可靠性</h2><p>在默认情况下，RabbitMQ会将接收到的信息保存在内存中以降低消息收发的延迟。这样会导致两个问题.</p><ul><li>一旦MQ宕机，内存中的消息会丢失</li><li>内存空间有限，当消费者故障或处理过慢时，会导致消息积压，引发MQ阻塞</li></ul><p>mq在内存满的情况下，会持久化一部分到磁盘，然而这个过程较为耗时，这个过程中的消息发过来则就相当于丢失了。这个过程是阻塞式的，mq就不能处理消息了。每一次把消息从内存写出到磁盘，做page out的过程中，mq处于阻塞状态，消息处理会直接降为0。这就是基于内存带来的影响。所以需要将消息设置为持久化的。</p><blockquote><p>RabbitMQ如何保证消息的可靠性?</p></blockquote><ul><li><p>·首先通过配置可以让交换机、队列、以及发送的消息都持久化。这样队列中的消息会持久化到磁盘，MQ重启消息依然存在。</p></li><li><p>RabbitMQ在3.6版本引入了LazyQueue，并且在3.12版本后会称为队列的默认模式。LazyQueue会将所有消息都持久化。</p></li><li><p>·开启持久化和生产者确认时，RabbitMQ只有在消息持久化完成后才会给生产者返回ACK回执</p></li></ul><h3 id="21-数据持久化">2.1 数据持久化</h3><p>为了提升性能，默认情况下MQ的数据都是在内存存储的临时数据，重启后就会消失。为了保证数据的可靠性，必须配置数据持久化，包括：</p><ul><li><p>交换机持久化</p><p>队列持久化</p></li><li><p>消息持久化</p></li></ul><div class="note warning simple"><p><strong>说明</strong>：在开启持久化机制以后，如果同时还开启了生产者确认，那么MQ会在消息持久化以后才发送ACK回执，进一步确保消息的可靠性。</p><p>不过出于性能考虑，为了减少IO次数，发送到MQ的消息并不是逐条持久化到数据库的，而是每隔一段时间批量持久化。一般间隔在100毫秒左右，这就会导致<code>ACK</code>有一定的延迟，因此建议生产者确认全部采用异步方式。</p></div><h3 id="22-lazy-queue">2.2 Lazy Queue</h3><p>在默认情况下，RabbitMQ会将接收到的信息保存在内存中以降低消息收发的延迟。但在某些特殊情况下，这会导致消息积压，比如：</p><ul><li>消费者宕机或出现网络故障</li><li>消息发送量激增，超过了消费者处理速度</li><li>消费者处理业务发生阻塞</li></ul><p>一旦出现消息堆积问题，RabbitMQ的内存占用就会越来越高，直到触发内存预警上限。此时RabbitMQ会将内存消息刷到磁盘上，这个行为成为<code>PageOut</code>. <code>PageOut</code>会耗费一段时间，并且会阻塞队列进程。因此在这个过程中RabbitMQ不会再处理新的消息，生产者的所有请求都会被阻塞。</p><p>为了解决这个问题，从RabbitMQ的3.6.0版本开始，就增加了Lazy Queues的模式，也就是惰性队列。惰性队列的特征如下：</p><ul><li>接收到消息后直接存入磁盘而非内存</li><li>消费者要消费消息时才会从磁盘中读取并加载到内存（也就是懒加载）</li><li>支持数百万条的消息存储</li></ul><p>而在3.12版本之后，<code>LazyQueue</code>已经成为所有队列的默认格式。因此官方推荐升级MQ为3.12版本或者所有队列都设置为<code>LazyQueue</code>模式。</p><ul><li>之前的消息持久化以后，是内存里写一份的同时（内存里满了，会直接删除，不会再像之前一样阻塞了队列进行消息写入磁盘），磁盘里也写一份，这样接受处理消息的速度就下降了</li><li>如果消费者处理消息的速度很快时，那么就不会逐条那种去从磁盘里加载消息到内存，而是直接提前缓存一批消息到内存（最多2048条）</li><li>普通的持久化发一条写一条，写的日志文件，而不是消息体本身，消息体本身只有当内存中存的消满了之后，才会写入磁盘的。</li><li>使用惰性队列的性能更好的原因是接收到消息直接存入磁盘，避免了非持久化的情况下，内存满时需要向磁盘中Page out，此时mq不能接收消息。同时对磁盘的io进行了优化，使其效率更高</li></ul><h4 id="控制台配置lazy模式">控制台配置Lazy模式</h4><p>在添加队列的时候，添加<code>x-queue-mod=lazy</code>参数即可设置队列为Lazy模式：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/6888aa4778a4b.png" alt="image-20250729190224944"></p><h4 id="代码配置lazy模式">代码配置Lazy模式</h4><p>在利用SpringAMQP声明队列的时候，添加<code>x-queue-mod=lazy</code>参数也可设置队列为Lazy模式：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">lazyQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder</span><br><span class="line">            .durable(<span class="string">&quot;lazy.queue&quot;</span>)</span><br><span class="line">            .lazy() <span class="comment">// 开启Lazy模式</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是通过<code>QueueBuilder</code>的<code>lazy()</code>函数配置Lazy模式，底层源码如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/6888aa6b7f4be.png" alt="image-20250729190302865"></p><p>当然，我们也可以基于注解来声明队列并设置为Lazy模式：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(</span></span><br><span class="line"><span class="meta">        name = &quot;lazy.queue&quot;,</span></span><br><span class="line"><span class="meta">        durable = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">        arguments = @Argument(name = &quot;x-queue-mode&quot;, value = &quot;lazy&quot;)</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenLazyQueue</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到 lazy.queue的消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="更新已有队列为lazy模式">更新已有队列为Lazy模式</h4><p>对于已经存在的队列，也可以配置为lazy模式，但是要通过设置policy实现。</p><p>可以基于命令行设置policy：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rabbitmqctl set_policy Lazy &quot;^lazy-queue$&quot; &#x27;&#123;&quot;queue-mode&quot;:&quot;lazy&quot;&#125;&#x27; --apply-to queues  </span><br></pre></td></tr></table></figure><p>命令解读：</p><ul><li><code>rabbitmqctl</code> ：RabbitMQ的命令行工具</li><li><code>set_policy</code> ：添加一个策略</li><li><code>Lazy</code> ：策略名称，可以自定义</li><li><code>"^lazy-queue$"</code> ：用正则表达式匹配队列的名字</li><li><code>'&#123;"queue-mode":"lazy"&#125;'</code> ：设置队列模式为lazy模式</li><li><code>--apply-to queues</code>：策略的作用对象，是所有的队列</li></ul><p>当然，也可以在控制台配置policy，进入在控制台的<code>Admin</code>页面，点击<code>Policies</code>，即可添加配置：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/6888aaa8ab015.png" alt="image-20250729190403770"></p><p>在RabbitMQ中，消息的持久性是由消息本身和队列的持久性决定的。如果消息没有被标记为持久化，那么即使队列本身是持久化的，在RabbitMQ服务器重启后，这些消息也会丢失。这里的关键点在于:</p><ol type="1"><li><strong>队列的持久性</strong>:持久化队列意味着队列的元数据(例如队列的名称、绑定关系等)会被存储到磁盘中，在RabbitMQ服务器重启时可以恢复队列的结构。但是，队列本身的持久性并不自动意味着队列中的消息会被持久化。</li><li><strong>消息的持久性</strong>:如果消息在发送时没有设置为持久化，即没有将delivery node 设置为②(即持久化)，则这些消息只会保存在内存中。当RabbitMQ服务器重启时，这些未持久化的消息会丢失，尽管队列本身可能被恢复。</li><li><strong>Lazy Queue</strong>: Lazy Queue是一种优化机制，它使得消息以最少的内存使用保存在磁盘上，即使是普通（非持久化)消息，也可以保存在磁盘上避免过多占用内存。它并不改变消息持久性的属性。也就是说，即使队列是Lazy类型的，如果消息没有被标记为持久化，消息仍然会在服务器重启时丢失。</li></ol><p><strong>总结</strong></p><ul><li><strong>队列持久化</strong>:保存队列结构。</li><li><strong>消息持久化</strong>:确保消息在RabbitMQ重启后不丢失。</li><li><strong>Lazy Queue</strong>:优化内存使用，减少对RAM的依赖，但消息如果未持久化，仍会丢失。</li></ul><p>所以，即使是 Lazy Queue，如果消息没有被标记为持久化，那么这些消息在RabbitMQ服务器重启后仍然会丢失。</p><blockquote><p>RabbitMQ 如何保证消息可靠性</p></blockquote><ul><li>首先通过配置可以让交换机、队列、以及发送的消息都持久化。这样队列中的消息会持久化到磁盘，MQ重启消息依然存在。</li><li>RabbitMQ在3.6版本引入了LazyQueue，并且在3.12版本后会称为队列的默认模式。LazyQueue会将所有消息都持久化。</li><li>开启持久化和生产者确认时，RabbitMQ只有在消息持久化完成后才会给生产者返回ACK回执</li></ul><h2 id="3-消费者可靠性">3. 消费者可靠性</h2><p>当RabbitMQ向消费者投递消息以后，需要知道消费者的处理状态如何。因为消息投递给消费者并不代表就一定被正确消费了，可能出现的故障有很多，比如：</p><ul><li>消息投递的过程中出现了网络故障</li><li>消费者接收到消息后突然宕机</li><li>消费者接收到消息后，因处理不当导致异常</li><li>…</li></ul><p>一旦发生上述情况，消息也会丢失。因此，RabbitMQ必须知道消费者的处理状态，一旦消息处理失败才能重新投递消息。</p><p>但问题来了：RabbitMQ如何得知消费者的处理状态呢？</p><h3 id="31-消费者确认机制">3.1 消费者确认机制</h3><p>消费者确认机制(Consumer Acknowledgement)是为了确认消费者是否成功处理消息。当消费者处理消息结束后，应该向RabbitMQ发送一个回执，告知RabbitMQ自己消息处理状态:</p><ul><li>ack：成功处理消息，RabbitMQ从队列中删除该消息</li><li>nack：消息处理失败，RabbitMQ需要再次投递消息</li><li>reject：消息处理失败并拒绝该消息，RabbitMQ从队列中删除该消息</li></ul><p>一般reject方式用的较少，除非是消息格式有问题，那就是开发问题了。因此大多数情况下我们需要将消息处理的代码通过<code>try catch</code>机制捕获，消息处理成功时返回ack，处理失败时返回nack.</p><p>由于消息回执的处理代码比较统一，因此SpringAMQP帮我们实现了消息确认。并允许我们通过配置文件设置ACK处理方式，有三种模式：</p><ul><li><strong><code>none</code></strong>：不处理。即消息投递给消费者后立刻ack，消息会立刻从MQ删除。非常不安全，不建议使用</li><li><strong><code>manual</code></strong>：手动模式。需要自己在业务代码中调用api，发送<code>ack</code>或<code>reject</code>，存在业务入侵，但更灵活</li><li><strong><code>auto</code></strong>：自动模式。SpringAMQP利用AOP对我们的消息处理逻辑做了环绕增强，当业务正常执行时则自动返回<code>ack</code>. 当业务出现异常时，根据异常判断返回不同结果：<ul><li>如果是<strong>业务异常</strong>，会自动返回<code>nack</code>；</li><li>如果是<strong>消息处理或校验异常</strong>，自动返回<code>reject</code>;</li></ul></li></ul><p>由于消息回执的处理代码比较统一，因此SpringAMQP帮我们实现了消息确认。并允许我们通过配置文件设置ACK处理方式，有三种模式：</p><ul><li><strong><code>none</code></strong>：不处理。即消息投递给消费者后立刻ack，消息会立刻从MQ删除。非常不安全，不建议使用</li><li><strong><code>manual</code></strong>：手动模式。需要自己在业务代码中调用api，发送<code>ack</code>或<code>reject</code>，存在业务入侵，但更灵活</li><li><strong><code>auto</code></strong>：自动模式。SpringAMQP利用AOP对我们的消息处理逻辑做了环绕增强，当业务正常执行时则自动返回<code>ack</code>. 当业务出现异常时，根据异常判断返回不同结果：<ul><li>如果是<strong>业务异常</strong>，会自动返回<code>nack</code>；</li><li>如果是<strong>消息处理或校验异常</strong>，自动返回<code>reject</code>;</li></ul></li></ul><p>返回Reject的常见异常有：</p><blockquote><p>Starting with version 1.3.2, the default ErrorHandler is now a ConditionalRejectingErrorHandler that rejects (and does not requeue) messages that fail with an irrecoverable error. Specifically, it rejects messages that fail with the following errors:</p><ul><li>o.s.amqp…MessageConversionException: Can be thrown when converting the incoming message payload using a MessageConverter.</li><li>o.s.messaging…MessageConversionException: Can be thrown by the conversion service if additional conversion is required when mapping to a @RabbitListener method.</li><li>o.s.messaging…MethodArgumentNotValidException: Can be thrown if validation (for example, @Valid) is used in the listener and the validation fails.</li><li>o.s.messaging…MethodArgumentTypeMismatchException: Can be thrown if the inbound message was converted to a type that is not correct for the target method. For example, the parameter is declared as Message<foo>but Message<bar>is received.</bar></foo></li><li>java.lang.NoSuchMethodException: Added in version 1.6.3.</li><li>java.lang.ClassCastException: Added in version 1.6.3.</li></ul></blockquote><p>通过下面的配置可以修改SpringAMQP的ACK处理方式：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="comment"># 不做处理</span></span><br></pre></td></tr></table></figure><p>修改consumer服务的SpringRabbitListener类中的方法，模拟一个消息处理的异常：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    log.info(<span class="string">&quot;spring 消费者接收到消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageConversionException</span>(<span class="string">&quot;故意的&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;消息处理完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试可以发现：当消息处理发生异常时，消息依然被RabbitMQ删除了。</p><p>我们再次把确认机制修改为auto：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">auto</span> <span class="comment"># 自动ack</span></span><br></pre></td></tr></table></figure><h3 id="32-失败重试机制">3.2 失败重试机制</h3><p>当消费者出现异常后，消息会不断requeue（重入队）到队列，再重新发送给消费者。如果消费者再次执行依然出错，消息会再次requeue到队列，再次投递，直到消息处理成功为止。</p><p>极端情况就是消费者一直无法执行成功，那么消息requeue就会无限循环，导致mq的消息处理飙升，带来不必要的压力：</p><p>Spring又提供了消费者失败重试机制：在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列。</p><p>修改consumer服务的application.yml文件，添加内容：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启消费者失败重试</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 初识的失败等待时长为1秒</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment"># true无状态；false有状态。如果业务中包含事务，这里改为false</span></span><br></pre></td></tr></table></figure><p>重启consumer服务，重复之前的测试。可以发现：</p><ul><li>消费者在失败后消息没有重新回到MQ无限重新投递，而是在本地重试了3次</li><li>本地重试3次以后，抛出了<code>AmqpRejectAndDontRequeueException</code>异常。查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是<code>reject</code></li></ul><p>结论：</p><ul><li>开启本地重试时，消息处理过程中抛出异常，不会requeue到队列，而是在消费者本地重试</li><li>重试达到最大次数后，Spring会返回reject，消息会被丢弃</li></ul><h3 id="33-失败处理机制">3.3 失败处理机制</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889839bd568a.png" alt="image-20250730102943744"></p><p>在之前的测试中，本地测试达到最大重试次数后，消息会被丢弃。这在某些对于消息可靠性要求较高的业务场景下，显然不太合适了。（开启retry之后，都失败reject后，MessageRecover的默认实现使得消息不requeue，从而被丢弃）</p><p>因此Spring允许我们自定义重试次数耗尽后的消息处理策略，这个策略是由<code>MessageRecovery</code>接口来定义的，它有3个不同实现：</p><ul><li><code>RejectAndDontRequeueRecoverer</code>：重试耗尽后，直接<code>reject</code>，丢弃消息。默认就是这种方式</li><li><code>ImmediateRequeueMessageRecoverer</code>：重试耗尽后，返回<code>nack</code>，消息重新入队</li><li><code>RepublishMessageRecoverer</code>：重试耗尽后，将失败消息投递到指定的交换机</li><li><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/688984d6e222f.png" alt="aaa "></li></ul><p>比较优雅的一种处理方案是<code>RepublishMessageRecoverer</code>，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。</p><p>1）在consumer服务中定义处理失败消息的交换机和队列</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2）定义一个RepublishMessageRecoverer，关联队列和交换机</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.retry.MessageRecoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.rabbitmq.listener.simple.retry.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorMessageConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="34-业务幂等性">3.4 业务幂等性</h3><p>何为幂等性？</p><ul><li>消息被重复消费，如果消费者和mq之间的网络连接断开，消费者的ack未能成功发送到mq,那么等到连接好了之后，mq又会重新发送消息，此时消息重复被消费。如果这个消息是用于扣减库存的，那么就会出现问题</li></ul><p><strong>幂等</strong>是一个数学概念，用函数表达式来描述是这样的：<code>f(x) = f(f(x))</code>，例如求绝对值函数。</p><p>在程序开发中，则是指同一个业务，执行一次或多次对业务状态的影响是一致的。例如：</p><ul><li>根据id删除数据</li><li>查询数据</li><li>新增数据</li></ul><p>但数据的更新往往不是幂等的，如果重复执行可能造成不一样的后果。比如：</p><ul><li>取消订单，恢复库存的业务。如果多次恢复就会出现库存重复增加的情况</li><li>退款业务。重复退款对商家而言会有经济损失。</li></ul><p>所以，我们要尽可能避免业务被重复执行。</p><p>然而在实际业务场景中，由于意外经常会出现业务被重复执行的情况，例如：</p><ul><li>页面卡顿时频繁刷新导致表单重复提交</li><li>服务间调用的重试</li><li>MQ消息的重复投递</li></ul><p>我们在用户支付成功后会发送MQ消息到交易服务，修改订单状态为已支付，就可能出现消息重复投递的情况。如果消费者不做判断，很有可能导致消息被消费多次，出现业务故障。</p><p>举例：</p><ol type="1"><li>假如用户刚刚支付完成，并且投递消息到交易服务，交易服务更改订单为<strong>已支付</strong>状态。</li><li>由于某种原因，例如网络故障导致生产者没有得到确认，隔了一段时间后<strong>重新投递</strong>给交易服务。</li><li>但是，在新投递的消息被消费之前，用户选择了退款，将订单状态改为了<strong>已退款</strong>状态。</li><li>退款完成后，新投递的消息才被消费，那么订单状态会被再次改为<strong>已支付</strong>。业务异常。</li></ol><p>因此，我们必须想办法保证消息处理的幂等性。这里给出两种方案：</p><ul><li>唯一消息ID</li><li>业务状态判断</li></ul><h4 id="341-唯一消息id白雪">3.4.1 唯一消息id（白雪）</h4><p>这个思路非常简单：</p><ol type="1"><li>每一条消息都生成一个唯一的id，与消息一起投递给消费者。</li><li>消费者接收到消息后处理自己的业务，业务处理成功后将消息ID保存到数据库</li><li>如果下次又收到相同消息，去数据库查询判断是否存在，存在则为重复消息放弃处理。</li></ol><p>我们该如何给消息添加唯一ID呢？</p><p>其实很简单，SpringAMQP的MessageConverter自带了MessageID的功能，我们只要开启这个功能即可。</p><p>以Jackson的消息转换器为例：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jjmc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.配置自动创建消息id，用于识别不同消息，也可以在业务中基于ID判断是否是重复消息</span></span><br><span class="line">    jjmc.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jjmc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="342-业务判断">3.4.2 业务判断</h4><p>业务判断就是基于业务本身的逻辑或状态来判断是否是重复的请求或消息，不同的业务场景判断的思路也不一样。</p><p>例如我们当前案例中，处理消息的业务逻辑是把订单状态从未支付修改为已支付。因此我们就可以在执行业务时判断订单状态是否是未支付，如果不是则证明订单已经被处理过，无需重复处理。</p><p>相比较而言，消息ID的方案需要改造原有的数据库，所以我更推荐使用业务判断的方案。</p><p>以支付修改订单的业务为例，我们需要修改<code>OrderServiceImpl</code>中的<code>markOrderPaySuccess</code>方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.查询订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">old</span> <span class="operator">=</span> getById(orderId);</span><br><span class="line">    <span class="comment">// 2.判断订单状态</span></span><br><span class="line">    <span class="keyword">if</span> (old == <span class="literal">null</span> || old.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 订单不存在或者订单状态不是1，放弃处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.尝试更新订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(orderId);</span><br><span class="line">    order.setStatus(<span class="number">2</span>);</span><br><span class="line">    order.setPayTime(LocalDateTime.now());</span><br><span class="line">    updateById(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述代码逻辑上符合了幂等判断的需求，但是由于判断和更新是两步动作，因此在极小概率下可能存在线程安全问题。</p><p>我们可以合并上述操作为这样：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// UPDATE `order` SET status = ? , pay_time = ? WHERE id = ? AND status = 1</span></span><br><span class="line">    lambdaUpdate()</span><br><span class="line">            .set(Order::getStatus, <span class="number">2</span>)</span><br><span class="line">            .set(Order::getPayTime, LocalDateTime.now())</span><br><span class="line">            .eq(Order::getId, orderId)</span><br><span class="line">            .eq(Order::getStatus, <span class="number">1</span>)</span><br><span class="line">            .update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意看，上述代码等同于这样的SQL语句：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> `<span class="keyword">order</span>` <span class="keyword">SET</span> status <span class="operator">=</span> ? , pay_time <span class="operator">=</span> ? <span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">AND</span> status <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>我们在where条件中除了判断id以外，还加上了status必须为1的条件。如果条件不符（说明订单已支付），则SQL匹配不到数据，根本不会执行。</p><blockquote><p>如何保证支付服务与交易服务订单状态的一致性</p></blockquote><ul><li>首先，支付服务会正在用户支付成功以后利用MQ消息通知交易服务，完成订单状态同步。</li><li>其次，为了保证MQ消息的可靠性，我们采用了生产者确认机制、消费者确认、消费者失败重试等策略，确保消息投递和处理的可靠性。同时也开启了MQ的持久化，避免因服务宕机导致消息丢失。</li><li>最后，我们还在交易服务更新订单状态时做了业务幂等判断，避免因消息重复消费导致订单状态异常。</li></ul><h3 id="35-兜底方案">3.5 兜底方案</h3><p>虽然我们利用各种机制尽可能增加了消息的可靠性，但也不好说能保证消息100%的可靠。万一真的MQ通知失败该怎么办呢？</p><p>有没有其它兜底方案，能够确保订单的支付状态一致呢？</p><p>其实思想很简单：既然MQ通知不一定发送到交易服务，那么交易服务就必须自己<strong>主动去查询</strong>支付状态。这样即便支付服务的MQ通知失败，我们依然能通过主动查询来保证订单状态的一致。</p><p>流程如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889ba0f634c0.png" alt="image-20250730142153934"></p><p>图中黄色线圈起来的部分就是MQ通知失败后的兜底处理方案，由交易服务自己主动去查询支付状态。</p><p>不过需要注意的是，交易服务并不知道用户会在什么时候支付，如果查询的时机不正确（比如查询的时候用户正在支付中），可能查询到的支付状态也不正确。</p><p>那么问题来了，我们到底该在什么时间主动查询支付状态呢？</p><p>这个时间是无法确定的，因此，通常我们采取的措施就是利用<strong>定时任务</strong>定期查询，例如每隔20秒就查询一次，并判断支付状态。如果发现订单已经支付，则立刻更新订单状态为已支付即可。</p><p>定时任务大家之前学习过，具体的实现这里就不再赘述了。</p><p>至此，消息可靠性的问题已经解决了。</p><p>综上，支付服务与交易服务之间的订单状态一致性是如何保证的？</p><ul><li>首先，支付服务会正在用户支付成功以后利用MQ消息通知交易服务，完成订单状态同步。</li><li>其次，为了保证MQ消息的可靠性，我们采用了生产者确认机制、消费者确认、消费者失败重试等策略，确保消息投递的可靠性</li><li>最后，我们还在交易服务设置了定时任务，定期查询订单支付状态。这样即便MQ通知失败，还可以利用定时任务作为兜底方案，确保订单支付状态的最终一致性。</li></ul><h2 id="4-延迟消息">4. 延迟消息</h2><blockquote><p>延迟消息∶发送者发送消息时指定一个时间，消费者不会立刻收到消息，而是在指定时间之后才收到消息。</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889bc7b848c6.png" alt="image-20250730143212336"></p><p>在电商的支付业务中，对于一些库存有限的商品，为了更好的用户体验，通常都会在用户下单时立刻扣减商品库存。例如电影院购票、高铁购票，下单后就会锁定座位资源，其他人无法重复购买。</p><p>但是这样就存在一个问题，假如用户下单后一直不付款，就会一直占有库存资源，导致其他客户无法正常交易，最终导致商户利益受损！</p><p>因此，电商中通常的做法就是：<strong>对于超过一定时间未支付的订单，应该立刻取消订单并释放占用的库存</strong>。</p><p>例如，订单支付超时时间为30分钟，则我们应该在用户下单后的第30分钟检查订单支付状态，如果发现未支付，应该立刻取消订单，释放库存。</p><p>但问题来了：如何才能准确的实现在下单后第30分钟去检查支付状态呢？</p><p>像这种在一段时间以后才执行的任务，我们称之为<strong>延迟任务</strong>，而要实现延迟任务，最简单的方案就是利用MQ的延迟消息了。</p><p>在RabbitMQ中实现延迟消息也有两种方案：</p><ul><li>死信交换机+TTL（存活时间）</li><li>延迟消息插件</li></ul><p>这一章我们就一起研究下这两种方案的实现方式，以及优缺点。</p><h3 id="41-死信交换机白雪">4.1 死信交换机（白雪）</h3><p>当一个队列中的消息满足下列情况之一时，就会成为死信(dead letter) :</p><ul><li>·消费者使用basic.reject或 basic.nack声明消费失败，并且消息的requeue参数设置为false</li><li>·消息是一个过期消息（达到了队列或消息本身设置的过期时间），超时无人消费</li><li>·要投递的队列消息堆积满了，最早的消息可能成为死信</li></ul><p>如果一个队列中的消息已经成为死信，并且这个队列通过**<code>dead-letter-exchange</code><strong>属性指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机就称为</strong>死信交换机**（Dead Letter Exchange）。而此时加入有队列与死信交换机绑定，则最终死信就会被投递到这个队列中。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889bd1a00717.png" alt="image-20250730143503000"></p><p>死信交换机有什么作用呢？</p><ol type="1"><li>收集那些因处理失败而被拒绝的消息</li><li>收集那些因队列满了而被拒绝的消息</li><li>收集因TTL（有效期）到期的消息</li></ol><p>前面两种作用场景可以看做是把死信交换机当做一种消息处理的最终兜底方案，与消费者重试时讲的<code>RepublishMessageRecoverer</code>作用类似。</p><p>而最后一种场景，大家设想一下这样的场景：</p><p>如图，有一组绑定的交换机（<code>ttl.fanout</code>）和队列（<code>ttl.queue</code>）。但是<code>ttl.queue</code>没有消费者监听，而是设定了死信交换机<code>hmall.direct</code>，而队列<code>direct.queue1</code>则与死信交换机绑定，RoutingKey是blue：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889c212b3aff.png" alt="image-20250730145606249"></p><p>假如我们现在发送一条消息到<code>ttl.fanout</code>，RoutingKey为blue，并设置消息的<strong>有效期</strong>为5000毫秒：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889c23065a8f.png" alt="image-20250730145646355"></p><div class="note danger simple"><p><strong>注意</strong>：尽管这里的<code>ttl.fanout</code>不需要RoutingKey，但是当消息变为死信并投递到死信交换机时，会沿用之前的RoutingKey，这样<code>hmall.direct</code>才能正确路由消息。</p></div><p>消息肯定会被投递到<code>ttl.queue</code>之后，由于没有消费者，因此消息无人消费。5秒之后，消息的有效期到期，成为死信：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889c29873dd6.png" alt="image-20250730145830374"></p><p>死信被再次投递到死信交换机<code>hmall.direct</code>，并沿用之前的RoutingKey，也就是<code>blue</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889c2aead488.png" alt="image-20250730145851549"></p><p>由于<code>direct.queue1</code>与<code>hmall.direct</code>绑定的key是blue，因此最终消息被成功路由到<code>direct.queue1</code>，如果此时有消费者与<code>direct.queue1</code>绑定， 也就能成功消费消息了。但此时已经是5秒钟以后了：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889c2c7bd956.png" alt="image-20250730145917700"></p><p>也就是说，publisher发送了一条消息，但最终consumer在5秒后才收到消息。我们成功实现了<strong>延迟消息</strong>。</p><p>这里的RoutingKey必须一致。死信在转移到死信队列时，他的Routing key 也会保存下来。但是如果配置了x-dead-letter-routing-key这 个参数的话，routingkey就会被替换为配置的这个值。 另外，死信在转移到死信队列的过程中，是没有经过消息发送者确认的，所以并不能保证消息的安全性。</p><div class="note danger simple"><p>RabbitMQ的消息过期是基于追溯方式来实现的，也就是说当一个消息的TTL到期以后不一定会被移除或投递到死信交换机，而是在消息恰好处于队首时才会被处理。</p><p>当队列中消息堆积很多的时候，过期消息可能不会被按时处理，因此你设置的TTL时间不一定准确。</p></div><h3 id="42-delayexchage插件">4.2 DelayExchage插件</h3><p>基于死信队列虽然可以实现延迟消息，但是太麻烦了。因此RabbitMQ社区提供了一个延迟消息插件来实现相同的效果。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889c39a79a58.png" alt="image-20250730150237949"></p><p>因为我们是基于Docker安装，所以需要先查看RabbitMQ的插件目录对应的数据卷。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker volume inspect mq-plugins</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;CreatedAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-06-19T09:22:59+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Mountpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/mq-plugins/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mq-plugins&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>插件目录被挂载到了<code>/var/lib/docker/volumes/mq-plugins/_data</code>这个目录，我们上传插件到该目录下。</p><p>接下来执行命令，安装插件：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker exec -it mq rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure><p>运行结果如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889c5e1c9f53.png" alt="image-20250730151231005"></p><h4 id="声明延迟交换机">声明延迟交换机</h4><p>基于注解方式：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        key = &quot;delay&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDelayMessage</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到delay.queue的延迟消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基于<code>@Bean</code>的方式：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayExchangeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">delayExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder</span><br><span class="line">                .directExchange(<span class="string">&quot;delay.direct&quot;</span>) <span class="comment">// 指定交换机类型和名称</span></span><br><span class="line">                .delayed() <span class="comment">// 设置delay的属性为true</span></span><br><span class="line">                .durable(<span class="literal">true</span>) <span class="comment">// 持久化</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;delay.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayQueueBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayedQueue()).to(delayExchange()).with(<span class="string">&quot;delay&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="发送延迟消息">发送延迟消息</h4><p>发送消息时，必须通过x-delay属性设定延迟时间：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherDelayMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, delayed message&quot;</span>;</span><br><span class="line">    <span class="comment">// 2.发送消息，利用消息后置处理器添加消息头</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;delay.direct&quot;</span>, <span class="string">&quot;delay&quot;</span>, message, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            <span class="comment">// 添加延迟消息属性</span></span><br><span class="line">            message.getMessageProperties().setDelay(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note danger simple"><p>延迟消息插件内部会维护一个本地数据库表，同时使用Elang Timers功能实现计时。如果消息的延迟时间设置较长，可能会导致堆积的延迟消息非常多，会带来较大的CPU开销，同时延迟消息的时间会存在误差。</p><p>因此，<strong>不建议设置延迟时间过长的延迟消息</strong>。</p></div><h2 id="5超时取消订单">5.超时取消订单</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889cff5a08f2.png" alt="image-20250730155528733"></p><p>接下来，我们就在交易服务中利用延迟消息实现订单超时取消功能。其大概思路如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/30/6889d0205efd9.png" alt="image-20250730155602496"></p><p>假如订单超时支付时间为30分钟，理论上说我们应该在下单时发送一条延迟消息，延迟时间为30分钟。这样就可以在接收到消息时检验订单支付状态，关闭未支付订单。</p><h1 id="七elasticsearch-01">七、Elasticsearch 01</h1><p>Elasticsearch是由elastic公司开发的一套搜索引擎技术，它是elastic技术栈中的一部分。完整的技术栈包括：</p><ul><li>Elasticsearch：用于数据存储、计算和搜索</li><li>Logstash/Beats：用于数据收集</li><li>Kibana：用于数据可视化</li></ul><p>整套技术栈被称为ELK，经常用来做日志收集、系统监控和状态分析等等：</p><p>整套技术栈的核心就是用来<strong>存储</strong>、<strong>搜索</strong>、<strong>计算</strong>的Elasticsearch，因此我们接下来学习的核心也是Elasticsearch。</p><p>我们要安装的内容包含2部分：</p><ul><li>elasticsearch：存储、搜索和运算</li><li>kibana：图形化展示</li></ul><p>首先Elasticsearch不用多说，是提供核心的数据存储、搜索、分析功能的。</p><p>然后是Kibana，Elasticsearch对外提供的是Restful风格的API，任何操作都可以通过发送http请求来完成。不过http请求的方式、路径、还有请求参数的格式都有严格的规范。这些规范我们肯定记不住，因此我们要借助于Kibana这个服务。</p><p>Kibana是elastic公司提供的用于操作Elasticsearch的可视化控制台。它的功能非常强大，包括：</p><ul><li>对Elasticsearch数据的搜索、展示</li><li>对Elasticsearch数据的统计、聚合，并形成图形化报表、图形</li><li>对Elasticsearch的集群状态监控</li><li>它还提供了一个开发控制台（DevTools），在其中对Elasticsearch的Restful的API接口提供了<strong>语法提示</strong></li></ul><h2 id="1安装">1.安装</h2><h3 id="11-安装elasticsearch">1.1 安装elasticsearch</h3><p>通过下面的Docker命令即可安装单机版本的elasticsearch：</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> es \</span><br><span class="line">  <span class="literal">-e</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span> \</span><br><span class="line">  <span class="literal">-e</span> <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">  <span class="literal">-v</span> es<span class="literal">-data</span>:/usr/share/elasticsearch/<span class="keyword">data</span> \</span><br><span class="line">  <span class="literal">-v</span> es<span class="literal">-plugins</span>:/usr/share/elasticsearch/plugins \</span><br><span class="line">  <span class="literal">--privileged</span> \</span><br><span class="line">  <span class="literal">--network</span> hm<span class="literal">-net</span> \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">9200</span>:<span class="number">9200</span> \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">9300</span>:<span class="number">9300</span> \</span><br><span class="line">  elasticsearch:<span class="number">7.12</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p>注意，这里我们采用的是elasticsearch的7.12.1版本，由于8以上版本的JavaAPI变化很大，在企业中应用并不广泛，企业中应用较多的还是8以下的版本。</p><p>安装完成后，访问9200端口，即可看到响应的Elasticsearch服务的基本信息：</p><p><a target="_blank" rel="noopener" href="http://192.168.163.129:9200/">elasticsearch</a></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/31/688b23740ffce.png" alt="image-20250731160354878"></p><p>通过下面的Docker命令，即可部署Kibana：</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> kibana \</span><br><span class="line"><span class="literal">-e</span> ELASTICSEARCH_HOSTS=http://es:<span class="number">9200</span> \</span><br><span class="line"><span class="literal">--network</span>=hm<span class="literal">-net</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">5601</span>:<span class="number">5601</span>  \</span><br><span class="line">kibana:<span class="number">7.12</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="http://192.168.163.129:5601/app/home#/">Home - Elastic</a></p><h2 id="2-倒排索引">2. 倒排索引</h2><p>倒排索引中有两个非常重要的概念：</p><ul><li>文档（<code>Document</code>）：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息</li><li>词条（<code>Term</code>）：对文档数据或用户搜索数据，利用某种算法分词，得到的具备含义的词语就是词条。例如：我是中国人，就可以分为：我、是、中国人、中国、国人这样的几个词条</li></ul><p><strong>创建倒排索引</strong>是对正向索引的一种特殊处理和应用，流程如下：</p><ul><li>将每一个文档的数据利用<strong>分词算法</strong>根据语义拆分，得到一个个词条</li><li>创建表，每行数据包括词条、词条所在文档id、位置等信息</li><li>因为词条唯一性，可以给词条创建<strong>正向</strong>索引</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/31/688b2c871ec35.png" alt="image-20250731164230323"></p><p>流程描述：</p><p>1）用户输入条件<code>"华为手机"</code>进行搜索。</p><p>2）对用户输入条件<strong>分词</strong>，得到词条：<code>华为</code>、<code>手机</code>。</p><p>3）拿着词条在倒排索引中查找（<strong>由于词条有索引，查询效率很高</strong>），即可得到包含词条的文档id：<code>1、2、3</code>。</p><p>4）拿着文档<code>id</code>到正向索引中查找具体文档即可（由于<code>id</code>也有索引，查询效率也很高）。</p><p>虽然要先查询倒排索引，再查询正向索引，但是无论是词条、还是文档id都建立了索引，查询速度非常快！无需全表扫描。</p><h3 id="正向和倒排">正向和倒排</h3><p>以索引的使用来理解：</p><p>正向索引，走的是全表扫描，速度很慢，而倒排，根据词条找文档id，可以走索引，再根据文档id找文档，也是索引，因此效率很高</p><p>那么为什么一个叫做正向索引，一个叫做倒排索引呢？</p><ul><li><strong>正向索引</strong>是最传统的，根据id索引的方式。但根据词条查询时，必须先逐条获取每个文档，然后判断文档中是否包含所需要的词条，是<strong>根据文档找词条的过程</strong>。</li><li>而<strong>倒排索引</strong>则相反，是先找到用户要搜索的词条，根据词条得到保护词条的文档的id，然后根据id获取文档。是<strong>根据词条找文档的过程</strong>。</li></ul><p>是不是恰好反过来了？</p><p>那么两者方式的优缺点是什么呢？</p><p><strong>正向索引</strong>：</p><ul><li>优点：<ul><li>可以给多个字段创建索引</li><li>根据索引字段搜索、排序速度非常快</li></ul></li><li>缺点：<ul><li>根据非索引字段，或者索引字段中的部分词条查找时，只能全表扫描。</li></ul></li></ul><p><strong>倒排索引</strong>：</p><ul><li>优点：<ul><li>根据词条搜索、模糊搜索时，速度非常快</li></ul></li><li>缺点：<ul><li>只能给词条创建索引，而不是字段</li><li>无法根据字段做排序</li></ul></li></ul><blockquote><p>什么是正向索引?</p></blockquote><ul><li>基于文档id创建索引。根据id查询快，但是查询词条时必须先找到文档，而后判断是否包含词条</li></ul><blockquote><p>什么是倒排索引?</p></blockquote><ul><li><p>对文档内容分词，对词条创建索引，并记录词条所在文档的id。</p></li><li><p>查询时先根据词条查询到文档id，而后根据文档id查询文档</p></li></ul><h2 id="3-ik-分词器">3. IK 分词器</h2><h3 id="31-安装">3.1 安装</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker exec <span class="literal">-it</span> es ./bin/elastic<span class="built_in">search-plugin</span>  install https://release.infinilabs.com/analysis<span class="literal">-ik</span>/stable/elastic<span class="built_in">search-analysis</span><span class="literal">-ik-7</span>.<span class="number">12.1</span>.zip</span><br></pre></td></tr></table></figure><p>最后，重启es容器：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker restart es</span><br></pre></td></tr></table></figure><h3 id="32-使用">3.2 使用</h3><p>IK分词器包含两种模式：</p><ul><li><code>ik_smart</code>：智能语义切分</li><li><code>ik_max_word</code>：最细粒度切分</li></ul><p>我们在Kibana的DevTools上来测试分词器，首先测试Elasticsearch官方提供的标准分词器：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑马程序员学习java太棒了&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;黑&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;马&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;程&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;序&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;员&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;学&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;习&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;太&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;棒&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;了&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>可以看到，标准分词器智能1字1词条，无法正确对中文做分词。</p><p>我们再测试IK分词器：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑马程序员学习java太棒了&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>执行结果如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;黑马&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;程序员&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;学习&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ENGLISH&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;太棒了&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="33-拓展词典">3.3 拓展词典</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="number">192</span> <span class="type">volumes</span>]<span class="comment"># find / -name &quot;IKAnalyzer.cfg.xml&quot;</span></span><br><span class="line">/var/lib/docker/volumes/es<span class="literal">-plugins</span>/_data/analysis<span class="literal">-ik</span>/config/IKAnalyzer.cfg.xml</span><br><span class="line">/var/lib/docker/overlay2/cff1207b40d8029573e223fd4319142257f24e214dc00e58df51b4786018513f/<span class="built_in">diff</span>/usr/share/elasticsearch/config/analysis<span class="literal">-ik</span>/IKAnalyzer.cfg.xml</span><br><span class="line">/var/lib/docker/overlay2/cff1207b40d8029573e223fd4319142257f24e214dc00e58df51b4786018513f/merged/usr/share/elasticsearch/config/analysis<span class="literal">-ik</span>/IKAnalyzer.cfg.xml</span><br><span class="line">[<span class="type">root</span>@<span class="number">192</span> <span class="type">volumes</span>]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在config目录下的<code>ext.dic</code>文件下即可添加新词</p><h2 id="4-基本概览">4. 基本概览</h2><p>elasticsearch是面向**文档（Document）**存储的，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化为<code>json</code>格式后存储在<code>elasticsearch</code>中：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/01/688bf844de836.png" alt="image-20250801071204395"></p><p>因此，原本数据库中的一行数据就是ES中的一个JSON文档；而数据库中每行数据都包含很多列，这些列就转换为JSON文档中的<strong>字段（Field）</strong>。</p><h3 id="索引和映射">索引和映射</h3><p>随着业务发展，需要在es中存储的文档也会越来越多，比如有商品的文档、用户的文档、订单文档等等</p><p>所有文档都散乱存放显然非常混乱，也不方便管理。</p><p>因此，我们要将类型相同的文档集中在一起管理，称为<strong>索引（Index）</strong>。例如：</p><p><strong>商品索引</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">3499</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">4999</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;三星手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">3999</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>用户索引</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">21</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">102</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">24</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">103</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;麻子&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>订单索引</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;goodsId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;totalFee&quot;</span><span class="punctuation">:</span> <span class="number">294</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">102</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;goodsId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;totalFee&quot;</span><span class="punctuation">:</span> <span class="number">328</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>所有用户文档，就可以组织在一起，称为用户的索引；</li><li>所有商品的文档，可以组织在一起，称为商品的索引；</li><li>所有订单的文档，可以组织在一起，称为订单的索引；</li></ul><p>因此，我们可以把索引当做是数据库中的表。</p><p>数据库的表会有约束信息，用来定义表的结构、字段的名称、类型等信息。因此，索引库中就有<strong>映射（mapping）</strong>，是索引中文档的字段约束信息，类似表的结构约束。</p><p><code>索引</code>：和mysql的表的概念类似</p><p><code>映射</code>：索引中文档的字段约束信息，类似表的结构约束</p><h3 id="mysql与elasticsearch">MySQL与elasticsearch</h3><p>我们统一的把mysql与elasticsearch的概念做一下对比：</p><table><thead><tr><th style="text-align:left"><strong>MySQL</strong></th><th style="text-align:left"><strong>Elasticsearch</strong></th><th style="text-align:left"><strong>说明</strong></th></tr></thead><tbody><tr><td style="text-align:left">Table</td><td style="text-align:left">Index</td><td style="text-align:left">索引(index)，就是文档的集合，类似数据库的表(table)</td></tr><tr><td style="text-align:left">Row</td><td style="text-align:left">Document</td><td style="text-align:left">文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是JSON格式</td></tr><tr><td style="text-align:left">Column</td><td style="text-align:left">Field</td><td style="text-align:left">字段（Field），就是JSON文档中的字段，类似数据库中的列（Column）</td></tr><tr><td style="text-align:left">Schema</td><td style="text-align:left">Mapping</td><td style="text-align:left">Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）</td></tr><tr><td style="text-align:left">SQL</td><td style="text-align:left">DSL</td><td style="text-align:left">DSL是elasticsearch提供的JSON风格的请求语句，用来操作elasticsearch，实现CRUD</td></tr></tbody></table><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/01/688c20a054a15.png" alt="image-20250801100406049"></p><p>那是不是说，我们学习了elasticsearch就不再需要mysql了呢？</p><p>并不是如此，两者各自有自己的擅长之处：</p><ul><li>Mysql：擅长事务类型操作，可以确保数据的安全和一致性</li><li>Elasticsearch：擅长海量数据的搜索、分析、计算</li></ul><p>因此在企业中，往往是两者结合使用：</p><ul><li>对安全性要求较高的写操作，使用mysql实现</li><li>对查询性能要求较高的搜索需求，使用elasticsearch实现</li><li>两者再基于某种方式，实现数据的同步，保证一致性</li></ul><h2 id="5-索引库的操作">5. 索引库的操作</h2><p>Index就类似数据库表，Mapping映射就类似表的结构。我们要向es中存储数据，必须先创建Index和Mapping</p><p>Mapping 是 Elasticsearch 的“字段结构 + 建索引规则 + 分词逻辑 + 存储行为”的声明。就类似于你在mysql中写Create table这种语句</p><h3 id="51-mapping映射属性">5.1 Mapping映射属性</h3><p>Mapping是对索引库中文档的约束，常见的Mapping属性包括：</p><ul><li><code>type</code>：字段数据类型，常见的简单类型有：<ul><li>字符串：<code>text</code>（可分词的文本）、<code>keyword</code>（精确值，例如：品牌、国家、ip地址）</li><li>数值：<code>long</code>、<code>integer</code>、<code>short</code>、<code>byte</code>、<code>double</code>、<code>float</code>、</li><li>布尔：<code>boolean</code></li><li>日期：<code>date</code></li><li>对象：<code>object</code></li></ul></li><li><code>index</code>：是否创建索引，默认为<code>true</code></li><li><code>analyzer</code>：使用哪种分词器</li><li><code>properties</code>：该字段的子字段</li></ul><p>例如下面的json文档：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">52.1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isMarried&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑马程序员Java讲师&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zy@itcast.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">99.1</span><span class="punctuation">,</span> <span class="number">99.5</span><span class="punctuation">,</span> <span class="number">98.9</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;云&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;赵&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>对应的每个字段映射（Mapping）：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/01/688c26ea5f1f0.png" alt="image-20250801103059719"></p><h3 id="52-索引的crud">5.2 索引的CRUD</h3><p>由于Elasticsearch采用的是Restful风格的API，因此其请求方式和路径相对都比较规范，而且请求参数也都采用JSON风格。</p><p>我们直接基于Kibana的DevTools来编写请求做测试，由于有语法提示，会非常方便。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/01/688c290b67d3a.png" alt="image-20250801103957167"></p><h4 id="创建索引库和映射">创建索引库和映射</h4><p><strong>基本语法</strong>：</p><ul><li>请求方式：<code>PUT</code></li><li>请求路径：<code>/索引库名</code>，可以自定义</li><li>请求参数：<code>mapping</code>映射</li></ul><p><strong>格式</strong>：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /索引库名称</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;字段名2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;字段名3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;子字段&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="comment">// ...略</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /heima</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="查询">查询</h4><p><strong>基本语法</strong>：</p><ul><li>请求方式：GET</li><li>请求路径：/索引库名</li><li>请求参数：无</li></ul><p><strong>格式</strong>：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /索引库名</span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /heima</span><br></pre></td></tr></table></figure><h4 id="修改索引库">修改索引库</h4><p>倒排索引结构虽然不复杂，但是一旦数据结构改变（比如改变了分词器），就需要重新创建倒排索引，这简直是灾难。因此索引库<strong>一旦创建，无法修改mapping</strong>。</p><p>虽然无法修改mapping中已有的字段，但是却允许添加新的字段到mapping中，因为不会对倒排索引产生影响。因此修改索引库能做的就是向索引库中添加新字段，或者更新索引库的基础属性。</p><p>新字段会创建自己的倒排索引，与现有索引并行存在，不会干扰已索引的数据。</p><p><strong>语法说明</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /索引库名/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;新字段名&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /heima/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="删除">删除</h4><p><strong>语法：</strong></p><ul><li>请求方式：DELETE</li><li>请求路径：/索引库名</li><li>请求参数：无</li></ul><p><strong>格式：</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /索引库名</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /heima</span><br></pre></td></tr></table></figure><h4 id="总结">总结</h4><p>索引库操作有哪些？</p><ul><li>创建索引库：PUT /索引库名</li><li>查询索引库：GET /索引库名</li><li>删除索引库：DELETE /索引库名</li><li>修改索引库，添加字段：PUT /索引库名/_mapping</li></ul><p>可以看到，对索引库的操作基本遵循的Restful的风格，因此API接口非常统一，方便记忆。</p><h2 id="6-文档操作">6. 文档操作</h2><p>有了索引库，接下来就可以向索引库中添加数据了。</p><p>Elasticsearch中的数据其实就是JSON风格的文档。操作文档自然包括<code>增</code>、<code>删</code>、<code>改</code>、<code>查</code>等几种常见操作，我们分别来学习。</p><h3 id="新增">新增</h3><p>新增文档，就会按照索引库中的映射来创建倒排索引，但是创建倒排索引的过程对我们是不可见的</p><p><strong>语法：</strong></p><p>id理解为数据库的主键</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /索引库名/_doc/文档id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;字段1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;字段2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;字段3&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;子属性1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值3&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;子属性2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值4&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>示例：</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /heima/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑马程序员Java讲师&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zy@itcast.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;云&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;赵&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="查询-1">查询</h3><p>根据rest风格，新增是post，查询应该是get，不过查询一般都需要条件，这里我们把文档id带上。</p><p><strong>语法：</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /<span class="punctuation">&#123;</span>索引库名称<span class="punctuation">&#125;</span>/_doc/<span class="punctuation">&#123;</span>id<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>示例：</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /heima/_doc/<span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/01/688c440913458.png" alt="image-20250801123520521"></p><h3 id="删除-1">删除</h3><p>删除使用DELETE请求，同样，需要根据id进行删除：</p><p><strong>语法：</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">DELETE</span> /&#123;索引库名&#125;/_doc/id值</span><br></pre></td></tr></table></figure><p><strong>示例：</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">DELETE /heima/_doc/<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="修改">修改</h3><p>全量修改是覆盖原来的文档，其本质是两步操作：</p><ul><li>根据指定的id删除文档</li><li>新增一个相同id的文档</li></ul><p><strong>注意</strong>：如果根据id删除时，id不存在，第二步的新增也会执行，也就从修改变成了新增操作了。</p><p><strong>语法：</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_doc/文档id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;字段1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;字段2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ... 略</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>示例：</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /heima/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑马程序员高级Java讲师&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zy@itcast.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;云&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;赵&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>由于<code>id</code>为<code>1</code>的文档已经被删除，所以第一次执行时，得到的反馈是<code>created</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=NWEzOTYzOGViN2E2NzlkODU1MzU2OTM4Mjc3YWMzYWFfSjlDSWxzNktUMXMyckg1U2JJS21TTElBVGZJY2lrVWZfVG9rZW46Vzl1dmJuNEt5b0t1TDh4bklXb2N4TVVxbm5kXzE3NTQwMzA3MTg6MTc1NDAzNDMxOF9WNA" alt="img"></p><p>所以如果执行第2次时，得到的反馈则是<code>updated</code>：</p><h4 id="局部修改">局部修改</h4><p>局部修改是只修改指定id匹配的文档中的部分字段。</p><p><strong>语法：</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_update/文档id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span> <span class="string">&quot;新的值&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>示例：</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /heima/_update/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ZhaoYun@itcast.cn&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="7-批处理">7. 批处理</h2><p>批处理采用POST请求，基本语法如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;field1&quot;</span> : <span class="string">&quot;value1&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;delete&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;create&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;field1&quot;</span> : <span class="string">&quot;value3&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;update&quot;</span> : &#123;<span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span> : &#123;<span class="string">&quot;field2&quot;</span> : <span class="string">&quot;value2&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li><code>index</code>代表新增操作<ul><li><code>_index</code>：指定索引库名</li><li><code>_id</code>指定要操作的文档id</li><li><code>&#123; "field1" : "value1" &#125;</code>：则是要新增的文档内容</li></ul></li><li><code>delete</code>代表删除操作<ul><li><code>_index</code>：指定索引库名</li><li><code>_id</code>指定要操作的文档id</li></ul></li><li><code>update</code>代表更新操作<ul><li><code>_index</code>：指定索引库名</li><li><code>_id</code>指定要操作的文档id</li><li><code>&#123; "doc" : &#123;"field2" : "value2"&#125; &#125;</code>：要更新的文档字段</li></ul></li></ul><p>示例，批量新增：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>: &#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;heima&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;info&quot;</span>: <span class="string">&quot;黑马程序员C++讲师&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;ww@itcast.cn&quot;</span>, <span class="string">&quot;name&quot;</span>:&#123;<span class="string">&quot;firstName&quot;</span>: <span class="string">&quot;五&quot;</span>, <span class="string">&quot;lastName&quot;</span>:<span class="string">&quot;王&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>: &#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;heima&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;4&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;info&quot;</span>: <span class="string">&quot;黑马程序员前端讲师&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;zhangsan@itcast.cn&quot;</span>, <span class="string">&quot;name&quot;</span>:&#123;<span class="string">&quot;firstName&quot;</span>: <span class="string">&quot;三&quot;</span>, <span class="string">&quot;lastName&quot;</span>:<span class="string">&quot;张&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>批量删除：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;<span class="string">&quot;delete&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;heima&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;delete&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;heima&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;4&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="8-javarestclient">8. JavaRestClient</h2><h3 id="81-导入客户端">8.1 导入客户端</h3><p>在elasticsearch提供的API中，与elasticsearch一切交互都封装在一个名为<code>RestHighLevelClient</code>的类中，必须先完成这个对象的初始化，建立与elasticsearch的连接。</p><p>分为三步：</p><p>1）在<code>item-service</code>模块中引入<code>es</code>的<code>RestHighLevelClient</code>依赖：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）因为SpringBoot默认的ES版本是<code>7.17.10</code>，所以我们需要覆盖默认的ES版本：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3）初始化RestHighLevelClient：</p><p>初始化的代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(</span><br><span class="line">        HttpHost.create(<span class="string">&quot;http://192.168.150.101:9200&quot;</span>)</span><br><span class="line">));</span><br></pre></td></tr></table></figure><h4 id="811-编写简单测试类">8.1.1 编写简单测试类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.item.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with IntelliJ IDEA.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 李阳</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2025/08/01/16:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: ElesticSearch测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;client=&quot;</span>+client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化客户端</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">       client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(</span><br><span class="line">               HttpHost.create(<span class="string">&quot;192.168.163.129:9200&quot;</span>)</span><br><span class="line">       ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁客户端</span></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">client=org.elasticsearch.client.RestHighLevelClient@12c7a01b</span><br><span class="line"><span class="number">17</span>:<span class="number">04</span>:<span class="number">46.887</span> [main] DEBUG org.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager - Connection manager is shutting down</span><br><span class="line"><span class="number">17</span>:<span class="number">04</span>:<span class="number">46.891</span> [main] DEBUG org.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager - Connection manager shut down</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/01/688c83881e251.png" alt="image-20250801170603450"></p><h3 id="82-索引库操作">8.2 索引库操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.item.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.GetIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with IntelliJ IDEA.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 李阳</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2025/08/01/16:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: ElesticSearch测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;client=&quot;</span>+client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.创建Request对象</span></span><br><span class="line">        <span class="type">CreateIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateIndexRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.准备请求参数</span></span><br><span class="line">        request.source(MAPPING_TEMPLATE, XContentType.JSON);</span><br><span class="line">        <span class="comment">// 3.发送请求</span></span><br><span class="line">        client.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MAPPING_TEMPLATE</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;name\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;price\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;image\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;category\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;brand\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;sold\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;commentCount\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;isAD\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;boolean\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;updateTime\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;date\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.创建Request对象</span></span><br><span class="line">        <span class="type">GetIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetIndexRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">        <span class="comment">// 3.发送请求</span></span><br><span class="line">        client.indices().get(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.创建Request对象</span></span><br><span class="line">        <span class="type">DeleteIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteIndexRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">        <span class="comment">// 3.发送请求</span></span><br><span class="line">        client.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化客户端</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">       client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(</span><br><span class="line">               HttpHost.create(<span class="string">&quot;192.168.163.129:9200&quot;</span>)</span><br><span class="line">       ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁客户端</span></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/01/688c9c0471ae2.png" alt="image-20250801185039277"></p><h3 id="83-文档操作">8.3 文档操作</h3><h4 id="新增-1">新增</h4><p>从MySQL中新增数据到elastic</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with IntelliJ IDEA.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 李阳</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2025/08/01/16:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: Doc文档测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest(properties = &quot;spring.profiles.active=local&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticDocTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IItemService itemService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;client=&quot;</span>+client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testIndexDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 0. 准备文档数据</span></span><br><span class="line">        <span class="comment">// 0.1 根据id查询商品信息</span></span><br><span class="line">        <span class="type">Item</span> <span class="variable">item</span> <span class="operator">=</span> itemService.getById(<span class="number">100000011127L</span>);</span><br><span class="line">        <span class="comment">// 0.2 将商品信息转换为文档数据</span></span><br><span class="line">        <span class="type">ItemDoc</span> <span class="variable">itemDoc</span> <span class="operator">=</span> BeanUtil.copyProperties(item, ItemDoc.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.准备Request</span></span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;items&quot;</span>).id(itemDoc.getId());</span><br><span class="line">        <span class="comment">// 2.准备请求参数</span></span><br><span class="line">        request.source(JSONUtil.toJsonStr(itemDoc), XContentType.JSON);</span><br><span class="line">        <span class="comment">// 3.发送请求</span></span><br><span class="line">        client. index(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化客户端</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">       client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(</span><br><span class="line">               HttpHost.create(<span class="string">&quot;192.168.163.129:9200&quot;</span>)</span><br><span class="line">       ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁客户端</span></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>有@Autowired private MyService myService;</p><p>是想要SpringBean 对象@SpringBootTest 注解通常用于集成测试中，它会启动整个 Spring 容器，以便可以注入 Spring 管理的 Bean。如果不是测试类，使用 SpringApplication.run() 启动 Spring Boot 应用</p></li><li><p>在<code>hm-service</code>模块的<code>com.hmall.item.domain.dto</code>包中定义一个新的DTO</p></li></ul><p>新增结果</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688d6f30220d2.png" alt="image-20250802095136444"></p><h4 id="查询-2">查询</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">testGetDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">       <span class="comment">// 1.准备Request</span></span><br><span class="line">       <span class="type">GetRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;items&quot;</span>, <span class="string">&quot;100000011127&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 2.发送请求</span></span><br><span class="line">       <span class="type">GetResponse</span> <span class="variable">documentFields</span> <span class="operator">=</span> client.get(request, RequestOptions.DEFAULT);</span><br><span class="line">       <span class="comment">// 3.处理响应结果</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> documentFields.getSourceAsString();</span><br><span class="line"></span><br><span class="line">       <span class="type">ItemDoc</span> <span class="variable">itemDoc</span> <span class="operator">=</span> JSONUtil.toBean(sourceAsString, ItemDoc.class);</span><br><span class="line">       System.out.println(<span class="string">&quot;items&quot;</span>+itemDoc);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>结果</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688d738e33c37.png" alt="image-20250802101009877"></p><h4 id="删除-2">删除</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testDeleteDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1.准备Request</span></span><br><span class="line">    <span class="type">DeleteRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(<span class="string">&quot;items&quot;</span>, <span class="string">&quot;100000011127&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.发送请求</span></span><br><span class="line">    client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="更新">更新</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1.准备Request</span></span><br><span class="line">    <span class="type">UpdateRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(<span class="string">&quot;items&quot;</span>,<span class="string">&quot;100000011127&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.准备请求参数</span></span><br><span class="line">    request.doc(</span><br><span class="line">            <span class="string">&quot;price&quot;</span>,<span class="number">25600</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 3.发送请求</span></span><br><span class="line">    client. update(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="批处理">批处理</h4><p>批处理与前面讲的文档的CRUD步骤基本一致：</p><ul><li>创建Request，但这次用的是<code>BulkRequest</code></li><li>准备请求参数</li><li>发送请求，这次要用到<code>client.bulk()</code>方法</li></ul><p><code>BulkRequest</code>本身其实并没有请求参数，其本质就是将多个普通的CRUD请求组合在一起发送。例如：</p><ul><li>批量新增文档，就是给每个文档创建一个<code>IndexRequest</code>请求，然后封装到<code>BulkRequest</code>中，一起发出。</li><li>批量删除，就是创建N个<code>DeleteRequest</code>请求，然后封装到<code>BulkRequest</code>，一起发出</li></ul><p>因此<code>BulkRequest</code>中提供了<code>add</code>方法，用以添加其它CRUD的请求：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688d7f36b41b8.png" alt="image-20250802110005414"></p><p>可以看到，能添加的请求有：</p><ul><li><code>IndexRequest</code>，也就是新增</li><li><code>UpdateRequest</code>，也就是修改</li><li><code>DeleteRequest</code>，也就是删除</li></ul><p>因此Bulk中添加了多个<code>IndexRequest</code>，就是批量新增功能了。示例：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testBulk</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1.创建Request</span></span><br><span class="line">    <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">    <span class="comment">// 2.准备请求参数</span></span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;items&quot;</span>).id(<span class="string">&quot;1&quot;</span>).source(<span class="string">&quot;json doc1&quot;</span>, XContentType.JSON));</span><br><span class="line">    request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;items&quot;</span>).id(<span class="string">&quot;2&quot;</span>).source(<span class="string">&quot;json doc2&quot;</span>, XContentType.JSON));</span><br><span class="line">    <span class="comment">// 3.发送请求</span></span><br><span class="line">    client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="完整代码">完整代码</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 批处理</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testBulk</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">PageNo</span> <span class="operator">=</span> <span class="number">1</span>, PageSize = <span class="number">500</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">// 0. 准备文档数据-查询到一页数据</span></span><br><span class="line">            Page&lt;Item&gt; page = itemService.lambdaQuery()</span><br><span class="line">                    .eq(Item::getStatus, <span class="number">1</span>)</span><br><span class="line">                    .page(Page.of(PageNo, PageSize));</span><br><span class="line">            List&lt;Item&gt; records = page.getRecords();</span><br><span class="line">            <span class="keyword">if</span>(records.isEmpty())&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 1.准备Request</span></span><br><span class="line">            <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">            <span class="comment">// 2.准备请求参数</span></span><br><span class="line">            <span class="keyword">for</span> (Item record : records) &#123;</span><br><span class="line">                request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;items&quot;</span>).id(record.getId().toString())</span><br><span class="line">                        .source(JSONUtil.toJsonStr(BeanUtil.copyProperties(record,ItemDoc.class)),XContentType.JSON));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.发送请求</span></span><br><span class="line">            client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 翻页</span></span><br><span class="line">            PageNo++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="八-elasticsearch-02">八. Elasticsearch 02</h1><p>Elasticsearch的查询可以分为两大类：</p><ul><li><strong>叶子查询（Leaf</strong> <strong>query</strong> <strong>clauses）</strong>：一般是在特定的字段里查询特定值，属于简单查询，很少单独使用。</li><li><strong>复合查询（Compound</strong> <strong>query</strong> <strong>clauses）</strong>：以逻辑方式组合多个叶子查询或者更改叶子查询的行为方式。</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688db44322502.png" alt="image-20250802144614784"></p><h2 id="81-dsl查询">8.1 DSL查询</h2><h3 id="1-入门">1. 入门</h3><p>我们依然在Kibana的DevTools中学习查询的DSL语法。首先来看查询的语法结构：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;查询类型&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// .. 查询条件</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><code>GET /&#123;索引库名&#125;/_search</code>：其中的<code>_search</code>是固定路径，不能修改</li></ul><p>例如，我们以最简单的无条件查询为例，无条件查询的类型是：match_all，因此其查询语句如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>由于match_all无条件，所以条件位置不写即可。</p><h3 id="2-叶子查询">2. 叶子查询</h3><p>叶子查询可分为：</p><ul><li><strong>全文检索查询（Full Text Queries）</strong>：利用分词器对用户输入搜索条件先分词，得到词条，然后再利用倒排索引搜索词条。例如：<ul><li><code>match</code>：</li><li><code>multi_match</code></li></ul></li><li><strong>精确查询（Term-level queries）</strong>：不对用户输入搜索条件分词，根据字段内容精确值匹配。但只能查找keyword、数值、日期、boolean类型的字段。例如：<ul><li><code>ids</code></li><li><code>term</code></li><li><code>range</code></li></ul></li><li><strong>地理坐标查询</strong>：用于搜索地理位置，搜索方式很多，例如：<ul><li><code>geo_bounding_box</code>：按矩形搜索</li><li><code>geo_distance</code>：按点和半径搜索</li></ul></li><li>…略</li></ul><h4 id="21-全文检索查询">2.1 全文检索查询</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688dbda71276a.png" alt="aaaaa"></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span> <span class="string">&quot;搜索条件&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688ddec79706d.png" alt="image-20250802174737736"></p><p>与<code>match</code>类似的还有<code>multi_match</code>，区别在于可以同时对多个字段搜索，而且多个字段都要满足，语法示例：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;搜索条件&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;字段1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;字段2&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>参与查询字段越多，查询性能就越差，可以使用copy_to将多个字段拷贝到一个字段中</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688de0167cac8.png" alt="image-20250802175313386"></p><p>相关度评分是基于BM25（Best Matching 25）算法来计算的，这是一种改进的TF-IDF（Term Frequency-Inverse Document Frequency）算法。</p><h4 id="22-精确查询">2.2 精确查询</h4><p>精确查询，英文是<code>Term-level query</code>，顾名思义，词条级别的查询。也就是说不会对用户输入的搜索条件再分词，而是作为一个词条，与搜索的字段内容精确值匹配。因此推荐查找<code>keyword</code>、数值、日期、<code>boolean</code>类型的字段。例如：</p><ul><li>id</li><li>price</li><li>城市</li><li>地名</li><li>人名</li></ul><p>等等，作为一个整体才有含义的字段。</p><p>以<code>term</code>查询为例，其语法如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;字段名(.keyword)&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;搜索条件&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688de37a8d719.png" alt="image-20250802180750164"></p><p>因为这里的brand是text类型的会被分词，如果直接匹配就匹配不上了，所以加了keyword</p><h5 id="range范围查询"><code>range</code>范围查询</h5><p><code>range</code>是范围查询，对于范围筛选的关键字有：</p><ul><li><code>gte</code>：大于等于</li><li><code>gt</code>：大于</li><li><code>lte</code>：小于等于</li><li><code>lt</code>：小于</li></ul><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span><span class="number">500000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span><span class="number">1000000</span></span><br><span class="line">      <span class="punctuation">&#125;</span>      </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688de4d25ec03.png" alt="image-20250802181336064"></p><p><code>Ids</code>根据id查询</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;具体的id&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688de648d6815.png" alt="image-20250802181950347"></p><blockquote><p>match和multi_match的区别是什么?</p></blockquote><ul><li><p>match:根据一个字段查询</p></li><li><p>multi_match:根据多个字段查询，参与查询字段越多，查询性能越差</p></li></ul><blockquote><p>精确查询常见的有哪些?</p></blockquote><ul><li>term查询:根据词条精确匹配，一般搜索keyword类型、数值类型、布尔类型、日期类型字段</li><li>range查询:根据数值范围查询，可以是数值、日期的范围</li></ul><h3 id="3-复合查询">3. 复合查询</h3><p>复合查询大致可以分为两类：</p><ul><li>第一类：基于逻辑运算组合叶子查询，实现组合条件，例如<ul><li>bool</li></ul></li><li>第二类：基于某种算法修改查询时的文档相关性算分，从而改变文档排名。例如：<ul><li>function_score</li><li>dis_max</li></ul></li></ul><h4 id="31-bool查询">3.1 bool查询</h4><p>bool查询，即布尔查询。就是利用逻辑运算来组合一个或多个查询子句的组合。bool查询支持的逻辑运算有：</p><ul><li>must：必须匹配每个子查询，类似“与”</li><li>should：选择性匹配子查询，类似“或”</li><li>must_not：必须不匹配，<strong>不参与算分</strong>，类似“非”</li><li>filter：必须匹配，<strong>不参与算分</strong></li></ul><p>bool查询的语法如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;手机&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vivo&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">2500</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>出于性能考虑，与搜索关键字无关的查询尽量采用must_not或filter逻辑运算，避免参与相关性算分。</p><h5 id="例如">例如：</h5><p>查询智能手机品牌华为</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;智能手机&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;brand.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">90000</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">159900</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/02/688dee0f954bb.png" alt="image-20250802185301332"></p><h3 id="4-排序">4. 排序</h3><p>elasticsearch默认是根据相关度算分（<code>_score</code>）来排序，但是也支持自定义方式对搜索结果排序。不过分词字段无法排序，能参与排序字段类型有：<code>keyword</code>类型、数值类型、地理坐标类型、日期类型等。</p><p>语法说明：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /indexName/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;排序字段&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;排序方式asc和desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>示例</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;sold&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688ecb3f14432.png" alt="image-20250803103645088"></p><h3 id="5-分页">5. 分页</h3><p>elasticsearch 默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了。</p><p>elasticsearch中通过修改<code>from</code>、<code>size</code>参数来控制要返回的分页结果：</p><ul><li><code>from</code>：从第几个文档开始</li><li><code>size</code>：总共查询几个文档</li></ul><p>类似于mysql中的<code>limit ?, ?</code></p><p>语法如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="comment">// 分页开始的位置，默认为0</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span>  <span class="comment">// 每页文档数量，默认10</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;手机&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688ecee903d46.png" alt="image-20250803105219258"></p><h5 id="深度分页">深度分页</h5><p>elasticsearch的数据一般会采用分片存储，也就是把一个索引中的数据分成N份，存储到不同节点上。这种存储方式比较有利于数据扩展，但给分页带来了一些麻烦。</p><p>Elasticsearch 的索引由多个不可变的分段（Segment） 组成，每个分段独立存储数据。文档按写入顺序存储在分段内，类似数组结构。通过内部文档 ID（Lucene 的 doc_id）可直接计算偏移量，实现快速随机访问。（POST /index/_doc）就会自动创建id，（POST /index/_doc/{id}）就是手动创建id，前面我们通过java的es客户端是后者的方式）</p><p>但是简单分页查询的问题在于，排序并不一定总是按文档id顺序排序，而是常常会按某些关键字进行排序（例如下方，但下方并未说明，实际有“sort“条件但没有“query“条件时，算分均为null，此时按文档id升序排列。题外话：如果只有“from“和“size“，不显式指定“sort“排序条件时，es默认会将搜索结果按算分降序排列；但同时没有“query“条件时，那么默认“query“就是match_all，所有算分都是1.0，此时退化为按_doc升序默认排序），所以会导致排序后文档id分散，从而无法依靠id顺序如同数组一般随机访问，而是如同链表一般顺序访问。</p><p>而分页条件（from、size）越大，查询内容也就越多（查询内容当然存在内存中，es是一个java项目，例如找出前10000个数据放在内存里，最后遍历到第9990-10000的数据），数据过多就会导致oom。这里“深度分页”解决的就是分页数据量过于庞大的问题。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688ed109e2ac5.png" alt="image-20250803110128561"></p><p>from+size = 页码 * size</p><p>针对深度分页，elasticsearch提供了两种解决方案：</p><ul><li><code>search after</code>：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li><li><code>scroll</code>：原理将排序后的文档id形成快照，保存下来，基于快照做分页。官方已经不推荐使用。</li></ul><p>https://blog.csdn.net/weixin_47762494/article/details/145763668?spm=1001.2014.3001.5501</p><p>假设你在看一本书，你已经翻到某一页（例如第10页），然后你想继续看第11页。search_after就像是“给你上一页的最后一行文字”，让你知道接下来你应该从哪里开始读，而不是从头开始翻书（就像from那样跳过很多页）</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688ed45c1bcc6.png" alt="image-20250803111528878"></p><h3 id="6-高亮显示">6. 高亮显示</h3><p>事实上elasticsearch已经提供了给搜索关键字加标签的语法，无需我们自己编码。</p><p>基本语法如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;搜索字段&quot;</span><span class="punctuation">:</span> <span class="string">&quot;搜索关键字&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;高亮字段名称&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;&quot;</span><span class="punctuation">,</span><span class="comment">// 高亮的前置标签</span></span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/em&gt;&quot;</span> <span class="comment">// 高亮的后置标签</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>搜索必须有查询条件，而且是全文检索类型的查询条件，例如<code>match</code></li><li>参与高亮的字段必须是<code>text</code>类型的字段</li><li>默认情况下参与高亮的字段要与搜索字段一致，除非添加：<code>required_field_match=false</code></li></ul><p><strong>示例</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;脱脂牛奶&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/em&gt;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688ed8e82965f.png" alt="image-20250803113500171"></p><h2 id="82-restclient-查询">8.2 RestClient 查询</h2><p>文档的查询依然使用昨天学习的 <code>RestHighLevelClient</code>对象，查询的基本步骤如下：</p><ul><li>1）创建<code>request</code>对象，这次是搜索，所以是<code>SearchRequest</code></li><li>2）准备请求参数，也就是查询DSL对应的JSON参数</li><li>3）发起请求</li><li>4）解析响应，响应结果相对复杂，需要逐层解析</li></ul><h3 id="1-查询所有">1. 查询所有</h3><p><strong>查询所有</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;client=&quot;</span>+client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testMatchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. 创建request对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. 配置request对象</span></span><br><span class="line">        request.source()</span><br><span class="line">                .query(QueryBuilders.matchAllQuery());</span><br><span class="line">        <span class="comment">// 3. 发送请求</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 解析响应结果</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> search.getHits();</span><br><span class="line">        <span class="comment">// 4.1. 获取总条数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> hits.getTotalHits().value;</span><br><span class="line">        System.out.println(<span class="string">&quot;总条数：&quot;</span>+value);</span><br><span class="line">        <span class="comment">// 4.2. 获取总记录数</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">            <span class="type">ItemDoc</span> <span class="variable">itemDoc</span> <span class="operator">=</span> JSONUtil.toBean(sourceAsString, ItemDoc.class);</span><br><span class="line">            System.out.println(itemDoc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化客户端</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">       client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(</span><br><span class="line">               HttpHost.create(<span class="string">&quot;192.168.163.129:9200&quot;</span>)</span><br><span class="line">       ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁客户端</span></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f13bf9c89c.png" alt="image-20250803154600032"></p><h3 id="2-构建条件查询">2. 构建条件查询</h3><h4 id="全文检索查询">全文检索查询</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f1556d2743.png" alt="image-20250803155245935"></p><h4 id="精确查询">精确查询</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f15b4c1bda.png" alt="image-20250803155415127"></p><h4 id="布尔查询">布尔查询</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f1636ea691.png" alt="image-20250803155634268"></p><p><strong>示例</strong></p><p>搜索关键字脱脂牛奶，品牌德亚，价格低于300</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;client=&quot;</span>+client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testMatchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. 创建request对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. 配置request对象</span></span><br><span class="line">        request.source()</span><br><span class="line">                .query(QueryBuilders</span><br><span class="line">                        .boolQuery()</span><br><span class="line">                        .must(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;脱脂牛奶 &quot;</span>))</span><br><span class="line">                        .filter(QueryBuilders.termQuery(<span class="string">&quot;brand.keyword&quot;</span>,<span class="string">&quot;德亚&quot;</span>))</span><br><span class="line">                        .filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).lt(<span class="number">30000</span>))</span><br><span class="line">                );</span><br><span class="line">        <span class="comment">// 3. 发送请求</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        pareResponseResult(search);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">pareResponseResult</span><span class="params">(SearchResponse search)</span> &#123;</span><br><span class="line">        <span class="comment">// 4. 解析响应结果</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> search.getHits();</span><br><span class="line">        <span class="comment">// 4.1. 获取总条数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> hits.getTotalHits().value;</span><br><span class="line">        System.out.println(<span class="string">&quot;总条数：&quot;</span>+value);</span><br><span class="line">        <span class="comment">// 4.2. 获取总记录数</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">            <span class="type">ItemDoc</span> <span class="variable">itemDoc</span> <span class="operator">=</span> JSONUtil.toBean(sourceAsString, ItemDoc.class);</span><br><span class="line">            System.out.println(itemDoc);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化客户端</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">       client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(</span><br><span class="line">               HttpHost.create(<span class="string">&quot;192.168.163.129:9200&quot;</span>)</span><br><span class="line">       ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁客户端</span></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f1be407ab5.png" alt="image-20250803162049889"></p><h3 id="3-排序和分页">3. 排序和分页</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f1c98a7f53.png" alt="image-20250803162351151"></p><p><strong>示例</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 分页</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testPage</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 0. 模拟前端传入的参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1</span>, pageSize = <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// 1. 创建request对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. 配置request对象</span></span><br><span class="line">        request.source()</span><br><span class="line">                .query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.1. 设置分页</span></span><br><span class="line">        request.source()</span><br><span class="line">                .from((pageNo-<span class="number">1</span>)*pageSize)</span><br><span class="line">                .size(pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.2. 设置排序</span></span><br><span class="line">        request.source()</span><br><span class="line">                .sort(<span class="string">&quot;sold&quot;</span>, SortOrder.DESC)</span><br><span class="line">                .sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line">        <span class="comment">// 3. 发送请求</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        pareResponseResult(search);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">pareResponseResult</span><span class="params">(SearchResponse search)</span> &#123;</span><br><span class="line">        <span class="comment">// 4. 解析响应结果</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> search.getHits();</span><br><span class="line">        <span class="comment">// 4.1. 获取总条数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> hits.getTotalHits().value;</span><br><span class="line">        System.out.println(<span class="string">&quot;总条数：&quot;</span>+value);</span><br><span class="line">        <span class="comment">// 4.2. 获取总记录数</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">            <span class="type">ItemDoc</span> <span class="variable">itemDoc</span> <span class="operator">=</span> JSONUtil.toBean(sourceAsString, ItemDoc.class);</span><br><span class="line">            System.out.println(itemDoc);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f2035b4e49.png" alt="image-20250803163902995"></p><h3 id="4-高亮显示">4. 高亮显示</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 高亮</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">testHighlight</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">       <span class="comment">// 1. 创建request对象</span></span><br><span class="line">       <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">       <span class="comment">// 2. 配置request对象</span></span><br><span class="line">       request.source()</span><br><span class="line">               .query(QueryBuilders</span><br><span class="line">                       .matchQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;脱脂牛奶&quot;</span>)</span><br><span class="line">               );</span><br><span class="line">       <span class="comment">// 2.1. 设置高亮</span></span><br><span class="line">       request.source()</span><br><span class="line">               .highlighter(SearchSourceBuilder.highlight().field(<span class="string">&quot;name&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>));</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 3. 发送请求</span></span><br><span class="line">       <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">       pareResponseResult(search);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">pareResponseResult</span><span class="params">(SearchResponse search)</span> &#123;</span><br><span class="line">       <span class="comment">// 4. 解析响应结果</span></span><br><span class="line">       <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> search.getHits();</span><br><span class="line">       <span class="comment">// 4.1. 获取总条数</span></span><br><span class="line">       <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> hits.getTotalHits().value;</span><br><span class="line">       System.out.println(<span class="string">&quot;总条数：&quot;</span>+value);</span><br><span class="line">       <span class="comment">// 4.2. 获取总记录数</span></span><br><span class="line">       SearchHit[] searchHits = hits.getHits();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">           <span class="type">ItemDoc</span> <span class="variable">itemDoc</span> <span class="operator">=</span> JSONUtil.toBean(sourceAsString, ItemDoc.class);</span><br><span class="line">           <span class="comment">// 5.1. 获取高亮结果</span></span><br><span class="line">           Map&lt;String, HighlightField&gt; hms = searchHit.getHighlightFields();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (hms != <span class="literal">null</span> || !hms.isEmpty()) &#123;</span><br><span class="line">               <span class="comment">// 5.2. 根据高亮字段名，获取高亮结果</span></span><br><span class="line">               <span class="type">HighlightField</span> <span class="variable">hf</span> <span class="operator">=</span> hms.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">               <span class="comment">// 5.3. 获取高亮结果，覆盖非高亮</span></span><br><span class="line">               <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> hf.getFragments()[<span class="number">0</span>].string();</span><br><span class="line">               itemDoc.setName(string);</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           System.out.println(itemDoc);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/03/688f2758b5691.png" alt="image-20250803170906792"></p><h2 id="83-数据聚合">8.3 数据聚合</h2><p>聚合（<code>aggregations</code>）可以让我们极其方便的实现对数据的统计、分析、运算。例如：</p><ul><li>什么品牌的手机最受欢迎？</li><li>这些手机的平均价格、最高价格、最低价格？</li><li>这些手机每月的销售情况如何？</li></ul><p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p><p>聚合常见的有三类：</p><ul><li>**桶（<code>Bucket</code>）**聚合：用来对文档做分组</li><li><code>TermAggregation</code>：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li><li><code>Date Histogram</code>：按照日期阶梯分组，例如一周为一组，或者一月为一组</li><li>**度量（<code>Metric</code>）**聚合：用以计算一些值，比如：最大值、最小值、平均值等</li><li><code>Avg</code>：求平均值</li><li><code>Max</code>：求最大值</li><li><code>Min</code>：求最小值</li><li><code>Stats</code>：同时求<code>max</code>、<code>min</code>、<code>avg</code>、<code>sum</code>等</li><li>**管道（`pipeline）**聚合：其它聚合的结果为基础做进一步运算</li></ul><p>**注意：**参加聚合的字段必须是keyword、日期、数值、布尔类型</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/04/68900b44be11c.png" alt="image-20250804092205880"></p><p>下面俩小人怎么盯着劳资看</p><h3 id="1-dsl聚合">1. DSL聚合</h3><p>例如我们要统计所有商品中共有哪些商品分类，其实就是以分类（category）字段对数据分组。category值一样的放在同一组，属于<code>Bucket</code>聚合中的<code>Term</code>聚合。</p><p>基本语法如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="comment">// 设置size为0，结果中不包含文档，只包含聚合结果</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 定义聚合</span></span><br><span class="line">    <span class="attr">&quot;category_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 给聚合起名字</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 聚合的类型，按照品牌值聚合，所以选择term</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category&quot;</span><span class="punctuation">,</span> <span class="comment">// 参与聚合的字段</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">20</span> <span class="comment">// 希望获取的聚合结果数量</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="bucket聚合">Bucket聚合</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># 聚合</span><br><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cate_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category.keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;brand_agg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brand.keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/04/6890107f106e1.png" alt="image-20250804094425360"></p><h4 id="带条件的聚合">带条件的聚合</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># 带条件的聚合</span><br><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;category.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;手机&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">300000</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brand_agg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brand.keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/04/689011bdc4db7.png" alt="image-20250804094941579"></p><h4 id="metric聚合">Metric聚合</h4><p>上节课，我们统计了价格高于3000的手机品牌，形成了一个个桶。现在我们需要对桶内的商品做运算，获取每个品牌价格的最小值、最大值、平均值。</p><p>这就要用到<code>Metric</code>聚合了，例如<code>stat</code>聚合，就可以同时获取<code>min</code>、<code>max</code>、<code>avg</code>等结果。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># Metric聚合</span><br><span class="line">GET /items/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;category.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;手机&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brand_agg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brand.keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;price_stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/04/6890139eb1661.png" alt="image-20250804095745353"></p><h3 id="2-restclient聚合">2. RestClient聚合</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">testAgg</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">       <span class="comment">// 1. 创建request对象</span></span><br><span class="line">       <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;items&quot;</span>);</span><br><span class="line">       <span class="comment">// 2. 配置request对象-分页</span></span><br><span class="line">       request.source().size(<span class="number">0</span>);</span><br><span class="line">       <span class="comment">// 2.1. 设置聚合函数</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">brandAgg</span> <span class="operator">=</span> <span class="string">&quot;brandAgg&quot;</span>;</span><br><span class="line">       request.source().aggregation(</span><br><span class="line">               AggregationBuilders.terms(brandAgg).field(<span class="string">&quot;brand.keyword&quot;</span>)</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 3. 发送请求</span></span><br><span class="line">       <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 4. 解析响应结果</span></span><br><span class="line">       <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> search.getAggregations();</span><br><span class="line">       <span class="type">Terms</span> <span class="variable">brandTerms</span> <span class="operator">=</span> aggregations.get(brandAgg);</span><br><span class="line"></span><br><span class="line">       List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = brandTerms.getBuckets();</span><br><span class="line">       <span class="comment">// 遍历获取桶</span></span><br><span class="line">       <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;品牌： &quot;</span>+bucket.getKeyAsString());</span><br><span class="line">           System.out.println(<span class="string">&quot;数量： &quot;</span>+bucket.getDocCount());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/04/68901853aad60.png" alt="image-20250804101731729"></p><h1 id="九面试部分">九、面试部分</h1><p>详情参照站内另外一篇文章面试模块</p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">李阳</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.baskly.fun/posts/42622/">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://blog.baskly.fun/posts/42622/")'>SpringCloud</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.baskly.fun/posts/42622/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=SpringCloud&amp;url=https://blog.baskly.fun/posts/42622/&amp;pic=https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=320ac6a6-3bf5-9cc8-180a-c9c4b73ea680" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.baskly.fun" target="_blank">李阳的秘密小屋</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/java/"><span class="categoryes-punctuation"><i class="anzhiyufont anzhiyu-icon-inbox"></i></span> java<span class="categoryesPageCount">9</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/javaweb/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span> javaweb<span class="tagsPageCount">8</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2024/12/24/676a8d8bc7d9f.png?_r_=44f6b0e5-baf0-473e-e531-b64b494f68de" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/49515/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e151d6a.png?_r_=90fa1921-0a69-b602-3178-9ee5211c46f1" onerror='onerror=null,src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">前端学习（tlias为例）</div></div></a></div><div class="next-post pull-right"><a href="/posts/3860/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=456351c6-24ef-054b-2585-a57c1677c6ef" onerror='onerror=null,src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">黑马学成在线</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i> <span>评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/805daa7195f2c.gif" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">这有描绘<b style="color:#fff">我的痕迹</b></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">李阳</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/lyay23" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E5%89%8D%E7%BD%AE%E8%AF%BE%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">一、前置课程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1mybatisplus"><span class="toc-number">1.1.</span> <span class="toc-text">1、MybatisPlus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 项目启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 常用注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 常见配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 核心功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">模糊查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9B%B4%E6%96%B0"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">条件更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9B%B4%E6%96%B0-1"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">条件更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89sql"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">自定义SQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service%E6%8E%A5%E5%8F%A3iservice"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">Service接口–IService</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-restful%E9%A3%8E%E6%A0%BC%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 Restful风格接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.6 逻辑删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-%E6%9E%9A%E4%B8%BE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.1.7.</span> <span class="toc-text">1.7 枚举处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-json%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.1.8.</span> <span class="toc-text">1.8 JSON类型处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="toc-number">1.1.9.</span> <span class="toc-text">1.9 分页插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%A1%88%E4%BE%8B"><span class="toc-number">1.1.9.1.</span> <span class="toc-text">通用分页查询案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%88%86%E9%A1%B5%E6%9D%A1%E4%BB%B6%E5%B0%81%E8%A3%85%E5%9C%A8%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B8%AD"><span class="toc-number">1.1.9.2.</span> <span class="toc-text">将分页条件封装在工具类中</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2docker"><span class="toc-number">1.2.</span> <span class="toc-text">2.Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 安装问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%A7%A3%E5%86%B3%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E6%97%B6es33%E6%98%BE%E7%A4%BA%E8%A2%AB%E5%B7%B2%E6%8B%94%E5%87%BA%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1. 解决配置网络时es33显示被已拔出问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%A7%A3%E5%86%B3docker%E9%95%9C%E5%83%8F%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">2. 解决Docker镜像问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85mysql"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 安装MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-docker%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. Docker常见命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 数据卷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#41-%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">4.1 什么是数据卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#42-%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">4.2 数据卷的命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#43-%E5%88%9B%E5%BB%BAnginx-%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">4.3 创建Nginx 数据卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#44-mysql-%E5%AE%B9%E5%99%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8C%82%E8%BD%BD"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">4.4 MySQL 容器的数据挂载</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 自定义镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%BD%91%E7%BB%9C"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E4%BD%BF%E7%94%A8docker%E6%89%93%E5%8C%85%E9%A1%B9%E7%9B%AEtlias%E4%B8%BA%E4%BE%8B"><span class="toc-number">1.2.7.</span> <span class="toc-text">7.使用Docker打包项目（tlias为例）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#71%E5%90%8E%E7%AB%AF%E6%89%93%E5%8C%85"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">7.1后端打包</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.7.1.1.</span> <span class="toc-text">具体步骤</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#72-%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">7.2. 前端项目部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-dockercompose"><span class="toc-number">1.2.8.</span> <span class="toc-text">8. DockerCompose</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E5%BE%AE%E6%9C%8D%E5%8A%A101"><span class="toc-number">2.</span> <span class="toc-text">二、微服务01</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%BC%E5%85%A5%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.0.1.</span> <span class="toc-text">1. 导入后端项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%97%B6%E5%8C%BA%E4%B8%8D%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98"><span class="toc-number">2.0.1.1.</span> <span class="toc-text">解决时区不同步问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.0.2.</span> <span class="toc-text">2. 单体架构与微服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8E%9F%E5%88%99"><span class="toc-number">2.0.3.</span> <span class="toc-text">3. 微服务拆分原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8rpc"><span class="toc-number">2.0.4.</span> <span class="toc-text">4. 远程调用（RPC）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#41-resttemplate"><span class="toc-number">2.0.4.1.</span> <span class="toc-text">4.1 RestTemplate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#42-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.0.4.2.</span> <span class="toc-text">4.2 注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#43-nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.0.4.3.</span> <span class="toc-text">4.3 Nacos注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#44-openfeign"><span class="toc-number">2.0.4.4.</span> <span class="toc-text">4.4 OpenFeign</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#45-%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">2.0.4.5.</span> <span class="toc-text">4.5 连接池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#46-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.0.4.6.</span> <span class="toc-text">4.6 最佳实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#46-%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA"><span class="toc-number">2.0.4.7.</span> <span class="toc-text">4.6 日志输出</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">2.0.4.7.1.</span> <span class="toc-text">定义日志级别</span></a></li></ol></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-%E5%BE%AE%E6%9C%8D%E5%8A%A102"><span class="toc-number">3.</span> <span class="toc-text">三、 微服务02</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1"><span class="toc-number">3.1.</span> <span class="toc-text">1. 网关路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E7%BD%91%E5%85%B3%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.1 网关快速入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E8%B7%AF%E7%94%B1%E5%B1%9E%E6%80%A7"><span class="toc-number">3.1.2.</span> <span class="toc-text">1.2 路由属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">路由断言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">路由过滤器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BD%91%E5%85%B3%E7%99%BB%E5%BD%95"><span class="toc-number">3.2.</span> <span class="toc-text">2. 网关登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1 网关过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2 自定义过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.3 实现登录校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-%E7%BD%91%E5%85%B3%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7"><span class="toc-number">3.2.4.</span> <span class="toc-text">2.4 网关传递用户</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E5%88%B0%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">保存用户到请求头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">拦截器获取用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">配置拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%89%AB%E6%8F%8F"><span class="toc-number">3.2.4.4.</span> <span class="toc-text">添加扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">3.2.4.5.</span> <span class="toc-text">结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#135-openfeign%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7"><span class="toc-number">3.2.5.</span> <span class="toc-text">1.3.5 OpenFeign传递用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">3.3.</span> <span class="toc-text">3. 配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1 配置共享</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#311-%E6%B7%BB%E5%8A%A0%E5%85%B1%E4%BA%AB%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">3.1.1 添加共享配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E6%8B%89%E5%8F%96nacos"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2 拉取nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.3 配置热更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">3.3.4.</span> <span class="toc-text">3.4 动态路由</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-%E5%BE%AE%E6%9C%8D%E5%8A%A103"><span class="toc-number">4.</span> <span class="toc-text">四、 微服务03</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#41-%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 雪崩问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#42-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 微服务保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#421-%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4%E6%96%B9%E6%A1%88"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 服务保护方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#422-%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 请求限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#423-%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 线程隔离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#424-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.2.4 服务熔断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#43-sentinel"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#431-sentinel%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 Sentinel安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#window%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">Window安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker%E8%BF%90%E8%A1%8C"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">Docker运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#432-fallback"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2 Fallback</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#44-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#441-seata"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.4.1 Seata</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#442-seata%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.4.2 Seata配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#443-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90seata"><span class="toc-number">4.4.3.</span> <span class="toc-text">4.4.3 微服务集成Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnacos"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">配置nacos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.3.3.</span> <span class="toc-text">改造配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#444-xa%E6%A8%A1%E5%BC%8F%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">4.4.4.</span> <span class="toc-text">4.4.4 XA模式（面试题）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.4.1.</span> <span class="toc-text">回滚日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#445-at%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.5.</span> <span class="toc-text">4.4.5 AT模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94mq%E5%9F%BA%E7%A1%80"><span class="toc-number">5.</span> <span class="toc-text">五、MQ基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#51-%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 异步调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#52-%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 技术选型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-rabbitmq"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#531-%E5%AE%89%E8%A3%85"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#532-spring-amqp"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2 Spring AMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5321-workqueues%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">5.3.2.1 WorkQueues模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5322-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">5.3.2.2 交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5323-fanout-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">5.3.2.3 Fanout 交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5324-direct-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">5.3.2.4 Direct 交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5325-topic%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.5.</span> <span class="toc-text">5.3.2.5 Topic交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5326-%E5%A3%B0%E6%98%8E%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.6.</span> <span class="toc-text">5.3.2.6 声明队列和交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5327-%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">5.3.2.7.</span> <span class="toc-text">5.3.2.7 消息转换器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5328-%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1"><span class="toc-number">5.3.2.8.</span> <span class="toc-text">5.3.2.8 订单业务</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD-mq%E9%AB%98%E7%BA%A7"><span class="toc-number">6.</span> <span class="toc-text">六、 MQ高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E5%8F%91%E9%80%81%E8%80%85%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">6.1.</span> <span class="toc-text">1.发送者的可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E5%8F%91%E9%80%81%E8%80%85%E9%87%8D%E8%BF%9E"><span class="toc-number">6.1.1.</span> <span class="toc-text">1.1 发送者重连</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E5%8F%91%E9%80%81%E8%80%85%E7%A1%AE%E8%AE%A4"><span class="toc-number">6.1.2.</span> <span class="toc-text">1.2 发送者确认</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">开启生产者确认</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#returncallback"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">ReturnCallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#confirmcallback"><span class="toc-number">6.1.2.3.</span> <span class="toc-text">ConfirmCallback</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-mq%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">6.2.</span> <span class="toc-text">2. MQ的可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.2.1.</span> <span class="toc-text">2.1 数据持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-lazy-queue"><span class="toc-number">6.2.2.</span> <span class="toc-text">2.2 Lazy Queue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E9%85%8D%E7%BD%AElazy%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">控制台配置Lazy模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%85%8D%E7%BD%AElazy%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">代码配置Lazy模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%B7%B2%E6%9C%89%E9%98%9F%E5%88%97%E4%B8%BAlazy%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.2.2.3.</span> <span class="toc-text">更新已有队列为Lazy模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">6.3.</span> <span class="toc-text">3. 消费者可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E6%B6%88%E8%B4%B9%E8%80%85%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">6.3.1.</span> <span class="toc-text">3.1 消费者确认机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">6.3.2.</span> <span class="toc-text">3.2 失败重试机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">6.3.3.</span> <span class="toc-text">3.3 失败处理机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-%E4%B8%9A%E5%8A%A1%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">6.3.4.</span> <span class="toc-text">3.4 业务幂等性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#341-%E5%94%AF%E4%B8%80%E6%B6%88%E6%81%AFid%E7%99%BD%E9%9B%AA"><span class="toc-number">6.3.4.1.</span> <span class="toc-text">3.4.1 唯一消息id（白雪）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#342-%E4%B8%9A%E5%8A%A1%E5%88%A4%E6%96%AD"><span class="toc-number">6.3.4.2.</span> <span class="toc-text">3.4.2 业务判断</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#35-%E5%85%9C%E5%BA%95%E6%96%B9%E6%A1%88"><span class="toc-number">6.3.5.</span> <span class="toc-text">3.5 兜底方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">6.4.</span> <span class="toc-text">4. 延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%99%BD%E9%9B%AA"><span class="toc-number">6.4.1.</span> <span class="toc-text">4.1 死信交换机（白雪）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-delayexchage%E6%8F%92%E4%BB%B6"><span class="toc-number">6.4.2.</span> <span class="toc-text">4.2 DelayExchage插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BB%B6%E8%BF%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">6.4.2.1.</span> <span class="toc-text">声明延迟交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">6.4.2.2.</span> <span class="toc-text">发送延迟消息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E8%B6%85%E6%97%B6%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95"><span class="toc-number">6.5.</span> <span class="toc-text">5.超时取消订单</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83elasticsearch-01"><span class="toc-number">7.</span> <span class="toc-text">七、Elasticsearch 01</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E5%AE%89%E8%A3%85"><span class="toc-number">7.1.</span> <span class="toc-text">1.安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E5%AE%89%E8%A3%85elasticsearch"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.1 安装elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">7.2.</span> <span class="toc-text">2. 倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E5%92%8C%E5%80%92%E6%8E%92"><span class="toc-number">7.2.1.</span> <span class="toc-text">正向和倒排</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ik-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">7.3.</span> <span class="toc-text">3. IK 分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E5%AE%89%E8%A3%85"><span class="toc-number">7.3.1.</span> <span class="toc-text">3.1 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E4%BD%BF%E7%94%A8"><span class="toc-number">7.3.2.</span> <span class="toc-text">3.2 使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E6%8B%93%E5%B1%95%E8%AF%8D%E5%85%B8"><span class="toc-number">7.3.3.</span> <span class="toc-text">3.3 拓展词典</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%A7%88"><span class="toc-number">7.4.</span> <span class="toc-text">4. 基本概览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%92%8C%E6%98%A0%E5%B0%84"><span class="toc-number">7.4.1.</span> <span class="toc-text">索引和映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql%E4%B8%8Eelasticsearch"><span class="toc-number">7.4.2.</span> <span class="toc-text">MySQL与elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%B4%A2%E5%BC%95%E5%BA%93%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">7.5.</span> <span class="toc-text">5. 索引库的操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-mapping%E6%98%A0%E5%B0%84%E5%B1%9E%E6%80%A7"><span class="toc-number">7.5.1.</span> <span class="toc-text">5.1 Mapping映射属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-%E7%B4%A2%E5%BC%95%E7%9A%84crud"><span class="toc-number">7.5.2.</span> <span class="toc-text">5.2 索引的CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93%E5%92%8C%E6%98%A0%E5%B0%84"><span class="toc-number">7.5.2.1.</span> <span class="toc-text">创建索引库和映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.5.2.2.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">7.5.2.3.</span> <span class="toc-text">修改索引库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-number">7.5.2.4.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.5.2.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">7.6.</span> <span class="toc-text">6. 文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E"><span class="toc-number">7.6.1.</span> <span class="toc-text">新增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">7.6.2.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-1"><span class="toc-number">7.6.3.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9"><span class="toc-number">7.6.4.</span> <span class="toc-text">修改</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E4%BF%AE%E6%94%B9"><span class="toc-number">7.6.4.1.</span> <span class="toc-text">局部修改</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">7.7.</span> <span class="toc-text">7. 批处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-javarestclient"><span class="toc-number">7.8.</span> <span class="toc-text">8. JavaRestClient</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#81-%E5%AF%BC%E5%85%A5%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">7.8.1.</span> <span class="toc-text">8.1 导入客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#811-%E7%BC%96%E5%86%99%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-number">7.8.1.1.</span> <span class="toc-text">8.1.1 编写简单测试类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#82-%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">7.8.2.</span> <span class="toc-text">8.2 索引库操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#83-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">7.8.3.</span> <span class="toc-text">8.3 文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E-1"><span class="toc-number">7.8.3.1.</span> <span class="toc-text">新增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2-2"><span class="toc-number">7.8.3.2.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-2"><span class="toc-number">7.8.3.3.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">7.8.3.4.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">7.8.3.5.</span> <span class="toc-text">批处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">7.8.3.6.</span> <span class="toc-text">完整代码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB-elasticsearch-02"><span class="toc-number">8.</span> <span class="toc-text">八. Elasticsearch 02</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#81-dsl%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.</span> <span class="toc-text">8.1 DSL查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%A5%E9%97%A8"><span class="toc-number">8.1.1.</span> <span class="toc-text">1. 入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%B6%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.2.</span> <span class="toc-text">2. 叶子查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#21-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.2.1.</span> <span class="toc-text">2.1 全文检索查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.2.2.</span> <span class="toc-text">2.2 精确查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#range%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.2.2.1.</span> <span class="toc-text">range范围查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.3.</span> <span class="toc-text">3. 复合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#31-bool%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.3.1.</span> <span class="toc-text">3.1 bool查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%8B%E5%A6%82"><span class="toc-number">8.1.3.1.1.</span> <span class="toc-text">例如：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8E%92%E5%BA%8F"><span class="toc-number">8.1.4.</span> <span class="toc-text">4. 排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%88%86%E9%A1%B5"><span class="toc-number">8.1.5.</span> <span class="toc-text">5. 分页</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5"><span class="toc-number">8.1.5.0.1.</span> <span class="toc-text">深度分页</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="toc-number">8.1.6.</span> <span class="toc-text">6. 高亮显示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#82-restclient-%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.</span> <span class="toc-text">8.2 RestClient 查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89"><span class="toc-number">8.2.1.</span> <span class="toc-text">1. 查询所有</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9E%84%E5%BB%BA%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.2.</span> <span class="toc-text">2. 构建条件查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">全文检索查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">精确查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.2.3.</span> <span class="toc-text">布尔查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E9%A1%B5"><span class="toc-number">8.2.3.</span> <span class="toc-text">3. 排序和分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="toc-number">8.2.4.</span> <span class="toc-text">4. 高亮显示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#83-%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-number">8.3.</span> <span class="toc-text">8.3 数据聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-dsl%E8%81%9A%E5%90%88"><span class="toc-number">8.3.1.</span> <span class="toc-text">1. DSL聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bucket%E8%81%9A%E5%90%88"><span class="toc-number">8.3.1.1.</span> <span class="toc-text">Bucket聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A6%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%81%9A%E5%90%88"><span class="toc-number">8.3.1.2.</span> <span class="toc-text">带条件的聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#metric%E8%81%9A%E5%90%88"><span class="toc-number">8.3.1.3.</span> <span class="toc-text">Metric聚合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-restclient%E8%81%9A%E5%90%88"><span class="toc-number">8.3.2.</span> <span class="toc-text">2. RestClient聚合</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E9%9D%A2%E8%AF%95%E9%83%A8%E5%88%86"><span class="toc-number">9.</span> <span class="toc-text">九、面试部分</span></a></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/11096/" title="Redis黑马版"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/12/24/676a8d8bc7d9f.png?_r_=44f6b0e5-baf0-473e-e531-b64b494f68de" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="Redis黑马版"></a><div class="content"><a class="title" href="/posts/11096/" title="Redis黑马版">Redis黑马版</a><time datetime="2025-09-08T02:34:21.000Z" title="发表于 2025-09-08 10:34:21">2025-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3860/" title="黑马学成在线"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=456351c6-24ef-054b-2585-a57c1677c6ef" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="黑马学成在线"></a><div class="content"><a class="title" href="/posts/3860/" title="黑马学成在线">黑马学成在线</a><time datetime="2025-08-04T02:34:21.000Z" title="发表于 2025-08-04 10:34:21">2025-08-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/42622/" title="SpringCloud"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=320ac6a6-3bf5-9cc8-180a-c9c4b73ea680" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="SpringCloud"></a><div class="content"><a class="title" href="/posts/42622/" title="SpringCloud">SpringCloud</a><time datetime="2025-07-13T00:34:21.000Z" title="发表于 2025-07-13 08:34:21">2025-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/49515/" title="前端学习（tlias为例）"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e151d6a.png?_r_=90fa1921-0a69-b602-3178-9ee5211c46f1" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="前端学习（tlias为例）"></a><div class="content"><a class="title" href="/posts/49515/" title="前端学习（tlias为例）">前端学习（tlias为例）</a><time datetime="2025-05-25T03:34:21.000Z" title="发表于 2025-05-25 11:34:21">2025-05-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/37847/" title="tlias 智能管理系统"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e362114.png?_r_=2740eacc-5213-f130-b94e-e88d2cdbffba" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="tlias 智能管理系统"></a><div class="content"><a class="title" href="/posts/37847/" title="tlias 智能管理系统">tlias 智能管理系统</a><time datetime="2025-04-07T03:34:21.000Z" title="发表于 2025-04-07 11:34:21">2025-04-07</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By 李阳</div><div class="footer_custom_text">下次再见！</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">5</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i> <span>隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongji1"></use></svg> <span>统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=12781955100&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>耳机分你一半</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zuji"></use></svg> <span>脚步</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-taiyang"></use></svg> <span>小太阳</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-a-xiaoyangyang_huaban1"></use></svg> <span>了解我</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/408/" style="font-size:.88rem">408<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:.88rem">C语言<sup>1</sup></a><a href="/tags/java/" style="font-size:.88rem;font-weight:500;color:var(--anzhiyu-lighttext)">java<sup>1</sup></a><a href="/tags/javaweb/" style="font-size:.88rem">javaweb<sup>8</sup></a><a href="/tags/%E5%8A%9B%E6%89%A3%E5%88%B7%E9%A2%98/" style="font-size:.88rem">力扣刷题<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:.88rem">操作系统<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size:.88rem">数据结构<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" style="font-size:.88rem">计算机组成原理<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">计算机网络<sup>2</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size:.88rem">软件工程<sup>1</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="12781955100" server="netease" type="playlist" mutex="true" preload="none" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=12781955100&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js").then((()=>{pangu.autoSpacingPage()}))}function panguInit(){GLOBAL_CONFIG_SITE.isPost&&panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask((()=>{const o=function(){HoldLog.apply(console,arguments)},n=new Date("04/01/2021 00:00:00");now1.setTime(now1.getTime()+250);const c=(now1-n)/1e3/60/60/24,e=["欢迎使用安知鱼!","生活明朗, 万物可爱","\n        \n       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗\n      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║\n      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║\n      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║\n      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝\n      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝\n        \n        ","已上线",Math.floor(c),"天","©2024 By 安知鱼 V1.6.14"],t=["NCC2-036","调用前置摄像头拍照成功，识别为【小笨蛋】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`\n%c${e[0]} %c ${e[1]} %c ${e[2]} %c${e[3]}%c ${e[4]}%c ${e[5]}\n\n%c ${e[6]}\n`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${t[0]} %c ${t[1]} %c \n${t[2]} %c\n${t[3]}\n`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，小笨蛋.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 李阳 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))}))</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" href="https://cdn.cbd.int/katex@0.16.0/dist/katex.min.css"><script src="https://cdn.cbd.int/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script>document.querySelectorAll("#article-container span.katex-display").forEach((a=>{anzhiyu.wrap(a,"div",{class:"katex-wrap"})}))</script><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach(((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,a="%%{init:{ 'theme':'"+t+"'}}%%\n"+d.textContent,i=mermaid.render(r,a);var m;"string"==typeof i?(m=i,d.insertAdjacentHTML("afterend",m)):i.then((({svg:e})=>{d.insertAdjacentHTML("afterend",e)}))}))},n=()=>{window.loadMermaid?t():getScript("https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js").then(t)};anzhiyu.addGlobalFn("themeChange",t,"mermaid"),window.pjax?n():document.addEventListener("DOMContentLoaded",n)})()</script><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.baskly.fun",region:"",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://twikoo.baskly.fun",region:"",urls:[window.location.pathname],includeReply:!1}).then((o=>{t.textContent=o[0].count})).catch((t=>{console.error(t)}))})()};t()})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener("load",(()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://twikoo.baskly.fun",region:"",pageSize:6,includeReply:!0}).then((function(t){const n=t.map((e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t}));saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)}))</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="yang@li.com"</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async src="//at.alicdn.com/t/c/font_4782341_g014uvnbwk6.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="https://lib.baomitu.com/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/imgloaded.min.js"></script><script src="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/countdown.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>