<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>SpringCloud | 李阳的秘密小屋</title><meta name="keywords" content="javaweb"><meta name="author" content="李阳"><meta name="copyright" content="李阳"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="SpringCloud"><meta name="application-name" content="SpringCloud"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud"><meta property="og:url" content="https://blog.baskly.fun/posts/42622/index.html"><meta property="og:site_name" content="李阳的秘密小屋"><meta property="og:description" content="SpringCloud"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=9e9a49a4-2f9b-83e3-4aad-021f88d04522"><meta property="article:author" content="李阳"><meta property="article:tag" content="bask,李阳"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=9e9a49a4-2f9b-83e3-4aad-021f88d04522"><meta name="description" content="SpringCloud"><link rel="shortcut icon" href="/img/flow-32x32.ico"><link rel="canonical" href="https://blog.baskly.fun/posts/42622/"><link rel="preconnect" href="//cdn.cbd.int"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"><link rel="mask-icon" href="/img/siteicon/yang180.png" color="#5bbad5"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/yang180.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/yang180.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/yang32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/yang16.png"><link rel="bookmark" href="/img/siteicon/yang180.png"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:void 0,peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"Liyang",mode:"local",switchBtn:!1,btnLink:"https://afdian.net/item/886a79d4db6711eda42a52540025c377",randomNum:3,basicWordCount:1e3,key:"xxxx",Referer:"https://xx.xx/"},diytitle:{enable:!0,leaveTitle:"不要走",backTitle:"不要离开我     -"},LA51:void 0,greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 要睡觉喽",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.baskly.fun",commentBarrageConfig:void 0,music_page_default:"nav_music",root:"/",preloader:{source:3},friends_vue_info:void 0,navMusic:!0,mainTone:{mode:"both",api:null,cover_change:!0},authorStatus:{skills:["东隅已逝 桑榆非晚","集中精神 攻克难关"]},algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!0,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!1,limitCount:50,languages:{author:"作者: 李阳",link:"链接: ",source:"来源: 李阳的秘密小屋",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:void 0,autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"李阳的秘密小屋",title:"SpringCloud",postAI:"",pageFillDescription:"一、前置课程, 1、MybatisPlus, 1.1 项目启动, 1.2 常用注解, 1.3 常见配置, 1.4 核心功能, 模糊查询, 条件更新, 条件更新, 自定义SQL, Service接口–IService, 1.5 Restful风格接口, 1.6 逻辑删除, 1.7 枚举处理器, 1.8 JSON类型处理器, 1.9 分页插件, 通用分页查询案例, 将分页条件封装在工具类中, 2.Docker, 1. 安装问题, 1. 解决配置网络时es33显示被已拔出问题, 2. 解决Docker镜像问题, 2. 安装MySQL, 3. Docker常见命令, 4. 数据卷, 4.1 什么是数据卷, 4.2 数据卷的命令, 4.3 创建Nginx 数据卷, 4.4 MySQL 容器的数据挂载, 5. 自定义镜像, 6. 网络, 7.使用Docker打包项目（tlias为例）, 7.1后端打包, 具体步骤, 7.2. 前端项目部署, 8. DockerCompose, 二、微服务01, 1. 导入后端项目, 解决时区不同步问题, 2. 单体架构与微服务, 3. 微服务拆分原则, 4. 远程调用（RPC）, 4.1 RestTemplate, 4.2 注册中心, 4.3 Nacos注册中心, 4.4 OpenFeign, 4.5 连接池, 4.6 最佳实践, 4.6 日志输出, 定义日志级别, 三、 微服务02, 1. 网关路由, 1.1 网关快速入门, 1.2 路由属性, 路由断言, 路由过滤器, 2. 网关登录, 2.1 网关过滤器, 2.2 自定义过滤器, 2.3 实现登录校验, 2.4 网关传递用户, 保存用户到请求头, 拦截器获取用户, 配置拦截器, 添加扫描, 结果, 1.3.5 OpenFeign传递用户, 3. 配置管理, 3.1 配置共享, 3.1.1 添加共享配置, 3.2 拉取nacos, 3.3 配置热更新, 3.4 动态路由, 四、 微服务03, 4.1 雪崩问题, 4.2 微服务保护, 4.2.1 服务保护方案, 4.2.2 请求限流, 4.2.3 线程隔离, 4.2.4  服务熔断, 4.3 Sentinel, 4.3.1 Sentinel安装, Window安装, Docker运行, 4.3.2 Fallback, 4.4 分布式事务, 4.4.1 Seata, 4.4.2 Seata配置, 4.4.3 微服务集成Seata, 导入依赖, 配置nacos, 改造配置, 4.4.4 XA模式（面试题）, 回滚日志, 4.4.5 AT模式, 五、MQ基础, 5.1 异步调用, 5.2 技术选型, 5.3 RabbitMQ, 5.3.1 安装, 5.3.2 Spring AMQP, 5.3.2.1 WorkQueues模型, 5.3.2.2 交换机, 5.3.2.3 Fanout 交换机, 5.3.2.4 Direct 交换机, 5.3.2.5 Topic交换机, 5.3.2.6 声明队列和交换机, 5.3.2.7 消息转换器, 5.3.2.8 订单业务, 六、 MQ高级, 1.发送者的可靠性, 1.1 发送者重连, 1.2 发送者确认, 开启生产者确认, ReturnCallback, ConfirmCallback跌跌撞撞终于来到这里我会记得这一天知不可乎骤得托遗响于悲风苏轼赤壁赋引用站外地址飞书详细文档黑马程序员一前置课程项目启动导入起步依赖自义定继承提供的接口并且指定实体类泛型常用注解约定大于配置用来指定表名用来指定表中主键字段信息用来指定表中的普通字段信息使用注解的常见场景成员变量名与数据库字段名不一致成员变量名以开头且是布尔值成员变量名与数据库关键字冲突成员变量不是数据库字段常见配置别名扫描包文件地址默认值是否开启下划线和驼峰的映射是否开启二级缓存为雪花算法生成更新策略只更新非空字段核心功能模糊查询查询名字中带的等构建查询条件查询条件更新更新用户名为的的余额为元要更新的数据更新的条件执行更新条件更新更新为的用户余额扣自定义我们可以利用的来构建复杂的条件然后自己定义语句中剩下的部分基于构建条件在方法参数中用注解声明变量名称必须是自定义并且使用条件接口自定义去继承要指定实体泛型自定义去继承要指定泛型和实体泛型风格接口后端传给前端要定义前端传给后端定义这里有一个我之前没有注意的点要转为可以使用工具包进行拷贝原始实体目标实体逻辑删除枚举处理器在枚举类的值上添加注解配置全局枚举处理器类型处理器首先定义一个单独的实体然后将类的字段修改为类型并声明类型处理器在类上开启自动映射这里设置是因为对于这种类中再嵌套一个自定义类的是需要手动在中定义相关字段等或者像这样开启自动映射分页插件在未引入分页插件的情况下是不支持分页功能的和中的分页方法都无法正常起效所以我们必须配置分页插件新建初始化核心插件添加分页插件编写分页查询的测试分页查询的两个参数分别是页码每页大小总条数总页数数据也可以支持排序根据排序是降序分页参数排序参数通过来指定通用分页查询案例定义一个统一的分页查询条件的实体包含分页排序参数过滤条件分页查询实体页码页码排序字段是否升序然后让我们需要分页的实体去继承分页实体根据子类自身的字段值和从父类继承的字段值来生成当两个子类对象比较时只有子类对象的本身的字段值和继承父类的字段值都相同方法的返回值是用于自动生成和方法并且在比较时调用父类的和方法用户查询条件实体用户名关键字用户状态正常冻结余额最小值余额最大值新建统一返回结果集分页结果总条数总页数集合分页查询代码示例构建条件分页条件排序条件默认按照更新时间排序查询数据非空校验无数据返回空结果有数据转换封装返回将分页条件封装在工具类中页码页码排序字段是否升序分页条件排序条件先看前端有没有传排序字段再看有没有手动指定排序字段返回空分页结果的分页结果目标类型原始类型的分页对象将分页结果转为分页结果的分页结果目标类型的字节码目标类型原始类型的分页对象非空校验无数据返回空结果数据转换封装返回将分页结果转为分页结果允许用户自定义到的转换方式的分页结果到的转换函数目标类型原始类型的分页对象非空校验无数据返回空结果数据转换封装返回业务层代码可简化为构建条件查询封装返回拷贝属性到用户名脱敏安装问题解决配置网络时显示被已拔出问题在电脑服务中开启和即可解决镜像问题操她奶奶的你妹的傻鸟用老师安装的方式一直不成功最终在评论区找到答案无法安装建议直接这条命令一次性全安装完毕安装常见命令命令说明文档地址查看本地镜像删除本地镜像创建并运行容器不能重复创建停止指定容器启动指定容器重新启动容器删除指定容器查看容器查看容器运行日志进入容器保存镜像到本地压缩文件加载本地压缩文件到镜像查看容器详细信息如何把镜像交给运维人员使用形成本地压缩包运维人员再使用将本地这个压缩包进行解压将镜像推送到镜像仓库运维人员再从镜像仓库进行拉取数据卷容器是隔离环境容器内程序的文件配置运行时产生的容器都在容器内部我们要读写容器内的文件非常不方便大家思考几个问题如果要升级版本需要销毁旧容器那么数据岂不是跟着被销毁了容器运行后如果我要修改其中的某些配置该怎么办我想要让代理我的静态资源怎么办因此容器提供程序的运行环境但是程序运行产生的数据程序运行依赖的配置都应该与容器解耦什么是数据卷数据卷是一个虚拟目录是容器内目录与宿主机目录之间映射的桥梁其实类似于双向绑定修改数据卷里面的内容实际的的内容也会修改以为例我们知道中有两个关键的目录放置一些静态资源放置配置文件如果我们要让代理我们的静态资源最好是放到目录如果我们要修改的配置最好是找到下的文件但遗憾的是容器运行的所有的文件都在容器内部所以我们必须利用数据卷将两个目录与宿主机目录关联方便我们操作如图在上图中我们创建了两个数据卷容器内部的目录和目录分别与两个数据卷关联而数据卷和分别指向了宿主机的目录和目录这样以来容器内的和目录就与宿主机的和目录关联起来我们称为挂载此时我们操作宿主机的就是在操作容器内的目录只要我们将静态资源放入宿主机对应目录就可以被代理了数据卷的命令命令说明文档地址创建数据卷查看所有数据卷删除指定数据卷查看某个数据卷的详情清除数据卷注意容器与数据卷的挂载要在创建容器时配置对于创建好的容器是不能设置数据卷的而且创建容器的过程中数据卷会自动创建如何挂载数据卷在创建容器时利用数据卷名容器内目录完成挂载容器创建时如果发现挂载的数据卷不存在时会自动创建创建数据卷哇神奇这是的默认存储位置所有命名卷都会存放在卷名下对应的宿主机目录是虚拟目录容器内的对应目录容器的数据挂载发现有默认的数据挂载但是默认匿名挂载名字复杂目录太深了下面给他修改到挂载到根目录注意文件必须要有创建数据库的命令不然无法创建成功数据库然后将文件放在文件夹里面运行即可自定义镜像镜像就是包含了应用程序程序运行的系统函数库运行配置等文件的文件包构建镜像的过程其实就是把上述文件打包的过程由于制作镜像的过程中需要逐层处理和打包比较复杂所以就提供了自动打包镜像的功能我们只需要将打包的过程每一层要做的事情用固定的语法写下来交给去执行即可而这种记录镜像结构的文件就称为指令说明示例指定基础镜像设置环境变量可在后面指令使用拷贝本地文件到镜像的指定目录执行的命令一般是安装过程的命令指定容器运行时监听的端口是给镜像使用者看的镜像中应用的启动命令容器运行时调用网络容器的网络其实是一个虚拟的其值并不固定与某一个容器绑定如果我们在开发时写死某个而在部署时很可能容器的会发生变化连接会失败所以我们必须借助于的网络功能来解决这个问题常见命令命令说明文档地址创建一个网络查看所有网络删除指定网络清除未使用的网络使指定容器连接加入某网络使指定容器连接离开某网络查看网络详细信息使用打包项目为例老东西终于把焚决交出来了后端打包准备容器并且创建数据库以及表结构上面在本地目录挂载时已经完成准备应用镜像部署容器运行测试修改项目的配置文件修改数据库服务地址及日志文件存放地址打包编写文件构建镜像部署容器具体步骤打开将中数据库连接部分改为中的在中的中的中点击等待成功然后我们的文件夹中会出现我们的包了包名字很长可以适当重命名新建使用作为基础镜像添加到镜像中设置环境变量配置阿里云你的你的统一编码创建应用目录复制应用文件到容器暴露端口运行命令在下新建文件夹里面上传进去我们的然后去构建镜像取名字为版本在当前文件夹里部署容器使用查看后端启动日志这样我们的项目就启动成功了使用发送请求也能正常输出结果前端项目部署创建一个新的容器将资料中提供的前端项目的静态资源部署到中在文件夹下创建一个新文件夹用于映射名字叫然后配置挂载然后访问未开启需要开启一下服务安装若未安装同步阿里云时间服务器北京时间解决因为时间和系统系统不符导致的时区不同步问题老东西把异火也交出来了通过一个单独的模板文件格式来定义一组相关联的应用容器帮助我们实现多个相互关联的容器的快速部署现在我们使用来重新构建项目准备资源服务端的包前端项目打包文件准备配置文件基于快速构建项目根据定义的路径在文件夹下新建空文件夹然后将以下文件存放在文件夹中其中和都是可选参数比较常见的有类型参数或指令说明指定文件的路径和名称指定名称就是当前文件中设置的多个的集合是逻辑概念创建并启动所有容器停止并移除所有容器网络列出所有启动的容器查看指定容器的日志停止容器启动容器重启容器查看运行的进程在指定的运行中容器中执行命令创建容器开始停止容器心心念念的终于结束了二微服务导入后端项目导入后端项目启动项目时报了错误看弹幕说时因为版本与高版本冲突导致的反射问题配置即可解决解决时区不同步问题年月日星期一年月日星期一时分秒秒一月月月月月月月月月月年月日星期二单体架构与微服务单体架构将业务的所有功能集中在一个项目中开发打成一个包部署优点架构简单部署成本低缺点团队协作成本高系统发布效率低系统可用性差微服务架构是服务化思想指导下的一套最佳实践架构方案服务化就是把单体架构中的功能模块拆分为多个独立项目微服务拆分原则什么时候需要拆分微服务如果是创业型公司最好先用单体架构快速迭代开发验证市场运作模型快速试错当业务跑通以后随着业务规模扩大人员规模增加再考虑拆分微服务如果是大型企业有充足的资源可以在项目开始之初就搭建微服务架构如何拆分首先要做到高内聚低耦合从拆分方式来说有横向拆分和纵向拆分两种纵向就是按照业务功能模块横向则是拆分通用性业务提高复用性服务拆分之后不可避免的会出现跨微服务的业务此时微服务之间就需要进行远程调用微服务之间的远程调用被称为即远程过程调用的实现方式有很多比如基于协议基于协议我们使用的是方式这种方式不关心服务提供者的具体技术实现只要对外暴露接口即可更符合微服务的需要远程调用在拆分的时候我们发现一个问题就是购物车业务中需要查询商品信息但商品信息查询的逻辑全部迁移到了服务导致我们无法查询最终结果就是查询到的购物车数据不完整因此要想解决这个问题我们就必须改造其中的代码把原本本地方法调用改造成跨微服务的远程调用即因此现在查询购物车列表的流程变成了这样那么问题来了我们该如何跨服务调用准确的说如何在中获取服务中的提供的商品数据呢答案是肯定的我们前端向服务端查询数据其实就是从浏览器远程查询服务端数据比如我们刚才通过测试商品查询接口就是向这个接口发起的请求而这种查询就是通过请求的方式来完成的不仅仅可以实现远程查询还可以实现新增删除等各种远程请求那么我们该如何用代码发送的请求呢发送请求可以使用提供的使用的基本步骤如下注册到容器调用的发送请求常见方法有发送请求并返回指定类型对象发送请求并返回指定类型对象发送请求发送请求发送任意类型请求返回感觉这种如果有大量用户同时请求不会变的很卡吗构造器注入构造器注入推荐我们使用构造器注入而不是使用因此我们可以在类上添加注解使用注入类注册中心在微服务远程调用的过程中包括两个角色服务提供者提供接口供其它微服务访问比如服务消费者调用其它微服务提供的接口比如服务者可以是消费者消费者也可以是服务者在大型微服务项目中服务提供者的数量会非常多为了管理这些服务就引入了注册中心的概念注册中心服务提供者服务消费者三者间关系如下流程如下服务启动时就会注册自己的服务信息服务名端口到注册中心调用者可以从注册中心订阅想要的服务获取服务对应的实例列表个服务可能多实例部署调用者自己对实例列表负载均衡挑选一个实例调用者向该实例发起远程调用当服务提供者的实例宕机或者启动新实例时调用者如何得知呢服务提供者会定期向注册中心发送请求报告自己的健康状态心跳请求当注册中心长时间收不到提供者的心跳时会认为该实例宕机将其从服务的实例列表中剔除注册中心一旦认为某个实例宕机并将其剔除实例列表那么其他服务的调用者就无法再调用这个实例当服务有新实例启动时会发送注册服务请求其信息会被记录在注册中心的服务实例列表当注册中心服务列表变更时会主动通知微服务更新本地服务列表注册中心访问路径哇神奇将来可以根据服务名称去注册中心中去拉取实例列表会使用负载均衡自动获取一个实例我们在中引入了负载均衡的依赖了然后定义请求路径为连接池连接池指的是一组预先创建的连接这些连接可以被重复使用而不是每次请求都创建一个新的连接在中不同的客户端实现对连接池的支持有所不同这是的默认客户端实现不支持连接池每次请求都会创建一个新的连接请求完成后连接会被关闭这种方式在高并发场景下性能较差这是一个功能强大的客户端库支持连接池通过配置连接池可以复用连接提高性能这是另一个流行的客户端库也支持连接池的连接池实现高效且易于配置适合在高并发场景下使用对请求做了优雅的伪装不过其底层发起请求依赖于其它的框架这些框架可以自己选择包括以下三种默认实现不支持连接池支持连接池支持连接池具体源码可以参考类中的成员变量因此我们通常会使用带有连接池的客户端来代替默认的比如我们使用在的中引入依赖的依赖在的配置文件中开启的连接池功能开启功能最佳实践方案抽取更加简单工程结构也比较清晰但缺点是整个项目耦合度偏高方案抽取相对麻烦工程结构相对更复杂但服务之间耦合度降低这个注解中包含了这个注解会扫描当前包中的文件而由于被抽离到模块包下两者包的位置不同所以扫描不到那么解决方法有扩大扫描包的范围那么在启动类上添加但此方法不推荐使用注解就包含了注解由第三方依赖提供的注解选项可以简化我们的操作不需要自己使用日志输出只会在所在包的日志级别为时才会输出日志而且其日志级别有级不记录任何日志信息这是默认值仅记录请求的方法以及响应状态码和执行时间在的基础上额外记录了请求和响应的头信息记录所有请求和响应的明细包括头信息请求体元数据默认的日志级别就是所以默认我们看不到请求日志一般也不开启的日志配置只有在需要调试的时候才开启日志因为日志输出的内容有很多输出时会影响性能定义日志级别在模块下新建一个配置类定义的日志级别接下来要让日志级别生效还需要配置这个类有两种方式局部生效在某个中配置只对当前生效全局生效在中配置针对所有生效三微服务由于每个微服务都有不同的地址或端口入口不同相信大家在与前端联调的时候发现了一些问题请求不同数据时要访问不同的入口需要维护多个入口地址麻烦前端无法调用无法实时更新服务列表单体架构时我们只需要完成一次用户登录身份校验就可以在所有业务中获取到用户信息而微服务拆分后每个微服务都独立部署这就存在一些问题每个微服务都需要编写登录校验用户信息获取的功能吗当微服务之间调用时该如何传递用户信息不要着急这些问题都可以在今天的学习中找到答案我们会通过网关技术解决上述问题今天的内容会分为章第一章网关路由解决前端请求入口的问题第二章网关鉴权解决统一登录校验和用户信息获取的问题第三章统一配置管理解决微服务的配置文件重复和配置热更新问题通过今天的学习你将掌握下列能力会利用微服务网关做请求路由会利用微服务网关做登录身份校验会利用实现统一配置管理会利用实现配置热更新网关路由网关就是网络的关口数据在网络间传输从一个网络传输到另一网络时就需要经过网关来做数据的路由和转发以及数据安全的校验更通俗的来讲网关就像是以前园区传达室的大爷外面的人要想进入园区必须经过大爷的认可如果你是不怀好意的人肯定被直接拦截外面的人要传话或送信要找大爷大爷帮你带给目标人现在微服务网关就起到同样的作用前端请求不能直接访问微服务而是要请求网关网关可以做安全控制也就是登录身份校验校验通过才放行通过认证后网关再根据请求判断应该访问哪个微服务将请求转发过去路由网关的基本构件它由一个一个目的地一个断言集合和一个过滤器集合定义如果断言为真则路由被匹配网关也相当于一个微服务其会注册到并拉取所有的服务信息所以要获取某个微服务对网关来说不是难事迷迷糊糊说这么多还是不知道网关是什么前端发送的请求先发给网关网关进行校验完毕之后使用负载均衡请求到具体的微服务中前端只要知道网关地址即可前端所有请求地址都为那么就会到达网关然后网关会根据前端的请求来去判断应该由哪个微服务来处理判断过程就是请求的路由然后网关就会帮你的请求转发到具体的微服务路由转发网关可以利用注册中心所有的微服务接口都存放在了注册中心拉取所有的服务中心网关来负责身份校验这样转发就不用在此校验了网关快速入门网关也相当于一个微服务其会注册到并拉取所有的服务信息所以要获取某个微服务对网关来说不是难事接下来在模块的目录新建一个文件内容如下路由规则自定义唯一路由的目标服务代表负载均衡会从注册中心拉取服务列表路由断言判断当前请求是否符合当前规则符合则路由到目标服务这里是以请求路径作为判断规则路由属性网关路由对应的类型是其中常见的属性有路由唯一标示路由目标地址路由断言判断请求是否符合当前路由路由过滤器对请求或响应做特殊处理路由断言名称说明示例是某个时间点后的请求是某个时间点之前的请求是某两个时间点之前的请求请求必须包含某些请求必须包含某些请求必须是访问某个域名请求方式必须是指定方式请求路径必须符合指定规则请求参数必须包含指定参数或者请求者的必须是指定范围权重处理路由过滤器名称说明示例给当前请求添加一个请求头移除请求中的一个请求头给响应结果中添加一个响应头从响应结果中移除有一个响应头请求路径重写去除请求路径中的段前缀则路径转发时只保留网关登录单体架构时我们只需要完成一次用户登录身份校验就可以在所有业务中获取到用户信息而微服务拆分后每个微服务都独立部署不再共享数据也就意味着每个微服务都需要做登录校验这显然不可取我们的登录是基于来实现的校验的算法复杂而且需要用到秘钥如果每个微服务都去做登录校验这就存在着两大问题每个微服务都需要知道的秘钥不安全每个微服务重复编写登录校验代码权限校验代码麻烦既然网关是所有微服务的入口一切请求都需要先经过网关我们完全可以把登录校验的工作放到网关去做这样之前说的问题就解决了只需要在网关和用户服务保存秘钥只需要在网关开发登录校验功能此时登录校验的流程如图不过这里存在几个问题网关路由是配置的请求转发是内部代码我们如何在转发之前做登录校验网关校验之后如何将用户信息传递给微服务微服务之间也会相互调用这种调用不经过网关又该如何传递用户信息网关过滤器登录校验必须在请求转发到微服务之前做否则就失去了意义而网关的请求转发是内部代码实现的要想在请求转发之前做登录校验就必须了解内部工作的基本原理网关内部是没有业务逻辑的他的任务是基于我们配的路由规则然后判断一下前端请求到底该由哪个微服务处理然后将请求转发到对应的微服务而进行路由判断的功能就是由一个叫的接口来处理的的默认实现是路由断言根据请求找到匹配的路由并存入上下文然后把请求交给处理默认实现是顾名思义是一个过滤器处理器它会加载网关中配置的多个过滤器放入集合并排序形成过滤器链然后依次执行这些过滤器而整个过滤链的最后要执行负责将请求转发到微服务当微服务返回结果后存入上下文接着依次传递给其他过滤器最终返回给用户过滤器内部可以包含两部分逻辑分别是和分别会在请求路由到微服务之前和之后执行当所有的逻辑都依次顺序执行通过后请求才会被路由到微服务否则会被拦截后续过滤器不再执行微服务返回结果后再倒序执行的逻辑如果我们能够定义一个过滤器在其中实现登录校验逻辑并且将过滤器执行顺序定义到之前这就符合我们的需求了可以将用户信息保存在请求头中然后传递给微服务然后微服务在从请求头中取出用户信息自定义过滤器网关过滤器链中的过滤器有两种路由过滤器作用范围比较灵活可以是任意指定的路由配置的过滤器有种默认不生效配置到哪一个路由下之后就对配置的路由生效配置到之后就会对所有路由生效这样就不必在所有的路由中配置类但是所属类别依旧是全局过滤器作用范围是所有路由不可配置实现登录校验获取判断是否不需要拦截无需拦截直接放行获取请求头中的校验并解析如果无效拦截如果有效传递用户信息放行对于虽然它是框架的一部分但它并不是由管理的是一个工具类用于匹配风格的路径模式它没有定义为的因此容器不知道如何自动注入它为什么需要手动创建实例工具类是一个工具类通常不需要管理其生命周期工具类是无状态的可以在任何地方实例化和使用非单例由于是无状态的它不需要作为单例管理每次使用时创建一个新的实例是安全的不会导致资源浪费或状态不一致的问题简单性手动创建实例非常简单只需要使用关键字即可这种方式代码清晰易于理解网关传递用户现在网关已经可以完成登录校验并获取登录用户身份信息但是当网关将请求转发到微服务时微服务又该如何获取用户身份呢由于网关发送请求到微服务依然采用的是请求因此我们可以将用户信息以请求头的方式传递到下游微服务然后微服务可以从请求头中获取登录用户信息考虑到微服务内部可能很多地方都需要用到登录用户信息因此我们可以利用的拦截器来实现登录用户信息获取并存入方便后续使用据图流程图如下因此接下来我们要做的事情有改造网关过滤器在获取用户信息后保存到请求头转发到下游微服务编写微服务拦截器拦截请求获取用户信息保存到后放行保存用户到请求头首先我们修改登录校验拦截器的处理逻辑保存用户信息到请求头中修改如果有效传递用户信息方法可以对下游请求做更改表示对请求做处理利用可以对请求中各种信息做修改放行拦截器先通过解析出再将其放入请求头后续的可以直接从请求头中获取无需再次解析提高效率拦截器获取用户需求由于每个微服务都可能有获取登录用户的需求因此我们直接在模块定义拦截器这样微服务只需要引入依赖即可生效无需重复编写获取请求头中的用户信息判断是否为空不为空保存到放行移除用户这里只是写了一个拦截器类但是并没有注册到拦截器里要想注册进去需要进行配置编写配置类将其进去当请求从驱动进入下游微服务时不会被直接传递而是自动被底层协议转换为标准的和通过线程池复用线程并且不是每次使用都会覆盖信息所以有必要在一次请求完成后清理信息拦截器生命周期等如有特殊情况处理如果请求在返回拦截请求不会执行但仍会触发行为配置拦截器拦截器需要配置进行配置才能生效通过将一个名为的拦截器添加到拦截器注册表中这样自定义的拦截器才会生效添加的原因因为中也引用了模块而我们知道使用的虽然也处理请求但是底层不是靠实现的而现在设计了只要引用这个包就会自动装配配置类然而底层没有自然无法自动装配配置类会报错所以我们需要设计成只有依赖了的微服务模块才自动装配而的核心类就是所以只有有这个类的微服务模块才会自动装配配置类是中的一个条件注解它用于在特定类存在于类路径上时才启用配置因此特定的类就是只要再中加入就会存在类是的核心组件之一通常用于处理请求如果存在说明当前项目中使用了会加载配置类除了外底层都是那要想不让网关得到这个配置那就要利用的特点去排除它都有一个的当我们配置了扫描时其他的微服务就会使用这个拦截器配置的内容但是网关也使用了这个配置类网关没有的内容因此会报错添加扫描不过需要注意的是这个配置类默认是不会生效的因为它所在的包是与其它微服务的扫描包不一致无法被扫描到因此无法生效基于的自动装配原理我们要将其添加到目录下的文件中依赖虽然被引入但默认扫描启动类所在的包及其子包这里没在对应的扫描范围内所有没有注册可以添加包范围在对应模块通过文件将对应配置类的全限定名写进去利用自动配置原理其他微服务引入对应模块依赖在启动后会进行注册同样也还可以用导入对应的组件或配置类可以基于的自动装配机制自动发现并装配配置类简单来说就是所有微服务都无法扫描到这个拦截器我们可以给每一个微服务的启动类加上指定扫描这个拦截器但是微服务数量庞大显然不是个好办法利用的自动装配原理就简单的多结果这样我们请求单个购物车就查询不到用户信息了传递用户请求从网关到交易时会被拦截将存入当这个请求执行完之后会清除故当交易发请求到商品时是没有的前端发起的请求都会经过网关再到微服务由于我们之前编写的过滤器和拦截器功能微服务可以轻松获取登录用户信息但有些业务是比较复杂的请求到达微服务后还需要调用其它多个微服务比如下单业务流程如下下单的过程中需要调用商品服务扣减库存调用购物车服务清理用户购物车而清理购物车时必须知道当前登录的用户身份但是订单服务调用购物车时并没有传递用户信息购物车服务无法知道当前用户是谁由于微服务获取用户信息是通过拦截器在请求头中读取因此要想实现微服务之间的用户信息传递就必须在微服务发起调用时把用户信息存入请求头仅限单线程内用于存储线程级别的上下文如用户身份事务其生命周期与线程绑定无法跨进程或跨服务传递微服务间通信本质是跨进程的分布式调用服务可能部署在不同物理节点无法穿透网络边界无法在服务的线程中直接访问服务的线程数据服务调用即跨进程的服务调用而只仅限于当前服务内部的范围所以无法使用但网关那里刚开始不是已经通过过滤器进行了存入请求头中吗为什么后续微服务调用服务时需要再次将存入请求头才能传递用户信息呢那是因为协议无状态每个请求默认不携带上一个请求的上下文直接理解成每次发送的都是一个新的请求所以需要我们自己给该请求做标识最后记住拦截器组合是实现微服务间身份透传的标准模式拦截器是属于微服务的过滤器是属于网关的拦截器从请求头获取并保存在中过滤器解析并保存在请求头中微服务之间调用是基于来实现的并不是我们自己发送的请求我们如何才能让每一个由发起的请求自动携带登录用户信息呢这里要借助中提供的一个拦截器接口不放在中因为不是所有模块都需要例如网关微服务就不需要其实就是拦截下来的转发请求然后再请求头中添加上字段后放行将用户信息添加请求头微服务调用微服务的请求是从网关传过来的所以这时请求头中是有用户信息的只需要从请求头中获取到用户信息添加到请求头中即可如何请求再次传递给下一个微服务这样就将用户信息传递给了其他微服务了配置管理到目前为止我们已经解决了微服务相关的几个问题微服务远程调用微服务注册发现微服务请求路由负载均衡微服务登录用户信息传递不过现在依然还有几个问题需要解决网关路由在配置文件中写死了如果变更必须重启微服务某些业务配置在配置文件中写死了每次修改都要重启服务每个微服务都有很多重复的配置维护成本高这些问题都可以通过统一的配置管理器服务解决而不仅仅具备注册中心功能也具备配置管理的功能微服务共享的配置可以统一交给保存和管理在控制台修改配置后会将配置变更推送给相关的微服务并且无需重启即可生效实现配置热更新网关的路由同样是配置因此同样可以基于这个功能实现动态路由功能无需重启网关即可修改路由配置配置共享我们可以把微服务共享的配置抽取到中统一管理这样就不需要每个微服务都重复配置了分为两步在中添加共享配置微服务拉取配置添加共享配置以为例我们看看有哪些配置是重复的可以抽取的首先是相关配置然后是日志配置然后是以及的配置我们在控制台分别添加这些配置首先是相关配置在配置管理配置列表中点击新建一个配置在弹出的表单中填写信息其中详细的配置如下注意这里的的相关参数并没有写死例如数据库通过配置了默认值为同时允许通过来覆盖默认值数据库端口通过配置了默认值为同时允许通过来覆盖默认值数据库可以通过来设定无默认值然后是统一的日志配置命名为配置内容如下然后是统一的配置命名为配置内容如下黑马商城接口文档黑马商城接口文档虎哥注意这里的相关配置我们没有写死例如接口文档标题我们用了来代替将来可以有用户手动指定联系人邮箱我们用了默认值是同时允许用户利用来覆盖拉取接下来我们要在微服务拉取共享配置将拉取到的共享配置与本地的配置合并完成项目上下文的初始化不过需要注意的是读取配置是上下文初始化时处理的发生在项目的引导阶段然后才会初始化上下文去读取也就是说引导阶段文件尚未读取根本不知道地址该如何去加载中的配置文件呢在初始化上下文的时候会先读取一个名为或者的文件如果我们将地址配置到中那么在项目引导阶段就可以读取中的配置了因此微服务整合配置管理的步骤如下引入依赖在模块引入依赖配置管理读取文件新建在中的目录新建一个文件内容如下服务名称地址文件后缀名共享配置共享配置共享日志配置共享日志配置修改由于一些配置挪到了因此需要修改为开启连接池支持购物车服务接口文档重启服务发现所有配置都生效了配置热更新有很多的业务相关参数将来可能会根据实际情况临时调整例如购物车业务购物车数量有一个上限默认是对应代码如下现在这里购物车是写死的固定值我们应该将其配置在配置文件中方便后期修改但现在的问题是即便写在配置文件中修改了配置还是需要重新打包重启服务才能生效能不能不用重启直接生效呢这就要用到的配置热更新能力了分为两步在中添加配置在微服务读取配置文件名称由三部分组成服务名我们是购物车服务所以是就是中的可以省略则所有共享该配置后缀名例如这里我们直接使用这个名称则不管是还是环境都可以共享该配置配置内容如下购物车商品数量上限接着我们在微服务中读取配置实现配置热更新在中新建一个属性读取类代码如下接着在业务中使用该属性加载类测试向购物车中添加多个商品我们在控制台将购物车上限配置为无需重启再次测试购物车功能加入成功无需重启服务配置热更新就生效了动态路由网关的路由配置全部是在项目启动时由在项目启动的时候加载并且一经加载就会缓存到内存中的路由表内一个不会改变也不会监听路由变更所以我们无法利用上节课学习的配置热更新来实现路由更新因此我们必须监听的配置变更然后手动把最新的路由更新到路由表中这里有两个难点如何监听配置变更如何把路由信息更新到路由表四微服务在微服务远程调用的过程中还存在几个问题需要解决首先是业务健壮性问题例如在之前的查询购物车列表业务中购物车服务需要查询最新的商品信息与购物车数据做对比提醒用户大家设想一下如果商品服务查询时发生故障查询购物车列表在调用商品服务时是不是也会异常从而导致购物车查询失败但从业务角度来说为了提升用户体验即便是商品查询失败购物车列表也应该正确展示出来哪怕是不包含最新的商品信息还有级联失败问题还是查询购物车的业务假如商品服务业务并发较高占用过多连接可能会导致商品服务的所有接口响应时间增加延迟变高甚至是长时间阻塞直至查询失败此时查询购物车业务需要查询并等待商品查询结果从而导致查询购物车列表业务的响应时间也变长甚至也阻塞直至无法访问而此时如果查询购物车的请求较多可能导致购物车服务的连接占用较多所有接口的响应时间都会增加整个服务性能很差甚至不可用依次类推整个微服务群中与购物车服务商品服务等有调用关系的服务可能都会出现问题最终导致整个集群不可用这就是级联失败问题或者叫雪崩问题级联失败是指一个系统中的局部故障引发连锁反应导致其他部分相继失效最终造成更大范围甚至整个系统崩溃的现象还有跨服务的事务问题比如昨天讲到过的下单业务下单的过程中需要调用多个微服务商品服务扣减库存订单服务保存订单购物车服务清理购物车这些业务全部都是数据库的写操作我们必须确保所有操作的同时成功或失败但是这些操作在不同微服务也就是不同的这样的情况如何确保事务特性呢雪崩问题雪崩问题产生的原因微服务相互调用服务提供者出现故障或阻塞服务调用者没有做好异常处理导致自身故障调用链中的所有服务级联失败导致整个集群故障如何避免雪崩尽量避免服务出现故障或阻塞保证代码的健壮性保证网络畅通能应对较高的并发请求服务调用者做好远程调用异常的后备方案避免故障扩散微服务保护服务保护方案微服务保护的方案有很多比如请求限流线程隔离服务熔断这些方案或多或少都会导致服务的体验上略有下降比如请求限流降低了并发上限线程隔离降低了可用资源数量服务熔断降低了服务的完整度部分服务变的不可用或弱可用因此这些方案都属于服务降级的方案但通过这些方案服务的健壮性得到了提升请求限流服务故障最重要原因就是并发太高解决了这个问题就能避免大部分故障当然接口的并发不是一直很高而是突发的因此请求限流就是限制或控制接口访问的并发流量避免服务因流量激增而出现故障请求限流往往会有一个限流器数量高低起伏的并发请求曲线经过限流器就变的非常平稳这就像是水电站的大坝起到蓄水的作用可以通过开关控制水流出的大小让下游水流始终维持在一个平稳的量线程隔离当一个业务接口响应时间长而且并发高时就可能耗尽服务器的线程资源导致服务内的其它接口受到影响所以我们必须把这种影响降低或者缩减影响的范围线程隔离正是解决这个问题的好办法线程隔离的思想来自轮船的舱壁模式轮船的船舱会被隔板分割为个相互隔离的密闭舱假如轮船触礁进水只有损坏的部分密闭舱会进水而其他舱由于相互隔离并不会进水这样就把进水控制在部分船体避免了整个船舱进水而沉没为了避免某个接口故障或压力过大导致整个服务不可用我们可以限定每个接口可以使用的资源范围也就是将其隔离起来如图所示我们给查询购物车业务限定可用线程数量上限为这样即便查询购物车的请求因为查询商品服务而出现故障也不会导致服务器的线程资源被耗尽不会影响到其它接口服务熔断线程隔离虽然避免了雪崩问题但故障服务商品服务依然会拖慢购物车服务服务调用方的接口响应速度而且商品查询的故障依然会导致查询购物车功能出现故障购物车业务也变的不可用了所以我们要做两件事情编写服务降级逻辑就是服务调用失败后的处理逻辑根据业务场景可以抛出异常也可以返回友好提示或默认数据异常统计和熔断统计服务提供方的异常比例当比例过高表明该接口会影响到其它服务应该拒绝调用该接口而是直接走降级逻辑这里服务提供方就是商品服务异常比例过高意思就是说如果过往记录中发现调用商品服务有次失败而熔断决策这里是当失败率超过阈值如购物车服务调用方的熔断器会拒绝后续请求不再真正调用商品服务避免资源浪费直接走降级逻辑返回缓存数据默认值或友好提示熔断恢复经过一段时间如秒熔断器尝试放行一个请求探测商品服务是否恢复若成功则逐步关闭熔断引用站外地址包下载微服务保护的技术有很多但在目前国内使用较多的还是所以接下来我们学习的使用是阿里巴巴开源的一款服务保护框架目前已经加入中的使用可以分为两个部分核心库包不依赖任何框架库能够运行于及以上的版本的运行时环境同时对等框架也有较好的支持在项目中引入依赖即可实现服务限流隔离熔断等功能控制台主要负责管理推送规则监控管理机器信息等安装安装下载包运行访问页面就可以看到的控制台了需要输入账号和密码默认都是登录后即可看到控制台默认会监控服务本身运行然后运行触发限流或熔断后的请求不一定要直接报错也可以返回一些默认数据或者友好提示用户体验会更好给编写失败后的降级逻辑有两种方式方式一无法对远程调用的异常做处理方式二可以对远程调用的异常做处理我们一般选择这种方式分布式事务首先我们看看项目中的下单业务整体流程由于订单购物车商品分别在三个不同的微服务而每个微服务都有自己独立的数据库因此下单过程中就会跨多个数据库完成业务而每个微服务都会执行自己的本地事务交易服务下单事务购物车服务清理购物车事务库存服务扣减库存事务整个业务中各个本地事务是有关联的因此每个微服务的本地事务也可以称为分支事务多个有关联的分支事务一起就组成了全局事务我们必须保证整个全局事务同时成功或失败我们知道每一个分支事务就是传统的单体事务都可以满足特性但全局事务跨越多个服务多个数据库是否还能满足呢我们来做一个测试先进入购物车页面目前有个购物车然结算下单进入订单结算页面然后将购物车中某个商品的库存修改为然后提交订单最终因库存不足导致下单失败然后我们去查看购物车列表发现购物车数据依然被清空了并未回滚事务并未遵循的原则归其原因就是参与事务的多个子业务在不同的微服务跨越了不同的数据库虽然每个单独的业务都能在本地遵循但是它们互相之间没有感知不知道有人失败了无法保证最终结果的统一也就无法遵循的事务特性了这就是分布式事务问题出现以下情况之一就可能产生分布式事务问题业务跨多个服务实现业务跨多个数据源实现接下来这一章我们就一起来研究下如何解决分布式事务问题解决分布式事务的方案有很多但实现起来都比较复杂因此我们一般会使用开源的框架来解决分布式事务问题在众多的开源分布式事务框架中功能最完善使用最多的就是阿里巴巴在年开源的了引用站外地址官方文档其实分布式事务产生的一个重要原因就是参与事务的多个分支事务互相无感知不知道彼此的执行状态因此解决分布式事务的思想非常简单就是找一个统一的事务协调者与多个分支事务通信检测每个分支事务的执行状态保证全局事务下的每一个分支事务同时成功或失败即可大多数的分布式事务框架都是基于这个理论来实现的也不例外在的事务管理中有三个重要的角色事务协调者维护全局和分支事务的状态协调全局事务提交或回滚事务管理器定义全局事务的范围开始全局事务提交或回滚全局事务资源管理器管理分支事务与交谈以注册分支事务和报告分支事务的状态并驱动分支事务提交或回滚的工作架构如图所示其中和可以理解为的客户端部分引入到参与事务的微服务依赖中即可将来和就会协助微服务实现本地分支事务与之间交互实现事务的提交或回滚而服务则是事务协调中心是一个独立的微服务需要单独部署三者关系的小例子可以把处理分布式事务的过程类比成组织一次多人协作的搬家任务用生活化场景理解三个角色事务管理器搬家发起人作用决定要不要开始全局事务搬家这件事以及最后成功了提交结果搬完失败了回滚不搬或恢复原样举例你想组织一次搬家先拍板周末要把家里东西搬到新房定义全局事务范围然后通知大家开始干活开启全局事务要是中途发现新房没收拾好你说不搬了东西放回原处回滚全局事务要是一切顺利你确认搬完啦任务结束提交全局事务事务协调者搬家总指挥作用盯着所有分支事务打包搬运拆装家具等环节的状态协调大家一起成功或一起失败举例你请了个指挥他负责盯着打包队有没有把东西包好分支事务状态搬运车有没有把东西运到分支事务状态拆装队有没有把家具装好分支事务状态要是打包队说包一半发现东西太多搞不定指挥就通知所有人别搬了各自恢复原样要是所有人都反馈搞定指挥就告诉大家可以收尾任务完成资源管理器具体干活的小组作用管理自己负责的分支事务比如打包组管打包搬运组管运输随时给汇报进度和状态举例打包组负责把家里东西分类打包打包完了跟指挥说我们包好啦要是打包到一半发现东西坏了也跟指挥说这里搞不定需要回退搬运组负责把打包好的东西运到新房路上车坏了分支事务失败就跟指挥汇报运不了得终止要是顺利运到就说送达成功拆装组负责在新房把家具装好装完汇报装好了装到一半发现零件少了汇报装不了得回退总结流程你发起搬家全局事务指挥协调打包搬运拆装分支事务每个小组干活并汇报状态指挥根据所有人状态决定让大家一起成功搬完或一起回滚不搬恢复你最终确认结果配置这样就使用成功部署了微服务集成导入依赖为了方便各个微服务集成我们需要把配置共享到因此模块不仅仅要引入依赖还要引入依赖统一配置管理读取文件配置首先在上添加一个共享的配置命名为内容如下服务注册中心的配置微服务根据这些信息去注册中心获取服务地址注册中心类型地址默认为空分组默认是服务名称事务组名称事务组与集群的映射关系改造配置内容如下服务名称地址文件后缀名共享配置共享配置共享日志配置共享日志配置共享配置模式面试题规范是组织定义的分布式事务处理标准规范描述了全局的与局部的之间的接口几乎所有主流的关系型数据库都对规范提供了支持的模式如下一阶段的工作注册分支事务到执行分支业务但是不提交报告执行状态到二阶段的工作检测各分支事务执行状态如果成功失败通知提交回滚事务接收指令提交回滚事务具体流程当方法执行时全局事务向注册一个全局事务执行内部业务逻辑调用每一个分支会拦截对的操作会向注册分支事务然后再放行去执行业务的执行完毕后不可以提交当所有方法执行完毕会向发送全局事务结束的信息会检查注册分支的事务状态如果发现都成功了就向所有分支发送提交回滚的指令这些事务才能提交事务释放锁反之下达回滚的命令优缺点模式的优点是什么事务的强一致性满足原则常用数据库都支持实现简单并且没有代码侵入模式的缺点是什么因为一阶段需要锁定数据库资源等待二阶段结束才释放性能较差依赖关系型数据库实现事务回滚日志模式模式同样是分阶段提交的事务模型不过缺弥补了模型中资源锁定周期过长的缺陷阶段一的工作注册分支事务记录数据快照执行业务并提交报告事务状态阶段二提交时的工作删除即可阶段二回滚时的工作根据恢复数据到更新前具体流程全局事务方法开启时会向注册一个全局事务调用所有的分支在操作之前会被拦截会向注册分支事务微服务的执行具体的语句并且立刻提交事务在执行之前先去生成一个修改数据库之前的数据保存一个快照保存在数据表中当执行完毕后回向报告事务状态会向报告事务的状态会检测事务状态都成功会删除快照失败则回滚从数据库中恢复快照那么万一有其他线程这时候修改了数据怎么办呢引用站外地址全局锁防止脏读简述模式与模式最大的区别是什么模式一阶段不提交事务锁定资源模式一阶段直接提交不锁定资源模式依赖数据库机制实现回滚模式利用数据快照实现数据回滚模式强一致模式最终一致快照数据的版本检查在回滚时会检查快照数据的版本是否与当前数据一致如果发现数据已经被其他事务修改会抛出异常阻止回滚操作这种机制可以避免数据被错误覆盖但会导致事务回滚失败需要额外的处理逻辑补偿机制如果回滚失败会尝试通过补偿机制如补偿来恢复数据补偿是根据业务逻辑预先定义的用于在回滚失败时尽可能恢复数据的一致性五基础面试考点来了嘿嘿异步调用异步调用方式其实就是基于消息通知的方式一般包含三个角色消息发送者投递消息的人就是原来的调用方消息管理暂存转发消息你可以把它理解成微信服务器消息接收者接收和处理消息的人就是原来的服务提供方在异步调用中发送者不再直接同步调用接收者的业务接口而是发送一条消息投递给消息然后接收者根据自己的需求从消息那里订阅消息每当发送方发送消息后接受者都能获取消息并处理这样发送消息的人和接收消息的人就完全解耦了还是以余额支付业务为例除了扣减余额更新支付流水单状态以外其它调用逻辑全部取消而是改为发送一条消息到而相关的微服务都可以订阅消息通知一旦消息到达则会分发给每一个订阅了的微服务处理各自的业务假如产品经理提出了新的需求比如要在支付成功后更新用户积分支付代码完全不用变更而仅仅是让积分服务也订阅消息即可不管后期增加了多少消息订阅者作为支付服务来讲执行问扣减余额更新支付流水状态后发送消息即可业务耗时仅仅是这三部分业务耗时仅仅大大提高了业务性能另外不管是交易服务通知服务还是积分服务他们的业务与支付关联度低现在采用了异步调用解除了耦合他们即便执行过程中出现了故障也不会影响到支付服务交易服务通知服务积分服务收到的消息后如果业务代码没有执行成功还会再给服务发消息直到成功执行为止为了使用实现分布式事务不能将发送消息的代码加入到事务中比如像不支持回滚操作的此时可以配合分布式事务中的事务钩子定义一个发送消息的方法每当事务成功的时候就可以发送消息综上异步调用的优势包括耦合度更低性能更好业务拓展性强故障隔离避免级联失败缓存消息流量削峰填谷当然异步通信也并非完美无缺它存在下列缺点完全依赖于的可靠性安全性和性能架构复杂后期维护和调试麻烦技术选型消息目前常见的实现方案就是消息队列简称为目比较常见的实现几种常见的对比公司社区阿里开发语言协议支持自定义协议自定义协议可用性高一般高高单机吞吐量一般差高非常高消息延迟微秒级毫秒级毫秒级毫秒以内消息可靠性高一般高一般追求可用性追求可靠性追求吞吐能力追求消息低延迟据统计目前国内消息队列使用最多的还是再加上其各方面都比较均衡稳定性也好因此我们选择来学习安装然后访问即可看到管理控制台首次访问需要登录默认的用户名和密码在配置文件中已经指定了对应的架构其中包含几个概念生产者也就是发送消息的一方消费者也就是消费消息的一方队列存储消息生产者投递的消息会暂存在消息队列中等待消费者处理交换机负责消息路由生产者发送的消息由交换机决定投递到哪个队列区分计网中的交换机的交换机是用于消息传递的而计网的交换机是用于数据包传输的虚拟主机起到数据隔离的作用每个虚拟主机相互独立有各自的每个虚拟主机相当于一个数据库彼此之间互不影响将来我们开发业务功能的时候肯定不会在控制台收发消息而是应该基于编程的方式由于采用了协议因此它具备跨语言的特性任何语言只要遵循协议收发消息都可以与交互并且官方也提供了各种不同语言的客户端但是官方提供的客户端编码相对复杂一般生产环境下我们更多会结合来使用而的官方刚好基于提供了这样一套消息收发的模板工具并且还基于对其实现了自动装配使用起来非常方便提供了三个功能自动声明队列交换机及其绑定关系设置队列基于注解的监听器模式异步接收消息设置消费端封装了工具用于发送消息设置生产端模型任务模型简单来说就是让多个消费者绑定到一个队列共同消费队列中的消息当消息处理比较耗时的时候可能生产消息的速度会远远大于消息的消费速度长此以往消息就会堆积越来越多无法及时处理此时就可以使用模型多个消费者共同处理消息处理消息处理的速度就能大大提高了交换机可以看到在订阅模型中多了一个角色而且过程略有变化生产者不再发送消息到队列中而是发给交换机交换机一方面接收生产者发送的消息另一方面知道如何处理消息例如递交给某个特别队列递交给所有队列或是将消息丢弃到底如何操作取决于的类型消息队列也与以前一样接收消息缓存消息不过队列一定要与交换机绑定消费者与以前一样订阅队列没有变化交换机只负责转发消息不具备存储消息的能力因此如果没有任何队列与绑定或者没有符合路由规则的队列那么消息会丢失引入的目的是为了在中一个消息能够分发给多个中被不同的消费者服务多次消费比如你一个订单信息需要加积分加经验这下可以分为两个来执行交换机的类型有四种广播将消息交给所有绑定到交换机的队列我们最早在控制台使用的正是交换机订阅基于路由发送给订阅了消息的队列通配符订阅与类似只不过可以使用通配符头匹配基于的消息头匹配用的较少交换机会将接收到的消息路由到每一个跟其绑定的所以也叫广播模式交换机会将接收到的消息根据规则路由到指定的因此称为定向路由每一个都与设置一个发布者发送消息时指定消息的将消息路由到与消息一致的队列描述下交换机与交换机的差异交换机将消息路由给每一个与之绑定的队列交换机根据判断路由给哪个队列如果多个队列具有相同的则与功能类似交换机也是基于做消息路由但是通常是多个单词的组合并且以分割与指定时可以使用通配符代指个或多个单词代指一个单词声明队列和交换机在之前我们都是基于控制台来创建队列交换机但是在实际开发时队列和交换机是程序员定义的将来项目上线又要交给运维去创建那么程序员就需要把程序中运行的所有队列和交换机都写下来交给运维在这个过程中是很容易出现错误的因此推荐的做法是由程序启动时检查队列和交换机是否存在如果不存在自动创建如果交换机或队列不存在会自动创建它们如果交换机不存在会根据注解中的配置如名称和类型自动创建交换机如果队列不存在会根据注解中的配置如名称自动创建队列如果绑定关系不存在会根据注解中的配置如路由键自动建立绑定关系如果交换机或队列已经存在不会更改已存在的交换机或队列如果交换机或队列已经存在并且它们的配置如名称类型等与注解中的配置一致不会对它们进行任何更改如果交换机或队列的配置与注解中的配置不一致例如交换机类型不同或队列的持久性设置不同会抛出错误导致声明失败消费者接收到的消息消费者接收到的消息再试试模式消费者接收到的消息消费者接收到的消息消息转换器当使用发送消息时传输内容通常是对象但消息队列只能处理字节数据因此需要先将对象序列化为字节发送接收时再反序列化为对象默认使用的是的序列化机制但这种方式格式不友好体积大不安全实际开发中通常会配置转换器使消息更轻量可读且更安全导入依赖然后添加一个定义消息转换器配置自动创建消息用于识别不同消息也可以在业务中基于判断是否是重复消息订单业务案例需求改造余额支付功能将支付成功后基于的交易服务的更新订单状态接口的同步调用改为基于的异步通知说明目前没有通知服务和积分服务因此我们只关注交易服务步骤如下定义类型交换机命名为定义消息队列命名为将与绑定为支付成功时不再调用交易服务更新订单状态的接口而是发送一条消息到发送消息的为消息内容是订单交易服务监听队列接收到消息后更新订单状态为已支付不管是生产者还是消费者都需要配置的基本信息分为两步添加依赖消息发送配置地址你的虚拟机端口虚拟主机用户名密码接收消息在服务中定义一个消息监听类其代码如下发送消息修改服务下的类中的方法查询支付单判断状态订单不是未支付状态异常交易已支付或关闭尝试扣减余额修改支付单状态交易已支付或关闭修改订单状态支付成功的消息发送失败支付单交易单六高级发送者的可靠性发送者重连首先第一种情况就是生产者发送消息时出现了网络故障导致与的连接中断为了解决这个问题提供的消息发送时的重试机制即当与连接超时后多次重试修改模块的文件添加下面的内容设置的连接超时时间开启超时重试机制失败后的初始等待时间失败后下次的等待时长倍数下次等待时长最大重试次数当网络不稳定的时候利用重试机制可以有效提高消息发送的成功率不过提供的重试机制是阻塞式的重试也就是说多次重试等待的过程中当前线程是被阻塞的会影响业务性能如果对于业务性能有要求建议禁用重试机制如果一定要使用请合理配置等待时长和重试次数当然也可以考虑使用异步线程来执行发送消息的代码发送者确认提供了和两种确认机制开启确机制认后当发送者发送消息给后会返回确认结果给发送者返同的结里有以下几种情况一般情况下只要生产者与之间的网路连接顺畅基本不会出现发送消息丢失的情况因此大多数情况下我们无需考虑这种问题不过在少数情况下也会出现消息发送到之后丢失的现象比如内部处理消息的进程发生了异常生产者发送消息到达后未找到生产者发送消息到达的后未找到合适的因此无法路由针对上述情况提供了生产者消息确认机制包括和两种在开启确认机制的情况下当生产者发送消息给后会根据消息处理的情况返回不同的回执具体如图所示总结如下当消息投递到但是路由失败时通过返回异常信息同时返回的确认信息代表投递成功临时消息投递到了并且入队成功返回告知投递成功持久消息投递到了并且入队完成持久化返回告知投递成功其它情况都会返回告知投递失败其中和属于机制是投递成功是投递失败而则属于机制默认两种机制都是关闭状态需要通过配置文件来开启和机制是可以同时开启的机制确认消息是否从路由到机制确认消息是否到达若同时开启路由失败队列不存在或者交换机配置错误时机制返回异常信息以及消息机制则返回不是两个机制不会互相影响和都是由机制返回的路由失败交换机到队列才触发机制返回异常信息消息投递发送者到交换机成功机制返回投递失败返回机制用于向生产者确认消息是否成功送达队列当生产者向发送消息时会返回一个唯一的交付标签生产者可以通过这个标签来查询消息的投递状态机制用于处理无法路由的消息当生产者向发送一条消息时如果消息无法被正确路由例如由于队列不存在或交换机配置错误会将该消息返回给生产者并附带一个错误信息开启生产者确认在模块的中添加配置开启机制并设置类型开启机制这里有三种模式可选关闭机制同步阻塞等待的回执异步回调返回回执一般我们推荐使用回调机制每个只能配置一个因此我们可以在配置类中统一设置我们在模块定义一个配置类的作用当消息发送到交换机时如果交换机无法将消息路由到任何队列例如路由键不匹配或队列不存在会返回一个消息就是用来处理这种场景的配置类中设置了一个消息返回的回调处理机制当发送的消息因为某些原因未能成功投递到目标队列时如交换机路由键不匹配等会触发回调并通过日志记录详细的错误信息这样你可以通过日志详细了解失败的原因便于排查问题内容如下它主要用于类在被创建并完成属性注入后执行一些初始化操作带有注解的方法会被自动调用触发由于每个消息发送时的处理逻辑不一定相同因此需要在每次发消息时定义具体来说是在调用中的方法时多传递一个参数这里的中包含两个核心的东西消息的唯一标示对不同的消息的回执以此做判断避免混淆回执结果的对象为什么只用写一次配置而需要每次都写因为消息需要被确认并且是每条消息都需要被确认我们新建一个测试向系统自带的交换机发送消息并且添加创建给添加发生异常时的处理逻辑基本不会触发接收到回执的处理逻辑参数中的就是回执内容类型代表回执代表回执发送消息成功收到类型返回时的异常描述发送消息失败收到发送消息可以看到由于传递的是错误的路由失败后触发了同时也收到了当我们修改为正确的以后就不会触发了只收到而如果连交换机都是错误的则只会收到开启生产者确认比较消耗性能一般不建议开启而且大家思考一下触发确认的几种情况路由失败一般是因为错误导致往往是编程导致交换机名称错误同样是编程错误导致内部故障这种需要处理但概率往往较低因此只有对消息可靠性要求非常高的业务才需要开启而且仅仅需要开启处理就可以了",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-07-29 16:07:16",postMainColor:""}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise(((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach((e=>{c.setAttribute(e,t[e])})),document.head.appendChild(c)})),e.getCSS=(e,t=!1)=>new Promise(((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)})),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/npm/js-heo@1.0.11/poem/poem.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/npm/js-heo@1.0.11/mainColor/heoMainColor.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/essay-style.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/todolist.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.1/static/custom-me.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/imgloaded.min.css"><link rel="stylesheet" href="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/twikoo.min.css"><script async defer src="https://umami.baskly.fun/script.js" data-website-id="83445f1f-eab2-4423-b52a-d98fcec8638f"></script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg"><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",(()=>{preloader.endLoading()})),setTimeout((function(){preloader.endLoading()}),1e4),document.addEventListener("pjax:send",(()=>{preloader.initLoading()})),document.addEventListener("pjax:complete",(()=>{preloader.endLoading()}))</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">李阳的秘密小屋</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i> <span>隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongji1"></use></svg> <span>统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=12781955100&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>耳机分你一半</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zuji"></use></svg> <span>脚步</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-taiyang"></use></svg> <span>小太阳</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-a-xiaoyangyang_huaban1"></use></svg> <span>了解我</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i> <span>搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/408/" style="font-size:1.05rem">408<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:1.05rem">C语言<sup>1</sup></a><a href="/tags/javaweb/" style="font-size:1.05rem">javaweb<sup>7</sup></a><a href="/tags/%E5%8A%9B%E6%89%A3%E5%88%B7%E9%A2%98/" style="font-size:1.05rem">力扣刷题<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:1.05rem">操作系统<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size:1.05rem">数据结构<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%B8%B8/" style="font-size:1.05rem">日常<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" style="font-size:1.05rem">计算机组成原理<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:1.05rem">计算机网络<sup>2</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size:1.05rem">软件工程<sup>1</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/" itemprop="url">java</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/javaweb/" tabindex="-1" itemprop="url"><span><i class="anzhiyufont anzhiyu-icon-hashtag"></i> javaweb</span></a></span></div></div><h1 class="post-title" itemprop="name headline">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-07-13T00:34:21.000Z" title="发表于 2025-07-13 08:34:21">2025-07-13</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-07-29T08:07:16.870Z" title="更新于 2025-07-29 16:07:16">2025-07-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">29.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>110分钟</span></span><span class="post-meta-separator"></span><span data-flag-title="SpringCloud"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"></span><span class="post-meta-position" title="作者IP属地为武汉"><i class="anzhiyufont anzhiyu-icon-location-dot"></i> 武汉</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/42622/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=9e9a49a4-2f9b-83e3-4aad-021f88d04522"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.baskly.fun/posts/42622/"><header><a class="post-meta-categories" href="/categories/java/" itemprop="url">java</a><a href="/tags/javaweb/" tabindex="-1" itemprop="url">javaweb</a><h1 id="CrawlerTitle" itemprop="name headline">SpringCloud</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">李阳</span><time itemprop="dateCreated datePublished" datetime="2025-07-13T00:34:21.000Z" title="发表于 2025-07-13 08:34:21">2025-07-13</time><time itemprop="dateCreated datePublished" datetime="2025-07-29T08:07:16.870Z" title="更新于 2025-07-29 16:07:16">2025-07-29</time></header><blockquote><p>跌跌撞撞终于来到这里，我会记得这一天。</p><p>知不可乎骤得，托遗响于悲风。<br><em>—— 苏轼《赤壁赋》</em></p></blockquote><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://b11et3un53m.feishu.cn/wiki/PsyawI04ei2FQykqfcPcmd7Dnsc"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left" style="background-image:url(https://bu.dusays.com/2025/07/29/68888113f2ea7.png)"><i class="anzhiyufont anzhiyu-icon-link" style="display:none"></i></div><div class="tag-link-right"><div class="tag-link-title">飞书详细文档</div><div class="tag-link-sitename">黑马程序员</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><h1>一、前置课程</h1><h2 id="1、MybatisPlus">1、MybatisPlus</h2><h3 id="1-1-项目启动">1.1 项目启动</h3><ol><li><p>导入起步依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&lt;!―-MybatisPlus--&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">grouprd</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&lt;/ dependency&gt;</span><br></pre></td></tr></table></figure></li><li><p>自义定<code>Mapper</code>继承<code>MyBatisPlus</code>提供的<code>BaseMapper</code>接口,并且指定实体类泛型</p><p>eg:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="1-2-常用注解">1.2 常用注解</h3><p>约定大于配置</p><ul><li><code>@TableName</code>:用来指定表名</li><li><code>@Table</code>: 用来指定表中主键字段信息</li><li><code>@TableField</code>:用来指定表中的普通字段信息</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/687309fd4d023.png" alt="image-20250713092057985"></p><p>使用<code>@TableField</code>注解的常见场景</p><ul><li>成员变量名与数据库字段名不一致</li><li>成员变量名以is开头且是布尔值</li><li>成员变量名与数据库关键字冲突</li><li>成员变量不是数据库字段</li></ul><h3 id="1-3-常见配置">1.3 常见配置</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">   <span class="attr">type-aliases-package:</span> <span class="string">com.itheima.mp.domain.po</span> <span class="comment">#别名扫描包</span></span><br><span class="line">   <span class="attr">mapper-locations:</span> <span class="string">&quot;classpath* : /mapper/**/*,xml&quot;</span> <span class="comment"># Mapper.xml文件地址，默认值</span></span><br><span class="line">   <span class="attr">configuration:</span></span><br><span class="line">     <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span> <span class="comment">#是否开启下划线和驼峰的映射</span></span><br><span class="line">     <span class="attr">cache-enabled:</span> <span class="literal">false</span> <span class="comment">#是否开启二级缓存</span></span><br><span class="line">   <span class="attr">global-config:</span></span><br><span class="line">     <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">assign_id</span> <span class="comment"># id为雪花算法生成</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span> <span class="comment">#更新策略:只更新非空字段</span></span><br></pre></td></tr></table></figure><h3 id="1-4-核心功能">1.4 核心功能</h3><h4 id="模糊查询">模糊查询</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//查询名字中带o,balance&gt;1000的id，user等</span></span><br><span class="line">/ /<span class="number">1.</span>构建查询条件</span><br><span class="line">Querywrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">Querywrapper</span>&lt;User&gt;()</span><br><span class="line">                   .select( <span class="string">&quot;id&quot;</span>，<span class="string">&quot;username&quot;</span>，<span class="string">&quot;info&quot;</span>,<span class="string">&quot;balance&quot;</span>)</span><br><span class="line">                   .like(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;o&quot;</span>)</span><br><span class="line">                   .ge( <span class="string">&quot;balance&quot;</span>,<span class="number">1000</span>) ;</span><br><span class="line"><span class="comment">// 2.查询</span></span><br><span class="line">userMapper.selectList(wrapper) ;</span><br></pre></td></tr></table></figure><h4 id="条件更新">条件更新</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新用户名为jack的的余额为2000元</span></span><br><span class="line"><span class="comment">// 1.要更新的数据</span></span><br><span class="line"><span class="type">user</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">user.setBalance (<span class="number">2000</span>);</span><br><span class="line"><span class="comment">// 2.更新的条件</span></span><br><span class="line">Querywrapperuser&gt; wrapper = <span class="keyword">new</span> <span class="title class_">Querywrapper</span>&lt;User&gt;()</span><br><span class="line">    .eq( column: <span class="string">&quot;username&quot;</span>，val: <span class="string">&quot;jack&quot;</span>);</span><br><span class="line"><span class="comment">//3.执行更新</span></span><br><span class="line">userMapper.update(user,wrapper);</span><br></pre></td></tr></table></figure><h4 id="条件更新-2">条件更新</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新id为1，2，4的用户余额扣100</span></span><br><span class="line">List&lt;Long&gt; ids = List.of(<span class="number">1L</span>，<span class="number">2L</span>，<span class="number">4L</span>);</span><br><span class="line">updatewrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">Updatewrapper</span>&lt;User&gt; ()</span><br><span class="line">    .setsql( <span class="string">&quot;balance = balance - 200&quot;</span>)</span><br><span class="line">    .in( column: <span class="string">&quot;id, ids);</span></span><br><span class="line"><span class="string">userMapper.update( null, wrapper) ;</span></span><br></pre></td></tr></table></figure><h4 id="自定义SQL">自定义SQL</h4><p>我们可以利用MyBatisPlus的Wrapper来构建复杂的Where条件，然后自己定义SQL语句中剩下的部分。</p><ol><li>基于Wrapper构建where条件</li><li>在mapper方法参数中用Param注解声明wrapper变量名称，必须是ew</li><li>自定义SQL，并且使用wrapper条件</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68731e6092394.png" alt="image-20250713104756971"></p><h4 id="Service接口–IService">Service接口–IService</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/687321021b3e5.png" alt="image-20250713105909031"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/687322560f0d9.png" alt="image-20250713110450874"></p><p>自定义Service去继承Iservice（要指定实体泛型），自定义ServiceImpl去继承ServiceImpl（要指定Mapper泛型和实体泛型）</p><p>eg：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserserice</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServigeImpl</span>&lt;UserMapper，User&gt; <span class="keyword">implements</span> <span class="title class_">TUserService</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-Restful风格接口">1.5 Restful风格接口</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68733109e18c1.png" alt="image-20250713120734859"></p><p>后端传给前端要定义VO，前端传给后端定义DTO</p><p>这里有一个我之前没有注意的点，po要转为vo，可以使用<code>hutool</code>工具包进行拷贝</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BeanUtil.copyproperties(原始实体，目标实体)</span><br></pre></td></tr></table></figure><h3 id="1-6-逻辑删除">1.6 逻辑删除</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734a0b9ec3e.png" alt="image-20250713135411266"></p><h3 id="1-7-枚举处理器">1.7 枚举处理器</h3><ol><li>在枚举类的值上添加<code>@EnumValue</code>注解</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734c7b05f15.png" alt="image-20250713140439923"></p><ol start="2"><li><p>配置全局枚举处理器</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="1-8-JSON类型处理器">1.8 JSON类型处理器</h3><ol><li>首先定义一个单独的JSON实体</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734ef1d9262.png" alt="image-20250713141511161"></p><ol start="2"><li>然后将User类的info字段修改为UserInfo类型，并声明类型处理器：</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734ee32877a.png" alt="image-20250713141456253"></p><ol start="3"><li>在类上开启自动映射（这里设置autoResultMap = true是因为MyBatis-Plus对于这种类中再嵌套一个自定义类的，是需要手动在.xml中定义相关字段等，或者像这样开启自动映射）</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68734f1e6a5ac.png" alt="image-20250713141555704"></p><h3 id="1-9-分页插件">1.9 分页插件</h3><p>在未引入分页插件的情况下，<code>MybatisPlus</code>是不支持分页功能的，<code>IService</code>和<code>BaseMapper</code>中的分页方法都无法正常起效。 所以，我们必须配置分页插件。</p><p>新建<code>MybatisConfig.java</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化核心插件</span></span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="comment">// 添加分页插件</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写分页查询的测试</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPageQuery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.分页查询，new Page()的两个参数分别是：页码、每页大小</span></span><br><span class="line">    Page&lt;User&gt; p = userService.page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">2</span>, <span class="number">2</span>));</span><br><span class="line">    <span class="comment">// 2.总条数</span></span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + p.getTotal());</span><br><span class="line">    <span class="comment">// 3.总页数</span></span><br><span class="line">    System.out.println(<span class="string">&quot;pages = &quot;</span> + p.getPages());</span><br><span class="line">    <span class="comment">// 4.数据</span></span><br><span class="line">    List&lt;User&gt; records = p.getRecords();</span><br><span class="line">    records.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以支持排序(根据balance排序，false是降序)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1</span>, pageSize = <span class="number">5</span>;</span><br><span class="line"><span class="comment">// 分页参数</span></span><br><span class="line">Page&lt;User&gt; page = Page.of(pageNo, pageSize);</span><br><span class="line"><span class="comment">// 排序参数, 通过OrderItem来指定</span></span><br><span class="line">page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;balance&quot;</span>, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">userService.page(page);</span><br></pre></td></tr></table></figure><h4 id="通用分页查询案例">通用分页查询案例</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/13/68735433538aa.png" alt="image-20250713143735745"></p><ol><li><p>定义一个统一的分页查询条件的实体，包含分页、排序参数、过滤条件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页查询实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageSize;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;排序字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sortBy;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否升序&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isAsc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后让我们需要分页的实体去继承分页实体</p><p><code>callSuper = true</code>根据子类自身的字段值和从父类继承的字段值 来生成hashcode，当两个子类对象比较时，只有子类对象的本身的字段值和继承父类的字段值都相同，equals方法的返回值是true</p><p><code>@EqualsAndHashCode</code> 用于自动生成 equals() 和 hashCode() 方法，并且在比较时，调用父类（super）的 equals() 和 hashCode() 方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;用户查询条件实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserQuery</span> <span class="keyword">extends</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名关键字&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户状态：1-正常，2-冻结&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最小值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer minBalance;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最大值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer maxBalance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>新建统一返回结果集</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页结果&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总条数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总页数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pages;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;集合&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>分页查询代码示例</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageDTO&lt;UserVO&gt; <span class="title function_">queryUsersPage</span><span class="params">(PageQuery query)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建条件</span></span><br><span class="line">    <span class="comment">// 1.1.分页条件</span></span><br><span class="line">    Page&lt;User&gt; page = Page.of(query.getPageNo(), query.getPageSize());</span><br><span class="line">    <span class="comment">// 1.2.排序条件</span></span><br><span class="line">    <span class="keyword">if</span> (query.getSortBy() != <span class="literal">null</span>) &#123;</span><br><span class="line">        page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(query.getSortBy(), query.getIsAsc()));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 默认按照更新时间排序</span></span><br><span class="line">        page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;update_time&quot;</span>, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.查询</span></span><br><span class="line">    page(page);</span><br><span class="line">    <span class="comment">// 3.数据非空校验</span></span><br><span class="line">    List&lt;User&gt; records = page.getRecords();</span><br><span class="line">    <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 无数据，返回空结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(page.getTotal(), page.getPages(), Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.有数据，转换</span></span><br><span class="line">    List&lt;UserVO&gt; list = BeanUtil.copyToList(records, UserVO.class);</span><br><span class="line">    <span class="comment">// 5.封装返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;UserVO&gt;(page.getTotal(), page.getPages(), list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="将分页条件封装在工具类中">将分页条件封装在工具类中</h4><p><code>PageQuery</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageNo=<span class="number">1</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageSize=<span class="number">10</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;排序字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sortBy;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否升序&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isAsc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt;  Page&lt;T&gt; <span class="title function_">toMpPage</span><span class="params">(OrderItem ... orders)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.分页条件</span></span><br><span class="line">        Page&lt;T&gt; p = Page.of(pageNo, pageSize);</span><br><span class="line">        <span class="comment">// 2.排序条件</span></span><br><span class="line">        <span class="comment">// 2.1.先看前端有没有传排序字段</span></span><br><span class="line">        <span class="keyword">if</span> (sortBy != <span class="literal">null</span>) &#123;</span><br><span class="line">            p.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(sortBy, isAsc));</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.2.再看有没有手动指定排序字段</span></span><br><span class="line">        <span class="keyword">if</span>(orders != <span class="literal">null</span>)&#123;</span><br><span class="line">            p.addOrder(orders);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPage</span><span class="params">(String defaultSortBy, <span class="type">boolean</span> isAsc)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.toMpPage(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(defaultSortBy, isAsc));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPageDefaultSortByCreateTimeDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toMpPage(<span class="string">&quot;create_time&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPageDefaultSortByUpdateTimeDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toMpPage(<span class="string">&quot;update_time&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PageDTO</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.mp.domain.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="keyword">private</span> Long pages;</span><br><span class="line">    <span class="keyword">private</span> List&lt;V&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回空分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlus的分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; 目标VO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; 原始PO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VO的分页对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">empty</span><span class="params">(Page&lt;P&gt; p)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将MybatisPlus分页结果转为 VO分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlus的分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voClass 目标VO类型的字节码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; 目标VO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; 原始PO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VO的分页对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">of</span><span class="params">(Page&lt;P&gt; p, Class&lt;V&gt; voClass)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.非空校验</span></span><br><span class="line">        List&lt;P&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 无数据，返回空结果</span></span><br><span class="line">            <span class="keyword">return</span> empty(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.数据转换</span></span><br><span class="line">        List&lt;V&gt; vos = BeanUtil.copyToList(records, voClass);</span><br><span class="line">        <span class="comment">// 3.封装返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), vos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将MybatisPlus分页结果转为 VO分页结果，允许用户自定义PO到VO的转换方式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlus的分页结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> convertor PO到VO的转换函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; 目标VO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; 原始PO类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VO的分页对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">of</span><span class="params">(Page&lt;P&gt; p, Function&lt;P, V&gt; convertor)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.非空校验</span></span><br><span class="line">        List&lt;P&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 无数据，返回空结果</span></span><br><span class="line">            <span class="keyword">return</span> empty(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.数据转换</span></span><br><span class="line">        List&lt;V&gt; vos = records.stream().map(convertor).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 3.封装返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), vos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>业务层代码可简化为</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageDTO&lt;UserVO&gt; <span class="title function_">queryUserByPage</span><span class="params">(PageQuery query)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建条件</span></span><br><span class="line">    Page&lt;User&gt; page = query.toMpPageDefaultSortByCreateTimeDesc();</span><br><span class="line">    <span class="comment">// 2.查询</span></span><br><span class="line">    page(page);</span><br><span class="line">    <span class="comment">// 3.封装返回</span></span><br><span class="line">    <span class="keyword">return</span> PageDTO.of(page, user -&gt; &#123;</span><br><span class="line">        <span class="comment">// 拷贝属性到VO</span></span><br><span class="line">        <span class="type">UserVO</span> <span class="variable">vo</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserVO.class);</span><br><span class="line">        <span class="comment">// 用户名脱敏</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> vo.getUsername();</span><br><span class="line">        vo.setUsername(username.substring(<span class="number">0</span>, username.length() - <span class="number">2</span>) + <span class="string">&quot;**&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-Docker">2.Docker</h2><h3 id="1-安装问题">1. 安装问题</h3><h4 id="1-解决配置网络时es33显示被已拔出问题">1. 解决配置网络时es33显示被已拔出问题</h4><p>在电脑服务中开启VMware DHCP Service”和“VMware NAT Service”。即可</p><h4 id="2-解决Docker镜像问题">2. 解决Docker镜像问题</h4><p>操她奶奶的，你妹的傻鸟Docker，用老师安装的方式一直不成功，最终在评论区找到答案</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">无法安装docker 建议直接：bash &lt;(curl -sSL https:<span class="comment">//linuxmirrors.cn/docker.sh)  这条命令，一次性全安装完毕</span></span><br></pre></td></tr></table></figure><h3 id="2-安装MySQL">2. 安装MySQL</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> mysql \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line">  <span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line">  <span class="literal">-e</span> MYSQL_ROOT_PASSWORD=abc123 \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;  <span class="string">&quot;registry-mirrors&quot;</span>: [   </span><br><span class="line">        <span class="string">&quot;https://docker-0.unsee.tech&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;https://docker-cf.registry.cyou&quot;</span>,   </span><br><span class="line">        <span class="string">&quot;https://docker.1panel.live&quot;</span>  </span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="3-Docker常见命令">3. Docker常见命令</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68743df04bd52.png" alt="img"></p><table><thead><tr><th style="text-align:center">命令</th><th style="text-align:center">说明</th><th style="text-align:center">文档地址</th></tr></thead><tbody><tr><td style="text-align:center">docker images</td><td style="text-align:center">查看本地镜像</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/images/">docker images</a></td></tr><tr><td style="text-align:center">docker rmi</td><td style="text-align:center">删除本地镜像</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a></td></tr><tr><td style="text-align:center">docker run</td><td style="text-align:center">创建并运行容器（不能重复创建）</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></td></tr><tr><td style="text-align:center">docker stop</td><td style="text-align:center">停止指定容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></td></tr><tr><td style="text-align:center">docker start</td><td style="text-align:center">启动指定容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/start/">docker start</a></td></tr><tr><td style="text-align:center">docker restart</td><td style="text-align:center">重新启动容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/restart/">docker restart</a></td></tr><tr><td style="text-align:center">docker rm</td><td style="text-align:center">删除指定容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rm/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker ps</td><td style="text-align:center">查看容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/ps/">docker ps</a></td></tr><tr><td style="text-align:center">docker logs</td><td style="text-align:center">查看容器运行日志</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/logs/">docker logs</a></td></tr><tr><td style="text-align:center">docker exec</td><td style="text-align:center">进入容器</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a></td></tr><tr><td style="text-align:center">docker save</td><td style="text-align:center">保存镜像到本地压缩文件</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/save/">docker save</a></td></tr><tr><td style="text-align:center">docker load</td><td style="text-align:center">加载本地压缩文件到镜像</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/load/">docker load</a></td></tr><tr><td style="text-align:center">docker inspect</td><td style="text-align:center">查看容器详细信息</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/inspect/">docker inspect</a></td></tr></tbody></table><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68743f28292ae.png" alt="image-20250714072007387"></p><p>如何把镜像交给运维人员：1.使用docker save形成本地压缩包，运维人员再使用docker load将本地这个压缩包进行解压；2.将镜像推送到镜像仓库，运维人员再从镜像仓库进行拉取</p><h3 id="4-数据卷">4. 数据卷</h3><p>容器是隔离环境，容器内程序的文件、配置、运行时产生的容器都在容器内部，我们要读写容器内的文件非常不方便。大家思考几个问题：</p><ul><li>如果要升级MySQL版本，需要销毁旧容器，那么数据岂不是跟着被销毁了？</li><li>MySQL、Nginx容器运行后，如果我要修改其中的某些配置该怎么办？</li><li>我想要让Nginx代理我的静态资源怎么办？</li></ul><p>因此，容器提供程序的运行环境，但是<strong>程序运行产生的数据、程序运行依赖的配置都应该与容器解耦</strong>。</p><h4 id="4-1-什么是数据卷">4.1 什么是数据卷</h4><p><strong>数据卷（volume）<strong>是一个虚拟目录，是</strong>容器内目录</strong>与<strong>宿主机目录</strong>之间映射的桥梁。（ps：其实类似于双向绑定，修改数据卷里面的nginx内容，实际的nginx的内容也会修改）</p><p>以Nginx为例，我们知道Nginx中有两个关键的目录：</p><ul><li><code>html</code>：放置一些静态资源</li><li><code>conf</code>：放置配置文件</li></ul><p>如果我们要让Nginx代理我们的静态资源，最好是放到<code>html</code>目录；如果我们要修改Nginx的配置，最好是找到<code>conf</code>下的<code>nginx.conf</code>文件。</p><p>但遗憾的是，容器运行的Nginx所有的文件都在容器内部。所以我们必须利用数据卷将两个目录与宿主机目录关联，方便我们操作。如图：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/687441cd20ef8.png" alt="image-20250714073124180"></p><p>在上图中：</p><ul><li>我们创建了两个数据卷：<code>conf</code>、<code>html</code></li><li>Nginx容器内部的<code>conf</code>目录和<code>html</code>目录分别与两个数据卷关联。</li><li>而数据卷conf和html分别指向了宿主机的<code>/var/lib/docker/volumes/conf/_data</code>目录和<code>/var/lib/docker/volumes/html/_data</code>目录</li></ul><p>这样以来，容器内的<code>conf</code>和<code>html</code>目录就 与宿主机的<code>conf</code>和<code>html</code>目录关联起来，我们称为<strong>挂载</strong>。此时，我们操作宿主机的<code>/var/lib/docker/volumes/html/_data</code>就是在操作容器内的<code>/usr/share/nginx/html/_data</code>目录。只要我们将静态资源放入宿主机对应目录，就可以被Nginx代理了。</p><h4 id="4-2-数据卷的命令">4.2 数据卷的命令</h4><table><thead><tr><th style="text-align:center"><strong>命令</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>文档地址</strong></th></tr></thead><tbody><tr><td style="text-align:center">docker volume create</td><td style="text-align:center">创建数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_create/">docker volume create</a></td></tr><tr><td style="text-align:center">docker volume ls</td><td style="text-align:center">查看所有数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_ls/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker volume rm</td><td style="text-align:center">删除指定数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker volume inspect</td><td style="text-align:center">查看某个数据卷的详情</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_inspect/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker volume prune</td><td style="text-align:center">清除数据卷</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docker volume prune</a></td></tr></tbody></table><p>注意：容器与数据卷的挂载要在创建容器时配置，对于创建好的容器，是不能设置数据卷的。而且<strong>创建容器的过程中，数据卷会自动创建</strong>。</p><p>如何挂载数据卷？</p><ul><li>在创建容器时，利用-v数据卷名:容器内目录完成挂载</li><li>容器创建时，如果发现挂载的数据卷不存在时，会自动创建</li></ul><h4 id="4-3-创建Nginx-数据卷">4.3 创建Nginx 数据卷</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68744990bc1b6.png" alt="image-20250714080431521"><br>哇神奇</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker rm -f nginx</span></span><br><span class="line">nginx</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker run -d --name nginx -p 80:80 -v html:/usr/share/nginx/html nginx</span></span><br><span class="line">d7d95a4dd8cb76b5a4baeb1a17ab2f5acbfdfe34844da319d3c7e30bfa1be047</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                   CREATED             STATUS             PORTS                                                  NAMES</span><br><span class="line">d7d95a4dd8cb   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">8</span> seconds ago       Up <span class="number">7</span> seconds       <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp, :::<span class="number">80</span>-&gt;<span class="number">80</span>/tcp                      nginx</span><br><span class="line"><span class="number">5</span>bb7b84c208d   mysql     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   About an hour ago   Up About an hour   <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">3306</span>-&gt;<span class="number">3306</span>/tcp, :::<span class="number">3306</span>-&gt;<span class="number">3306</span>/tcp, <span class="number">33060</span>/tcp   mysql</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     f029801a77bbe84d7ee550a9cce21abf4644a56906111cc68be691efd9495a9e</span><br><span class="line">local     html</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker volume inspect html</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2025-07-13T22:12:13+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: <span class="type">null</span>,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/html/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: <span class="type">null</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cd /var/lib/docker/volumes/html/_data</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">_data</span>]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是 Docker 的默认存储位置，所有命名卷都会存放在 <code>/var/lib/docker/volumes/&lt;卷名&gt;/_data</code> 下</p><p>volume对应的宿主机目录，html是虚拟目录 ，<code>/usr/share/nginx/html</code> 容器内的对应目录</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/68746bec07642.png" alt="image-20250714103106907"></p><h4 id="4-4-MySQL-容器的数据挂载">4.4 MySQL 容器的数据挂载</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker inspect mysql</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;e4c3c8923f08031b15e4590cbc0a10209867ac4793a46ac409e4ae3d6923cea9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-07-13T18:25:21.488931875Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;docker-entrypoint.sh&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;mysqld&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;running&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Running&quot;</span>: <span class="type">true</span>,</span><br><span class="line">            <span class="string">&quot;Paused&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Restarting&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;OOMKilled&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Dead&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Pid&quot;</span>: <span class="number">52260</span>,</span><br><span class="line">            <span class="string">&quot;ExitCode&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2025-07-13T18:25:21.819305537Z&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line"> </span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;c5ab9bdf061d55de6fc1d602ff8e644d915611171539536ea48f1ba0b5092d5e&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/c5ab9bdf061d55de6fc1d602ff8e644d915611171539536ea48f1ba0b5092d5e/_data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RW&quot;</span>: <span class="type">true</span>,</span><br><span class="line">                <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;e4c3c8923f08&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;3306/tcp&quot;</span>: &#123;&#125;,</span><br><span class="line">                <span class="string">&quot;33060/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;TZ=Asia/Shanghai&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_ROOT_PASSWORD=abc123&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;GOSU_VERSION=1.17&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_MAJOR=innovation&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_VERSION=9.3.0-1.el9&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MYSQL_SHELL_VERSION=9.3.0-1.el9&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;mysqld&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;/var/lib/mysql&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;docker-entrypoint.sh&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: <span class="type">null</span>,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;NetworkSettings&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Bridge&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxID&quot;</span>: <span class="string">&quot;bbc2939d84f12f3ba3b2063229491abfaf2b0ee8a52b7b3d605792017b49f3a5&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxKey&quot;</span>: <span class="string">&quot;/var/run/docker/netns/bbc2939d84f1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Ports&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;3306/tcp&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;3306&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;::&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;3306&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;33060/tcp&quot;</span>: <span class="type">null</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;HairpinMode&quot;</span>: <span class="type">false</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6PrefixLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: <span class="type">null</span>,</span><br><span class="line">            <span class="string">&quot;SecondaryIPv6Addresses&quot;</span>: <span class="type">null</span>,</span><br><span class="line">            <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;67d5ed6abb8444918c766a0e9be1ba00a6ed7d9f32d55155e1b7924466ee1a0d&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IPPrefixLen&quot;</span>: <span class="number">16</span>,</span><br><span class="line">            <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Networks&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;bridge&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;IPAMConfig&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;Links&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;Aliases&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;2bcb6623ac17cfcba762bc1efedf14674fe023680a15b89e4f5f687f76ad2d90&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;67d5ed6abb8444918c766a0e9be1ba00a6ed7d9f32d55155e1b7924466ee1a0d&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPPrefixLen&quot;</span>: <span class="number">16</span>,</span><br><span class="line">                    <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&quot;DriverOpts&quot;</span>: <span class="type">null</span>,</span><br><span class="line">                    <span class="string">&quot;DNSNames&quot;</span>: <span class="type">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>发现有默认的数据挂载，但是默认匿名挂载名字复杂目录太深了，下面给他修改到挂载到根目录</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> mysql \</span><br><span class="line"><span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line"><span class="literal">-e</span> Tz=Asia/Shanghai \</span><br><span class="line"><span class="literal">-e</span> MYSQL_ROOT_PASSWORD=abc123 \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/<span class="keyword">data</span>:/var/lib/mysql \</span><br><span class="line"><span class="literal">-v</span> /root/mysq1/conf:/etc/mysq1/conf.d \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/init:/docker<span class="literal">-entrypoint-initdb</span>.d \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><p>注意：SQL文件必须要有创建数据库的命令，不然无法创建成功数据库</p><p>然后将SQL文件放在init文件夹里面</p><p>运行</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> mysql \</span><br><span class="line"><span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line"><span class="literal">-e</span> Tz=Asia/Shanghai \</span><br><span class="line"><span class="literal">-e</span> MYSQL_ROOT_PASSWORD=abc123 \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/<span class="keyword">data</span>:/var/lib/mysql \</span><br><span class="line"><span class="literal">-v</span> /root/mysq1/conf:/etc/mysq1/conf.d \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/init:/docker<span class="literal">-entrypoint-initdb</span>.d \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><p>即可</p><h3 id="5-自定义镜像">5. 自定义镜像</h3><p>镜像就是包含了应用程序、程序运行的系统函数库、运行配置等文件的文件包。构建镜像的过程其实就是把上述文件打包的过程。</p><p>由于制作镜像的过程中，需要逐层处理和打包，比较复杂，所以Docker就提供了自动打包镜像的功能。我们只需要将打包的过程，每一层要做的事情用固定的语法写下来，交给Docker去执行即可。而这种记录镜像结构的文件就称为<strong>Dockerfile</strong></p><table><thead><tr><th style="text-align:center"><strong>指令</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>示例</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>FROM</strong></td><td style="text-align:center">指定基础镜像</td><td style="text-align:center"><code>FROM centos:6</code></td></tr><tr><td style="text-align:center"><strong>ENV</strong></td><td style="text-align:center">设置环境变量，可在后面指令使用</td><td style="text-align:center"><code>ENV key value</code></td></tr><tr><td style="text-align:center"><strong>COPY</strong></td><td style="text-align:center">拷贝本地文件到镜像的指定目录</td><td style="text-align:center"><code>COPY ./xx.jar /tmp/app.jar</code></td></tr><tr><td style="text-align:center"><strong>RUN</strong></td><td style="text-align:center">执行Linux的shell命令，一般是安装过程的命令</td><td style="text-align:center"><code>RUN yum install gcc</code></td></tr><tr><td style="text-align:center"><strong>EXPOSE</strong></td><td style="text-align:center">指定容器运行时监听的端口，是给镜像使用者看的</td><td style="text-align:center"><code>EXPOSE 8080</code></td></tr><tr><td style="text-align:center"><strong>ENTRYPOINT</strong></td><td style="text-align:center">镜像中应用的启动命令，容器运行时调用</td><td style="text-align:center"><code>ENTRYPOINT java -jar xx.jar</code></td></tr></tbody></table><h3 id="6-网络">6. 网络</h3><p>容器的网络IP其实是一个虚拟的IP，其值并不固定与某一个容器绑定，如果我们在开发时写死某个IP，而在部署时很可能MySQL容器的IP会发生变化，连接会失败。</p><p>所以，我们必须借助于docker的网络功能来解决这个问题<br>常见命令</p><table><thead><tr><th style="text-align:center"><strong>命令</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>文档地址</strong></th></tr></thead><tbody><tr><td style="text-align:center">docker network create</td><td style="text-align:center">创建一个网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_create/">docker network create</a></td></tr><tr><td style="text-align:center">docker network ls</td><td style="text-align:center">查看所有网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_ls/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network rm</td><td style="text-align:center">删除指定网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_rm/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network prune</td><td style="text-align:center">清除未使用的网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_prune/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network connect</td><td style="text-align:center">使指定容器连接加入某网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_connect/">docs.docker.com</a></td></tr><tr><td style="text-align:center">docker network disconnect</td><td style="text-align:center">使指定容器连接离开某网络</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_disconnect/">docker network disconnect</a></td></tr><tr><td style="text-align:center">docker network inspect</td><td style="text-align:center">查看网络详细信息</td><td style="text-align:center"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_inspect/">docker network inspect</a></td></tr></tbody></table><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">mysql</span>]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">f1a34d4477b4   baskly    bridge    local</span><br><span class="line"><span class="number">2</span>bcb6623ac17   bridge    bridge    local</span><br><span class="line">e693457ba93b   host      host      local</span><br><span class="line"><span class="number">028</span>d2b795efa   none      null      local</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">mysql</span>]<span class="comment"># docker network connect baskly mysql</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">mysql</span>]<span class="comment"># docker inspect mysql</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="7-使用Docker打包项目（tlias为例）">7.使用Docker打包项目（tlias为例）</h3><blockquote><p>老东西 终于把焚决交出来了</p></blockquote><h4 id="7-1后端打包">7.1后端打包</h4><ol><li><p>准备MySQL容器，并且创建tlias数据库以及表结构（上面在本地目录挂载MySQL时已经2完成）</p></li><li><p>准备Java应用（tlias）镜像，部署Docker容器，运行测试</p><ul><li><p>修改tlias项目的配置文件，修改数据库服务地址及logback日志文件存放地址，打jar包。</p></li><li><p>编写Dockerfile文件。</p></li><li><p>构建Docker镜像。</p></li><li><p>部署Docker容器。</p></li></ul></li></ol><h5 id="具体步骤">具体步骤</h5><ol><li><p>打开idea将yml中数据库连接部分改为Docker中的MySQL</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">   <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">   <span class="attr">url:</span> <span class="string">jdbc:mysql://mysql:3306/tlias?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line">   <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">password:</span> <span class="string">abc123</span></span><br></pre></td></tr></table></figure></li><li><p>在idea中的Maven中的Lifecycle中点击<code>package</code>,等待build成功。然后我们的target文件夹中会出现我们的Jar包了。jar包名字很长可以适当重命名</p></li><li><p>新建Dockerfile</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 CentOS 7 作为基础镜像</span></span><br><span class="line">FROM centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 JDK 到镜像中</span></span><br><span class="line"><span class="built_in">COPY</span> jdk21.tar.gz /usr/local/</span><br><span class="line">RUN tar <span class="literal">-xzf</span> /usr/local/jdk21.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr/local/jdk21.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">ENV JAVA_HOME=/usr/local/jdk<span class="literal">-21</span>.<span class="number">0.1</span></span><br><span class="line">ENV PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置阿里云OSS</span></span><br><span class="line">ENV OSS_ACCESS_KEY_ID=[你的]</span><br><span class="line">ENV OSS_ACCESS_KEY_SECRET=[你的]</span><br><span class="line"><span class="comment">#统一编码</span></span><br><span class="line">ENV LANG=en_US.UTF<span class="literal">-8</span></span><br><span class="line">ENV LANGUAGE=en_US:en</span><br><span class="line">ENV LC_ALL=en_US.UTF<span class="literal">-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用目录</span></span><br><span class="line">RUN mkdir <span class="literal">-p</span> /tlias</span><br><span class="line">WORKDIR /tlias</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用 JAR 文件到容器</span></span><br><span class="line"><span class="built_in">COPY</span>  tlias.jar  tlias.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/tlias/tlias.jar&quot;</span>]</span><br></pre></td></tr></table></figure></li><li><p>在<code>/usr/local/</code>下新建<code>tlias-docker-app</code>文件夹，里面上传进去我们的<code>tlias.jar</code>,<code>Dockerfile</code>,<code>jdk21</code></p></li><li><p>然后去构建Docker镜像</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker build -t tlias:1.0 .</span></span><br><span class="line">[+] Building <span class="number">266.8</span>s (<span class="number">11</span>/<span class="number">11</span>) FINISHED                             docker:default</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load build definition from Dockerfile                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">818</span>B                                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load metadata <span class="keyword">for</span> docker.io/library/centos:<span class="number">7</span>              <span class="number">146.9</span>s</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load .dockerignore                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                            <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">1</span>/<span class="number">6</span>] FROM docker.io/library/centos:<span class="number">7</span>@sha256:be65f488b7764ad3638f23  <span class="number">111.2</span>s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/centos:<span class="number">7</span>@sha256:be65f488b7764ad3638f236b  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:eeb6ee3f44bd0b5103bb561b4c16bcb82328cfe5809 <span class="number">2.75</span>kB / <span class="number">2.75</span>kB  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:<span class="number">2</span>d473b07cdd5f0912cd6f1a703352c82b512407 <span class="number">76.10</span>MB / <span class="number">76.10</span>MB  <span class="number">103.9</span>s</span><br><span class="line"> =&gt; =&gt; sha256:be65f488b7764ad3638f236b7b515b3678369a5124c <span class="number">1.20</span>kB / <span class="number">1.20</span>kB  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:dead07b4d8ed7e29e98de0f4504d87e8880d4347859d839 <span class="number">529</span>B / <span class="number">529</span>B  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; extracting sha256:<span class="number">2</span>d473b07cdd5f0912cd6f1a703352c82b512407db6b05b43  <span class="number">7.1</span>s</span><br><span class="line"> =&gt; [<span class="built_in">int</span><span class="type">ernal</span>] load build context                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">173</span>B                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">2</span>/<span class="number">6</span>] <span class="built_in">COPY</span> jdk21.tar.gz /usr/local/                                    <span class="number">2.0</span>s</span><br><span class="line"> =&gt; [<span class="number">3</span>/<span class="number">6</span>] RUN tar <span class="literal">-xzf</span> /usr/local/jdk21.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr  <span class="number">5.4</span>s</span><br><span class="line"> =&gt; [<span class="number">4</span>/<span class="number">6</span>] RUN mkdir <span class="literal">-p</span> /tlias                                              <span class="number">0.4</span>s</span><br><span class="line"> =&gt; [<span class="number">5</span>/<span class="number">6</span>] WORKDIR /tlias                                                   <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">6</span>/<span class="number">6</span>] <span class="built_in">COPY</span>  tlias.jar  tlias.jar                                       <span class="number">0.1</span>s</span><br><span class="line"> =&gt; exporting to image                                                     <span class="number">0.7</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                    <span class="number">0.6</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:<span class="number">8</span>b8dd47f37a8752599c8d24b4b01dcce96ccb2469d4f4  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/tlias:<span class="number">1.0</span>                               <span class="number">0.0</span>s</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">tlias        <span class="number">1.0</span>       <span class="number">8</span>b8dd47f37a8   About a minute ago   <span class="number">783</span>MB</span><br><span class="line">redis        latest    f2cd22713a18   <span class="number">7</span> days ago           <span class="number">128</span>MB</span><br><span class="line">nginx        latest    <span class="number">9592</span>f5595f2b   <span class="number">2</span> weeks ago          <span class="number">192</span>MB</span><br><span class="line">mysql        latest    <span class="number">4</span>c2531d6bf10   <span class="number">2</span> months ago         <span class="number">859</span>MB</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>取名字为tlias，版本1.0，在当前文件夹里</p></li><li><p>部署docker容器</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker run -d --name tlias-server -p 8080:8080 --network baskly tlias:1.0</span></span><br><span class="line">ffc30c9fde8cf187b0c035e1fd27b12417ebcf988af34b3779c2cf50040f7a4d</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">tlias</span>-<span class="type">docker</span>-<span class="type">app</span>]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                   CREATED          STATUS          PORTS   NAMES</span><br><span class="line">ffc30c9fde8c   tlias:<span class="number">1.0</span>   <span class="string">&quot;java -jar /tlias/tl…&quot;</span>   <span class="number">18</span> seconds ago   Up <span class="number">17</span> seconds   <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp, :::<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp   tlias<span class="literal">-server</span></span><br></pre></td></tr></table></figure></li><li><p>使用<code>docker logs -f tlias-service</code> 查看后端启动日志</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[root<span class="meta">@localhost</span> tlias-docker-app]# docker logs -f tlias-server</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | &#x27;</span>_ | <span class="string">&#x27;_| | &#x27;</span>_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">&#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> :: Spring Boot ::                (v3.4.4)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2025-07-13T21:02:32.843Z  INFO 1 --- [tlias-web-managemen] [           main] c.itheima.TliasWebManagemenApplication   : Starting TliasWebManagemenApplication v0.0.1-SNAPSHOT using Java 21.0.1 with PID 1 (/tlias/tlias.jar started by root in /tlias)</span></span><br><span class="line"><span class="string">2025-07-13T21:02:32.849Z  INFO 1 --- [tlias-web-managemen] [           main] c.itheima.TliasWebManagemenApplication   : No active profile set, falling back to 1 default profile: &quot;default&quot;</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.395Z  INFO 1 --- [tlias-web-managemen] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port 8080 (http)</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.427Z  INFO 1 --- [tlias-web-managemen] [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.428Z  INFO 1 --- [tlias-web-managemen] [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.39]</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.493Z  INFO 1 --- [tlias-web-managemen] [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="string">2025-07-13T21:02:35.495Z  INFO 1 --- [tlias-web-managemen] [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 2524 ms</span></span><br><span class="line"><span class="string">Logging initialized using &#x27;</span><span class="keyword">class</span> <span class="title class_">org</span>.apache.ibatis.logging.stdout.StdOutImpl<span class="string">&#x27; adapter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">,------.                           ,--.  ,--.         ,--.</span></span><br><span class="line"><span class="string">|  .--. &#x27;</span>  ,--,--.  ,---.   ,---.  |  <span class="string">&#x27;--&#x27;</span>  |  ,---.  |  |  ,---.   ,---.  ,--.--.</span><br><span class="line">|  <span class="string">&#x27;--&#x27;</span> | <span class="string">&#x27; ,-.  | | .-. | | .-. : |  .--.  | | .-. : |  | | .-. | | .-. : |  .--&#x27;</span></span><br><span class="line">|  | --<span class="string">&#x27;  \ &#x27;</span>-<span class="string">&#x27;  | &#x27;</span> <span class="string">&#x27;-&#x27;</span> <span class="string">&#x27; \   --. |  |  |  | \   --. |  | | &#x27;</span>-<span class="string">&#x27; &#x27;</span> \   --. |  |</span><br><span class="line">`--<span class="string">&#x27;       `--`--&#x27;</span> .`-  /   `----<span class="string">&#x27; `--&#x27;</span>  `--<span class="string">&#x27;  `----&#x27;</span> `--<span class="string">&#x27; |  |-&#x27;</span>   `----<span class="string">&#x27; `--&#x27;</span></span><br><span class="line">                   `---<span class="string">&#x27;                                   `--&#x27;</span>                        is intercepting.</span><br><span class="line"></span><br><span class="line"><span class="number">2025</span>-<span class="number">07</span>-13T21:<span class="number">02</span>:<span class="number">37.</span>128Z  INFO <span class="number">1</span> --- [tlias-web-managemen] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port <span class="number">8080</span> (http) with context path <span class="string">&#x27;/&#x27;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">07</span>-13T21:<span class="number">02</span>:<span class="number">37.</span>149Z  INFO <span class="number">1</span> --- [tlias-web-managemen] [           main] c.itheima.TliasWebManagemenApplication   : Started TliasWebManagemenApplication in <span class="number">5.209</span> seconds (process running <span class="keyword">for</span> <span class="number">5.838</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>这样我们的项目就启动成功了使用ApiFox发送请求也能正常输出结果<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874a49234ca3.png" alt="image-20250714143249324"></p></li></ol><h4 id="7-2-前端项目部署">7.2. 前端项目部署</h4><p>创建一个新的nginx容器，将资料中提供的前端项目的静态资源部署到nginx中。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874a598518f0.png" alt="image-20250714143712192"></p><ol><li><p>在root文件夹下创建一个新文件夹用于映射Nginx，名字叫<code>tlias-nginx</code>。</p></li><li><p>然后配置挂载</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"> <span class="literal">--name</span> nginx<span class="literal">-tlias</span> \</span><br><span class="line"> <span class="literal">-v</span> /root/tlias<span class="literal">-nginx</span>/html:/usr/share/nginx/html \</span><br><span class="line"> <span class="literal">-v</span> /root/tlias<span class="literal">-nginx</span>/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line"> <span class="literal">--network</span> baskly \</span><br><span class="line"> <span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> \</span><br><span class="line">nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure></li><li><p>然后访问（未开启需要开启一下服务）</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装ntpdate（若未安装）</span></span><br><span class="line">sudo yum install <span class="literal">-y</span> ntpdate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步阿里云时间服务器（北京时间）</span></span><br><span class="line">sudo ntpdate ntp.aliyun.com</span><br></pre></td></tr></table></figure><p>解决因为Linux时间和系统系统不符导致的时区不同步问题</p></li></ol><h3 id="8-DockerCompose">8. DockerCompose</h3><blockquote><p>老东西 把异火也交出来了</p></blockquote><p>Docker Compose通过一个单独的docker-compose.yml模板文件（YANL 格式）来定义一组相关联的应用容器，帮助我们实现多个相互关联的Docker容器的快速部署。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874b22bd22c4.png" alt="image-20250714153048956"></p><p>现在我们使用DockerCompose来重新构建项目</p><ul><li>准备资源（tlias.sql，服务端的jdk17、jar包、Dockerfile，前端项目打包文件、nginx.conf)</li><li>准备docker-compose.yml配置文件</li><li>基于DockerCompose快速构建项目</li></ul><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">abc123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/init:/docker-entrypoint-initdb.d&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">  <span class="attr">tlias:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">tlias-server</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-tlias</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/conf/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">tlias-net:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">itheima</span></span><br></pre></td></tr></table></figure><p>根据compose定义的路径在文件夹下新建空文件夹，然后将以下文件存放在文件夹中</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874bc04e9c7b.png" alt="image-20250714161252989"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker compose [<span class="type">OPTIONS</span>] [<span class="type">COMMAND</span>]</span><br></pre></td></tr></table></figure><p>其中，OPTIONS和COMMAND都是可选参数，比较常见的有：</p><table><thead><tr><th><strong>类型</strong></th><th><strong>参数或指令</strong></th><th style="text-align:center"><strong>说明</strong></th></tr></thead><tbody><tr><td>Options</td><td>-f</td><td style="text-align:center">指定compose文件的路径和名称</td></tr><tr><td></td><td>-p</td><td style="text-align:center">指定project名称。project就是当前compose文件中设置的多个service的集合，是逻辑概念</td></tr><tr><td>Commands</td><td>up</td><td style="text-align:center">创建并启动所有service容器</td></tr><tr><td></td><td>down</td><td style="text-align:center">停止并移除所有容器、网络</td></tr><tr><td></td><td>ps</td><td style="text-align:center">列出所有启动的容器</td></tr><tr><td></td><td>logs</td><td style="text-align:center">查看指定容器的日志</td></tr><tr><td></td><td>stop</td><td style="text-align:center">停止容器</td></tr><tr><td></td><td>start</td><td style="text-align:center">启动容器</td></tr><tr><td></td><td>restart</td><td style="text-align:center">重启容器</td></tr><tr><td></td><td>top</td><td style="text-align:center">查看运行的进程</td></tr><tr><td></td><td>exec</td><td style="text-align:center">在指定的运行中容器中执行命令</td></tr></tbody></table><ol><li><p>创建容器</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment"># docker compose up -d</span></span><br><span class="line">[+] Running <span class="number">11</span>/<span class="number">11</span></span><br><span class="line"> ✔ mysql Pulled                                                           <span class="number">94.0</span>s</span><br><span class="line">   ✔ <span class="number">90</span>dac1e734aa Already exists                                           <span class="number">0.0</span>s</span><br><span class="line">   ✔ bf40b60a847d Pull complete                                           <span class="number">32.0</span>s</span><br><span class="line">   ✔ <span class="number">9</span>d9cb66e1171 Pull complete                                           <span class="number">32.1</span>s</span><br><span class="line">   ✔ <span class="number">31</span>b29e08d2d1 Pull complete                                           <span class="number">32.8</span>s</span><br><span class="line">   ✔ <span class="number">1</span>f5a1dfb5b55 Pull complete                                           <span class="number">32.8</span>s</span><br><span class="line">   ✔ <span class="number">7</span>becd864c61c Pull complete                                           <span class="number">32.8</span>s</span><br><span class="line">   ✔ <span class="number">00</span>a0a1479659 Pull complete                                           <span class="number">35.0</span>s</span><br><span class="line">   ✔ cff841917be4 Pull complete                                           <span class="number">35.0</span>s</span><br><span class="line">   ✔ <span class="number">8</span>e98c1c43da6 Pull complete                                           <span class="number">76.4</span>s</span><br><span class="line">   ✔ <span class="number">61</span>ba5ff08093 Pull complete                                           <span class="number">76.4</span>s</span><br><span class="line">[+] Building <span class="number">38.5</span>s (<span class="number">11</span>/<span class="number">11</span>) FINISHED                              docker:default</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load build definition from Dockerfile                 <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">818</span>B                                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load metadata <span class="keyword">for</span> docker.io/library/centos:<span class="number">7</span>         <span class="number">36.3</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load .dockerignore                                    <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                            <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="number">1</span>/<span class="number">6</span>] FROM docker.io/library/centos:<span class="number">7</span>@sha256:be65f488b7764ad363  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span> <span class="built_in">int</span><span class="type">ernal</span>] load build context                                    <span class="number">2.1</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">232.73</span>MB                                      <span class="number">2.1</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">2</span>/<span class="number">6</span>] <span class="built_in">COPY</span> jdk21.tar.gz /usr/local/                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">3</span>/<span class="number">6</span>] RUN tar <span class="literal">-xzf</span> /usr/local/jdk21.tar.gz <span class="literal">-C</span> /usr/local  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">4</span>/<span class="number">6</span>] RUN mkdir <span class="literal">-p</span> /tlias                                 <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">5</span>/<span class="number">6</span>] WORKDIR /tlias                                      <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="type">tlias</span> <span class="number">6</span>/<span class="number">6</span>] <span class="built_in">COPY</span>  tlias.jar  tlias.jar                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="type">tlias</span>] exporting to image                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                    <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:e2a98bd74211094262b8ba068f777e782edeba8b11cdf  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/app<span class="literal">-tlias</span>                               <span class="number">0.0</span>s</span><br><span class="line">[+] Running <span class="number">4</span>/<span class="number">4</span></span><br><span class="line"> ✔ Network itheima         Created                                         <span class="number">0.1</span>s</span><br><span class="line"> ✔ Container mysql         Started                                         <span class="number">1.2</span>s</span><br><span class="line"> ✔ Container tlias<span class="literal">-server</span>  Started                                         <span class="number">1.2</span>s</span><br><span class="line"> ✔ Container nginx<span class="literal">-tlias</span>   Started   </span><br></pre></td></tr></table></figure></li><li><p>开始停止容器</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment"># docker compose stop</span></span><br><span class="line">[+] Stopping <span class="number">3</span>/<span class="number">3</span></span><br><span class="line"> ✔ Container nginx<span class="literal">-tlias</span>   Stopped                                         <span class="number">0.2</span>s</span><br><span class="line"> ✔ Container tlias<span class="literal">-server</span>  Stopped                                         <span class="number">0.2</span>s</span><br><span class="line"> ✔ Container mysql         Stopped                                         <span class="number">2.9</span>s</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment"># docker compose start</span></span><br><span class="line">[+] Running <span class="number">3</span>/<span class="number">3</span></span><br><span class="line"> ✔ Container mysql         Started                                         <span class="number">0.3</span>s</span><br><span class="line"> ✔ Container tlias<span class="literal">-server</span>  Started                                         <span class="number">0.3</span>s</span><br><span class="line"> ✔ Container nginx<span class="literal">-tlias</span>   Started                                         <span class="number">0.4</span>s</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">app</span>]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>🥲心心念念的Docker终于结束了</p></li></ol><h1>二、微服务01</h1><h3 id="1-导入后端项目">1. 导入后端项目</h3><p>导入后端项目启动项目时报了错误</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.reflect.InaccessibleObjectException</span><br></pre></td></tr></table></figure><p>看弹幕说时因为MyBatisPlus版本与Java高版本冲突导致的反射问题</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/14/6874f9c876c67.png" alt="image-20250714203620847"></p><p>配置vm</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="literal">--add-opens</span> java.base/java.lang.invoke=ALL<span class="literal">-UNNAMED</span></span><br></pre></td></tr></table></figure><p>即可解决</p><h4 id="解决时区不同步问题">解决时区不同步问题</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/68759b7de967c.png" alt="image-20250715080613698"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># date</span></span><br><span class="line"><span class="number">2025</span>年 <span class="number">07</span>月 <span class="number">14</span>日 星期一 <span class="number">21</span>:<span class="number">22</span>:<span class="number">05</span> CST</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># hwclock</span></span><br><span class="line"><span class="number">2025</span>年<span class="number">07</span>月<span class="number">14</span>日 星期一 <span class="number">21</span>时<span class="number">22</span>分<span class="number">51</span>秒  <span class="literal">-0</span>.<span class="number">695010</span> 秒</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># systemctl status ntpd</span></span><br><span class="line">● ntpd.service - Network Time Service</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 一 <span class="number">2025</span><span class="literal">-07-14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> CST; <span class="number">10</span><span class="built_in">h</span> ago</span><br><span class="line">  <span class="keyword">Process</span>: <span class="number">43362</span> ExecStart=/usr/sbin/ntpd <span class="literal">-u</span> ntp:ntp <span class="variable">$OPTIONS</span> (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"> Main PID: <span class="number">43363</span> (ntpd)</span><br><span class="line">    Tasks: <span class="number">1</span></span><br><span class="line">   Memory: <span class="number">624.0</span>K</span><br><span class="line">   CGroup: /system.slice/ntpd.service</span><br><span class="line">           └─<span class="number">43363</span> /usr/sbin/ntpd <span class="literal">-u</span> ntp:ntp <span class="literal">-g</span></span><br><span class="line"></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: Listen normally on <span class="number">9</span> ens33 fe80::<span class="number">8396</span>:<span class="number">4</span>bf:<span class="number">9262</span>:f21 UDP <span class="number">123</span></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: Listen normally on <span class="number">10</span> veth1ba4f03 fe80::<span class="number">3</span>cd2:e1ff:fe8b:fa0a UDP <span class="number">123</span></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: Listening on routing socket on fd <span class="comment">#27 for interface updates</span></span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c016 <span class="number">06</span> restart</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c012 <span class="number">02</span> freq_set kernel <span class="number">0.000</span> PPM</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c011 <span class="number">01</span> freq_not_set</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">01</span> localhost systemd[<span class="number">1</span>]: Started Network Time Service.</span><br><span class="line"><span class="number">7</span>月 <span class="number">14</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">09</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c61c <span class="number">0</span>c clock_step +<span class="number">38329.171798</span> s</span><br><span class="line"><span class="number">7</span>月 <span class="number">15</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">58</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c614 <span class="number">04</span> freq_mode</span><br><span class="line"><span class="number">7</span>月 <span class="number">15</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">59</span> localhost ntpd[<span class="number">43363</span>]: <span class="number">0.0</span>.<span class="number">0.0</span> c618 <span class="number">08</span> no_sys_peer</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># date</span></span><br><span class="line"><span class="number">2025</span>年 <span class="number">07</span>月 <span class="number">15</span>日 星期二 <span class="number">08</span>:<span class="number">02</span>:<span class="number">44</span> CST</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-单体架构与微服务">2. 单体架构与微服务</h3><p>单体架构:将业务的所有功能集中在一个项目中开发，打成一个包部署。</p><p>优点：架构简单，部署成本低</p><p>缺点：团队协作成本高，系统发布效率低，系统可用性差</p><p>微服务架构，是服务化思想指导下的一套最佳实践架构方案。服务化，就是把单体架构中的功能模块拆分为多个独立项目。</p><h3 id="3-微服务拆分原则">3. 微服务拆分原则</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/68759e54a2d78.png" alt="image-20250715081827665"></p><p>什么时候需要拆分微服务？</p><ul><li>如果是创业型公司，最好先用单体架构快速迭代开发，验证市场运作模型，快速试错。当业务跑通以后，随着业务规模扩大、人员规模增加，再考虑拆分微服务。</li><li>如果是大型企业，有充足的资源，可以在项目开始之初就搭建微服务架构</li></ul><p>如何拆分？</p><ul><li>首先要做到高内聚、低耦合</li><li>从拆分方式来说，有横向拆分和纵向拆分两种。纵向就是按照业务功能模块，横向则是拆分通用性业务，提高复用性</li></ul><p>服务拆分之后，不可避免的会出现跨微服务的业务，此时微服务之间就需要进行远程调用。微服务之间的远程调用被称为RPC，即远程过程调用。RPC的实现方式有很多，比如：</p><ul><li>基于Http协议</li><li>基于Dubbo协议</li></ul><p>我们使用的是Http方式，这种方式不关心服务提供者的具体技术实现，只要对外暴露Http接口即可，更符合微服务的需要。</p><h3 id="4-远程调用（RPC）">4. 远程调用（RPC）</h3><p>在拆分的时候，我们发现一个问题：就是购物车业务中需要查询商品信息，但商品信息查询的逻辑全部迁移到了<code>item-service</code>服务，导致我们无法查询。</p><p>最终结果就是查询到的购物车数据不完整，因此要想解决这个问题，我们就必须改造其中的代码，把原本本地方法调用，改造成跨微服务的远程调用（RPC，即<strong>R</strong>emote <strong>P</strong>roduce <strong>C</strong>all）。</p><p>因此，现在查询购物车列表的流程变成了这样：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/6875bf1040313.png" alt="image-20250715103806173"></p><p>那么问题来了：我们该如何跨服务调用，准确的说，如何在<code>cart-service</code>中获取<code>item-service</code>服务中的提供的商品数据呢？</p><p>答案是肯定的，我们前端向服务端查询数据，其实就是从浏览器远程查询服务端数据。比如我们刚才通过Swagger测试商品查询接口，就是向<code>http://localhost:8081/items</code>这个接口发起的请求：</p><p>而这种查询就是通过http请求的方式来完成的，不仅仅可以实现远程查询，还可以实现新增、删除等各种远程请求。<br>那么：我们该如何用Java代码发送Http的请求呢？</p><h4 id="4-1-RestTemplate">4.1 RestTemplate</h4><p>Java发送http请求可以使用Spring提供的RestTemplate，使用的基本步骤如下：</p><ul><li>注册RestTemplate到Spring容器</li><li>调用RestTemplate的API发送请求，常见方法有：<ul><li>getForObject：发送Get请求并返回指定类型对象</li><li>PostForObject：发送Post请求并返回指定类型对象</li><li>put：发送PUT请求</li><li>delete：发送Delete请求</li><li>exchange：发送任意类型请求，返回ResponseEntity</li></ul></li></ul><p>感觉这种如果有大量用户同时请求不会变的很卡吗？？？？？？</p><div class="note blue anzhiyufont anzhiyu-icon-bullhorn modern"><p>构造器注入</p></div><details class="folding-tag" green><summary>构造器注入</summary><div class="content"><p>Spring推荐我们使用Lombok构造器注入而不是使用<code>@Autowired</code></p><p>因此我们可以在类上添加<code>@RequiredArgsConstructor</code>注解，使用<code>final</code>注入类</p><p>eg：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/6875c44601fb1.png" alt="image-20250715110020446"></p></div></details><h4 id="4-2-注册中心">4.2 注册中心</h4><p>在微服务远程调用的过程中，包括两个角色：</p><ul><li>服务提供者：提供接口供其它微服务访问，比如<code>item-service</code></li><li>服务消费者：调用其它微服务提供的接口，比如<code>cart-service</code></li><li>服务者可以是消费者，消费者也可以是服务者</li></ul><p>在大型微服务项目中，服务提供者的数量会非常多，为了管理这些服务就引入了<strong>注册中心</strong>的概念。注册中心、服务提供者、服务消费者三者间关系如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/687642f91dee1.png" alt="image-20250715200054715"></p><p>流程如下：</p><ul><li>服务启动时就会注册自己的服务信息（服务名、IP、端口）到注册中心</li><li>调用者可以从注册中心订阅想要的服务，获取服务对应的实例列表（1个服务可能多实例部署）</li><li>调用者自己对实例列表负载均衡，挑选一个实例</li><li>调用者向该实例发起远程调用</li></ul><p>当服务提供者的实例宕机或者启动新实例时，调用者如何得知呢？</p><ul><li>服务提供者会定期向注册中心发送请求，报告自己的健康状态（心跳请求）</li><li>当注册中心长时间收不到提供者的心跳时，会认为该实例宕机，将其从服务的实例列表中剔除</li><li>注册中心一旦认为某个实例宕机并将其剔除实例列表，那么其他服务的调用者就无法再调用这个实例。</li><li>当服务有新实例启动时，会发送注册服务请求，其信息会被记录在注册中心的服务实例列表</li><li>当注册中心服务列表变更时，会主动通知微服务，更新本地服务列表</li></ul><h4 id="4-3-Nacos注册中心">4.3 Nacos注册中心</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> nacos \</span><br><span class="line"><span class="literal">--env-file</span> ./nacos/custom.env \</span><br><span class="line"><span class="literal">-p</span> <span class="number">8848</span>:<span class="number">8848</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">9848</span>:<span class="number">9848</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">9849</span>:<span class="number">9849</span> \</span><br><span class="line"><span class="literal">--restart</span>=always \</span><br><span class="line"><span class="literal">--network</span> hm<span class="literal">-net</span> \</span><br><span class="line">nacos/nacos<span class="literal">-server</span>:v2.<span class="number">1.0</span><span class="literal">-slim</span></span><br></pre></td></tr></table></figure><p>访问路径</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8848</span>/nacos</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/15/68764c4d39516.png" alt="image-20250715204042672"></p><h4 id="4-4-OpenFeign">4.4 OpenFeign</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/687759c72d8e2.png" alt="image-20250716155017015"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/68775a37c9c09.png" alt="image-20250716155218953"></p><p>哇神奇</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/68775f9635517.png" alt="image-20250716161513007"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/16/687765ea25acb.png" alt="image-20250716164213666"></p><ol><li>将来Feign可以根据服务名称去注册中心中去拉取实例列表</li><li>Feign会使用负载均衡自动获取一个实例（我们在pom中引入了负载均衡的依赖了）</li><li>然后定义GET请求，路径为<code>/items</code>,</li></ol><h4 id="4-5-连接池">4.5 连接池</h4><p>连接池指的是一组预先创建的 HTTP 连接，这些连接可以被重复使用，而不是每次请求都创建一个新的连接。</p><p>在 Feign 中，不同的 HTTP 客户端实现对连接池的支持有所不同：</p><p><code>HttpURLConnection</code>：</p><p>这是 Java 的默认 HTTP 客户端实现，不支持连接池。每次请求都会创建一个新的连接，请求完成后连接会被关闭。这种方式在高并发场景下性能较差。</p><p><code>Apache HttpClient</code>：</p><p>这是一个功能强大的 HTTP 客户端库，支持连接池。通过配置连接池，可以复用连接，提高性能。</p><p><code>OKHttp</code>：</p><p>这是另一个流行的 HTTP 客户端库，也支持连接池。OKHttp 的连接池实现高效且易于配置，适合在高并发场景下使用。</p><p>OpenFeign对Http请求做了优雅的伪装，不过其底层发起http请求，依赖于其它的框架。这些框架可以自己选择，包括以下三种:</p><ul><li>HttpURLConnection:默认实现，不支持连接池</li><li>Apache Httpclient:支持连接池</li><li>OKHttp:支持连接池</li></ul><p>具体源码可以参考FeignBlockingLoadBalancerClient类中的delegate成员变量。</p><p>因此我们通常会使用带有连接池的客户端来代替默认的HttpURLConnection。比如，我们使用OK Http</p><p>在<code>cart-service</code>的<code>pom.xml</code>中引入依赖：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!--OK http 的依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;feign-okhttp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>在<code>cart-service</code>的<code>application.yml</code>配置文件中开启Feign的连接池功能：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">feign:</span><br><span class="line">  okhttp:</span><br><span class="line">    enabled: <span class="literal">true</span> # 开启OKHttp功能</span><br></pre></td></tr></table></figure><h4 id="4-6-最佳实践">4.6 最佳实践</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/19/687b4ef5b6320.png" alt="image-20250719155315118"></p><p>方案1抽取更加简单，工程结构也比较清晰，但缺点是整个项目耦合度偏高。</p><p>方案2抽取相对麻烦，工程结构相对更复杂，但服务之间耦合度降低。</p><p>@SpringBootApplication这个注解中包含了@ComponentScan, 这个注解会扫描当前包(com.hmall.cart)中的文件, 而ItemClient由于被抽离到hm-api模块包下(com.hmall.api), 两者包的位置不同, 所以springboot扫描不到. 那么解决方法有: 1. 扩大扫描包的范围, 那么在启动类上添加&quot;@ComponentScan({“com.hmall.cart”,“com.hmall.api”})“, 但此方法不推荐. 2. 使用”@import&quot;注解, &quot;@EnableFeignClients&quot;就包含了@import注解, 由第三方依赖提供的 @EnableXxxxx注解, basePackages选项可以简化我们的操作, 不需要自己使用@Import.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/19/687b550a170a4.png" alt="image-20250719161917933"></p><h4 id="4-6-日志输出">4.6 日志输出</h4><p>OpenFeign只会在FeignClient所在包的日志级别为<strong>DEBUG</strong>时，才会输出日志。而且其日志级别有4级：</p><ul><li><strong>NONE</strong>：不记录任何日志信息，这是默认值。</li><li><strong>BASIC</strong>：仅记录请求的方法，URL以及响应状态码和执行时间</li><li><strong>HEADERS</strong>：在BASIC的基础上，额外记录了请求和响应的头信息</li><li><strong>FULL</strong>：记录所有请求和响应的明细，包括头信息、请求体、元数据。</li></ul><p>Feign默认的日志级别就是NONE，所以默认我们看不到请求日志。一般也不开启feign的日志配置，只有在需要调试feign的时候才开启日志，因为日志输出的内容有很多，输出时会影响性能。</p><h5 id="定义日志级别">定义日志级别</h5><p>在hm-api模块下新建一个配置类，定义Feign的日志级别：</p><p>接下来，要让日志级别生效，还需要配置这个类。有两种方式：</p><ul><li><strong>局部</strong>生效：在某个<code>FeignClient</code>中配置，只对当前<code>FeignClient</code>生效</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;, configuration = DefaultFeignConfig.class)</span></span><br></pre></td></tr></table></figure><ul><li><strong>全局</strong>生效：在<code>@EnableFeignClients</code>中配置，针对所有<code>FeignClient</code>生效。</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = DefaultFeignConfig.class)</span></span><br></pre></td></tr></table></figure><h1>三、 微服务02</h1><p>由于每个微服务都有不同的地址或端口，入口不同，相信大家在与前端联调的时候发现了一些问题：</p><ul><li>请求不同数据时要访问不同的入口，需要维护多个入口地址，麻烦</li><li>前端无法调用nacos，无法实时更新服务列表</li></ul><p>单体架构时我们只需要完成一次用户登录、身份校验，就可以在所有业务中获取到用户信息。而微服务拆分后，每个微服务都独立部署，这就存在一些问题：</p><ul><li>每个微服务都需要编写登录校验、用户信息获取的功能吗？</li><li>当微服务之间调用时，该如何传递用户信息？</li></ul><p>不要着急，这些问题都可以在今天的学习中找到答案，我们会通过<strong>网关</strong>技术解决上述问题。今天的内容会分为3章：</p><ul><li>第一章：网关路由，解决前端请求入口的问题。</li><li>第二章：网关鉴权，解决统一登录校验和用户信息获取的问题。</li><li>第三章：统一配置管理，解决微服务的配置文件重复和配置热更新问题。</li></ul><p>通过今天的学习你将掌握下列能力：</p><ul><li>会利用微服务网关做请求路由</li><li>会利用微服务网关做登录身份校验</li><li>会利用Nacos实现统一配置管理</li><li>会利用Nacos实现配置热更新</li></ul><h2 id="1-网关路由">1. 网关路由</h2><p>网关就是<strong>网</strong>络的<strong>关</strong>口。数据在网络间传输，从一个网络传输到另一网络时就需要经过网关来做数据的<strong>路由和转发以及数据安全的校验</strong>。</p><p>更通俗的来讲，网关就像是以前园区传达室的大爷。</p><ul><li>外面的人要想进入园区，必须经过大爷的认可，如果你是不怀好意的人，肯定被直接拦截。</li><li>外面的人要传话或送信，要找大爷。大爷帮你带给目标人。</li></ul><p>现在，微服务网关就起到同样的作用。前端请求不能直接访问微服务，而是要请求网关：</p><ul><li>网关可以做安全控制，也就是登录身份校验，校验通过才放行</li><li>通过认证后，网关再根据请求判断应该访问哪个微服务，将请求转发过去</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/20/687c38bd937a6.png" alt="image-20250720083051495"></p><p><code>Route</code>（路由）: 网关的基本构件。它由一个ID、一个目的地URI、一个断言（Predicate）集合和一个过滤器（Filter）集合定义。如果断言为真，则路由被匹配。</p><p>网关也相当于一个微服务，其会注册到nacos，并拉取所有的服务信息，所以要获取某个微服务对网关来说不是难事</p><p>迷迷糊糊说这么多还是不知道网关是什么🥲🥲</p><ol><li>前端发送的请求先发给网关，网关进行校验完毕之后使用负载均衡请求到具体的微服务中</li><li>前端只要知道网关地址即可（8080），前端所有请求地址都为8080那么就会到达网关，然后网关会根据前端的请求来去判断应该由哪个微服务来处理（判断过程就是请求的路由 ），然后网关就会帮你的请求转发到具体的微服务（路由转发）</li><li>网关可以利用注册中心（所有的微服务接口都存放在了注册中心），拉取所有的服务中心</li><li>网关来负责身份校验，这样转发就不用在此校验了</li></ol><h3 id="1-1-网关快速入门">1.1 网关快速入门</h3><p>网关也相当于一个微服务，其会注册到nacos，并拉取所有的服务信息，所以要获取某个微服务对网关来说不是难事。</p><p>接下来，在<code>hm-gateway</code>模块的<code>resources</code>目录新建一个<code>application.yaml</code>文件，内容如下：</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span> <span class="comment"># 路由规则id，自定义，唯一</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span> <span class="comment"># 路由的目标服务，lb代表负载均衡，会从注册中心拉取服务列表</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，判断当前请求是否符合当前规则，符合则路由到目标服务</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span> <span class="comment"># 这里是以请求路径作为判断规则</span></span><br></pre></td></tr></table></figure><h3 id="1-2-路由属性">1.2 路由属性</h3><p>网关路由对应的Java类型是RouteDefinition，其中常见的属性有</p><ul><li>id:路由唯一标示</li><li>uri:路由目标地址</li><li>predicates:路由断言，判断请求是否符合当前路由。</li><li>filters:路由过滤器，对请求或响应做特殊处理。</li></ul><h4 id="路由断言">路由断言</h4><table><thead><tr><th style="text-align:center"><strong>名称</strong></th><th style="text-align:center"><strong>说明</strong></th><th style="text-align:center"><strong>示例</strong></th></tr></thead><tbody><tr><td style="text-align:center">After</td><td style="text-align:center">是某个时间点后的请求</td><td style="text-align:center">- After=2037-01-20T17:42:47.789-07:00[America/Denver]</td></tr><tr><td style="text-align:center">Before</td><td style="text-align:center">是某个时间点之前的请求</td><td style="text-align:center">- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td></tr><tr><td style="text-align:center">Between</td><td style="text-align:center">是某两个时间点之前的请求</td><td style="text-align:center">- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</td></tr><tr><td style="text-align:center">Cookie</td><td style="text-align:center">请求必须包含某些cookie</td><td style="text-align:center">- Cookie=chocolate, ch.p</td></tr><tr><td style="text-align:center">Header</td><td style="text-align:center">请求必须包含某些header</td><td style="text-align:center">- Header=X-Request-Id, \d+</td></tr><tr><td style="text-align:center">Host</td><td style="text-align:center">请求必须是访问某个host（域名）</td><td style="text-align:center">- <a target="_blank" rel="noopener" href="http://Host=.somehost.org">Host=.somehost.org</a>,.anotherhost.org</td></tr><tr><td style="text-align:center">Method</td><td style="text-align:center">请求方式必须是指定方式</td><td style="text-align:center">- Method=GET,POST</td></tr><tr><td style="text-align:center">Path</td><td style="text-align:center">请求路径必须符合指定规则</td><td style="text-align:center">- Path=/red/{segment},/blue/**</td></tr><tr><td style="text-align:center">Query</td><td style="text-align:center">请求参数必须包含指定参数</td><td style="text-align:center">- Query=name, Jack或者- Query=name</td></tr><tr><td style="text-align:center">RemoteAddr</td><td style="text-align:center">请求者的ip必须是指定范围</td><td style="text-align:center">- RemoteAddr=192.168.1.1/24</td></tr><tr><td style="text-align:center">weight</td><td style="text-align:center">权重处理</td><td style="text-align:center"></td></tr></tbody></table><h4 id="路由过滤器">路由过滤器</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">说明</th><th style="text-align:center">示例</th></tr></thead><tbody><tr><td style="text-align:center">AddRequestHeader</td><td style="text-align:center">给当前请求添加一个请求头</td><td style="text-align:center">AddrequestHeader=headerName, headerValue</td></tr><tr><td style="text-align:center">RemoveRequestHeader</td><td style="text-align:center">移除请求中的一个请求头</td><td style="text-align:center">RemoveRequestHeader=headerName</td></tr><tr><td style="text-align:center">AddResponseHeader</td><td style="text-align:center">给响应结果中添加一个响应头</td><td style="text-align:center">AddResponseHeader=headerName , headerValue</td></tr><tr><td style="text-align:center">RemoveResponseHeader</td><td style="text-align:center">从响应结果中移除有一个响应头</td><td style="text-align:center">RemoveResponseHeader=headerName</td></tr><tr><td style="text-align:center">RewritePath</td><td style="text-align:center">请求路径重写</td><td style="text-align:center">RewritePath=/red/ ? ( ?&lt;segment&gt;.*)，/$\l{segment]</td></tr><tr><td style="text-align:center">StripPrefix</td><td style="text-align:center">去除请求路径中的N段前缀</td><td style="text-align:center">StripPrefix=1，则路径/a/b转发时只保留/b</td></tr></tbody></table><h2 id="2-网关登录">2. 网关登录</h2><p>单体架构时我们只需要完成一次用户登录、身份校验，就可以在所有业务中获取到用户信息。而微服务拆分后，每个微服务都独立部署，不再共享数据。也就意味着每个微服务都需要做登录校验，这显然不可取。</p><p>我们的登录是基于JWT来实现的，校验JWT的算法复杂，而且需要用到秘钥。如果每个微服务都去做登录校验，这就存在着两大问题：</p><ul><li>每个微服务都需要知道JWT的秘钥，不安全</li><li>每个微服务重复编写登录校验代码、权限校验代码，麻烦</li></ul><p>既然网关是所有微服务的入口，一切请求都需要先经过网关。我们完全可以把登录校验的工作放到网关去做，这样之前说的问题就解决了：</p><ul><li>只需要在网关和用户服务保存秘钥</li><li>只需要在网关开发登录校验功能</li></ul><p>此时，登录校验的流程如图：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/20/687c55b28e6dd.png" alt="image-20250720103424790"></p><p>不过，这里存在几个问题：</p><ul><li>网关路由是配置的，请求转发是Gateway内部代码，我们如何在转发之前做登录校验？</li><li>网关校验JWT之后，如何将用户信息传递给微服务？</li><li>微服务之间也会相互调用，这种调用不经过网关，又该如何传递用户信息？</li></ul><h3 id="2-1-网关过滤器">2.1 网关过滤器</h3><p>登录校验必须在请求转发到微服务之前做，否则就失去了意义。而网关的请求转发是<code>Gateway</code>内部代码实现的，要想在请求转发之前做登录校验，就必须了解<code>Gateway</code>内部工作的基本原理。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/20/687c576d672c9.png" alt="image-20250720104147586"></p><ol><li>网关内部是没有业务逻辑的，他的任务是基于我们配的路由规则然后判断一下前端请求，到底该由哪个微服务处理，然后将请求转发到对应的微服务</li><li>而进行路由判断的功能就是由一个叫<code>handlerMapping</code>的接口来处理的<code>HandlerMapping</code>的默认实现是<br><code>RoutePredicateHandlerMapping</code>(路由断言).<code>HandlerMapping</code>根据请求找到匹配的路由并存入上下文，然后把请求交给webHandler处理。</li><li><code>WebHandler</code>默认实现是<code>FilteringwebHandler</code> ,顾名思义是一个过滤器处理器。它会加载网关中配置的多个过滤器，放入集合并排序，形成过滤器链。然后依次执行这些过滤器。</li><li>而整个过滤链的最后要执行<code>NettyRoutingFilter</code>，负责将请求转发到微服务，当微服务返回结果后存入上下文</li><li>接着依次传递给其他过滤器，最终返回给用户</li><li>过滤器内部可以包含两部分逻辑，分别是pre和post，分别会在请求路由到微服务之前和之后执行。</li><li>当所有Filter的pre逻辑都依次顺序执行通过后，请求才会被路由到微服务，否则会被拦截，后续过滤器不再执行。微服务返回结果后，再倒序执行Filter的post逻辑</li><li>如果我们能够定义一个过滤器，在其中实现登录校验逻辑，并且将过滤器执行顺序定义到<code>NettyRoutingFilter</code>之前，这就符合我们的需求了！</li><li>可以将用户信息保存在请求头中，然后传递给微服务，然后微服务在从请求头中取出用户信息</li></ol><h3 id="2-2-自定义过滤器">2.2 自定义过滤器</h3><p>网关过滤器链中的过滤器有两种：</p><ul><li><strong><code>GatewayFilter</code></strong>：路由过滤器，作用范围比较灵活，可以是任意指定的路由<code>Route</code>. （配置的过滤器，有33种，默认不生效，配置到哪一个路由下之后就对配置的路由生效。配置到default-filter：之后就会对所有路由生效（这样就不必在所有的路由中配置类，但是所属类别依旧是GatewayFilter）。）</li><li><strong><code>GlobalFilter</code></strong>：全局过滤器，作用范围是所有路由，不可配置。</li></ul><h3 id="2-3-实现登录校验">2.3 实现登录校验</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(AuthProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTool jwtTool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthProperties authProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取Request</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// 2.判断是否不需要拦截</span></span><br><span class="line">        <span class="keyword">if</span>(isExclude(request.getPath().toString()))&#123;</span><br><span class="line">            <span class="comment">// 无需拦截，直接放行</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.获取请求头中的token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        List&lt;String&gt; headers = request.getHeaders().get(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!CollUtils.isEmpty(headers)) &#123;</span><br><span class="line">            token = headers.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.校验并解析token</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userId = jwtTool.parseToken(token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnauthorizedException e) &#123;</span><br><span class="line">            <span class="comment">// 如果无效，拦截</span></span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            response.setRawStatusCode(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 5.如果有效，传递用户信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;userId = &quot;</span> + userId);</span><br><span class="line">        <span class="comment">// 6.放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExclude</span><span class="params">(String antPath)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String pathPattern : authProperties.getExcludePaths()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(antPathMatcher.match(pathPattern, antPath))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>对于AntPathMatcher，虽然它是Spring框架的一部分，但它并不是由Spring管理的Bean。AntPathMatcher是一个工具类，用于匹配Ant风格的路径模式，它没有定义为Spring的Bean，因此Spring容器不知道如何自动注入它。</p><p>为什么需要手动创建AntPathMatcher实例？</p><p>工具类：AntPathMatcher是一个工具类，通常不需要Spring管理其生命周期。工具类是无状态的，可以在任何地方实例化和使用。</p><p>非单例：由于AntPathMatcher是无状态的，它不需要作为单例Bean管理。每次使用时创建一个新的实例是安全的，不会导致资源浪费或状态不一致的问题。</p><p>简单性：手动创建AntPathMatcher实例非常简单，只需要使用new关键字即可。这种方式代码清晰，易于理解</p></li></ul><h3 id="2-4-网关传递用户">2.4 网关传递用户</h3><p>现在，网关已经可以完成登录校验并获取登录用户身份信息。但是当网关将请求转发到微服务时，微服务又该如何获取用户身份呢？</p><p>由于网关发送请求到微服务依然采用的是<code>Http</code>请求，因此我们可以将用户信息以请求头的方式传递到下游微服务。然后微服务可以从请求头中获取登录用户信息。考虑到微服务内部可能很多地方都需要用到登录用户信息，因此我们可以利用SpringMVC的拦截器来实现登录用户信息获取，并存入ThreadLocal，方便后续使用。</p><p>据图流程图如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/21/687e269e78f41.png" alt="image-20250721193804387"></p><p>因此，接下来我们要做的事情有：</p><ul><li>改造网关过滤器，在获取用户信息后保存到请求头，转发到下游微服务</li><li>编写微服务拦截器，拦截请求获取用户信息，保存到<code>ThreadLocal</code>后放行</li></ul><h4 id="保存用户到请求头">保存用户到请求头</h4><p>首先，我们修改登录校验拦截器的处理逻辑，保存用户信息到请求头中：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/22/687f7b34da201.png" alt="image-20250722195113363"></p><p>修改<code>AuthGlobalFilter</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 5.如果有效，传递用户信息</span></span><br><span class="line">        <span class="comment">// mutate()方法可以对下游请求做更改，.request表示对请求做处理，利用builder可以对请求中各种信息做修改</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> userId.toString();</span><br><span class="line">        <span class="type">ServerWebExchange</span> <span class="variable">swe</span> <span class="operator">=</span> exchange.mutate()</span><br><span class="line">                .request(builder -&gt; builder.header(<span class="string">&quot;user-Info&quot;</span>, userInfo))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// 6.放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(swe);</span><br></pre></td></tr></table></figure><ul><li>拦截器先通过 Token 解析出<code>userId</code>，再将其放入请求头；</li><li>后续的 Controller 可以直接从请求头<code>user-Info</code>中获取<code>userId</code>，无需再次解析 Token，提高效率。</li></ul><h4 id="拦截器获取用户">拦截器获取用户</h4><p>需求:由于每个微服务都可能有获取登录用户的需求，因此我们直接在hm-common模块定义拦截器，这样微服务只需要引入依赖即可生效，无需重复编写。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.common.interceptors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.hmall.common.utils.UserContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.获取请求头中的用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;user-info&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.判断是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(userInfo)) &#123;</span><br><span class="line">            <span class="comment">// 不为空，保存到ThreadLocal</span></span><br><span class="line">            UserContext.setUser(Long.valueOf(userInfo));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 移除用户</span></span><br><span class="line">        UserContext.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里只是写了一个拦截器类，但是并没有注册到<code>springmvc</code>拦截器里。要想注册进去需要进行配置：编写<code>config</code>配置类<code>WebMvcConfigurer</code> ，将其add进去</p><p>当请求从 Spring Cloud Gateway（WebFlux、Netty驱动）进入下游 Spring MVC 微服务时，exchange 不会被直接传递，而是 自动被底层 HTTP 协议转换为标准的 HttpServletRequest 和 HttpServletResponse。</p><p>spring-web通过线程池复用线程，并且不是每次使用user-service都会覆盖user信息，所以有必要在一次请求完成后清理user信息</p><p>拦截器生命周期：</p><p>preHandle() → 2. Controller &amp; Service等 → 3. postHandle()（如有） → 4. afterCompletion()</p><p>特殊情况处理如果请求在 preHandle 返回 false（拦截请求）：不会执行 Controller，但 仍会触发 afterCompletion（Spring 5.3+ 行为）。</p><h4 id="配置拦截器">配置拦截器</h4><p>springMVC拦截器需要配置@configuration，进行配置才能生效</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">UserInfoInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>通过 registry.addInterceptor(new UserInfoInterceptor()) 将一个名为 UserInfoInterceptor 的拦截器添加到拦截器注册表中。这样自定义的拦截器才会生效</li><li>添加@ConditionalOnClass(DispatcherServlet.class)的原因：因为hm-gateway中也引用了common模块，而我们知道gateway使用的openfeign虽然也处理http请求，但是底层不是靠SpringMvc实现的，而现在设计了只要引用common这个包就会自动装配MvcConfig配置类，然而hm-gateway底层没有springmvc自然无法自动装配MvcConfig配置类，会报错。所以我们需要设计成只有依赖了SpringMvc的微服务模块才自动装配，而SpringMvc的核心类就是DispatcherServlet.class，所以只有有DispatcherServlet.class这个类的微服务模块才会自动装配MvcConfig配置类</li><li>@ConditionalOnClass 是 Spring Boot 中的一个条件注解，它用于在特定类存在于类路径上时才启用配置。因此特定的类就是DispatcherServlet.class只要再pom.xml中加入spring-boot-starter-web就会存在DispatcherServlet类</li><li>DispatcherServlet.class 是 Spring MVC 的核心组件之一，通常用于处理 HTTP 请求。如果存在 DispatcherServlet，说明当前项目中使用了 Spring MVC，Spring 会加载 MvcConfig 配置类</li><li>除了hm-gateway外底层都是springMVC，那要想不让网关得到这个WebMvcconfigurer配置，那就要；利用SpringMVC的特点去排除它，SprngMVC都有一个DispatcherServlet的api。</li><li>当我们配置了扫描时，其他的微服务就会使用这个拦截器配置的内容，但是网关也使用了这个配置类，网关没有MVC的内容因此会报错。</li></ul><h4 id="添加扫描">添加扫描</h4><p><code>spring.factories</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  com.hmall.common.config.MyBatisConfig,\</span><br><span class="line">  com.hmall.common.config.MvcConfig,\</span><br><span class="line">  com.hmall.common.config.JsonConfig</span><br></pre></td></tr></table></figure><ul><li>不过，需要注意的是，这个配置类默认是不会生效的，因为它所在的包是<code>com.hmall.common.config</code>，与其它微服务的扫描包不一致，无法被扫描到，因此无法生效。基于SpringBoot的自动装配原理，我们要将其添加到<code>resources</code>目录下的<code>META-INF/spring.factories</code>文件中：</li><li>依赖虽然被引入，但@ComponentScan默认扫描启动类所在的包及其子包，这里没在对应的扫描范围内所有没有注册。可以@ComponentScan添加包范围；在对应模块通过spring.factories文件将对应配置类的全限定名写进去，利用Springboot自动配置原理，其他微服务引入对应模块依赖，在启动后会进行Bean注册；同样也还可以用@Import导入对应的Bean组件或配置类</li><li>spring.factories可以基于springboot的自动装配机制自动发现并装配配置类。简单来说，就是所有微服务都无法扫描到这个拦截器，我们可以给每一个微服务的启动类Application加上compinentscan指定扫描这个拦截器，但是，微服务数量庞大，显然不是个好办法，利用SpringBoot的自动装配原理就简单的多</li></ul><h4 id="结果">结果</h4><p>这样我们请求单个购物车就查询不到用户信息了</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/24/6881fa6ec44c8.png" alt="image-20250724171835215"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">: ==&gt;  Preparing: SELECT id,user_id,item_id,num,name,spec,price,image,create_time,update_time FROM cart <span class="title function_">WHERE</span> <span class="params">(user_id = ?)</span></span><br><span class="line"><span class="number">17</span>:<span class="number">15</span>:<span class="number">27</span>:<span class="number">140</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">6</span>] c.h.cart.mapper.CartMapper.selectList    : ==&gt; Parameters: <span class="number">2</span>(Long)</span><br><span class="line"><span class="number">17</span>:<span class="number">15</span>:<span class="number">27</span>:<span class="number">148</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">6</span>] c.h.cart.mapper.CartMapper.selectList    : &lt;==      Total: <span class="number">1</span></span><br><span class="line"><span class="number">17</span>:<span class="number">16</span>:<span class="number">27</span>:<span class="number">290</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">7</span>] c.h.cart.mapper.CartMapper.selectList    : ==&gt;  Preparing: SELECT id,user_id,item_id,num,name,spec,price,image,create_time,update_time FROM cart <span class="title function_">WHERE</span> <span class="params">(user_id = ?)</span></span><br><span class="line"><span class="number">17</span>:<span class="number">16</span>:<span class="number">27</span>:<span class="number">293</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">7</span>] c.h.cart.mapper.CartMapper.selectList    : ==&gt; Parameters: <span class="literal">null</span></span><br><span class="line"><span class="number">17</span>:<span class="number">16</span>:<span class="number">27</span>:<span class="number">298</span> DEBUG <span class="number">1764</span> --- [nio-<span class="number">8082</span>-exec-<span class="number">7</span>] c.h.cart.mapper.CartMapper.selectList    : &lt;==      Total: <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="1-3-5-OpenFeign传递用户">1.3.5 OpenFeign传递用户</h3><blockquote><p>请求从网关到交易时会被mvc拦截，将userinfo存入threadlocal，当这个请求执行完之后，afterCompletion会清除threadlocal，故当交易发请求到商品时是没有ui的</p></blockquote><p>前端发起的请求都会经过网关再到微服务，由于我们之前编写的过滤器和拦截器功能，微服务可以轻松获取登录用户信息。</p><p>但有些业务是比较复杂的，请求到达微服务后还需要调用其它多个微服务。比如下单业务，流程如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/24/68820370c5d70.png" alt="image-20250724175700620"></p><p>下单的过程中，需要调用商品服务扣减库存，调用购物车服务清理用户购物车。而清理购物车时必须知道当前登录的用户身份。但是，<strong>订单服务调用购物车时并没有传递用户信息</strong>，购物车服务无法知道当前用户是谁！</p><p>由于微服务获取用户信息是通过拦截器在请求头中读取，因此要想实现微服务之间的用户信息传递，就<strong>必须在微服务发起调用时把用户信息存入请求头</strong>。</p><ul><li><p>ThreadLocal：仅限单JVM线程内，用于存储线程级别的上下文（如用户身份、事务ID）。其生命周期与线程绑定，无法跨进程或跨服务传递。</p><p>微服务间通信：本质是跨进程的分布式调用，服务可能部署在不同物理节点。ThreadLocal无法穿透网络边界，无法在服务A的线程中直接访问服务B的线程数据。</p></li><li><p>服务调用，即跨进程的服务调用，而ThreadLocal只仅限于当前服务内部的范围，所以无法使用，但网关那里刚开始不是已经通过过滤器进行了userInfo存入请求头中吗？为什么后续微服务a调用服务b时，需要再次将userInfo存入请求头才能传递用户信息呢？那是因为------&gt;HTTP协议无状态：每个请求默认不携带上一个请求的上下文（直接理解成，每次发送的都是一个新的http请求，所以需要我们自己给该请求做标识）。 最后记住：拦截器+Feign组合：是实现微服务间身份透传的标准模式。</p></li><li><p>拦截器是属于微服务的，过滤器是属于网关的；拦截器从请求头获取userId，并保存在context中，过滤器解析jwt并保存在请求头中；</p></li></ul><p>微服务之间调用是基于OpenFeign来实现的，并不是我们自己发送的请求。我们如何才能让每一个由OpenFeign发起的请求自动携带登录用户信息呢？</p><p>这里要借助Feign中提供的一个拦截器接口：<code>feign.RequestInterceptor</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/6882cd197e1e5.png" alt="image-20250725081720605"></p><p>不放在common中，因为不是所有模块都需要，例如网关微服务就不需要FeignClient<br>其实就是拦截下来OpenFeign的转发请求，然后再请求头中添加上user-info字段后放行。</p><p><code>DefaultFeignConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultFeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将用户信息添加请求头</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">userInfoRequestInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 微服务调用微服务的请求是从网关传过来的，</span></span><br><span class="line"><span class="comment">                 * 所以这时请求头中是有用户信息的，</span></span><br><span class="line"><span class="comment">                 * 只需要从请求头中获取到用户信息，添加到请求头中即可</span></span><br><span class="line"><span class="comment">                 * 如何请求再次传递给下一个微服务，这样就将用户信息传递给了其他微服务了</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserContext.getUser();</span><br><span class="line">                <span class="keyword">if</span> (userId != <span class="literal">null</span>)&#123;</span><br><span class="line">                    requestTemplate.header(<span class="string">&quot;user-info&quot;</span>, userId.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-配置管理">3. 配置管理</h2><p>到目前为止我们已经解决了微服务相关的几个问题：</p><ul><li>微服务远程调用</li><li>微服务注册、发现</li><li>微服务请求路由、负载均衡</li><li>微服务登录用户信息传递</li></ul><p>不过，现在依然还有几个问题需要解决：</p><ul><li>网关路由在配置文件中写死了，如果变更必须重启微服务</li><li>某些业务配置在配置文件中写死了，每次修改都要重启服务</li><li>每个微服务都有很多重复的配置，维护成本高</li></ul><p>这些问题都可以通过统一的<strong>配置管理器服务</strong>解决。而Nacos不仅仅具备注册中心功能，也具备配置管理的功能：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/6882ef6723d77.png" alt="image-20250725104348028"></p><p>微服务共享的配置可以统一交给Nacos保存和管理，在Nacos控制台修改配置后，Nacos会将配置变更推送给相关的微服务，并且无需重启即可生效，实现配置热更新。</p><p>网关的路由同样是配置，因此同样可以基于这个功能实现动态路由功能，无需重启网关即可修改路由配置。</p><h3 id="3-1-配置共享">3.1 配置共享</h3><p>我们可以把微服务共享的配置抽取到Nacos中统一管理，这样就不需要每个微服务都重复配置了。分为两步：</p><ul><li>在Nacos中添加共享配置</li><li>微服务拉取配置</li></ul><h4 id="3-1-1-添加共享配置">3.1.1 添加共享配置</h4><p>以cart-service为例，我们看看有哪些配置是重复的，可以抽取的：</p><p>首先是jdbc相关配置：</p><p>然后是日志配置：</p><p>然后是swagger以及OpenFeign的配置：</p><p>我们在nacos控制台分别添加这些配置。</p><p>首先是jdbc相关配置，在<code>配置管理</code>-&gt;<code>配置列表</code>中点击<code>+</code>新建一个配置：</p><p>在弹出的表单中填写信息：</p><p>其中详细的配置如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;hm.db.host:192.168.150.101&#125;:$&#123;hm.db.port:3306&#125;/$&#123;hm.db.database&#125;?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;hm.db.un:root&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.db.pw:123&#125;</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure><p>注意这里的jdbc的相关参数并没有写死，例如：</p><ul><li><code>数据库ip</code>：通过<code>$&#123;hm.db.host:192.168.150.101&#125;</code>配置了默认值为<code>192.168.150.101</code>，同时允许通过<code>$&#123;hm.db.host&#125;</code>来覆盖默认值</li><li><code>数据库端口</code>：通过<code>$&#123;hm.db.port:3306&#125;</code>配置了默认值为<code>3306</code>，同时允许通过<code>$&#123;hm.db.port&#125;</code>来覆盖默认值</li><li><code>数据库database</code>：可以通过<code>$&#123;hm.db.database&#125;</code>来设定，无默认值</li></ul><p>然后是统一的日志配置，命名为<code>shared-log.``yaml</code>，配置内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.hmall:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss:SSS</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>然后是统一的swagger配置，命名为<code>shared-swagger.yaml</code>，配置内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">$&#123;hm.swagger.title:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">$&#123;hm.swagger.description:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">$&#123;hm.swagger.email:zhanghuyi@itcast.cn&#125;</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">$&#123;hm.swagger.concat:虎哥&#125;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">$&#123;hm.swagger.package&#125;</span></span><br></pre></td></tr></table></figure><p>注意，这里的swagger相关配置我们没有写死，例如：</p><ul><li><code>title</code>：接口文档标题，我们用了<code>$&#123;hm.swagger.title&#125;</code>来代替，将来可以有用户手动指定</li><li><code>email</code>：联系人邮箱，我们用了<code>$&#123;hm.swagger.email:``zhanghuyi@itcast.cn``&#125;</code>，默认值是<code>zhanghuyi@itcast.cn</code>，同时允许用户利用<code>$&#123;hm.swagger.email&#125;</code>来覆盖。</li></ul><h3 id="3-2-拉取nacos">3.2 拉取nacos</h3><p>接下来，我们要在微服务拉取共享配置。将拉取到的共享配置与本地的<code>application.yaml</code>配置合并，完成项目上下文的初始化。</p><p>不过，需要注意的是，读取Nacos配置是SpringCloud上下文（<code>ApplicationContext</code>）初始化时处理的，发生在项目的引导阶段。然后才会初始化SpringBoot上下文，去读取<code>application.yaml</code>。</p><p>也就是说引导阶段，<code>application.yaml</code>文件尚未读取，根本不知道nacos 地址，该如何去加载nacos中的配置文件呢？</p><p>SpringCloud在初始化上下文的时候会先读取一个名为<code>bootstrap.yaml</code>(或者<code>bootstrap.properties</code>)的文件，如果我们将nacos地址配置到<code>bootstrap.yaml</code>中，那么在项目引导阶段就可以读取nacos中的配置了。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/688336256383b.png" alt="image-20250725154538843"></p><p>因此，微服务整合Nacos配置管理的步骤如下：</p><p>1）引入依赖：</p><p>在cart-service模块引入依赖：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos配置管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--读取bootstrap文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）新建bootstrap.yaml</p><p>在cart-service中的resources目录新建一个bootstrap.yaml文件：</p><p>内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cart-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span> <span class="comment"># nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 文件后缀名</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="comment"># 共享配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-jdbc.yaml</span> <span class="comment"># 共享mybatis配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-log.yaml</span> <span class="comment"># 共享日志配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-swagger.yaml</span> <span class="comment"># 共享日志配置</span></span><br></pre></td></tr></table></figure><p>3）修改application.yaml</p><p>由于一些配置挪到了bootstrap.yaml，因此application.yaml需要修改为：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启OKHttp连接池支持</span></span><br><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">swagger:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">购物车服务接口文档</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">com.hmall.cart.controller</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">hm-cart</span></span><br></pre></td></tr></table></figure><p>重启服务，发现所有配置都生效了。</p><h3 id="3-3-配置热更新">3.3 配置热更新</h3><p>有很多的业务相关参数，将来可能会根据实际情况临时调整。例如购物车业务，购物车数量有一个上限，默认是10，对应代码如下：</p><p>现在这里购物车是写死的固定值，我们应该将其配置在配置文件中，方便后期修改。</p><p>但现在的问题是，即便写在配置文件中，修改了配置还是需要重新打包、重启服务才能生效。能不能不用重启，直接生效呢？</p><p>这就要用到Nacos的配置热更新能力了，分为两步：</p><ul><li>在Nacos中添加配置</li><li>在微服务读取配置</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/25/68837b6508f41.png" alt="image-20250725204101759"></p><p>文件名称由三部分组成：</p><ul><li><strong><code>服务名</code></strong>：我们是购物车服务，所以是<code>cart-service</code></li><li><strong><code>spring.active.profile</code></strong>：就是spring boot中的<code>spring.active.profile</code>，可以省略，则所有profile共享该配置</li><li><strong><code>后缀名</code></strong>：例如yaml</li></ul><p>这里我们直接使用<code>cart-service.yaml</code>这个名称，则不管是dev还是local环境都可以共享该配置。</p><p>配置内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">cart:</span></span><br><span class="line">    <span class="attr">maxAmount:</span> <span class="number">1</span> <span class="comment"># 购物车商品数量上限</span></span><br></pre></td></tr></table></figure><p>接着，我们在微服务中读取配置，实现配置热更新。</p><p>在<code>cart-service</code>中新建一个属性读取类：</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.cart.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;hm.cart&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer maxAmount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着，在业务中使用该属性加载类：</p><p>测试，向购物车中添加多个商品：</p><p>我们在nacos控制台，将购物车上限配置为5：</p><p>无需重启，再次测试购物车功能：</p><p>加入成功！</p><p>无需重启服务，配置热更新就生效了！</p><h3 id="3-4-动态路由">3.4 动态路由</h3><p>网关的路由配置全部是在项目启动时由<code>org.springframework.cloud.gateway.route.CompositeRouteDefinitionLocator</code>在项目启动的时候加载，并且一经加载就会缓存到内存中的路由表内（一个Map），不会改变。也不会监听路由变更，所以，我们无法利用上节课学习的配置热更新来实现路由更新。</p><p>因此，我们必须监听Nacos的配置变更，然后手动把最新的路由更新到路由表中。这里有两个难点：</p><ul><li>如何监听Nacos配置变更？</li><li>如何把路由信息更新到路由表？</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/26/6884b4335720b.png" alt="image-20250726185538185"></p><h1>四、 微服务03</h1><p>在微服务远程调用的过程中，还存在几个问题需要解决。</p><p>首先是<strong>业务健壮性</strong>问题：</p><p>例如在之前的查询购物车列表业务中，购物车服务需要查询最新的商品信息，与购物车数据做对比，提醒用户。大家设想一下，如果商品服务查询时发生故障，查询购物车列表在调用商品服 务时，是不是也会异常？从而导致购物车查询失败。但从业务角度来说，为了提升用户体验，即便是商品查询失败，购物车列表也应该正确展示出来，哪怕是不包含最新的商品信息。</p><p>还有<strong>级联</strong>失败问题：</p><p>还是查询购物车的业务，假如商品服务业务并发较高，占用过多Tomcat连接。可能会导致商品服务的所有接口响应时间增加，延迟变高，甚至是长时间阻塞直至查询失败。</p><p>此时查询购物车业务需要查询并等待商品查询结果，从而导致查询购物车列表业务的响应时间也变长，甚至也阻塞直至无法访问。而此时如果查询购物车的请求较多，可能导致购物车服务的Tomcat连接占用较多，所有接口的响应时间都会增加，整个服务性能很差， 甚至不可用。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/68859664902a1.png" alt="image-20250727110050083"></p><p>依次类推，整个微服务群中与购物车服务、商品服务等有调用关系的服务可能都会出现问题，最终导致整个集群不可用。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885968bb4fe9.png" alt="image-20250727110130582"></p><p>这就是<strong>级联</strong>失败问题，或者叫<strong>雪崩</strong>问题。</p><p>级联失败（Cascading Failure）是指一个系统中的局部故障引发连锁反应，导致其他部分相继失效，最终造成更大范围甚至整个系统崩溃的现象。</p><p>还有跨服务的事务问题：</p><p>比如昨天讲到过的下单业务，下单的过程中需要调用多个微服务：</p><ul><li>商品服务：扣减库存</li><li>订单服务：保存订单</li><li>购物车服务：清理购物车</li></ul><p>这些业务全部都是数据库的写操作，我们必须确保所有操作的同时成功或失败。但是这些操作在不同微服务，也就是不同的Tomcat，这样的情况如何确保事务特性呢？</p><h2 id="4-1-雪崩问题">4.1 雪崩问题</h2><blockquote><p>雪崩问题产生的原因？</p></blockquote><ul><li>微服务相互调用，服务提供者出现故障或阻塞。</li><li>服务调用者没有做好异常处理，导致自身故障。</li><li>调用链中的所有服务级联失败，导致整个集群故障</li></ul><blockquote><p>如何避免雪崩</p></blockquote><ul><li><p>尽量避免服务出现故障或阻塞。</p><ul><li>保证代码的健壮性;</li><li>保证网络畅通;</li><li>能应对较高的并发请求;</li></ul></li><li><p>服务调用者做好远程调用异常的后备方案，避免故障扩散</p></li></ul><h2 id="4-2-微服务保护">4.2 微服务保护</h2><h3 id="4-2-1-服务保护方案">4.2.1 服务保护方案</h3><p>微服务保护的方案有很多，比如：</p><ul><li>请求限流</li><li>线程隔离</li><li>服务熔断</li></ul><p>这些方案或多或少都会导致服务的体验上略有下降，比如请求限流，降低了并发上限；线程隔离，降低了可用资源数量；服务熔断，降低了服务的完整度，部分服务变的不可用或弱可用。因此这些方案都属于服务<strong>降级</strong>的方案。但通过这些方案，服务的健壮性得到了提升，</p><h3 id="4-2-2-请求限流">4.2.2 请求限流</h3><p>服务故障最重要原因，就是并发太高！解决了这个问题，就能避免大部分故障。当然，接口的并发不是一直很高，而是突发的。因此请求限流，就是<strong>限制或控制</strong>接口访问的并发流量，避免服务因流量激增而出现故障。</p><p>请求限流往往会有一个限流器，数量高低起伏的并发请求曲线，经过限流器就变的非常平稳。这就像是水电站的大坝，起到蓄水的作用，可以通过开关控制水流出的大小，让下游水流始终维持在一个平稳的量。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885aa8b68650.png" alt="image-20250727122650049"></p><h3 id="4-2-3-线程隔离">4.2.3 线程隔离</h3><p>当一个业务接口响应时间长，而且并发高时，就可能耗尽服务器的线程资源，导致服务内的其它接口受到影响。所以我们必须把这种影响降低，或者缩减影响的范围。线程隔离正是解决这个问题的好办法。</p><p>线程隔离的思想来自轮船的舱壁模式：</p><p>轮船的船舱会被隔板分割为N个相互隔离的密闭舱，假如轮船触礁进水，只有损坏的部分密闭舱会进水，而其他舱由于相互隔离，并不会进水。这样就把进水控制在部分船体，避免了整个船舱进水而沉没。</p><p>为了避免某个接口故障或压力过大导致整个服务不可用，我们可以限定每个接口可以使用的资源范围，也就是将其“隔离”起来。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885aac45ccdb.png" alt="image-20250727122747279"></p><p>如图所示，我们给查询购物车业务限定可用线程数量上限为20，这样即便查询购物车的请求因为查询商品服务而出现故障，也不会导致服务器的线程资源被耗尽，不会影响到其它接口。</p><h3 id="4-2-4-服务熔断">4.2.4 服务熔断</h3><p>线程隔离虽然避免了雪崩问题，但故障服务（商品服务）依然会拖慢购物车服务（服务调用方）的接口响应速度。而且商品查询的故障依然会导致查询购物车功能出现故障，购物车业务也变的不可用了。</p><p>所以，我们要做两件事情：</p><ul><li><strong>编写服务降级逻辑</strong>：就是服务调用失败后的处理逻辑，根据业务场景，可以抛出异常，也可以返回友好提示或默认数据。</li><li><strong>异常统计和熔断</strong>：统计服务提供方的异常比例，当比例过高表明该接口会影响到其它服务，应该拒绝调用该接口，而是直接走降级逻辑。</li></ul><p>这里服务提供方就是商品服务，异常比例过高意思就是说如果过往记录中发现调用10商品服务，有6次失败（60%），而熔断决策这里是当失败率超过阈值（如50%），购物车服务（调用方）的熔断器会：</p><ul><li>拒绝后续请求：不再真正调用商品服务，避免资源浪费。</li><li>直接走降级逻辑：返回缓存数据、默认值或友好提示。</li></ul><p>熔断恢复：</p><p>经过一段时间（如5秒），熔断器尝试放行一个请求探测商品服务是否恢复。若成功，则逐步关闭熔断。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885ab3154574.png" alt="image-20250727122936308"></p><h2 id="4-3-Sentinel">4.3 Sentinel</h2><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://github.com/alibaba/Sentinel/releases"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left"><i class="anzhiyufont anzhiyu-icon-link"></i></div><div class="tag-link-right"><div class="tag-link-title">Sentinel</div><div class="tag-link-sitename">jar包下载</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><p>微服务保护的技术有很多，但在目前国内使用较多的还是Sentinel，所以接下来我们学习Sentinel的使用。</p><p>Sentinel是阿里巴巴开源的一款服务保护框架，目前已经加入SpringCloudAlibaba中。</p><p>Sentinel 的使用可以分为两个部分:</p><ul><li><strong>核心库</strong>（Jar包）：不依赖任何框架/库，能够运行于 Java 8 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。在项目中引入依赖即可实现服务限流、隔离、熔断等功能。</li><li><strong>控制台</strong>（Dashboard）：Dashboard 主要负责管理推送规则、监控、管理机器信息等。</li></ul><h3 id="4-3-1-Sentinel安装">4.3.1 Sentinel安装</h3><h4 id="Window安装">Window安装</h4><p>下载jar包，cmd运行：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -Dserver.port=8090 -Dcsp.sentinel.dashboard.server=localhost:8090 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar</span><br></pre></td></tr></table></figure><p>访问<a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8090</a>页面，就可以看到sentinel的控制台了</p><p>需要输入账号和密码，默认都是：sentinel</p><p>登录后，即可看到控制台，默认会监控sentinel-dashboard服务本身</p><h4 id="Docker运行">Docker运行</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> sentinel <span class="literal">-p</span> <span class="number">8090</span>:<span class="number">8858</span> <span class="literal">--network</span> hm<span class="literal">-net</span> bladex/sentinel<span class="literal">-dashboard</span>:<span class="number">1.8</span>.<span class="number">7</span></span><br></pre></td></tr></table></figure><p>然后运行<a target="_blank" rel="noopener" href="http://192.168.163.129:8090">http://192.168.163.129:8090</a></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885bdfbd1cb5.png" alt="image-20250727134943797"></p><h3 id="4-3-2-Fallback">4.3.2 Fallback</h3><p>触发限流或熔断后的请求不一定要直接报错，也可以返回一些默认数据或者友好提示，用户体验会更好。</p><p>给FeignClient编写失败后的降级逻辑有两种方式：</p><ul><li>方式一：FallbackClass，无法对远程调用的异常做处理</li><li>方式二：FallbackFactory，可以对远程调用的异常做处理，我们一般选择这种方式。</li></ul><h2 id="4-4-分布式事务">4.4 分布式事务</h2><p>首先我们看看项目中的下单业务整体流程：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885e1586ebce.png" alt="image-20250727162035686"></p><p>由于订单、购物车、商品分别在三个不同的微服务，而每个微服务都有自己独立的数据库，因此下单过程中就会跨多个数据库完成业务。而每个微服务都会执行自己的本地事务：</p><ul><li>交易服务：下单事务</li><li>购物车服务：清理购物车事务</li><li>库存服务：扣减库存事务</li></ul><p>整个业务中，各个本地事务是有关联的。因此每个微服务的本地事务，也可以称为<strong>分支事务</strong>。多个有关联的分支事务一起就组成了<strong>全局事务</strong>。我们必须保证整个全局事务同时成功或失败。</p><p>我们知道每一个分支事务就是传统的<strong>单体事务</strong>，都可以满足ACID特性，但全局事务跨越多个服务、多个数据库，是否还能满足呢？</p><p>我们来做一个测试，先进入购物车页面：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885e17732490.png" alt="image-20250727162106559"></p><p>目前有4个购物车，然结算下单，进入订单结算页面：</p><p>然后将购物车中某个商品的库存修改为<code>0</code>：</p><p>然后，提交订单，最终因库存不足导致下单失败：</p><p>然后我们去查看购物车列表，发现购物车数据依然被清空了，并未回滚：</p><p>事务并未遵循ACID的原则，归其原因就是参与事务的多个子业务在不同的微服务，跨越了不同的数据库。虽然每个单独的业务都能在本地遵循ACID，但是它们互相之间没有感知，不知道有人失败了，无法保证最终结果的统一，也就无法遵循ACID的事务特性了。</p><p>这就是分布式事务问题，出现以下情况之一就可能产生分布式事务问题：</p><ul><li>业务跨多个服务实现</li><li>业务跨多个数据源实现</li></ul><p>接下来这一章我们就一起来研究下如何解决分布式事务问题。</p><h3 id="4-4-1-Seata">4.4.1 Seata</h3><p>解决分布式事务的方案有很多，但实现起来都比较复杂，因此我们一般会使用开源的框架来解决分布式事务问题。在众多的开源分布式事务框架中，功能最完善、使用最多的就是阿里巴巴在2019年开源的Seata了。</p><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://seata.apache.org/zh-cn/docs/overview/what-is-seata"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left"><i class="anzhiyufont anzhiyu-icon-link"></i></div><div class="tag-link-right"><div class="tag-link-title">Seata</div><div class="tag-link-sitename">官方文档</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><p>其实分布式事务产生的一个重要原因，就是参与事务的多个分支事务互相无感知，不知道彼此的执行状态。因此解决分布式事务的思想非常简单：</p><p>就是找一个统一的<strong>事务协调者</strong>，与多个分支事务通信，检测每个分支事务的执行状态，保证全局事务下的每一个分支事务同时成功或失败即可。大多数的分布式事务框架都是基于这个理论来实现的。</p><p>Seata也不例外，在Seata的事务管理中有三个重要的角色：</p><ul><li><strong>TC</strong> <strong>(Transaction Coordinator</strong>) - **事务协调者：**维护全局和分支事务的状态，协调全局事务提交或回滚。</li><li><strong>TM (Transaction Manager) -</strong> **事务管理器：**定义全局事务的范围、开始全局事务、提交或回滚全局事务。</li><li><strong>RM (Resource Manager) -</strong> **资源管理器：**管理分支事务，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li></ul><p>Seata的工作架构如图所示：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885e4942f0e7.png" alt="image-20250727163426944"></p><p>其中，<strong>TM</strong>和<strong>RM</strong>可以理解为Seata的客户端部分，引入到参与事务的微服务依赖中即可。将来<strong>TM</strong>和<strong>RM</strong>就会协助微服务，实现本地分支事务与<strong>TC</strong>之间交互，实现事务的提交或回滚。</p><p>而<strong>TC</strong>服务则是事务协调中心，是一个独立的微服务，需要单独部署。</p><details class="folding-tag" green><summary>三者关系的小例子</summary><div class="content"><p>可以把 Seata 处理分布式事务的过程，类比成组织一次多人协作的搬家任务，用生活化场景理解三个角色：</p><ol><li>TM（事务管理器）：搬家发起人</li></ol><ul><li><strong>作用</strong>：决定要不要开始 “全局事务（搬家这件事）”，以及最后成功了提交结果（搬完）、失败了回滚（不搬或恢复原样）。</li><li><strong>举例</strong>：你（TM）想组织一次搬家，先拍板 “周末要把家里东西搬到新房”（定义全局事务范围），然后通知大家开始干活（开启全局事务）。要是中途发现新房没收拾好，你说 “不搬了，东西放回原处”（回滚全局事务）；要是一切顺利，你确认 “搬完啦，任务结束”（提交全局事务）。</li></ul><ol start="2"><li>TC（事务协调者）：搬家总指挥</li></ol><ul><li><strong>作用</strong>：盯着所有 “分支事务（打包、搬运、拆装家具等环节）” 的状态，协调大家一起成功或一起失败。</li><li><strong>举例</strong>：你请了个指挥（TC），他负责盯着：打包队有没有把东西包好（分支事务状态）、搬运车有没有把东西运到（分支事务状态）、拆装队有没有把家具装好（分支事务状态）…… 要是打包队说 “包一半发现东西太多，搞不定”，指挥（TC）就通知所有人 “别搬了，各自恢复原样”；要是所有人都反馈 “搞定”，指挥（TC）就告诉大家 “可以收尾，任务完成”。</li></ul><ol start="3"><li>RM（资源管理器）：具体干活的小组</li></ol><ul><li><strong>作用</strong>：管理自己负责的 “分支事务（比如打包组管打包、搬运组管运输）”，随时给 TC 汇报进度和状态。</li><li><strong>举例</strong>：<ul><li>打包组（RM1）：负责把家里东西分类打包，打包完了跟指挥（TC）说 “我们包好啦”；要是打包到一半发现东西坏了，也跟指挥（TC）说 “这里搞不定，需要回退”。</li><li>搬运组（RM2）：负责把打包好的东西运到新房，路上车坏了（分支事务失败），就跟指挥（TC）汇报 “运不了，得终止”；要是顺利运到，就说 “送达成功”。</li><li>拆装组（RM3）：负责在新房把家具装好，装完汇报 “装好了”；装到一半发现零件少了，汇报 “装不了，得回退”。</li></ul></li></ul><p><strong>总结流程</strong>：<br>你（TM）发起搬家（全局事务）→ 指挥（TC）协调打包、搬运、拆装（分支事务）→ 每个小组（RM）干活并汇报状态 → 指挥（TC）根据所有人状态，决定让大家一起成功（搬完）或一起回滚（不搬 / 恢复）→ 你（TM）最终确认结果。</p></div></details><h3 id="4-4-2-Seata配置">4.4.2 Seata配置</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">--name</span> seata \</span><br><span class="line"><span class="literal">-p</span> <span class="number">8099</span>:<span class="number">8099</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">7099</span>:<span class="number">7099</span> \</span><br><span class="line"><span class="literal">-e</span> SEATA_IP=<span class="number">192.168</span>.<span class="number">163.129</span> \</span><br><span class="line"><span class="literal">-v</span> ./seata:/seata<span class="literal">-server</span>/resources \</span><br><span class="line"><span class="literal">--privileged</span>=true \</span><br><span class="line"><span class="literal">--network</span> hm<span class="literal">-net</span> \</span><br><span class="line"><span class="literal">-d</span> \</span><br><span class="line">seataio/seata<span class="literal">-server</span>:<span class="number">1.5</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure><p>这样就使用Docker成功部署了</p><h3 id="4-4-3-微服务集成Seata">4.4.3 微服务集成Seata</h3><h4 id="导入依赖">导入依赖</h4><p>为了方便各个微服务集成seata，我们需要把seata配置共享到nacos，因此<code>trade-service</code>模块不仅仅要引入seata依赖，还要引入nacos依赖:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--统一配置管理--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--读取bootstrap文件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="配置nacos">配置nacos</h4><p>首先在nacos上添加一个共享的seata配置，命名为<code>shared-seata.yaml</code>：</p><p>内容如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">registry:</span> <span class="comment"># TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span> <span class="comment"># 注册中心类型 nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span> <span class="comment"># nacos地址</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span> <span class="comment"># namespace，默认为空</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment"># 分组，默认是DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span> <span class="comment"># seata服务名称</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">hmall</span> <span class="comment"># 事务组名称</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span> <span class="comment"># 事务组与tc集群的映射关系</span></span><br><span class="line">      <span class="attr">hmall:</span> <span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/6885fec9f2b39.png" alt="image-20250727182613408"></p><h4 id="改造配置">改造配置</h4><p><code>bootstrap.yaml</code>：</p><p>内容如下:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">trade-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span> <span class="comment"># nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 文件后缀名</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="comment"># 共享配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-jdbc.yaml</span> <span class="comment"># 共享mybatis配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-log.yaml</span> <span class="comment"># 共享日志配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-swagger.yaml</span> <span class="comment"># 共享日志配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-seata.yaml</span> <span class="comment"># 共享seata配置</span></span><br></pre></td></tr></table></figure><h3 id="4-4-4-XA模式（面试题）">4.4.4 XA模式（面试题）</h3><p>XA规范是X/Open组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准，XA规范描述了全局的TM与局部的RM之间的接口，几乎所有主流的关系型数据库都对XA规范提供了支持。Seata的XA模式如下:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/27/68860a70183b9.png" alt="image-20250727191557888"></p><p>一阶段的工作</p><ul><li>RM注册分支事务到TC</li><li>RM执行分支业务SQL但是不提交</li><li>RM报告执行状态到TC</li></ul><p>二阶段的工作</p><ul><li>TC检测各分支事务执行状态（如果成功/失败，通知RM提交/回滚事务）</li><li>RM接收TC指令，提交/回滚事务</li></ul><blockquote><p>具体流程</p></blockquote><ul><li>当方法执行时，全局事务（TM）向TC注册一个全局事务</li><li>TM执行内部业务逻辑，调用每一个分支</li><li>RM会拦截对SQL的操作,RM会向TC注册分支事务</li><li>然后再放行去执行业务的SQL（SQL执行完毕后不可以<strong>提交</strong>）</li><li>当所有方法执行完毕TM会向TC发送全局事务结束的信息</li><li>TC会检查注册分支的事务状态 ，如果发现都成功了就向所有分支发送提交/回滚的指令</li><li>这些事务才能提交事务释放锁（反之下达回滚的命令）</li></ul><blockquote><p>优缺点</p></blockquote><p>XA模式的优点是什么?</p><ul><li>·事务的强一致性，满足ACID原则。</li><li>·常用数据库都支持，实现简单，并且没有代码侵入</li></ul><p>XA模式的缺点是什么?</p><ul><li>·因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差</li><li>·依赖关系型数据库实现事务</li></ul><h4 id="回滚日志">回滚日志</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">28.936</span>  INFO <span class="literal">---</span> [<span class="type">rverHandlerThread_1_4_500</span>] i.s.s.coordinator.DefaultCoordinator     : <span class="keyword">Begin</span> new global transaction applicationId: trade<span class="literal">-serviceup</span>: hmall, transactionName: createOrder(com.hmall.trade.domain.dto.OrderFormDTO),timeout:<span class="number">60000</span>,xid:<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203713</span></span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.113</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.139</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203715</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.286</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.290</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203717</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.345</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.350</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203719</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.464</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.468</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203721</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.548</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-cart</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.554</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">2</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203723</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-cart</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.597</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203713</span>,extraData=null1,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">29.734</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_10_500</span>] io.seata.server.coordinator.DefaultCore  : Committing global transaction is successfully done, xid =<span class="number">45712777161203713</span>.</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.234</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : timeout=<span class="number">60000</span>,transactionName=createOrder(com.hmall.tradeTO),clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.239</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_11_500</span>] i.s.s.coordinator.DefaultCoordinator     : <span class="keyword">Begin</span> new global transaction applicationId: trade<span class="literal">-serviceup</span>: hmall, transactionName: createOrder(com.hmall.trade.domain.dto.OrderFormDTO),timeout:<span class="number">60000</span>,xid:<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203822</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.270</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.288</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203824</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.317</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.322</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203826</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.339</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.342</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203828</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-trade</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.369</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203</span>urceId=jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span>,lockKey=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.372</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Register branch successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:nchId = <span class="number">45712777161203830</span>, resourceId = jdbc:mysql://<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">3306</span>/hm<span class="literal">-item</span> ,lockKeys = null</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.435</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : SeataMergeMessage xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">4571277716120361203830</span>,resourceId=null,status=PhaseOne_Failed,applicationData=null</span><br><span class="line">,clientIp:<span class="number">192.168</span>.<span class="number">163.1</span>,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.485</span>  INFO <span class="literal">---</span> [<span class="type">nPool.commonPool</span>-<span class="type">worker</span>-<span class="number">3</span>] i.seata.server.coordinator.AbstractCore  : Report branch status successfully, xid = <span class="number">192.168</span>.<span class="number">163.129</span>:, branchId = <span class="number">45712777161203830</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.612</span>  INFO <span class="literal">---</span> [     <span class="type">batchLoggerPrint_1_1</span>] i.s.c.r.p.server.BatchLogHandler         : xid=<span class="number">192.168</span>.<span class="number">163.129</span>:<span class="number">8099</span>:<span class="number">45712777161203822</span>,extraData=null1,vgroup:hmall</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.664</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback branch transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span> branchId = <span class="number">45712777161203828</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.679</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback branch transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span> branchId = <span class="number">45712777161203826</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.692</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback branch transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span> branchId = <span class="number">45712777161203824</span></span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">06.694</span>  INFO <span class="literal">---</span> [<span class="type">verHandlerThread_1_17_500</span>] io.seata.server.coordinator.DefaultCore  : Rollback global transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span>.</span><br><span class="line"><span class="number">01</span>:<span class="number">20</span>:<span class="number">39.827</span>  INFO <span class="literal">---</span> [      <span class="type">RetryCommitting_1_1</span>] io.seata.server.coordinator.DefaultCore  : Committing global transaction is successfully done, xid =<span class="number">45712777161203713</span>.</span><br><span class="line"><span class="number">01</span>:<span class="number">22</span>:<span class="number">16.808</span>  INFO <span class="literal">---</span> [     <span class="type">RetryRollbacking_1_1</span>] io.seata.server.coordinator.DefaultCore  : Rollback global transaction successfully, xid = <span class="number">192.168</span>.<span class="number">11203822</span>.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-4-5-AT模式">4.4.5 AT模式</h3><p><code>AT</code>模式同样是分阶段提交的事务模型，不过缺弥补了<code>XA</code>模型中资源锁定周期过长的缺陷</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/6886d4f275380.png" alt="image-20250728093957746"></p><p>阶段一<code>RM</code>的工作：</p><ul><li>注册分支事务</li><li>记录undo-log（数据快照）</li><li>执行业务sql并提交</li><li>报告事务状态</li></ul><p>阶段二提交时<code>RM</code>的工作：</p><ul><li>删除undo-log即可</li></ul><p>阶段二回滚时<code>RM</code>的工作：</p><ul><li>根据undo-log恢复数据到更新前</li></ul><blockquote><p>具体流程</p></blockquote><ol><li>全局事务方法开启时TM会向TC注册一个全局事务</li><li>TM调用所有的分支</li><li>，在操作SQL之前会被RM拦截，RM会向TC注册分支事务</li><li>微服务的item执行具体的SQL语句并且<strong>立刻提交事务</strong></li><li>item在执行SQL之前先去生成一个修改数据库之前的数据保存一个快照， 保存在数据表<code>undo-log</code>中</li><li>当执行完毕后回向TC报告事务状态</li><li>TM会向TC报告事务的状态</li><li>TC会检测事务状态，都成功会删除log快照，失败则回滚从数据库中恢复快照</li></ol><p>那么万一有其他线程这时候修改了数据怎么办呢？？？</p><div calss="anzhiyu-tag-link"><a class="tag-Link" target="_blank" href="https://www.cnblogs.com/hongdada/p/16796704.html"><div class="tag-link-tips">引用站外地址</div><div class="tag-link-bottom"><div class="tag-link-left"><i class="anzhiyufont anzhiyu-icon-link"></i></div><div class="tag-link-right"><div class="tag-link-title">Seata全局锁</div><div class="tag-link-sitename">防止脏读</div></div><i class="anzhiyufont anzhiyu-icon-angle-right"></i></div></a></div><p>简述<code>AT</code>模式与<code>XA</code>模式最大的区别是什么？</p><ul><li><code>XA</code>模式一阶段不提交事务，锁定资源；<code>AT</code>模式一阶段直接提交，不锁定资源。</li><li><code>XA</code>模式依赖数据库机制实现回滚；<code>AT</code>模式利用数据快照实现数据回滚。</li><li><code>XA</code>模式强一致；<code>AT</code>模式最终一致</li></ul><p>快照数据的版本检查</p><p>Seata在回滚时会检查快照数据的版本是否与当前数据一致。如果发现数据已经被其他事务修改，Seata会抛出异常，阻止回滚操作。这种机制可以避免数据被错误覆盖，但会导致事务回滚失败，需要额外的处理逻辑。补偿机制：如果回滚失败，Seata会尝试通过补偿机制（如补偿SQL）来恢复数据。补偿SQL是根据业务逻辑预先定义的，用于在回滚失败时尽可能恢复数据的一致性。</p><h1>五、MQ基础</h1><blockquote><p>面试考点来了嘿嘿</p></blockquote><h2 id="5-1-异步调用">5.1 异步调用</h2><p>异步调用方式其实就是基于消息通知的方式，一般包含三个角色：</p><ul><li>消息发送者：投递消息的人，就是原来的调用方</li><li>消息Broker：管理、暂存、转发消息，你可以把它理解成微信服务器</li><li>消息接收者：接收和处理消息的人，就是原来的服务提供方</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68870ee59ec7e.png" alt="image-20250728134714684"></p><p>在异步调用中，发送者不再直接同步调用接收者的业务接口，而是发送一条消息投递给消息Broker。然后接收者根据自己的需求从消息Broker那里订阅消息。每当发送方发送消息后，接受者都能获取消息并处理。</p><p>这样，发送消息的人和接收消息的人就完全解耦了。</p><p>还是以余额支付业务为例：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68870f2ea38f5.png" alt="image-20250728134824173"></p><p>除了扣减余额、更新支付流水单状态以外，其它调用逻辑全部取消。而是改为发送一条消息到Broker。而相关的微服务都可以订阅消息通知，一旦消息到达Broker，则会分发给每一个订阅了的微服务，处理各自的业务。</p><p>假如产品经理提出了新的需求，比如要在支付成功后更新用户积分。支付代码完全不用变更，而仅仅是让积分服务也订阅消息即可：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68870f493649c.png" alt="image-20250728134850118"></p><p>不管后期增加了多少消息订阅者，作为支付服务来讲，执行问扣减余额、更新支付流水状态后，发送消息即可。业务耗时仅仅是这三部分业务耗时，仅仅100ms，大大提高了业务性能。</p><p>另外，不管是交易服务、通知服务，还是积分服务，他们的业务与支付关联度低。现在采用了异步调用，解除了耦合，他们即便执行过程中出现了故障，也不会影响到支付服务。</p><ul><li>交易服务、通知服务、积分服务收到Broker的消息后，如果业务代码没有执行成功broker还会再给服务发消息直到成功执行为止。</li><li>为了使用mq实现分布式事务，不能将mq发送消息的代码加入到事务中，比如像rabbitmq不支持rollback回滚操作的。此时可以配合分布式事务seata中的事务钩子，定义一个发送消息的方法，每当事务成功的时候，就可以发送消息。</li></ul><p>综上，异步调用的优势包括：</p><ul><li>耦合度更低</li><li>性能更好</li><li>业务拓展性强</li><li>故障隔离，避免级联失败</li><li>缓存消息，流量削峰填谷</li></ul><p>当然，异步通信也并非完美无缺，它存在下列缺点：</p><ul><li>完全依赖于Broker的可靠性、安全性和性能</li><li>架构复杂，后期维护和调试麻烦</li></ul><h2 id="5-2-技术选型">5.2 技术选型</h2><p>消息Broker，目前常见的实现方案就是消息队列（MessageQueue），简称为MQ.</p><p>目比较常见的MQ实现：</p><ul><li>ActiveMQ</li><li>RabbitMQ</li><li>RocketMQ</li><li>Kafka</li></ul><p>几种常见MQ的对比</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">RabbitMQ</th><th style="text-align:center">ActiveMQ</th><th style="text-align:center">RocketMQ</th><th style="text-align:center">Kafka</th></tr></thead><tbody><tr><td style="text-align:center">公司/社区</td><td style="text-align:center">Rabbit</td><td style="text-align:center">Apache</td><td style="text-align:center">阿里</td><td style="text-align:center">Apache</td></tr><tr><td style="text-align:center">开发语言</td><td style="text-align:center">Erlang</td><td style="text-align:center">Java</td><td style="text-align:center">Java</td><td style="text-align:center">Scala&amp;Java</td></tr><tr><td style="text-align:center">协议支持</td><td style="text-align:center">AMQP，XMPP，SMTP，STOMP</td><td style="text-align:center">OpenWire,STOMP，REST,XMPP,AMQP</td><td style="text-align:center">自定义协议</td><td style="text-align:center">自定义协议</td></tr><tr><td style="text-align:center">可用性</td><td style="text-align:center">高</td><td style="text-align:center">一般</td><td style="text-align:center">高</td><td style="text-align:center">高</td></tr><tr><td style="text-align:center">单机吞吐量</td><td style="text-align:center">一般</td><td style="text-align:center">差</td><td style="text-align:center">高</td><td style="text-align:center">非常高</td></tr><tr><td style="text-align:center">消息延迟</td><td style="text-align:center">微秒级</td><td style="text-align:center">毫秒级</td><td style="text-align:center">毫秒级</td><td style="text-align:center">毫秒以内</td></tr><tr><td style="text-align:center">消息可靠性</td><td style="text-align:center">高</td><td style="text-align:center">一般</td><td style="text-align:center">高</td><td style="text-align:center">一般</td></tr></tbody></table><p>追求可用性：Kafka、 RocketMQ 、RabbitMQ</p><p>追求可靠性：RabbitMQ、RocketMQ</p><p>追求吞吐能力：RocketMQ、Kafka</p><p>追求消息低延迟：RabbitMQ、Kafka</p><p>据统计，目前国内消息队列使用最多的还是RabbitMQ，再加上其各方面都比较均衡，稳定性也好，因此我们选择RabbitMQ来学习。</p><h2 id="5-3-RabbitMQ">5.3 RabbitMQ</h2><h3 id="5-3-1-安装">5.3.1 安装</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run \</span><br><span class="line"> <span class="literal">-e</span> RABBITMQ_DEFAULT_USER=itheima \</span><br><span class="line"> <span class="literal">-e</span> RABBITMQ_DEFAULT_PASS=<span class="number">123321</span> \</span><br><span class="line"> <span class="literal">-v</span> mq<span class="literal">-plugins</span>:/plugins \</span><br><span class="line"> <span class="literal">--name</span> mq \</span><br><span class="line"> <span class="literal">--hostname</span> mq \</span><br><span class="line"> <span class="literal">-p</span> <span class="number">15672</span>:<span class="number">15672</span> \</span><br><span class="line"> <span class="literal">-p</span> <span class="number">5672</span>:<span class="number">5672</span> \</span><br><span class="line"> <span class="literal">--network</span> hm<span class="literal">-net</span>\</span><br><span class="line"> <span class="literal">-d</span> \</span><br><span class="line"> rabbitmq:<span class="number">3.8</span><span class="literal">-management</span></span><br></pre></td></tr></table></figure><p>然后访问http://192.168.150.101:15672即可看到管理控制台。首次访问需要登录，默认的用户名和密码在配置文件中已经指定了。</p><p>RabbitMQ对应的架构：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/688725203b22d.png" alt="image-20250728152206702"></p><p>其中包含几个概念：</p><ul><li><strong><code>publisher</code></strong>：生产者，也就是发送消息的一方</li><li><strong><code>consumer</code></strong>：消费者，也就是消费消息的一方</li><li><strong><code>queue</code></strong>：队列，存储消息。生产者投递的消息会暂存在消息队列中，等待消费者处理</li><li><strong><code>exchange</code></strong>：交换机，负责消息路由。生产者发送的消息由交换机决定投递到哪个队列。（区分计网中的交换机：RabbitMQ的交换机是用于消息传递的，而计网的交换机是用于数据包传输的。）</li><li><strong><code>virtual host</code></strong>：虚拟主机，起到数据隔离的作用。每个虚拟主机相互独立，有各自的exchange、queue（每个虚拟主机相当于一个数据库，彼此之间互不影响）</li></ul><h3 id="5-3-2-Spring-AMQP">5.3.2 Spring AMQP</h3><p>将来我们开发业务功能的时候，肯定不会在控制台收发消息，而是应该基于编程的方式。由于<code>RabbitMQ</code>采用了AMQP协议，因此它具备跨语言的特性。任何语言只要遵循AMQP协议收发消息，都可以与<code>RabbitMQ</code>交互。并且<code>RabbitMQ</code>官方也提供了各种不同语言的客户端。</p><p>但是，RabbitMQ官方提供的Java客户端编码相对复杂，一般生产环境下我们更多会结合Spring来使用。而Spring的官方刚好基于RabbitMQ提供了这样一套消息收发的模板工具：SpringAMQP。并且还基于SpringBoot对其实现了自动装配，使用起来非常方便。</p><p>SpringAMQP提供了三个功能：</p><ul><li>自动声明队列、交换机及其绑定关系(设置队列)</li><li>基于注解的监听器模式，异步接收消息(设置消费端)</li><li>封装了RabbitTemplate工具，用于发送消息(设置生产端)</li></ul><h4 id="5-3-2-1-WorkQueues模型">5.3.2.1 WorkQueues模型</h4><p>Work queues，任务模型。简单来说就是<strong>让多个消费者</strong>绑定到一个队列，共同消费队列中的消息。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/6887393660eac.png" alt="image-20250728164739680"></p><p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。</p><p>此时就可以使用work 模型，<strong>多个消费者共同处理消息处理，消息处理的速度就能大大提高</strong>了。</p><h4 id="5-3-2-2-交换机">5.3.2.2 交换机</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68873f1c747c5.png" alt="image-20250728171249867"></p><p>可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：</p><ul><li><strong>Publisher</strong>：生产者，不再发送消息到队列中，而是发给交换机</li><li><strong>Exchange</strong>：交换机，一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。</li><li><strong>Queue</strong>：消息队列也与以前一样，接收消息、缓存消息。不过队列一定要与交换机绑定。</li><li><strong>Consumer</strong>：消费者，与以前一样，订阅队列，没有变化</li></ul><p><strong>Exchange</strong>（交换机）只负责转发消息，不具备存储消息的能力，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！（引入Exchange的目的是为了在Rabbitmq中一个消息能够分发给多个queue中被不同的消费者服务多次消费，比如你一个订单信息需要加积分，加经验，这下可以分为两个queue来执行）</p><p>交换机的类型有四种：</p><ul><li><strong>Fanout</strong>：广播，将消息交给所有绑定到交换机的队列。我们最早在控制台使用的正是Fanout交换机</li><li><strong>Direct</strong>：订阅，基于RoutingKey（路由key）发送给订阅了消息的队列</li><li><strong>Topic</strong>：通配符订阅，与Direct类似，只不过RoutingKey可以使用通配符</li><li><strong>Headers</strong>：头匹配，基于MQ的消息头匹配，用的较少。</li></ul><h4 id="5-3-2-3-Fanout-交换机">5.3.2.3 Fanout 交换机</h4><p>Fanout Exchange 会将接收到的消息路由到每一个跟其绑定的queue，所以也叫广播模式</p><h4 id="5-3-2-4-Direct-交换机">5.3.2.4 Direct 交换机</h4><p>Direct Exchange 会将接收到的消息根据规则路由到指定的Queue，因此称为<strong>定向</strong>路由。</p><ul><li>每一个Queue都与Exchange设置一个BindingKey</li><li>发布者发送消息时，指定消息的RoutingKey</li><li>Exchange将消息路由到BindingKey与消息RoutingKey一致的队列</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/68874f0032449.png" alt="image-20250728182043602"></p><p>描述下Direct交换机与Fanout交换机的差异？</p><ul><li>Fanout交换机将消息路由给每一个与之绑定的队列</li><li>Direct交换机根据RoutingKey判断路由给哪个队列</li><li>如果多个队列具有相同的RoutingKey，则与Fanout功能类似</li></ul><h4 id="5-3-2-5-Topic交换机">5.3.2.5 Topic交换机</h4><p>TopicExchange也是基于RoutingKey做消息路由，但是routingKey通常是多个单词的组合，并且以.分割。</p><p>Queue与Exchange指定BindingKey时可以使用通配符</p><ul><li>#：代指0个或多个单词</li><li>*： 代指一个单词</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/28/688751e789935.png" alt="image-20250728183310831"></p><h4 id="5-3-2-6-声明队列和交换机">5.3.2.6 声明队列和交换机</h4><p>在之前我们都是基于RabbitMQ控制台来创建队列、交换机。但是在实际开发时，队列和交换机是程序员定义的，将来项目上线，又要交给运维去创建。那么程序员就需要把程序中运行的所有队列和交换机都写下来，交给运维。在这个过程中是很容易出现错误的。</p><p>因此推荐的做法是由程序启动时检查队列和交换机是否存在，如果不存在自动创建。</p><blockquote><p>如果交换机或队列不存在</p><p>Spring AMQP会自动创建它们：</p><p>如果交换机（Exchange）不存在，Spring AMQP会根据注解中的配置（如名称和类型）自动创建交换机。</p><p>如果队列（Queue）不存在，Spring AMQP会根据注解中的配置（如名称）自动创建队列。</p><p>如果绑定关系（Binding）不存在，Spring AMQP会根据注解中的配置（如路由键）自动建立绑定关系。</p><p>如果交换机或队列已经存在</p><p>不会更改已存在的交换机或队列：</p><p>如果交换机或队列已经存在，并且它们的配置（如名称、类型等）与注解中的配置一致，Spring AMQP不会对它们进行任何更改。</p><p>如果交换机或队列的配置与注解中的配置不一致（例如，交换机类型不同或队列的持久性设置不同），RabbitMQ会抛出错误，导致声明失败。</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到direct.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到direct.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再试试Topic模式：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;china.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到topic.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;#.news&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到topic.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-2-7-消息转换器">5.3.2.7 消息转换器</h4><p>当使用 Spring 发送消息时，传输内容通常是 Java 对象，但消息队列只能处理字节数据。因此，需要先将对象序列化为字节发送，接收时再反序列化为对象。Spring 默认使用的是 JDK 的序列化机制，但这种方式格式不友好、体积大、不安全。实际开发中，通常会配置 JSON 转换器，使消息更轻量、可读且更安全。</p><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后添加一个Bean</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jackson2JsonMessageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.配置自动创建消息id，用于识别不同消息，也可以在业务中基于ID判断是否是重复消息</span></span><br><span class="line">    jackson2JsonMessageConverter.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jackson2JsonMessageConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-2-8-订单业务">5.3.2.8 订单业务</h4><p>案例需求：改造余额支付功能，将支付成功后基于OpenFeign的交易服务的更新订单状态接口的同步调用，改为基于RabbitMQ的异步通知。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68885ef954ca9.png" alt="image-20250729134112561"></p><p>说明：目前没有通知服务和积分服务，因此我们只关注交易服务，步骤如下：</p><ul><li>定义<code>direct</code>类型交换机，命名为<code>pay.direct</code></li><li>定义消息队列，命名为<code>trade.pay.success.queue</code></li><li>将<code>trade.pay.success.queue</code>与<code>pay.direct</code>绑定，<code>BindingKey</code>为<code>pay.success</code></li><li>支付成功时不再调用交易服务更新订单状态的接口，而是发送一条消息到<code>pay.direct</code>，发送消息的<code>RoutingKey</code> 为<code>pay.success</code>，消息内容是订单id</li><li>交易服务监听<code>trade.pay.success.queue</code>队列，接收到消息后更新订单状态为已支付</li></ul><p>不管是生产者还是消费者，都需要配置MQ的基本信息。分为两步：</p><p>1）添加依赖：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--消息发送--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）配置MQ地址：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span> <span class="comment"># 你的虚拟机IP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure><p>4.1.接收消息</p><p>在trade-service服务中定义一个消息监听类：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68885f2ceb484.png" alt="image-20250729134204022"></p><p>其代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.trade.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.trade.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ExchangeTypes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayStatusListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = &quot;trade.pay.success.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = &quot;pay.topic&quot;),</span></span><br><span class="line"><span class="meta">            key = &quot;pay.success&quot;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenPaySuccess</span><span class="params">(Long orderId)</span>&#123;</span><br><span class="line">        orderService.markOrderPaySuccess(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.2.发送消息</p><p>修改<code>pay-service</code>服务下的<code>com.hmall.pay.``service``.impl.``PayOrderServiceImpl</code>类中的<code>tryPayOrderByBalance</code>方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPayOrderByBalance</span><span class="params">(PayOrderDTO payOrderDTO)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.查询支付单</span></span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">po</span> <span class="operator">=</span> getById(payOrderDTO.getId());</span><br><span class="line">    <span class="comment">// 2.判断状态</span></span><br><span class="line">    <span class="keyword">if</span>(!PayStatus.WAIT_BUYER_PAY.equalsValue(po.getStatus()))&#123;</span><br><span class="line">        <span class="comment">// 订单不是未支付，状态异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;交易已支付或关闭！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.尝试扣减余额</span></span><br><span class="line">    userClient.deductMoney(payOrderDTO.getPw(), po.getAmount());</span><br><span class="line">    <span class="comment">// 4.修改支付单状态</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> markPayOrderSuccess(payOrderDTO.getId(), LocalDateTime.now());</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;交易已支付或关闭！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.修改订单状态</span></span><br><span class="line">    <span class="comment">// tradeClient.markOrderPaySuccess(po.getBizOrderNo());</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;pay.direct&quot;</span>, <span class="string">&quot;pay.success&quot;</span>, po.getBizOrderNo());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;支付成功的消息发送失败，支付单id：&#123;&#125;， 交易单id：&#123;&#125;&quot;</span>, po.getId(), po.getBizOrderNo(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>六、 MQ高级</h1><h2 id="1-发送者的可靠性">1.发送者的可靠性</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/688865206c1ba.png" alt="image"></p><h3 id="1-1-发送者重连">1.1 发送者重连</h3><p>首先第一种情况，就是生产者发送消息时，出现了网络故障，导致与MQ的连接中断。</p><p>为了解决这个问题，SpringAMQP提供的消息发送时的重试机制。即：当<code>RabbitTemplate</code>与MQ连接超时后，多次重试。</p><p>修改<code>publisher</code>模块的<code>application.yaml</code>文件，添加下面的内容：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="string">1s</span> <span class="comment"># 设置MQ的连接超时时间</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启超时重试机制</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 失败后的初始等待时间</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br></pre></td></tr></table></figure><p>当网络不稳定的时候，利用重试机制可以有效提高消息发送的成功率。不过SpringAMQP提供的重试机制是阻塞式的重试，也就是说多次重试等待的过程中，当前线程是被阻塞的，会影响业务性能。</p><p>如果对于业务性能有要求，建议禁用重试机制。如果一定要使用，请合理配置等待时长和重试次数，当然也可以考虑使用异步线程来执行发送消息的代码。</p><h3 id="1-2-发送者确认">1.2 发送者确认</h3><p>SpringAMQP提供了Publisher Confirm和Publisher Return两种确认机制。开启确机制认后，当发送者发送消息给MQ后，MQ会返回确认结果给发送者。返同的结里有以下几种情况</p><p>一般情况下，只要生产者与MQ之间的网路连接顺畅，基本不会出现发送消息丢失的情况，因此大多数情况下我们无需考虑这种问题。</p><p>不过，在少数情况下，也会出现消息发送到MQ之后丢失的现象，比如：</p><ul><li>MQ内部处理消息的进程发生了异常</li><li>生产者发送消息到达MQ后未找到<code>Exchange</code></li><li>生产者发送消息到达MQ的<code>Exchange</code>后，未找到合适的<code>Queue</code>，因此无法路由</li></ul><p>针对上述情况，RabbitMQ提供了生产者消息确认机制，包括<code>Publisher Confirm</code>和<code>Publisher Return</code>两种。在开启确认机制的情况下，当生产者发送消息给MQ后，MQ会根据消息处理的情况返回不同的<strong>回执</strong>。</p><p>具体如图所示：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68886be28537d.png" alt="image-20250729143619347"></p><p>总结如下：</p><ul><li><p>当消息投递到MQ，但是路由失败时，通过<strong>Publisher Return</strong>返回异常信息，同时返回ack的确认信息，代表投递成功</p></li><li><p>临时消息投递到了MQ，并且入队成功，返回ACK，告知投递成功</p></li><li><p>持久消息投递到了MQ，并且入队完成持久化，返回ACK ，告知投递成功</p></li><li><p>其它情况都会返回NACK，告知投递失败</p></li><li><p>其中<code>ack</code>和<code>nack</code>属于<strong>Publisher Confirm</strong>机制，<code>ack</code>是投递成功；<code>nack</code>是投递失败。而<code>return</code>则属于<strong>Publisher Return</strong>机制。</p><p>默认两种机制都是关闭状态，需要通过配置文件来开启。</p></li><li><p>return和confirm机制是可以同时开启的。return机制：确认消息是否从 Exchange 路由到 Queue。confirm机制：确认消息是否到达 Exchange。若同时开启，路由失败(队列不存在或者交换机配置错误)时return机制返回异常信息以及消息，confirm机制则返回ack（不是nack）。两个机制不会互相影响。ack和nack都是由confirm机制返回的。</p></li><li><p>路由失败（交换机到队列），才触发ReturnCallback机制,返回异常信息；消息投递（发送者到交换机）成功，ConfirmCallback机制返回ack，投递失败返回nck</p></li><li><p>Publisher Confirm 机制用于向生产者确认消息是否成功送达队列。当生产者向 RabbitMQ 发送消息时，RabbitMQ 会返回一个唯一的交付标签（Delivery Tag），生产者可以通过这个标签来查询消息的投递状态。Publisher Return 机制用于处理无法路由的消息。当生产者向 RabbitMQ 发送一条消息时，如果消息无法被正确路由（例如由于队列不存在或交换机配置错误），RabbitMQ 会将该消息返回给生产者，并附带一个错误信息。</p></li></ul><h4 id="开启生产者确认">开启生产者确认</h4><p>在publisher模块的<code>application.yaml</code>中添加配置：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># 开启publisher confirm机制，并设置confirm类型</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 开启publisher return机制</span></span><br></pre></td></tr></table></figure><p>这里<code>publisher-confirm-type</code>有三种模式可选：</p><ul><li><code>none</code>：关闭confirm机制</li><li><code>simple</code>：同步阻塞等待MQ的回执</li><li><code>correlated</code>：MQ异步回调返回回执</li></ul><p>一般我们推荐使用<code>correlated</code>，回调机制。</p><h4 id="ReturnCallback">ReturnCallback</h4><p>每个<code>RabbitTemplate</code>只能配置一个<code>ReturnCallback</code>，因此我们可以在配置类中统一设置。我们在publisher模块定义一个配置类：</p><p><code>ReturnCallback</code> 的作用：当消息发送到交换机时，如果交换机无法将消息路由到任何队列（例如，路由键不匹配或队列不存在），<code>RabbitMQ</code> 会返回一个 <code>Return</code> 消息。ReturnCallback 就是用来处理这种场景的。</p><p>配置类 <code>MqConfig</code> 中设置了一个消息返回的回调处理机制。当发送的消息因为某些原因未能成功投递到目标队列时（如交换机、路由键不匹配等），<code>rabbitTemplate</code> 会触发 <code>ReturnedMessage</code> 回调，并通过日志记录详细的错误信息。这样你可以通过日志详细了解失败的原因，便于排查问题。</p><p>内容如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="comment">// 它主要用于类, 在bean被创建并完成属性注入后，执行一些初始化操作(带有@PostConstruct注解的方法会被自动调用。)</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;触发return callback,&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());</span><br><span class="line">                log.debug(<span class="string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());</span><br><span class="line">                log.debug(<span class="string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());</span><br><span class="line">                log.debug(<span class="string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());</span><br><span class="line">                log.debug(<span class="string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ConfirmCallback">ConfirmCallback</h4><p>由于每个消息发送时的处理逻辑不一定相同，因此ConfirmCallback需要在每次发消息时定义。具体来说，是在调用RabbitTemplate中的convertAndSend方法时，多传递一个参数：</p><p>这里的CorrelationData中包含两个核心的东西：</p><ul><li><code>id</code>：消息的唯一标示，MQ对不同的消息的回执以此做判断，避免混淆</li><li><code>SettableListenableFuture</code>：回执结果的Future对象</li></ul><p>为什么returnCallback只用写一次配置，而ConfirmCallback需要每次都写，因为消息需要被确认，并且是每条消息都需要被确认</p><p>我们新建一个测试，向系统自带的交换机发送消息，并且添加<code>ConfirmCallback</code>：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherConfirm</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建CorrelationData</span></span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">cd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>();</span><br><span class="line">    <span class="comment">// 2.给Future添加ConfirmCallback</span></span><br><span class="line">    cd.getFuture().addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;CorrelationData.Confirm&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.1.Future发生异常时的处理逻辑，基本不会触发</span></span><br><span class="line">            log.error(<span class="string">&quot;send message fail&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(CorrelationData.Confirm result)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.2.Future接收到回执的处理逻辑，参数中的result就是回执内容</span></span><br><span class="line">            <span class="keyword">if</span>(result.isAck())&#123; <span class="comment">// result.isAck()，boolean类型，true代表ack回执，false 代表 nack回执</span></span><br><span class="line">                log.debug(<span class="string">&quot;发送消息成功，收到 ack!&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123; <span class="comment">// result.getReason()，String类型，返回nack时的异常描述</span></span><br><span class="line">                log.error(<span class="string">&quot;发送消息失败，收到 nack, reason : &#123;&#125;&quot;</span>, result.getReason());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 3.发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;hmall.direct&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;hello&quot;</span>, cd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/07/29/68887a6965355.png" alt="image-20250729153759012"></p><p>可以看到，由于传递的<code>RoutingKey</code>是错误的，路由失败后，触发了<code>return callback</code>，同时也收到了ack。</p><p>当我们修改为正确的<code>RoutingKey</code>以后，就不会触发<code>return callback</code>了，只收到ack。</p><p>而如果连交换机都是错误的，则只会收到nack。</p><div class="note warning simple"><p>开启生产者确认比较消耗MQ性能，一般不建议开启。而且大家思考一下触发确认的几种情况：</p><ul><li>路由失败：一般是因为RoutingKey错误导致，往往是编程导致</li><li>交换机名称错误：同样是编程错误导致</li><li>MQ内部故障：这种需要处理，但概率往往较低。因此只有对消息可靠性要求非常高的业务才需要开启，而且仅仅需要开启ConfirmCallback处理nack就可以了。</li></ul></div></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">李阳</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.baskly.fun/posts/42622/">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://blog.baskly.fun/posts/42622/")'>SpringCloud</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.baskly.fun/posts/42622/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=SpringCloud&amp;url=https://blog.baskly.fun/posts/42622/&amp;pic=https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=9e9a49a4-2f9b-83e3-4aad-021f88d04522" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.baskly.fun" target="_blank">李阳的秘密小屋</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/java/"><span class="categoryes-punctuation"><i class="anzhiyufont anzhiyu-icon-inbox"></i></span> java<span class="categoryesPageCount">7</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/javaweb/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span> javaweb<span class="tagsPageCount">7</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2024/12/24/676a8d8bc7d9f.png?_r_=1ec38028-b3be-0279-6ff4-0ad63d0a3af9" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/49515/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/12/24/676a8d8bc7d9f.png?_r_=94b256b1-06ba-1b25-4eef-f8852b9ae005" onerror='onerror=null,src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">前端学习（tlias为例）</div></div></a></div><div class="next-post pull-right"><a href="/posts/33676/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/12/24/676a8d8bc7d9f.png?_r_=1ec38028-b3be-0279-6ff4-0ad63d0a3af9" onerror='onerror=null,src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">战痘日记</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i> <span>评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/03/01/67c2609b7c10b.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/805daa7195f2c.gif" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">这有描绘<b style="color:#fff">我的痕迹</b></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">李阳</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/lyay23" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">一、前置课程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81MybatisPlus"><span class="toc-number">1.1.</span> <span class="toc-text">1、MybatisPlus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 项目启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 常用注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 常见配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 核心功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">模糊查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9B%B4%E6%96%B0"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">条件更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9B%B4%E6%96%B0-2"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">条件更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89SQL"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">自定义SQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E6%8E%A5%E5%8F%A3%E2%80%93IService"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">Service接口–IService</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Restful%E9%A3%8E%E6%A0%BC%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 Restful风格接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.6 逻辑删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-%E6%9E%9A%E4%B8%BE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.1.7.</span> <span class="toc-text">1.7 枚举处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-JSON%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.1.8.</span> <span class="toc-text">1.8 JSON类型处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="toc-number">1.1.9.</span> <span class="toc-text">1.9 分页插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%A1%88%E4%BE%8B"><span class="toc-number">1.1.9.1.</span> <span class="toc-text">通用分页查询案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%88%86%E9%A1%B5%E6%9D%A1%E4%BB%B6%E5%B0%81%E8%A3%85%E5%9C%A8%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B8%AD"><span class="toc-number">1.1.9.2.</span> <span class="toc-text">将分页条件封装在工具类中</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Docker"><span class="toc-number">1.2.</span> <span class="toc-text">2.Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 安装问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%A7%A3%E5%86%B3%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E6%97%B6es33%E6%98%BE%E7%A4%BA%E8%A2%AB%E5%B7%B2%E6%8B%94%E5%87%BA%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1. 解决配置网络时es33显示被已拔出问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%A7%A3%E5%86%B3Docker%E9%95%9C%E5%83%8F%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">2. 解决Docker镜像问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85MySQL"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 安装MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Docker%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. Docker常见命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 数据卷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">4.1 什么是数据卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">4.2 数据卷的命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E5%88%9B%E5%BB%BANginx-%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">4.3 创建Nginx 数据卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-MySQL-%E5%AE%B9%E5%99%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8C%82%E8%BD%BD"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">4.4 MySQL 容器的数据挂载</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 自定义镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%BD%91%E7%BB%9C"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E4%BD%BF%E7%94%A8Docker%E6%89%93%E5%8C%85%E9%A1%B9%E7%9B%AE%EF%BC%88tlias%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="toc-number">1.2.7.</span> <span class="toc-text">7.使用Docker打包项目（tlias为例）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1%E5%90%8E%E7%AB%AF%E6%89%93%E5%8C%85"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">7.1后端打包</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.7.1.1.</span> <span class="toc-text">具体步骤</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">7.2. 前端项目部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-DockerCompose"><span class="toc-number">1.2.8.</span> <span class="toc-text">8. DockerCompose</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">二、微服务01</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%BC%E5%85%A5%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.0.1.</span> <span class="toc-text">1. 导入后端项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%97%B6%E5%8C%BA%E4%B8%8D%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98"><span class="toc-number">2.0.1.1.</span> <span class="toc-text">解决时区不同步问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.0.2.</span> <span class="toc-text">2. 单体架构与微服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8E%9F%E5%88%99"><span class="toc-number">2.0.3.</span> <span class="toc-text">3. 微服务拆分原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%88RPC%EF%BC%89"><span class="toc-number">2.0.4.</span> <span class="toc-text">4. 远程调用（RPC）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-RestTemplate"><span class="toc-number">2.0.4.1.</span> <span class="toc-text">4.1 RestTemplate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.0.4.2.</span> <span class="toc-text">4.2 注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.0.4.3.</span> <span class="toc-text">4.3 Nacos注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-OpenFeign"><span class="toc-number">2.0.4.4.</span> <span class="toc-text">4.4 OpenFeign</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">2.0.4.5.</span> <span class="toc-text">4.5 连接池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.0.4.6.</span> <span class="toc-text">4.6 最佳实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA"><span class="toc-number">2.0.4.7.</span> <span class="toc-text">4.6 日志输出</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">2.0.4.7.1.</span> <span class="toc-text">定义日志级别</span></a></li></ol></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">三、 微服务02</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1"><span class="toc-number">3.1.</span> <span class="toc-text">1. 网关路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%BD%91%E5%85%B3%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.1 网关快速入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%B7%AF%E7%94%B1%E5%B1%9E%E6%80%A7"><span class="toc-number">3.1.2.</span> <span class="toc-text">1.2 路由属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">路由断言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">路由过滤器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BD%91%E5%85%B3%E7%99%BB%E5%BD%95"><span class="toc-number">3.2.</span> <span class="toc-text">2. 网关登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1 网关过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2 自定义过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.3 实现登录校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%BD%91%E5%85%B3%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7"><span class="toc-number">3.2.4.</span> <span class="toc-text">2.4 网关传递用户</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E5%88%B0%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">保存用户到请求头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">拦截器获取用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">配置拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%89%AB%E6%8F%8F"><span class="toc-number">3.2.4.4.</span> <span class="toc-text">添加扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">3.2.4.5.</span> <span class="toc-text">结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-5-OpenFeign%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7"><span class="toc-number">3.2.5.</span> <span class="toc-text">1.3.5 OpenFeign传递用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">3.3.</span> <span class="toc-text">3. 配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1 配置共享</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E6%B7%BB%E5%8A%A0%E5%85%B1%E4%BA%AB%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">3.1.1 添加共享配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%8B%89%E5%8F%96nacos"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2 拉取nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.3 配置热更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">3.3.4.</span> <span class="toc-text">3.4 动态路由</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">四、 微服务03</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 雪崩问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 微服务保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4%E6%96%B9%E6%A1%88"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 服务保护方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 请求限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 线程隔离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.2.4 服务熔断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-Sentinel"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-Sentinel%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 Sentinel安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Window%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">Window安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker%E8%BF%90%E8%A1%8C"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">Docker运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-Fallback"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2 Fallback</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-Seata"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.4.1 Seata</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-Seata%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.4.2 Seata配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90Seata"><span class="toc-number">4.4.3.</span> <span class="toc-text">4.4.3 微服务集成Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnacos"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">配置nacos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.3.3.</span> <span class="toc-text">改造配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-4-XA%E6%A8%A1%E5%BC%8F%EF%BC%88%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%89"><span class="toc-number">4.4.4.</span> <span class="toc-text">4.4.4 XA模式（面试题）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.4.1.</span> <span class="toc-text">回滚日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-5-AT%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.5.</span> <span class="toc-text">4.4.5 AT模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">五、MQ基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 异步调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 技术选型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-RabbitMQ"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E5%AE%89%E8%A3%85"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-Spring-AMQP"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2 Spring AMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-1-WorkQueues%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">5.3.2.1 WorkQueues模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-2-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">5.3.2.2 交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-3-Fanout-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">5.3.2.3 Fanout 交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-4-Direct-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">5.3.2.4 Direct 交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-5-Topic%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.5.</span> <span class="toc-text">5.3.2.5 Topic交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-6-%E5%A3%B0%E6%98%8E%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.2.6.</span> <span class="toc-text">5.3.2.6 声明队列和交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-7-%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">5.3.2.7.</span> <span class="toc-text">5.3.2.7 消息转换器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-8-%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1"><span class="toc-number">5.3.2.8.</span> <span class="toc-text">5.3.2.8 订单业务</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">六、 MQ高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8F%91%E9%80%81%E8%80%85%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">6.1.</span> <span class="toc-text">1.发送者的可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8F%91%E9%80%81%E8%80%85%E9%87%8D%E8%BF%9E"><span class="toc-number">6.1.1.</span> <span class="toc-text">1.1 发送者重连</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%8F%91%E9%80%81%E8%80%85%E7%A1%AE%E8%AE%A4"><span class="toc-number">6.1.2.</span> <span class="toc-text">1.2 发送者确认</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">开启生产者确认</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReturnCallback"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">ReturnCallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConfirmCallback"><span class="toc-number">6.1.2.3.</span> <span class="toc-text">ConfirmCallback</span></a></li></ol></li></ol></li></ol></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/33676/" title="战痘日记"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/12/24/676a8d8bc7d9f.png?_r_=1ec38028-b3be-0279-6ff4-0ad63d0a3af9" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="战痘日记"></a><div class="content"><a class="title" href="/posts/33676/" title="战痘日记">战痘日记</a><time datetime="2025-07-21T10:34:21.000Z" title="发表于 2025-07-21 18:34:21">2025-07-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/42622/" title="SpringCloud"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=9e9a49a4-2f9b-83e3-4aad-021f88d04522" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="SpringCloud"></a><div class="content"><a class="title" href="/posts/42622/" title="SpringCloud">SpringCloud</a><time datetime="2025-07-13T00:34:21.000Z" title="发表于 2025-07-13 08:34:21">2025-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/49515/" title="前端学习（tlias为例）"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/12/24/676a8d8bc7d9f.png?_r_=94b256b1-06ba-1b25-4eef-f8852b9ae005" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="前端学习（tlias为例）"></a><div class="content"><a class="title" href="/posts/49515/" title="前端学习（tlias为例）">前端学习（tlias为例）</a><time datetime="2025-05-25T03:34:21.000Z" title="发表于 2025-05-25 11:34:21">2025-05-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/37847/" title="tlias 智能管理系统"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e1191e4.png?_r_=2961fbf6-ab5f-bdba-02c2-4822342d8bcb" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="tlias 智能管理系统"></a><div class="content"><a class="title" href="/posts/37847/" title="tlias 智能管理系统">tlias 智能管理系统</a><time datetime="2025-04-07T03:34:21.000Z" title="发表于 2025-04-07 11:34:21">2025-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/21962/" title="苍穹外卖"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/05/30/68398ca86a127.gif&quot;" data-lazy-src="https://bu.dusays.com/2024/11/24/674340e0cd15e.png?_r_=b33cd71f-f619-3137-dbd6-cad8083a77d9" onerror='this.onerror=null,this.src="https://bu.dusays.com/2025/05/30/68398ca86a127.gif"' alt="苍穹外卖"></a><div class="content"><a class="title" href="/posts/21962/" title="苍穹外卖">苍穹外卖</a><time datetime="2025-03-15T13:34:21.000Z" title="发表于 2025-03-15 21:34:21">2025-03-15</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By 李阳</div><div class="footer_custom_text">下次再见！</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i> <span>隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongji1"></use></svg> <span>统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=12781955100&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>耳机分你一半</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zuji"></use></svg> <span>脚步</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-taiyang"></use></svg> <span>小太阳</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-a-xiaoyangyang_huaban1"></use></svg> <span>了解我</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/408/" style="font-size:.88rem">408<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:.88rem">C语言<sup>1</sup></a><a href="/tags/javaweb/" style="font-size:.88rem">javaweb<sup>7</sup></a><a href="/tags/%E5%8A%9B%E6%89%A3%E5%88%B7%E9%A2%98/" style="font-size:.88rem">力扣刷题<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:.88rem">操作系统<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size:.88rem">数据结构<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%B8%B8/" style="font-size:.88rem">日常<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" style="font-size:.88rem">计算机组成原理<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">计算机网络<sup>2</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size:.88rem">软件工程<sup>1</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="12781955100" server="netease" type="playlist" mutex="true" preload="none" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=12781955100&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js").then((()=>{pangu.autoSpacingPage()}))}function panguInit(){GLOBAL_CONFIG_SITE.isPost&&panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask((()=>{const o=function(){HoldLog.apply(console,arguments)},n=new Date("04/01/2021 00:00:00");now1.setTime(now1.getTime()+250);const c=(now1-n)/1e3/60/60/24,e=["欢迎使用安知鱼!","生活明朗, 万物可爱","\n        \n       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗\n      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║\n      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║\n      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║\n      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝\n      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝\n        \n        ","已上线",Math.floor(c),"天","©2024 By 安知鱼 V1.6.14"],t=["NCC2-036","调用前置摄像头拍照成功，识别为【小笨蛋】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`\n%c${e[0]} %c ${e[1]} %c ${e[2]} %c${e[3]}%c ${e[4]}%c ${e[5]}\n\n%c ${e[6]}\n`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${t[0]} %c ${t[1]} %c \n${t[2]} %c\n${t[3]}\n`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，小笨蛋.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 李阳 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))}))</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" href="https://cdn.cbd.int/katex@0.16.0/dist/katex.min.css"><script src="https://cdn.cbd.int/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script>document.querySelectorAll("#article-container span.katex-display").forEach((a=>{anzhiyu.wrap(a,"div",{class:"katex-wrap"})}))</script><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach(((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,a="%%{init:{ 'theme':'"+t+"'}}%%\n"+d.textContent,i=mermaid.render(r,a);var m;"string"==typeof i?(m=i,d.insertAdjacentHTML("afterend",m)):i.then((({svg:e})=>{d.insertAdjacentHTML("afterend",e)}))}))},n=()=>{window.loadMermaid?t():getScript("https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js").then(t)};anzhiyu.addGlobalFn("themeChange",t,"mermaid"),window.pjax?n():document.addEventListener("DOMContentLoaded",n)})()</script><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.baskly.fun",region:"",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://twikoo.baskly.fun",region:"",urls:[window.location.pathname],includeReply:!1}).then((o=>{t.textContent=o[0].count})).catch((t=>{console.error(t)}))})()};t()})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener("load",(()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://twikoo.baskly.fun",region:"",pageSize:6,includeReply:!0}).then((function(t){const n=t.map((e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t}));saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)}))</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="yang@li.com"</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async src="//at.alicdn.com/t/c/font_4782341_g014uvnbwk6.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="https://lib.baomitu.com/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/imgloaded.min.js"></script><script src="https://jsd-proxy.ygxz.in/gh/lyay23/blogstatic@v1.0.0/static/countdown.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>